<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":"ture","mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;分析总结 pinctrl 子系统框架结构，平台 mtk6771 内核版本 kernel-4.4 , 本文所有的分析均基于此版本。">
<meta property="og:type" content="article">
<meta property="og:title" content="pinctrl 子系统">
<meta property="og:url" content="https://example.com/2021/06/11/linux%E9%A9%B1%E5%8A%A8-pinctrl/index.html">
<meta property="og:site_name" content="braon-z&#39;s blog">
<meta property="og:description" content="&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;分析总结 pinctrl 子系统框架结构，平台 mtk6771 内核版本 kernel-4.4 , 本文所有的分析均基于此版本。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/linux%E9%A9%B1%E5%8A%A8/pinctrl%E5%AD%90%E7%B3%BB%E7%BB%9F/mtk%E5%B9%B3%E5%8F%B0pin%E8%84%9A%E5%AF%84%E5%AD%98%E5%99%A8%E8%A1%A8%E7%A4%BA.png?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1622682822;86400000001622600000&q-key-time=1622682822;86400000001622600000&q-header-list=&q-url-param-list=&q-signature=8050114349f3348de91b2edb09e72d1d84cfbb58">
<meta property="og:image" content="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/linux%E9%A9%B1%E5%8A%A8/pinctrl%E5%AD%90%E7%B3%BB%E7%BB%9F/pinctrl%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%A1%86%E6%9E%B6.png?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1622712744;86400000001622640000&q-key-time=1622712744;86400000001622640000&q-header-list=&q-url-param-list=&q-signature=4c7485bd86a798d58e70091a2a2453f819fffda1">
<meta property="og:image" content="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/linux%E9%A9%B1%E5%8A%A8/pinctrl%E5%AD%90%E7%B3%BB%E7%BB%9F/%E8%AE%BE%E5%A4%87%20pinctr%20%E7%9A%84%E5%86%85%E9%83%A8%E6%95%B0%E6%8D%AE%E7%BB%84%E7%BB%87%E7%BB%93%E6%9E%84.png?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1622778256;86400000001622700000&q-key-time=1622778256;86400000001622700000&q-header-list=&q-url-param-list=&q-signature=da4eb2c74bc03c747b997c052e507548c1aada8e">
<meta property="og:image" content="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/linux%E9%A9%B1%E5%8A%A8/pinctrl%E5%AD%90%E7%B3%BB%E7%BB%9F/pin_state%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B.png?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1623235951;86400000001623150000&q-key-time=1623235951;86400000001623150000&q-header-list=&q-url-param-list=&q-signature=bf31a7976aeadcc08a17b2740d6c73d5da2b9331">
<meta property="article:published_time" content="2021-06-11T01:14:17.000Z">
<meta property="article:modified_time" content="2021-06-11T07:38:15.492Z">
<meta property="article:author" content="braon-z">
<meta property="article:tag" content="驱动">
<meta property="article:tag" content="pinctrl">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/linux%E9%A9%B1%E5%8A%A8/pinctrl%E5%AD%90%E7%B3%BB%E7%BB%9F/mtk%E5%B9%B3%E5%8F%B0pin%E8%84%9A%E5%AF%84%E5%AD%98%E5%99%A8%E8%A1%A8%E7%A4%BA.png?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1622682822;86400000001622600000&q-key-time=1622682822;86400000001622600000&q-header-list=&q-url-param-list=&q-signature=8050114349f3348de91b2edb09e72d1d84cfbb58">


<link rel="canonical" href="https://example.com/2021/06/11/linux%E9%A9%B1%E5%8A%A8-pinctrl/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>pinctrl 子系统 | braon-z's blog</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">braon-z's blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81pinctrl-%E5%AD%90%E7%B3%BB%E7%BB%9F%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">一、pinctrl 子系统基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81pinctrl-dev"><span class="nav-text">1、pinctrl_dev</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81pinctrl-desc"><span class="nav-text">2、pinctrl_desc</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-pinctrl-pin-desc"><span class="nav-text">1) pinctrl_pin_desc</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-pinctrl-ops"><span class="nav-text">2) pinctrl_ops</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-pinmux"><span class="nav-text">3) pinmux</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-pinconf-ops"><span class="nav-text">4) pinconf_ops</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81pinctrl"><span class="nav-text">3、pinctrl</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-pinctrl-state"><span class="nav-text">1) pinctrl_state</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-pinctrl-setting"><span class="nav-text">2) pinctrl_setting</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-pinctrl-map"><span class="nav-text">3) pinctrl_map</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81mtk-%E5%B9%B3%E5%8F%B0%E5%AF%84%E5%AD%98%E5%99%A8%E7%9A%84%E8%A1%A8%E7%A4%BA%E6%96%B9%E5%BC%8F"><span class="nav-text">二、mtk 平台寄存器的表示方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81pinctrl-%E5%AD%90%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%B3%BB%E7%BB%9F%E6%A1%86%E6%9E%B6"><span class="nav-text">三、pinctrl 子系统的系统框架</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E6%A1%86%E6%9E%B6%E6%8E%A5%E5%8F%A3"><span class="nav-text">1、框架接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0"><span class="nav-text">2、内部实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E9%85%8D%E7%BD%AE%E8%AE%BE%E5%A4%87%E7%9A%84%E5%BC%95%E8%84%9A%E8%B5%84%E6%BA%90"><span class="nav-text">1) 配置设备的引脚资源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E8%A7%A3%E6%9E%90%E8%AE%BE%E5%A4%87%E5%BC%95%E8%84%9A%E8%B5%84%E6%BA%90%E7%9A%84%E6%97%B6%E6%9C%BA"><span class="nav-text">2) 解析设备引脚资源的时机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-pinctrl-%E8%A7%A3%E6%9E%90%E8%AE%BE%E5%A4%87%E5%BC%95%E8%84%9A%E8%B5%84%E6%BA%90"><span class="nav-text">3) pinctrl 解析设备引脚资源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">4) 源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a-%E5%88%9B%E5%BB%BA-pinctrl-map"><span class="nav-text">a. 创建 pinctrl_map</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#pinctrl-dt-to-map"><span class="nav-text">pinctrl_dt_to_map</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#dt-to-map-one-config"><span class="nav-text">dt_to_map_one_config</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#mtk-pctrl-dt-node-to-map"><span class="nav-text">mtk_pctrl_dt_node_to_map</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#mtk-pctrl-dt-subnode-to-map"><span class="nav-text">mtk_pctrl_dt_subnode_to_map</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#mtk-pctrl-dt-node-to-map-func"><span class="nav-text">mtk_pctrl_dt_node_to_map_func</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#mtk-pctrl-is-function-valid"><span class="nav-text">mtk_pctrl_is_function_valid</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#pinctrl-utils-add-map-configs"><span class="nav-text">pinctrl_utils_add_map_configs</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#pinconf-generic-parse-dt-config"><span class="nav-text">pinconf_generic_parse_dt_config</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#parse-dt-cfg"><span class="nav-text">parse_dt_cfg</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#pinctrl-utils-reserve-map"><span class="nav-text">pinctrl_utils_reserve_map</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#mtk-pctrl-find-group-by-pin"><span class="nav-text">mtk_pctrl_find_group_by_pin</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#dt-remember-or-free-map"><span class="nav-text">dt_remember_or_free_map</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#pinctrl-register-map"><span class="nav-text">pinctrl_register_map</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b-%E5%B0%86pinctrl-map%E8%BD%AC%E5%8C%96%E4%B8%BApinctrl-setting"><span class="nav-text">b. 将pinctrl_map转化为pinctrl_setting</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#add-setting"><span class="nav-text">add_setting</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#create-state"><span class="nav-text">create_state</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#pinmux-map-to-setting"><span class="nav-text">pinmux_map_to_setting</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#pinmux-func-name-to-selector"><span class="nav-text">pinmux_func_name_to_selector</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#pinctrl-get-group-selector"><span class="nav-text">pinctrl_get_group_selector</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#pinconf-map-to-setting"><span class="nav-text">pinconf_map_to_setting</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#pin-get-from-name"><span class="nav-text">pin_get_from_name</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81pinctrl-%E5%AD%90%E7%B3%BB%E7%BB%9F%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">四、pinctrl 子系统的使用</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="braon-z"
      src="/images/wallhaven.jfif">
  <p class="site-author-name" itemprop="name">braon-z</p>
  <div class="site-description" itemprop="description"> 爱一个人，攀一座山，追一次梦<br>不妨大胆一点，有很多事没有答案</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/yourname" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yourname@gmail.com" title="E-Mail → mailto:yourname@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


<div style="">
  <canvas id="canvas" style="width:60%;">当前浏览器不支持canvas，请更换浏览器后再试</canvas>
</div>
<script>
(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //声明canvas的宽高
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //存储时间数据
    var data = [];
    //存储运动的小球
    var balls = [];
    //设置粒子半径
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //存储时间数字，由十位小时、个位小时、冒号、十位分钟、个位分钟、冒号、十位秒钟、个位秒钟这7个数字组成
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*生成点阵数字*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*更新时钟*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //时间发生变化
            if(NewData[i] !== data[i]){
                //将变化的数字值和在data数组中的索引存储在changeNumArray数组中
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //增加小球
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*更新小球状态*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*增加要运动的小球*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*渲染*/
    function render(){
        //重置画布宽度，达到清空画布的效果
        canvas.height = 100;
        //渲染时钟
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //渲染小球
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //更新时钟
        updateDigitTime();
        //更新小球状态
        updateBalls();
        //渲染
        render();
    },50);
}

})();
</script>
        </div>
      </div>
        <div class="back-to-top animated" role="button">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://example.com/2021/06/11/linux%E9%A9%B1%E5%8A%A8-pinctrl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/wallhaven.jfif">
      <meta itemprop="name" content="braon-z">
      <meta itemprop="description" content=" 爱一个人，攀一座山，追一次梦<br>不妨大胆一点，有很多事没有答案">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="braon-z's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          pinctrl 子系统
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-06-11 09:14:17 / 修改时间：15:38:15" itemprop="dateCreated datePublished" datetime="2021-06-11T09:14:17+08:00">2021-06-11</time>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Valine：</span>
  
    <a title="valine" href="/2021/06/11/linux%E9%A9%B1%E5%8A%A8-pinctrl/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/06/11/linux%E9%A9%B1%E5%8A%A8-pinctrl/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>43k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>39 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>&nbsp;&nbsp;&nbsp;&nbsp;分析总结 pinctrl 子系统框架结构，平台 mtk6771 内核版本 kernel-4.4 , 本文所有的分析均基于此版本。</p>
<a id="more"></a>

<h2 id="一、pinctrl-子系统基本概念"><a href="#一、pinctrl-子系统基本概念" class="headerlink" title="一、pinctrl 子系统基本概念"></a>一、pinctrl 子系统基本概念</h2><p>&nbsp;&nbsp;&nbsp;&nbsp; 引脚控制子系统(pin control subsystem)，和设备模型一样是linux驱动最基础的系统之一。 对于一块 soc 的 cpu 上有很多引脚，驱动工程师需要根据其应用场景使其处于我们需要的状态，例如配置某个引脚为 gpio 或者 配置其为 i2c。对于不同的 cpu 其寄存器的地址往往是不一样的，比如 S3C2440 的 gpio 控制器的基地址为 0x53000000，而 mtk 的 gpio 地址为 0x10005000，而且寄存器的地址的位也表示不同的含义，而内核为了兼容不同的芯片于是创建出 pinctrl 子系统，该系统用于<font color=red>将板级信息从内核分离出来</font>，对于真正的寄存器的操作，由 soc 厂家来完成(bsp工程师)，而对于普通的驱动工程师来讲，我们调用内核给出的统一接口来设置对应的pin脚就行了。</p>
<h3 id="1、pinctrl-dev"><a href="#1、pinctrl-dev" class="headerlink" title="1、pinctrl_dev"></a>1、pinctrl_dev</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;该结构是 pinctrl 子系统的核心结构，每一个 soc 都需要向内核注册一个 pinctrl_dev 来描述该 pinctl 子系统，它包含下面几部分内容。</p>
<ol>
<li>注册到该子系统的 soc 的引脚控制器 pinctrl_desc</li>
<li>注册到该子系统的 pin 脚 pin_desc_tree</li>
<li>注册到该子系统的 pin 脚对应的 gpio_rang</li>
<li>注册到该子系统的 私有数据</li>
<li>soc 的 pin 脚的默认状态以及，板子休眠时 pin 脚的状态，我看了一下 mtk 平台好像并没有用到这部分功能，不知道其他平台有没有用到这个功能。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_dev</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span>                <span class="comment">// 挂接到全局 pinctrldev_list</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_desc</span> *<span class="title">desc</span>;</span>            <span class="comment">// 引脚控制器描述符</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">radix_tree_root</span> <span class="title">pin_desc_tree</span>;</span> <span class="comment">// 用于挂接所有注册到该设备的 pin 脚，注册的 pin 脚由</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">gpio_ranges</span>;</span>         <span class="comment">// 用于挂接 gpio_range</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span>                   <span class="comment">// 设备模型中的设备</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *driver_data;                    <span class="comment">// 私有数据</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl</span> *<span class="title">p</span>;</span>                    <span class="comment">// 当前设备的 pinctrl ，用于管理整个 soc 板子的 pin 脚状态。</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">hog_default</span>;</span>    <span class="comment">// 板子默认的 pin 脚状态</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">hog_sleep</span>;</span>      <span class="comment">// 板子休眠时的 pin 脚状态</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_FS</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">device_root</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="2、pinctrl-desc"><a href="#2、pinctrl-desc" class="headerlink" title="2、pinctrl_desc"></a>2、pinctrl_desc</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;pinctrl_desc 表示引脚控制器，它是软件上抽象出来的概念，抽象这个结构是为了方便代码的编写，实际硬件并不存在这样的控制器，该结构描述对 pin 脚寄存器真正的操作接口，该接口通常由 soc 厂完成，一般情况一个 soc 只有一个 pinctrl_desc 结构，它包含了下面内容。</p>
<ol>
<li>soc 要处理的<font color=red>所有引脚</font>的软件描述</li>
<li>获取每个(组)引脚的 pin 脚信息的操作接口 pctlops</li>
<li>每个(组)引脚的复用(pinmux)操作接口 pmxops</li>
<li>每个(组)引脚的电器特性(pinconfig)操作接口 confops</li>
<li>支持客制化的 pinconfig</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引脚控制器描述符，将其注册到引脚控制子系统</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_desc</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;                    <span class="comment">// 引脚控制器的名称</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_pin_desc</span> *<span class="title">pins</span>;</span> <span class="comment">// 引脚描述符数组，描述此引脚控制器处理的所有引脚</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> npins;                  <span class="comment">// 数组中描述符的数量，通常只是上面的 pin 字段的 ARRAY_SIZE()</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_ops</span> *<span class="title">pctlops</span>;</span>   <span class="comment">// 用于获取pin group 信息以及将设备树中的引脚配置(引脚复用以及pinconfig)转换为对应的 pinctrl_map</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinmux_ops</span> *<span class="title">pmxops</span>;</span>     <span class="comment">// pin 复用相关操作，以 group 为单位进行操作</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinconf_ops</span> *<span class="title">confops</span>;</span>   <span class="comment">// 配饰 pin 的 pinconfg(上拉、下拉、输出方式等)，以 pin 或 group 为操作对象</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span>                <span class="comment">// 提供引脚控制器的模块，用于重新计数</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_GENERIC_PINCONF</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> num_custom_params;      <span class="comment">// 客制化引脚支持的 pinconfig 的数量</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinconf_generic_params</span> *<span class="title">custom_params</span>;</span> <span class="comment">// 客制化引脚支持的 pinconfig</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pin_config_item</span> *<span class="title">custom_conf_items</span>;</span>    <span class="comment">// 有关如何在 debugfs 中打印 @params 的信息，必须与 @custom_params 大小相同，即 @num_custom_params</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="1-pinctrl-pin-desc"><a href="#1-pinctrl-pin-desc" class="headerlink" title="1) pinctrl_pin_desc"></a>1) pinctrl_pin_desc</h4><p>&nbsp;&nbsp;&nbsp;&nbsp; soc上有大量引脚，每一个引脚使用 pinctrl_pin_desc 来描述</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//内核中用其描述 pin 的信息</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_pin_desc</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> number;  <span class="comment">// pin 引脚号</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name; <span class="comment">// 此引脚的名称，将用来初始化 pin_desc 的 name，如果为空将使用 PIN + number 例如：PIN0</span></span><br><span class="line">    <span class="keyword">void</span> *drv_data;   <span class="comment">// 私有数据</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="2-pinctrl-ops"><a href="#2-pinctrl-ops" class="headerlink" title="2) pinctrl_ops"></a>2) pinctrl_ops</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;对于引脚的使用，有时候一次性会使用到多个引脚，I2C接口会同时使用 2 个引脚，SPI 接口会同时使用 4 个引脚。需要以 group 为单位，访问控制多个 pin，这就是 <strong>pin groups</strong>。但是 <font color=red>mtk 平台采取的策略则是每一个 pin 就是一个 group。</font>，而 pinctrl_ops 则用于获取对应 group 的 pin 脚信息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_ops</span> &#123;</span></span><br><span class="line">    <span class="comment">// 获取 pin group 的数量，对于mtk平台这里就是 pin 脚的数量</span></span><br><span class="line">    <span class="keyword">int</span> (*get_groups_count) (struct pinctrl_dev *pctldev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取使用 selector 作为数组下标指定 group 的名称</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *(*get_group_name) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> selector);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 selector 作为数组下标返回指定 group 所用到的 pins 以及 pin 的数量 num_pins，由于mtk 平台采一个 pin 就是一个 group，因此这里固定返回 1.</span></span><br><span class="line">    <span class="keyword">int</span> (*get_group_pins) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> selector, <span class="keyword">const</span> <span class="keyword">unsigned</span> **pins, <span class="keyword">unsigned</span> *num_pins);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// debug 相关</span></span><br><span class="line">    <span class="keyword">void</span> (*pin_dbg_show) (struct pinctrl_dev *pctldev, struct seq_file *s, <span class="keyword">unsigned</span> offset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于将设备树中的引脚配置转换为对应的 pinctrl_map</span></span><br><span class="line">    <span class="keyword">int</span> (*dt_node_to_map) (struct pinctrl_dev *pctldev, struct device_node *np_config, struct pinctrl_map **<span class="built_in">map</span>, <span class="keyword">unsigned</span> *num_maps);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于释放前面创建的 pinctrl_map</span></span><br><span class="line">    <span class="keyword">void</span> (*dt_free_map) (struct pinctrl_dev *pctldev, struct pinctrl_map *<span class="built_in">map</span>, <span class="keyword">unsigned</span> num_maps);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;需要注意的是该接口除了能够获取 pin group 信息之外,还有一个非常重要的回调接口 dt_node_to_map ，用于<font color=red>将设备树中的引脚配置转换为对应的 pinctrl_map</font>。 该接口的实现通常由soc原厂实现。</p>
<h4 id="3-pinmux"><a href="#3-pinmux" class="headerlink" title="3) pinmux"></a>3) pinmux</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;pinmux 表示引脚复，用这个概念就不做解释了。需要注意的是引脚复用和引脚的电器特性(pinconfig)并不是相同的概念, pinctrl子系统中引脚的复用类型用 <font color=red>func</font> 来描述，例如，某 pin 可以复用为 i2c 也可复用为 spi，那么这个引脚则拥有两个 func。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinmux_ops</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查某个 pin 是否已作它用，用于管脚复用时的互斥（避免多个功能同时使用某个 pin 而不知道，导致奇怪的错误）。</span></span><br><span class="line">    <span class="keyword">int</span> (*request) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> offset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*<span class="built_in">free</span>) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> offset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回板子 functions 支持的引脚复用的类型的总数，spi0、i2c0、mmc0 这三种类型则应该返回 3   </span></span><br><span class="line">    <span class="keyword">int</span> (*get_functions_count) (struct pinctrl_dev *pctldev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过数组下标 selector 返回 functions 数组中对应的引脚复用为什么功能</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *(*get_function_name) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> selector);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回 selector 表示的复用功能有哪些 group, 例如：当 selector 表示的复用功能为 i2c 的数组下标时，可能返回 &quot;i2c-0&quot;，&quot;i2c-1&quot;,num_groups = 2.</span></span><br><span class="line">    <span class="keyword">int</span> (*get_function_groups) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> selector, <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> **groups, <span class="keyword">unsigned</span> *num_groups);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置 group 为 func_selector 表示的复用功能</span></span><br><span class="line">    <span class="keyword">int</span> (*set_mux) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> func_selector, <span class="keyword">unsigned</span> group_selector);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下面是gpio相关</span></span><br><span class="line">    <span class="keyword">int</span> (*gpio_request_enable) (struct pinctrl_dev *pctldev, struct pinctrl_gpio_range *range, <span class="keyword">unsigned</span> offset);</span><br><span class="line">    <span class="keyword">void</span> (*gpio_disable_free) (struct pinctrl_dev *pctldev, struct pinctrl_gpio_range *range, <span class="keyword">unsigned</span> offset);</span><br><span class="line">    <span class="keyword">int</span> (*gpio_set_direction) (struct pinctrl_dev *pctldev, struct pinctrl_gpio_range *range, <span class="keyword">unsigned</span> offset, <span class="keyword">bool</span> input);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> strict;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="4-pinconf-ops"><a href="#4-pinconf-ops" class="headerlink" title="4) pinconf_ops"></a>4) pinconf_ops</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;对于每一个引脚都有其特定的电器特性，如上拉、下拉、三态、强推挽输出等用 pinconfig 来描述，pinctrl子系统同样也给出了电器特性的操作函数回调接口。对于电器特性的操作既可以操作一个引脚，也可以操作一组引脚。<font color = red>对于 mtk 平台每个 pin 都是一个 group，因此只用到了 pin_config_group_get 和 pin_config_group_set 接口</font></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinconf_ops</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_GENERIC_PINCONF</span></span><br><span class="line">    <span class="keyword">bool</span> is_generic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">//获取一个引脚的 pinconfig</span></span><br><span class="line">    <span class="keyword">int</span> (*pin_config_get) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> pin, <span class="keyword">unsigned</span> <span class="keyword">long</span> *config);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置一个引脚的 pinconfig</span></span><br><span class="line">    <span class="keyword">int</span> (*pin_config_set) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> pin, <span class="keyword">unsigned</span> <span class="keyword">long</span> *configs, <span class="keyword">unsigned</span> num_configs);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取一个 group 描述的 pin 的 pinconfig</span></span><br><span class="line">    <span class="keyword">int</span> (*pin_config_group_get) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> selector, <span class="keyword">unsigned</span> <span class="keyword">long</span> *config);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置一个 group 描述的 pin 的 pinconfig</span></span><br><span class="line">    <span class="keyword">int</span> (*pin_config_group_set) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> selector, <span class="keyword">unsigned</span> <span class="keyword">long</span> *configs, <span class="keyword">unsigned</span> num_configs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//后面这写接口基本用不着，debug相关接口</span></span><br><span class="line">    <span class="keyword">int</span> (*pin_config_dbg_parse_modify) (struct pinctrl_dev *pctldev, <span class="keyword">const</span> <span class="keyword">char</span> *arg, <span class="keyword">unsigned</span> <span class="keyword">long</span> *config);</span><br><span class="line">    <span class="keyword">void</span> (*pin_config_dbg_show) (struct pinctrl_dev *pctldev, struct seq_file *s, <span class="keyword">unsigned</span> offset);</span><br><span class="line">    <span class="keyword">void</span> (*pin_config_group_dbg_show) (struct pinctrl_dev *pctldev, struct seq_file *s, <span class="keyword">unsigned</span> selector);</span><br><span class="line">    <span class="keyword">void</span> (*pin_config_config_dbg_show) (struct pinctrl_dev *pctldev, struct seq_file *s, <span class="keyword">unsigned</span> <span class="keyword">long</span> config);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="3、pinctrl"><a href="#3、pinctrl" class="headerlink" title="3、pinctrl"></a>3、pinctrl</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;对于不同的设备的引脚状态统一由属于该设备的 pinctrl 统一管理。也就是说每一个设备都有一个属于自己的 pinctrl ,该 pinctrl 管理着该设备的 pinctrl_state。相关结构如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span>        <span class="comment">// 挂接到全局的 pinctrl_list</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span>           <span class="comment">// 表示所属的 dev</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">states</span>;</span>      <span class="comment">// 挂接该 pinctrl 所有的 state</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">state</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">dt_maps</span>;</span>     <span class="comment">// 用来挂接 pinctrl_dt_map ，该结构管理着 pinctrl 下所有的 pinctrl_map</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">users</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 每个设备中都有自己的 pin_info</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> &#123;</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PINCTRL</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dev_pin_info</span> *<span class="title">pins</span>;</span> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dev_pin_info</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl</span> *<span class="title">p</span>;</span>  <span class="comment">//每个创建的设备中的 pinctrl</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//默认的 state</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">default_state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">init_state</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PM</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">sleep_state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">idle_state</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="1-pinctrl-state"><a href="#1-pinctrl-state" class="headerlink" title="1) pinctrl_state"></a>1) pinctrl_state</h4><p>用于描述设备上的 pin 脚所处的状态，一个设备上的 pin 脚可以有多种状态。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span> <span class="comment">// 挂接到所属的 pinctrl</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;      <span class="comment">// 对应的 pinctrl_map 的 name</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">settings</span>;</span> <span class="comment">// 挂接该 state 下所有的 setting</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>每一个 pin 脚有两个状态, 引脚复用(pinmux)，和引脚状态(pinconfig)，这两种状态由 pinctrl_setting 来描述。</p>
<h4 id="2-pinctrl-setting"><a href="#2-pinctrl-setting" class="headerlink" title="2) pinctrl_setting"></a>2) pinctrl_setting</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;一个 pinctrl_setting 只能表示一个引脚复用(pinmux)或者一组电器特性(pinconfig)，通过 pinctrl_map_type 来区分当前的 pinctrl_setting 是描述 pinmux 还是描述 pinconfig，如果 pinctrl_map_type 为 PIN_MAP_TYPE_MUX_GROUP 表示该 setting 或 pinctrl_map 为引脚复用，如果为 PIN_MAP_TYPE_CONFIGS_GROUP 则表示 setting 或 pinctrl_map 为 pinconfig。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_setting</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span>       <span class="comment">// 挂接到所属的 state</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">pinctrl_map_type</span> <span class="title">type</span>;</span>  <span class="comment">// 该 setting 的 pinctrl_map 的类型</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_dev</span> *<span class="title">pctldev</span>;</span> <span class="comment">// 该 pinctrl_map 所属的 pinctrl_dev</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *dev_name;        <span class="comment">// 被设置为 pinctrl_map-&gt;dev_name</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_setting_mux</span> <span class="title">mux</span>;</span> <span class="comment">//如果 type 为 PIN_MAP_TYPE_MUX_GROUP 则使用这个结构来保存引脚复用相关参数</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_setting_configs</span> <span class="title">configs</span>;</span> <span class="comment">//如果 type 为 PIN_MAP_TYPE_CONFIGS_PIN 或者  PIN_MAP_TYPE_CONFIGS_GROUP 则使用这个结构来保存引脚电器特性相关参数</span></span><br><span class="line">    &#125; data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_setting_mux</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> group; <span class="comment">// 要用到的  pin group 的数组下标</span></span><br><span class="line">    <span class="keyword">unsigned</span> func;  <span class="comment">// 要用到的 func 的数组下标</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_setting_configs</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> group_or_pin;  <span class="comment">// 要配置的 pin 或者 pin group 的数组下标</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *configs; <span class="comment">// 对应的 pinconfig，具体的含义由 soc 原厂定义</span></span><br><span class="line">    <span class="keyword">unsigned</span> num_configs;   <span class="comment">// config 数量</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>不过这个结构需要通过中间结构 pinctrl_map 转化而来，这个结构又通过 dts 配置的引脚参数创建而来。</p>
<h4 id="3-pinctrl-map"><a href="#3-pinctrl-map" class="headerlink" title="3) pinctrl_map"></a>3) pinctrl_map</h4><p>该结构也是提供对应的索引，不过它提供的索引是以字符串的形式提供的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map</span> &#123;</span> <span class="comment">//三个 name 都是在 pinctrl_dt_to_map 函数获取，在 dt_remember_or_free_map 函数进行初始化。</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *dev_name;       <span class="comment">// 所属 pinctrl 的 name</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;           <span class="comment">// 设备树中的 pinctrl-names 的属性值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前 pinctrl_map 所属的类别，一般用到的有两大类，复用(mux) 和 pinconfig,</span></span><br><span class="line">    <span class="comment">// 当使用 mux 时使用 pinctrl_map_mux，而 pinconfig 则使用 pinctrl_map_configs</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">pinctrl_map_type</span> <span class="title">type</span>;</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *ctrl_dev_name;  <span class="comment">// 所属的 pinctrl_dev 的 name</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map_mux</span> <span class="title">mux</span>;</span> <span class="comment">// 当 type 为 PIN_MAP_TYPE_MUX_GROUP 则使用这个</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map_configs</span> <span class="title">configs</span>;</span> <span class="comment">// 当 type为 IN_MAP_TYPE_CONFIGS_PIN、PIN_MAP_TYPE_CONFIGS_GROUP 使用这个</span></span><br><span class="line">    &#125; data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map_mux</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *group;       <span class="comment">//具体用到的group，例如：i2c0 有 &quot;i2c0_grp1&quot;、&quot;i2c0_grp1&quot;,如果使用 &quot;i2c0_grp1&quot; 这组，则 group = &quot;i2c0_grp1&quot;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *function;    <span class="comment">//要用到的复用功能，例如: i2c0、i2c1、spi1 等</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map_configs</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *group_or_pin; <span class="comment">// 该 pin 或者pin group的名字</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *configs;   <span class="comment">// 要设置的 pinconfig 数组首地址</span></span><br><span class="line">    <span class="keyword">unsigned</span> num_configs;     <span class="comment">// 数组大小</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="二、mtk-平台寄存器的表示方式"><a href="#二、mtk-平台寄存器的表示方式" class="headerlink" title="二、mtk 平台寄存器的表示方式"></a>二、mtk 平台寄存器的表示方式</h2><p>如下图所示，mtk 平台的寄存器在内核中的数据组织方式如下所示：</p>
<p><img src="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/linux%E9%A9%B1%E5%8A%A8/pinctrl%E5%AD%90%E7%B3%BB%E7%BB%9F/mtk%E5%B9%B3%E5%8F%B0pin%E8%84%9A%E5%AF%84%E5%AD%98%E5%99%A8%E8%A1%A8%E7%A4%BA.png?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1622682822;86400000001622600000&q-key-time=1622682822;86400000001622600000&q-header-list=&q-url-param-list=&q-signature=8050114349f3348de91b2edb09e72d1d84cfbb58" alt="mtk 平台寄存器的表示方式"></p>
<h2 id="三、pinctrl-子系统的系统框架"><a href="#三、pinctrl-子系统的系统框架" class="headerlink" title="三、pinctrl 子系统的系统框架"></a>三、pinctrl 子系统的系统框架</h2><h3 id="1、框架接口"><a href="#1、框架接口" class="headerlink" title="1、框架接口"></a>1、框架接口</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;pinctrl 子系统提供的服务并不复杂，主要提供了以下两个服务，向驱动工程师提供操作 pin 的接口也就是具体的设备要使用的接口，向 bsp 工程师提供对应的寄存器操作的接口。</p>
<img src="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/linux%E9%A9%B1%E5%8A%A8/pinctrl%E5%AD%90%E7%B3%BB%E7%BB%9F/pinctrl%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%A1%86%E6%9E%B6.png?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1622712744;86400000001622640000&q-key-time=1622712744;86400000001622640000&q-header-list=&q-url-param-list=&q-signature=4c7485bd86a798d58e70091a2a2453f819fffda1" width="75%" height="75%" alt="pinctrl 子系统的系统框架">

<h3 id="2、内部实现"><a href="#2、内部实现" class="headerlink" title="2、内部实现"></a>2、内部实现</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;pinctrl 子系统提供的服务接口很简单，但它的内部实现还是有点复杂的。内核驱动都是基于设备模型来开发的，因此对引脚的操作都是基于设备来讲的。对于一个设备首先要做的就是配置其需要使用到的软硬件资源，当然其中就包括 pin 脚资源。而 pinctrl 子系统则需要解析处理我们配置的 pin 脚资源。当我们配置设备的引脚资源后 pinctrl 会在合适的时机来解析我们配置的引脚资源，什么时机是最合适的呢，显而易见设备和驱动匹配的时候。因为设备资源最终的使用者是驱动，当驱动匹配到设备的时候也就是要使用该资源的时候。当完成对资源的解析，我们只需要调用简单的接口就能使我们的设备上的 pin 脚处于我们需要的状态。</p>
<h4 id="1-配置设备的引脚资源"><a href="#1-配置设备的引脚资源" class="headerlink" title="1) 配置设备的引脚资源"></a>1) 配置设备的引脚资源</h4><p>&nbsp;&nbsp;&nbsp;&nbsp; 配置引脚资源有两种方式首先是使用设备树，这也是目前主流的方式。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">lcm_dev: lcm &#123;</span><br><span class="line">    pinctrl-names = <span class="string">&quot;lcm_1v8_en_low&quot;</span> , <span class="string">&quot;lcm_1v8_en_high&quot;</span>; <span class="comment">//对应的 pinctrl_state 的 name</span></span><br><span class="line"></span><br><span class="line">    pinctrl<span class="number">-0</span> = &lt;&amp;gpio_lcm_pwr1v8_low&gt;;  <span class="comment">//----这是一个 pinctrl_state</span></span><br><span class="line">    pinctrl<span class="number">-1</span> = &lt;&amp;gpio_lcm_pwr1v8_high&gt;; <span class="comment">//----这是一个 pinctrl_state</span></span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&amp;pio &#123; </span><br><span class="line"></span><br><span class="line">    gpio_lcm_pwr1v8_low: gpio_lcm_pwr1v8_low &#123; <span class="comment">//----这是一组 pinctrl_map </span></span><br><span class="line">        pins_cmd_dat &#123;</span><br><span class="line">            pinmux = &lt;PINMUX_GPIO5__FUNC_GPIO5&gt;; <span class="comment">//这被解析 pinctrl_map-&gt;data-&gt;mux</span></span><br><span class="line">            slew-rate = &lt;<span class="number">1</span>&gt;;           <span class="comment">//这两个被解析到pinctrl_map-&gt;data-&gt;configs   </span></span><br><span class="line">            output-low;                          </span><br><span class="line">        &#125;;  <span class="comment">//于是这里将创建有 2 个 pinctrl_map 的数组</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    gpio_lcm_pwr1v8_high: gpio_lcm_pwr1v8_high &#123; <span class="comment">//----这是一组 pinctrl_map </span></span><br><span class="line">        pins_cmd_dat &#123;</span><br><span class="line">            pinmux = &lt;PINMUX_GPIO5__FUNC_GPIO5&gt;; <span class="comment">//这被解析到 pinctrl_map-&gt;data-&gt;mux</span></span><br><span class="line">            output-high;                         <span class="comment">//这被解析到 pinctrl_map-&gt;data-&gt;configs</span></span><br><span class="line">        &#125;; <span class="comment">// 于是这里将创建有 2 个 pinctrl_map 的数组</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述 lcm 配置了两个 state ，他们分别是”lcm_1v8_en_low” 和 “lcm_1v8_en_high”.</p>
<h4 id="2-解析设备引脚资源的时机"><a href="#2-解析设备引脚资源的时机" class="headerlink" title="2) 解析设备引脚资源的时机"></a>2) 解析设备引脚资源的时机</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;当设备和驱动匹配的时候在 really_probe 函数中会调用 pinctrl_bind_pins 来解析并创建属于该设备的 pinctrl，匹配流程可以参考<a target="_blank" rel="noopener" href="https://baron-z.cn/2021/01/03/linux%E9%A9%B1%E5%8A%A8-%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9E%8B-%E9%87%8D%E6%9E%84/#more">linux设备模型</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">really_probe</span><span class="params">(struct device *dev, struct device_driver *drv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ....</span><br><span class="line">    <span class="comment">/* If using pinctrl, bind pins now before probing */</span></span><br><span class="line">    ret = pinctrl_bind_pins(dev);</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>来看看这个函数做了什么</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pinctrl_bind_pins</span><span class="params">(struct device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    dev-&gt;pins = devm_kzalloc(dev, <span class="keyword">sizeof</span>(*(dev-&gt;pins)), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!dev-&gt;pins)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析 pin 脚信息并返回 pinctrl</span></span><br><span class="line">    dev-&gt;pins-&gt;p = devm_pinctrl_get(dev);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(dev-&gt;pins-&gt;p)) &#123;</span><br><span class="line">        dev_dbg(dev, <span class="string">&quot;no pinctrl handle\n&quot;</span>);</span><br><span class="line">        ret = PTR_ERR(dev-&gt;pins-&gt;p);</span><br><span class="line">        <span class="keyword">goto</span> cleanup_alloc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回 default 的 sate</span></span><br><span class="line">    dev-&gt;pins-&gt;default_state = pinctrl_lookup_state(dev-&gt;pins-&gt;p,</span><br><span class="line">                    PINCTRL_STATE_DEFAULT);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(dev-&gt;pins-&gt;default_state)) &#123;</span><br><span class="line">        dev_dbg(dev, <span class="string">&quot;no default pinctrl state\n&quot;</span>);</span><br><span class="line">        ret = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> cleanup_get;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查找 init 的 state 如果不存在则设置为 default 否则设置为 init</span></span><br><span class="line">    dev-&gt;pins-&gt;init_state = pinctrl_lookup_state(dev-&gt;pins-&gt;p,</span><br><span class="line">                    PINCTRL_STATE_INIT);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(dev-&gt;pins-&gt;init_state)) &#123;</span><br><span class="line">        <span class="comment">/* Not supplying this state is perfectly legal */</span></span><br><span class="line">        dev_dbg(dev, <span class="string">&quot;no init pinctrl state\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ret = pinctrl_select_state(dev-&gt;pins-&gt;p,</span><br><span class="line">                       dev-&gt;pins-&gt;default_state);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ret = pinctrl_select_state(dev-&gt;pins-&gt;p, dev-&gt;pins-&gt;init_state);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        dev_dbg(dev, <span class="string">&quot;failed to activate initial pinctrl state\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> cleanup_get;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PM</span></span><br><span class="line">    <span class="comment">//查找 sleep 的 state</span></span><br><span class="line">    dev-&gt;pins-&gt;sleep_state = pinctrl_lookup_state(dev-&gt;pins-&gt;p,</span><br><span class="line">                    PINCTRL_STATE_SLEEP);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(dev-&gt;pins-&gt;sleep_state))</span><br><span class="line">        <span class="comment">/* Not supplying this state is perfectly legal */</span></span><br><span class="line">        dev_dbg(dev, <span class="string">&quot;no sleep pinctrl state\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查找 sleep 的 state</span></span><br><span class="line">    dev-&gt;pins-&gt;idle_state = pinctrl_lookup_state(dev-&gt;pins-&gt;p,</span><br><span class="line">                    PINCTRL_STATE_IDLE);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(dev-&gt;pins-&gt;idle_state))</span><br><span class="line">        <span class="comment">/* Not supplying this state is perfectly legal */</span></span><br><span class="line">        dev_dbg(dev, <span class="string">&quot;no idle pinctrl state\n&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">cleanup_get:</span><br><span class="line">    devm_pinctrl_put(dev-&gt;pins-&gt;p);</span><br><span class="line">cleanup_alloc:</span><br><span class="line">    devm_kfree(dev, dev-&gt;pins);</span><br><span class="line">    dev-&gt;pins = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Only return deferrals */</span></span><br><span class="line">    <span class="keyword">if</span> (ret != -EPROBE_DEFER)</span><br><span class="line">        ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数解析 pin 脚信息并返回 pinctrl ，获取 default 以及其他默认state，这些state 在 include/linux/pinctrl/pinctrl-state.h 中提供</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINCTRL_STATE_DEFAULT <span class="meta-string">&quot;default&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINCTRL_STATE_INIT <span class="meta-string">&quot;init&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINCTRL_STATE_IDLE <span class="meta-string">&quot;idle&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINCTRL_STATE_SLEEP <span class="meta-string">&quot;sleep&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>在 default 之后查找 init 的 state 如果不存在则设置为 default ，从代码也可以看出如果没有 default 也不会去获取后面的 state ，因此<font color=red>如果需要使用到 init、idle、sleep 这三个 state 必须配置 default state</font>。由于解析过程涉及的函数比较多因此先给出内部数据结构的组织结构方便理解。</p>
<img src="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/linux%E9%A9%B1%E5%8A%A8/pinctrl%E5%AD%90%E7%B3%BB%E7%BB%9F/%E8%AE%BE%E5%A4%87%20pinctr%20%E7%9A%84%E5%86%85%E9%83%A8%E6%95%B0%E6%8D%AE%E7%BB%84%E7%BB%87%E7%BB%93%E6%9E%84.png?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1622778256;86400000001622700000&q-key-time=1622778256;86400000001622700000&q-header-list=&q-url-param-list=&q-signature=da4eb2c74bc03c747b997c052e507548c1aada8e" width="100%" height="100%" alt="设备 pinctr 的内部数据组织结构">

<p>可以从数据结构中看出涉及到两个关键的数据 pinctrl_map 和 pinctrl_setting， 这两个数据结构是直接连接到外部的 pinmux 信息和 pinconfig 信息。</p>
<h4 id="3-pinctrl-解析设备引脚资源"><a href="#3-pinctrl-解析设备引脚资源" class="headerlink" title="3) pinctrl 解析设备引脚资源"></a>3) pinctrl 解析设备引脚资源</h4><p>解析过程如下图所示</p>
<img src="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/linux%E9%A9%B1%E5%8A%A8/pinctrl%E5%AD%90%E7%B3%BB%E7%BB%9F/pin_state%E8%A7%A3%E6%9E%90%E6%B5%81%E7%A8%8B.png?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1623235951;86400000001623150000&q-key-time=1623235951;86400000001623150000&q-header-list=&q-url-param-list=&q-signature=bf31a7976aeadcc08a17b2740d6c73d5da2b9331" width="100%" height="100%" alt="设备树 pin_state 解析流程">

<h4 id="4-源码分析"><a href="#4-源码分析" class="headerlink" title="4) 源码分析"></a>4) 源码分析</h4><p>涉及到的代码相对比较多就不去排版了，每个函数都有注释可以作为一个手册阅读。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 在 pinctrl_list 链表中查找属于本设备的 pinctrl</span></span><br><span class="line"><span class="comment">// 2. 如果不存在则注册一个 pinctrl</span></span><br><span class="line"><span class="function">struct pinctrl *<span class="title">pinctrl_get</span><span class="params">(struct device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl</span> *<span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (WARN_ON(!dev))</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 pinctrl 被注册则,直接返回该 pinctrl</span></span><br><span class="line">    p = find_pinctrl(dev);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        dev_dbg(dev, <span class="string">&quot;obtain a copy of previously claimed pinctrl\n&quot;</span>);</span><br><span class="line">        kref_get(&amp;p-&gt;users);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建 pinctrl</span></span><br><span class="line">    <span class="keyword">return</span> create_pinctrl(dev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 pinctrl_list 链表中查找属于本设备的 pinctrl</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct pinctrl *<span class="title">find_pinctrl</span><span class="params">(struct device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl</span> *<span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line">    mutex_lock(&amp;pinctrl_list_mutex);</span><br><span class="line">    list_for_each_entry(p, &amp;pinctrl_list, node)</span><br><span class="line">        <span class="keyword">if</span> (p-&gt;dev == dev) &#123;</span><br><span class="line">            mutex_unlock(&amp;pinctrl_list_mutex);</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    mutex_unlock(&amp;pinctrl_list_mutex);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct pinctrl *<span class="title">create_pinctrl</span><span class="params">(struct device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl</span> *<span class="title">p</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *devname;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_maps</span> *<span class="title">maps_node</span>;</span> <span class="comment">//map索引</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map</span> <span class="title">const</span> *<span class="title">map</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建并初始化 pinctrl -------------------------- part 1</span></span><br><span class="line">    p = kzalloc(<span class="keyword">sizeof</span>(*p), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        dev_err(dev, <span class="string">&quot;failed to alloc struct pinctrl\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p-&gt;dev = dev; <span class="comment">//初始化所属的dev</span></span><br><span class="line">    INIT_LIST_HEAD(&amp;p-&gt;states); <span class="comment">//初始化 states 链表</span></span><br><span class="line">    INIT_LIST_HEAD(&amp;p-&gt;dt_maps); <span class="comment">//初始化 dt_maps链表</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将该设备 dts 中的 pin state 转化为 pinctrl_map ------------------- part 2</span></span><br><span class="line">    ret = pinctrl_dt_to_map(p);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        kfree(p);</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(ret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    devname = dev_name(dev);</span><br><span class="line"></span><br><span class="line">    mutex_lock(&amp;pinctrl_maps_mutex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对于 maps_node 中的每一组属于该设备的 map 调用 add_setting，将对应的 pinctrl_map 转换为 pinctrl_setting ------ patr 3</span></span><br><span class="line">    for_each_maps(maps_node, i, <span class="built_in">map</span>) &#123;</span><br><span class="line">        <span class="comment">/* Map must be for this device */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(<span class="built_in">map</span>-&gt;dev_name, devname))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">    </span><br><span class="line">        ret = add_setting(p, <span class="built_in">map</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (ret == -EPROBE_DEFER) &#123;</span><br><span class="line">            pinctrl_free(p, <span class="literal">false</span>);</span><br><span class="line">            mutex_unlock(&amp;pinctrl_maps_mutex);</span><br><span class="line">            <span class="keyword">return</span> ERR_PTR(ret);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutex_unlock(&amp;pinctrl_maps_mutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* If some other error than deferral occured, return here */</span></span><br><span class="line">        pinctrl_free(p, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(ret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kref_init(&amp;p-&gt;users);</span><br><span class="line"></span><br><span class="line">    mutex_lock(&amp;pinctrl_list_mutex);</span><br><span class="line">    <span class="comment">//将 pinctrl 加入到全局链表 pinctrl_list</span></span><br><span class="line">    list_add_tail(&amp;p-&gt;node, &amp;pinctrl_list);</span><br><span class="line">    mutex_unlock(&amp;pinctrl_list_mutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>其实整个解析过程也是分为三步、<strong>part1</strong>-创建本设备的 pinctrl、<strong>part2</strong>-将 dts 转化为对应的 pinctrl_map、<strong>part3</strong>-最后是将 pinctrl_map 转换为pinctrl_setting</p>
</blockquote>
<h5 id="a-创建-pinctrl-map"><a href="#a-创建-pinctrl-map" class="headerlink" title="a. 创建 pinctrl_map"></a>a. 创建 pinctrl_map</h5><h6 id="pinctrl-dt-to-map"><a href="#pinctrl-dt-to-map" class="headerlink" title="pinctrl_dt_to_map"></a>pinctrl_dt_to_map</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 从state = 0 开始，递增判断 pinctrl 所属的设备的的设备树节点是否存在 pinctrl-state ，不存在则直接返回</span></span><br><span class="line"><span class="comment">// 2. 如果存在则 state 作为 index 获取 pinctrl-names 属性的值 statename</span></span><br><span class="line"><span class="comment">// 3. 遍历 pinctrl-0 属性的值所表示的节点，在 pinctrldev_list 中查找属于该节点的父节点的 pinctrl_dev</span></span><br><span class="line"><span class="comment">//    然后调用 pctldev-&gt;desc-&gt;pctlops-&gt;dt_node_to_map(pctldev, np_config, &amp;map, &amp;num_maps); 函数, 创建出需要的  pinctrl_map </span></span><br><span class="line"><span class="comment">// 4. 进一步初始化 pinctrl_map</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pinctrl_dt_to_map</span><span class="params">(struct pinctrl *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np</span> =</span> p-&gt;dev-&gt;of_node; <span class="comment">//获取到 pinctrl 所属的设备的设备节点</span></span><br><span class="line">    <span class="keyword">int</span> state, ret;</span><br><span class="line">    <span class="keyword">char</span> *propname;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">property</span> *<span class="title">prop</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *statename;</span><br><span class="line">    <span class="keyword">const</span> __be32 *<span class="built_in">list</span>;</span><br><span class="line">    <span class="keyword">int</span> size, config;</span><br><span class="line">    phandle phandle;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np_config</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* CONFIG_OF enabled, p-&gt;dev not instantiated from DT */</span></span><br><span class="line">    <span class="keyword">if</span> (!np) &#123;</span><br><span class="line">        <span class="keyword">if</span> (of_have_populated_dt())</span><br><span class="line">            dev_dbg(p-&gt;dev,</span><br><span class="line">                <span class="string">&quot;no of_node; not parsing pinctrl DT\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    of_node_get(np); <span class="comment">// 增加节点引用计数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (state = <span class="number">0</span>; ; state++) &#123;</span><br><span class="line">        </span><br><span class="line">        propname = kasprintf(GFP_KERNEL, <span class="string">&quot;pinctrl-%d&quot;</span>, state);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 通过 propname 获得对应设备树中的属性，pinctrl-0 属性的值为设备节点的引用，即为 phandle 属性。</span></span><br><span class="line">        prop = of_find_property(np, propname, &amp;size);</span><br><span class="line">        kfree(propname);</span><br><span class="line">        <span class="keyword">if</span> (!prop)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="built_in">list</span> = prop-&gt;value;    <span class="comment">// 获取到属性值</span></span><br><span class="line">        size /= <span class="keyword">sizeof</span>(*<span class="built_in">list</span>); <span class="comment">// 获取属性值的个数，即上面dts中的 &lt;&amp;gpio_lcm_pwr1v8_low&gt; 的个数明显这里只有一个</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过 pinctrl-names, 获取对应的 state 的名字，一般情况下 state = 0 的名字为 default</span></span><br><span class="line">        <span class="comment">// 这里可以看出，pinctrl-names 属性的值，和 pinctrl-* 是一一对应的。</span></span><br><span class="line">        ret = of_property_read_string_index(np, <span class="string">&quot;pinctrl-names&quot;</span>, state, &amp;statename);</span><br><span class="line">   </span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">/* strlen(&quot;pinctrl-&quot;) == 8 */</span></span><br><span class="line">            statename = prop-&gt;name + <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (config = <span class="number">0</span>; config &lt; size; config++) &#123; <span class="comment">//</span></span><br><span class="line">           <span class="comment">//将属性值转化为 pandle，只是保证数据的大小端一致性</span></span><br><span class="line">            phandle = be32_to_cpup(<span class="built_in">list</span>++);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//通过 phandle 获取到其所在的设备节点 gpio_lcm_pwr1v8_low</span></span><br><span class="line">            np_config = of_find_node_by_phandle(phandle);</span><br><span class="line">            <span class="keyword">if</span> (!np_config) &#123;</span><br><span class="line">                dev_err(p-&gt;dev,</span><br><span class="line">                    <span class="string">&quot;prop %s index %i invalid phandle\n&quot;</span>,</span><br><span class="line">                    prop-&gt;name, config);</span><br><span class="line">                ret = -EINVAL;</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 在 pinctrldev_list 中查找属于 gpio_lcm_pwr1v8_low 所在节点根节点的中的 pinctrl_dev, </span></span><br><span class="line">            <span class="comment">// 然后调用 pctldev-&gt;desc-&gt;pctlops-&gt;dt_node_to_map(pctldev, np_config, &amp;map, &amp;num_maps); 函数, 创建出需要的 pinctrl_map</span></span><br><span class="line">            <span class="comment">// 进一步初始化 pinctrl_map ，创建 pinctrl_dt_map 初始化之后 将，dt_map 挂接到所属的 pinctrl</span></span><br><span class="line">            <span class="comment">// 检查 pinctrl_map 的合法性，动态创建一个 maps_node 初始化之后挂接到全局  pinctrl_maps</span></span><br><span class="line">            ret = dt_to_map_one_config(p, statename, np_config);</span><br><span class="line">            of_node_put(np_config);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err:</span><br><span class="line">    pinctrl_dt_free_maps(p);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="dt-to-map-one-config"><a href="#dt-to-map-one-config" class="headerlink" title="dt_to_map_one_config"></a>dt_to_map_one_config</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 pinctrldev_list 中查找属于 gpio_lcm_pwr1v8_low 所在节点根节点的中的 pinctrl_dev, </span></span><br><span class="line"><span class="comment">// 然后调用 pctldev-&gt;desc-&gt;pctlops-&gt;dt_node_to_map(pctldev, np_config, &amp;map, &amp;num_maps); 函数, 创建出需要的 pinctrl_map</span></span><br><span class="line"><span class="comment">// 进一步初始化 pinctrl_map ，创建 pinctrl_dt_map 初始化之后 将，dt_map 挂接到所属的 pinctrl</span></span><br><span class="line"><span class="comment">// 检查 pinctrl_map 的合法性，动态创建一个 maps_node 初始化之后挂接到全局  pinctrl_maps</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dt_to_map_one_config</span><span class="params">(struct pinctrl *p, <span class="keyword">const</span> <span class="keyword">char</span> *statename, struct device_node *np_config)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np_pctldev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_dev</span> *<span class="title">pctldev</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map</span> *<span class="title">map</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> num_maps;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  查找 pinctrl 的根节点 */</span></span><br><span class="line">    np_pctldev = of_node_get(np_config); <span class="comment">//增加节点引用计数</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//获取 np_pctldev 所在的设备节点的父节点，即pinctrl-0 指向的设备节点 gpio_lcm_pwr1v8_low 的父节点，即 pintrl 根节点</span></span><br><span class="line">        np_pctldev = of_get_next_parent(np_pctldev);</span><br><span class="line">        <span class="keyword">if</span> (!np_pctldev || of_node_is_root(np_pctldev)) &#123;</span><br><span class="line">            dev_info(p-&gt;dev, <span class="string">&quot;could not find pctldev for node %s, deferring probe\n&quot;</span>,</span><br><span class="line">                np_config-&gt;full_name);</span><br><span class="line">            of_node_put(np_pctldev);</span><br><span class="line">            <span class="comment">/* OK let&#x27;s just assume this will appear later then */</span></span><br><span class="line">            <span class="keyword">return</span> -EPROBE_DEFER;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取 pintrl 根节点的 pinctrl_dev</span></span><br><span class="line">        pctldev = get_pinctrl_dev_from_of_node(np_pctldev);</span><br><span class="line">        <span class="keyword">if</span> (pctldev) <span class="comment">//如果存在推出循环</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">/* 如果 pinctrl 所在的节点和 dts 中的 pinctrl 根节点相同则 error */</span></span><br><span class="line">        <span class="keyword">if</span> (np_pctldev == p-&gt;dev-&gt;of_node) &#123;</span><br><span class="line">            of_node_put(np_pctldev);</span><br><span class="line">            <span class="keyword">return</span> -ENODEV;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    of_node_put(np_pctldev); <span class="comment">//减少节点引用计数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取其 pinctrl_ops </span></span><br><span class="line">    ops = pctldev-&gt;desc-&gt;pctlops;</span><br><span class="line">    <span class="keyword">if</span> (!ops-&gt;dt_node_to_map) &#123;</span><br><span class="line">        dev_err(p-&gt;dev, <span class="string">&quot;pctldev %s doesn&#x27;t support DT\n&quot;</span>,</span><br><span class="line">            dev_name(pctldev-&gt;dev));</span><br><span class="line">        <span class="keyword">return</span> -ENODEV;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用 dt_node_to_map 函数， 对于 gpio_lcm_pwr1v8_low 的所有子节点调用 mtk_pctrl_dt_subnode_to_map</span></span><br><span class="line">    <span class="comment">// 从设备树中获取对应的配置，并创建对应的 pinctrl_map</span></span><br><span class="line">    ret = ops-&gt;dt_node_to_map(pctldev, np_config, &amp;<span class="built_in">map</span>, &amp;num_maps);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进一步初始化 pinctrl_map ，创建 pinctrl_dt_map 初始化之后 将，dt_map 挂接到所属的 pinctrl</span></span><br><span class="line">    <span class="comment">// 检查 pinctrl_map 的合法性，动态创建一个 maps_node 初始化之后挂接到全局  pinctrl_maps</span></span><br><span class="line">    <span class="keyword">return</span> dt_remember_or_free_map(p, statename, pctldev, <span class="built_in">map</span>, num_maps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来是 mtk 平台的处理过程</p>
<h6 id="mtk-pctrl-dt-node-to-map"><a href="#mtk-pctrl-dt-node-to-map" class="headerlink" title="mtk_pctrl_dt_node_to_map"></a>mtk_pctrl_dt_node_to_map</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//对于 np_config(就是前面的 gpio_lcm_pwr1v8_low)的所有子节点调用 mtk_pctrl_dt_subnode_to_map, 从设备树中获取对应的配置，并创建对应的 pinctrl_map</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mtk_pctrl_dt_node_to_map</span><span class="params">(struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">                 struct device_node *np_config,</span></span></span><br><span class="line"><span class="function"><span class="params">                 struct pinctrl_map **<span class="built_in">map</span>, <span class="keyword">unsigned</span> *num_maps)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> reserved_maps;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    *<span class="built_in">map</span> = <span class="literal">NULL</span>;</span><br><span class="line">    *num_maps = <span class="number">0</span>; <span class="comment">//表示 pinctrl_map 的数组下标</span></span><br><span class="line">    reserved_maps = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* </span></span><br><span class="line"><span class="comment">    * 对于 gpio_lcm_pwr1v8_low 的所有子节点调用 mtk_pctrl_dt_subnode_to_map,</span></span><br><span class="line"><span class="comment">    * 从设备树中获取对应的配置，并创建对应的 pinctrl_map</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    for_each_child_of_node(np_config, np) &#123;</span><br><span class="line">        ret = mtk_pctrl_dt_subnode_to_map(pctldev, np, <span class="built_in">map</span>,</span><br><span class="line">                &amp;reserved_maps, num_maps);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            pinctrl_utils_dt_free_map(pctldev, *<span class="built_in">map</span>, *num_maps);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="mtk-pctrl-dt-subnode-to-map"><a href="#mtk-pctrl-dt-subnode-to-map" class="headerlink" title="mtk_pctrl_dt_subnode_to_map"></a>mtk_pctrl_dt_subnode_to_map</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//从设备树中获取对应的配置，并创建对应的 pinctrl_map</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mtk_pctrl_dt_subnode_to_map</span><span class="params">(struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">                      struct device_node *node,</span></span></span><br><span class="line"><span class="function"><span class="params">                      struct pinctrl_map **<span class="built_in">map</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">unsigned</span> *reserved_maps,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">unsigned</span> *num_maps)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">property</span> *<span class="title">pins</span>;</span></span><br><span class="line">    u32 pinfunc, pin, func;</span><br><span class="line">    <span class="keyword">int</span> num_pins, num_funcs, maps_per_pin;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *configs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> num_configs;</span><br><span class="line">    <span class="keyword">bool</span> has_config = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> i, err;</span><br><span class="line">    <span class="keyword">unsigned</span> reserve = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mtk_pinctrl_group</span> *<span class="title">grp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mtk_pinctrl</span> *<span class="title">pctl</span> =</span> pinctrl_dev_get_drvdata(pctldev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 pin 的属性，从这里可以知道 mtk 平台兼容两种 pin 属性的写法，</span></span><br><span class="line">    <span class="comment">// 一种是 pinmux，一种是 pins</span></span><br><span class="line">    pins = of_find_property(node, <span class="string">&quot;pinmux&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!pins) &#123;</span><br><span class="line">        pins = of_find_property(node, <span class="string">&quot;pins&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (!pins) &#123;</span><br><span class="line">        dev_err(pctl-&gt;dev, <span class="string">&quot;missing pins property in node %s .\n&quot;</span>,</span><br><span class="line">                node-&gt;name);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在设备节点查找 dt_params 以及 pctldev-&gt;desc-&gt;custom_params 中的支持的 pinconfig</span></span><br><span class="line">    <span class="comment">// 如果存在则按顺寻将 params 和 custom_params 可配置的 pinconfig 参数 pin_config_param </span></span><br><span class="line">    <span class="comment">// 以及配置的默认状态 default_value 组合后,存入 configs 指向的内存空间, 并返回 configs 的长度</span></span><br><span class="line">    err = pinconf_generic_parse_dt_config(node, pctldev, &amp;configs,</span><br><span class="line">        &amp;num_configs);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (num_configs)</span><br><span class="line">        has_config = <span class="number">1</span>; <span class="comment">//是否需要配置 configs</span></span><br><span class="line"></span><br><span class="line">    num_pins = pins-&gt;length / <span class="keyword">sizeof</span>(u32); <span class="comment">//获取 dts 配置的 pin 的数量</span></span><br><span class="line">    num_funcs = num_pins; <span class="comment">//计算出 func 的数量</span></span><br><span class="line">    maps_per_pin = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (num_funcs)</span><br><span class="line">        maps_per_pin++; <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (has_config &amp;&amp; num_pins &gt;= <span class="number">1</span>) <span class="comment">//如果有配置的 config 以及需要配置的 pin &gt;= 1</span></span><br><span class="line">        maps_per_pin++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!num_pins || !maps_per_pin) &#123;</span><br><span class="line">        err = -EINVAL;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reserve = num_pins * maps_per_pin; <span class="comment">//计算需要的 pinctrl_map 的数量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重新申请一片大小为 *num_maps + reserve 的内存空间，并将 map 的值复制过去，</span></span><br><span class="line">    <span class="comment">// reserved_maps 之后的内存空间初始化为 0, 同时更新 pinctrl_map 的数量 reserved_maps</span></span><br><span class="line">    <span class="comment">// num_maps 表示有效的 pinctrl_map 的数量</span></span><br><span class="line">    err = pinctrl_utils_reserve_map(pctldev, <span class="built_in">map</span>,</span><br><span class="line">            reserved_maps, num_maps, reserve);</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_pins; i++) &#123;</span><br><span class="line">        err = of_property_read_u32_index(node, <span class="string">&quot;pinmux&quot;</span>,</span><br><span class="line">                i, &amp;pinfunc);</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            err = of_property_read_u32_index(node, <span class="string">&quot;pins&quot;</span>,</span><br><span class="line">                i, &amp;pinfunc);</span><br><span class="line">            <span class="keyword">if</span> (err)</span><br><span class="line">                <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pin = MTK_GET_PIN_NO(pinfunc); <span class="comment">//获取配置的 pin 脚</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取该引脚对应的复用状态，复用状态在 include/dt-bindings/pinctrl/mt6771-pinfunc.h 文件中配置</span></span><br><span class="line">        func = MTK_GET_PIN_FUNC(pinfunc);  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pin &gt;= pctl-&gt;devdata-&gt;npins ||</span><br><span class="line">                func &gt;= ARRAY_SIZE(mtk_gpio_functions)) &#123;</span><br><span class="line">            dev_err(pctl-&gt;dev, <span class="string">&quot;invalid pins value.\n&quot;</span>);</span><br><span class="line">            err = -EINVAL;</span><br><span class="line">            <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回该 pin 所对应的 group</span></span><br><span class="line">        grp = mtk_pctrl_find_group_by_pin(pctl, pin);</span><br><span class="line">        <span class="keyword">if</span> (!grp) &#123;</span><br><span class="line">            dev_err(pctl-&gt;dev, <span class="string">&quot;unable to match pin %d to group\n&quot;</span>,</span><br><span class="line">                    pin);</span><br><span class="line">            err = -EINVAL;</span><br><span class="line">            <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 初始化 pinctrl_map 的 type 为 PIN_MAP_TYPE_MUX_GROUP，</span></span><br><span class="line">        <span class="comment">// 初始化 data.mux.group 为 grp-&gt;name;</span></span><br><span class="line">        <span class="comment">// 初始化 ata.mux.function 为 mtk_gpio_functions[fnum];</span></span><br><span class="line">        err = mtk_pctrl_dt_node_to_map_func(pctl, pin, func, grp, <span class="built_in">map</span>,</span><br><span class="line">                reserved_maps, num_maps);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果有 config 则设置 config 对应的 pinctrl_map，</span></span><br><span class="line">        <span class="comment">//因此 poinconfig 是对该节点的所有 pin 生效</span></span><br><span class="line">        <span class="keyword">if</span> (has_config) &#123; </span><br><span class="line">            err = pinctrl_utils_add_map_configs(pctldev, <span class="built_in">map</span>,</span><br><span class="line">                    reserved_maps, num_maps, grp-&gt;name,</span><br><span class="line">                    configs, num_configs,</span><br><span class="line">                    PIN_MAP_TYPE_CONFIGS_GROUP);</span><br><span class="line">            <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span>:</span><br><span class="line">    kfree(configs);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MTK_PIN_NO(x) ((x) &lt;&lt; 8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MTK_GET_PIN_NO(x) ((x) &gt;&gt; 8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MTK_GET_PIN_FUNC(x) ((x) &amp; 0xf)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINMUX_GPIO0__FUNC_GPIO0 (MTK_PIN_NO(0) | 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINMUX_GPIO0__FUNC_MRG_SYNC (MTK_PIN_NO(0) | 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINMUX_GPIO0__FUNC_PCM0_SYNC (MTK_PIN_NO(0) | 2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINMUX_GPIO0__FUNC_TP_GPIO0_AO (MTK_PIN_NO(0) | 3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINMUX_GPIO0__FUNC_SRCLKENAI0 (MTK_PIN_NO(0) | 4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINMUX_GPIO0__FUNC_SCP_SPI2_CS (MTK_PIN_NO(0) | 5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINMUX_GPIO0__FUNC_I2S3_MCK (MTK_PIN_NO(0) | 6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINMUX_GPIO0__FUNC_SPI2_CSB (MTK_PIN_NO(0) | 7)</span></span><br></pre></td></tr></table></figure>
<h6 id="mtk-pctrl-dt-node-to-map-func"><a href="#mtk-pctrl-dt-node-to-map-func" class="headerlink" title="mtk_pctrl_dt_node_to_map_func"></a>mtk_pctrl_dt_node_to_map_func</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化 pinctrl_map 的 type 为 PIN_MAP_TYPE_MUX_GROUP，</span></span><br><span class="line"><span class="comment">// 初始化 data.mux.group 为 grp-&gt;name;</span></span><br><span class="line"><span class="comment">// 初始化 ata.mux.function 为 mtk_gpio_functions[fnum];</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mtk_pctrl_dt_node_to_map_func</span><span class="params">(struct mtk_pinctrl *pctl,</span></span></span><br><span class="line"><span class="function"><span class="params">        u32 pin, u32 fnum, struct mtk_pinctrl_group *grp,</span></span></span><br><span class="line"><span class="function"><span class="params">        struct pinctrl_map **<span class="built_in">map</span>, <span class="keyword">unsigned</span> *reserved_maps,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">unsigned</span> *num_maps)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">bool</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*num_maps == *reserved_maps)</span><br><span class="line">        <span class="keyword">return</span> -ENOSPC;</span><br><span class="line"></span><br><span class="line">    (*<span class="built_in">map</span>)[*num_maps].type = PIN_MAP_TYPE_MUX_GROUP; <span class="comment">// 初始化 pinctrl_map 的 type</span></span><br><span class="line">    (*<span class="built_in">map</span>)[*num_maps].data.mux.group = grp-&gt;name; <span class="comment">//初始化 data.mux.group</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//该 pin 的引脚复用 fnum 有效性检查</span></span><br><span class="line">    ret = mtk_pctrl_is_function_valid(pctl, pin, fnum);</span><br><span class="line">    <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">        dev_err(pctl-&gt;dev, <span class="string">&quot;invalid function %d on pin %d .\n&quot;</span>,</span><br><span class="line">                fnum, pin);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化对应 pin 脚复用的函数名</span></span><br><span class="line">    (*<span class="built_in">map</span>)[*num_maps].data.mux.function = mtk_gpio_functions[fnum];</span><br><span class="line">    (*num_maps)++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="mtk-pctrl-is-function-valid"><a href="#mtk-pctrl-is-function-valid" class="headerlink" title="mtk_pctrl_is_function_valid"></a>mtk_pctrl_is_function_valid</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该 pin_num 的引脚复用 fnum 有效性检查</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">mtk_pctrl_is_function_valid</span><span class="params">(struct mtk_pinctrl *pctl,</span></span></span><br><span class="line"><span class="function"><span class="params">        u32 pin_num, u32 fnum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pctl-&gt;devdata-&gt;npins; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">mtk_desc_pin</span> *<span class="title">pin</span> =</span> pctl-&gt;devdata-&gt;pins + i;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pin-&gt;pin.number == pin_num) &#123; 找到该 pin 对应的 mtk_desc_pin</span><br><span class="line">            <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">mtk_desc_function</span> *<span class="title">func</span> =</span></span><br><span class="line">                    pin-&gt;functions; <span class="comment">//获取到对应的 functions</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (func &amp;&amp; func-&gt;name) &#123; <span class="comment">//查找对应的 functions 是否有对应的引脚复用 fnum</span></span><br><span class="line">                <span class="keyword">if</span> (func-&gt;muxval == fnum) </span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                func++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mtk_desc_function</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> muxval;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mtk_desc_pin</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_pin_desc</span> <span class="title">pin</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MTK_EINT_MULTI_TRIGGER_DESIGN</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mtk_desc_eint</span> <span class="title">eint</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">mtk_desc_eint</span> <span class="title">eint</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">mtk_desc_function</span>  *<span class="title">functions</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mtk_desc_function</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> muxval;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="pinctrl-utils-add-map-configs"><a href="#pinctrl-utils-add-map-configs" class="headerlink" title="pinctrl_utils_add_map_configs"></a>pinctrl_utils_add_map_configs</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//删除多余内存空间</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pinctrl_utils_add_map_configs</span><span class="params">(struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">        struct pinctrl_map **<span class="built_in">map</span>, <span class="keyword">unsigned</span> *reserved_maps,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">unsigned</span> *num_maps, <span class="keyword">const</span> <span class="keyword">char</span> *group,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">unsigned</span> <span class="keyword">long</span> *configs, <span class="keyword">unsigned</span> num_configs,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">enum</span> pinctrl_map_type type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *dup_configs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (WARN_ON(*num_maps == *reserved_maps)) <span class="comment">//防止数组越界</span></span><br><span class="line">        <span class="keyword">return</span> -ENOSPC;</span><br><span class="line"></span><br><span class="line">    dup_configs = kmemdup(configs, num_configs * <span class="keyword">sizeof</span>(*dup_configs),</span><br><span class="line">                  GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!dup_configs) &#123;</span><br><span class="line">        dev_err(pctldev-&gt;dev, <span class="string">&quot;kmemdup(configs) failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    (*<span class="built_in">map</span>)[*num_maps].type = type;</span><br><span class="line">    (*<span class="built_in">map</span>)[*num_maps].data.configs.group_or_pin = group;</span><br><span class="line">    (*<span class="built_in">map</span>)[*num_maps].data.configs.configs = dup_configs;</span><br><span class="line">    (*<span class="built_in">map</span>)[*num_maps].data.configs.num_configs = num_configs;</span><br><span class="line">    (*num_maps)++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="pinconf-generic-parse-dt-config"><a href="#pinconf-generic-parse-dt-config" class="headerlink" title="pinconf_generic_parse_dt_config"></a>pinconf_generic_parse_dt_config</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在设备节点 device_node 查找 dt_params 以及 pctldev-&gt;desc-&gt;custom_params 中的支持的引脚状态</span></span><br><span class="line"><span class="comment">// 如果存在则按顺寻将 params 和 custom_params 可配置的引脚状态参数 pin_config_param </span></span><br><span class="line"><span class="comment">// 以及配置的默认状态 default_value 组合后,存入 configs 指向的内存空间, 并返回 configs 的长度nconfigs</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pinconf_generic_parse_dt_config</span><span class="params">(struct device_node *np,</span></span></span><br><span class="line"><span class="function"><span class="params">                    struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">unsigned</span> <span class="keyword">long</span> **configs,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">unsigned</span> <span class="keyword">int</span> *nconfigs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *cfg;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> max_cfg, ncfg = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!np)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* allocate a temporary array big enough to hold one of each option */</span></span><br><span class="line">    <span class="comment">//获取 dt_params 的中 config 的数量</span></span><br><span class="line">    max_cfg = ARRAY_SIZE(dt_params);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pctldev) </span><br><span class="line">        max_cfg += pctldev-&gt;desc-&gt;num_custom_params;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每个 config 都由 unsigned long 表示，申请 max_cfg 个 unsigned long</span></span><br><span class="line">    cfg = kcalloc(max_cfg, <span class="keyword">sizeof</span>(*cfg), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!cfg)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 查询设备节点 np 中存在的  params[] 数组中的属性，</span></span><br><span class="line">   <span class="comment">// 如果存在则按顺寻将该 params 可配置的引脚状态参数 pin_config_param </span></span><br><span class="line">   <span class="comment">// 以及配置的默认状态 default_value 组合后,存入 cfg 指向的内存空间, ncfg 表示 cfg 的长度</span></span><br><span class="line">    parse_dt_cfg(np, dt_params, ARRAY_SIZE(dt_params), cfg, &amp;ncfg);</span><br><span class="line">    <span class="keyword">if</span> (pctldev &amp;&amp; pctldev-&gt;desc-&gt;num_custom_params &amp;&amp; pctldev-&gt;desc-&gt;custom_params)</span><br><span class="line">        <span class="comment">//如果存在 custom_params 则同样查询该节点存在的属性，并返回其值</span></span><br><span class="line">        parse_dt_cfg(np, pctldev-&gt;desc-&gt;custom_params,</span><br><span class="line">                 pctldev-&gt;desc-&gt;num_custom_params, cfg, &amp;ncfg);</span><br><span class="line"></span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//没有 configs 则推出</span></span><br><span class="line">    <span class="keyword">if</span> (ncfg == <span class="number">0</span>) &#123;</span><br><span class="line">        *configs = <span class="literal">NULL</span>;</span><br><span class="line">        *nconfigs = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//为了节省内存空间，这里将值复制到 configs 之后释放掉 cfg 所占的多余的内存空间</span></span><br><span class="line">    *configs = kmemdup(cfg, ncfg * <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">long</span>), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!*configs) &#123;</span><br><span class="line">        ret = -ENOMEM;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *nconfigs = ncfg;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">    kfree(cfg);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinconf_generic_params</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> property;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">pin_config_param</span> <span class="title">param</span>;</span></span><br><span class="line">    u32 default_value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//文件中定义的全局变量，表示支持的引脚状态</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinconf_generic_params</span> <span class="title">dt_params</span>[] =</span> &#123;</span><br><span class="line">    <span class="comment">// bias-bus-hold 属性名，在设备树中使用该名字，</span></span><br><span class="line">    <span class="comment">// PIN_CONFIG_BIAS_BUS_HOLD 引脚的状态，</span></span><br><span class="line">    <span class="comment">// 0 引脚状态的值</span></span><br><span class="line">    &#123; <span class="string">&quot;bias-bus-hold&quot;</span>, PIN_CONFIG_BIAS_BUS_HOLD, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;bias-disable&quot;</span>, PIN_CONFIG_BIAS_DISABLE, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;bias-high-impedance&quot;</span>, PIN_CONFIG_BIAS_HIGH_IMPEDANCE, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;bias-pull-up&quot;</span>, PIN_CONFIG_BIAS_PULL_UP, <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;bias-pull-pin-default&quot;</span>, PIN_CONFIG_BIAS_PULL_PIN_DEFAULT, <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;bias-pull-down&quot;</span>, PIN_CONFIG_BIAS_PULL_DOWN, <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;drive-open-drain&quot;</span>, PIN_CONFIG_DRIVE_OPEN_DRAIN, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;drive-open-source&quot;</span>, PIN_CONFIG_DRIVE_OPEN_SOURCE, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;drive-push-pull&quot;</span>, PIN_CONFIG_DRIVE_PUSH_PULL, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;drive-strength&quot;</span>, PIN_CONFIG_DRIVE_STRENGTH, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;input-debounce&quot;</span>, PIN_CONFIG_INPUT_DEBOUNCE, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;input-disable&quot;</span>, PIN_CONFIG_INPUT_ENABLE, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;input-enable&quot;</span>, PIN_CONFIG_INPUT_ENABLE, <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;input-schmitt&quot;</span>, PIN_CONFIG_INPUT_SCHMITT, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;input-schmitt-disable&quot;</span>, PIN_CONFIG_INPUT_SCHMITT_ENABLE, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;input-schmitt-enable&quot;</span>, PIN_CONFIG_INPUT_SCHMITT_ENABLE, <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;low-power-disable&quot;</span>, PIN_CONFIG_LOW_POWER_MODE, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;low-power-enable&quot;</span>, PIN_CONFIG_LOW_POWER_MODE, <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;output-high&quot;</span>, PIN_CONFIG_OUTPUT, <span class="number">1</span>, &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;output-low&quot;</span>, PIN_CONFIG_OUTPUT, <span class="number">0</span>, &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;power-source&quot;</span>, PIN_CONFIG_POWER_SOURCE, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;slew-rate&quot;</span>, PIN_CONFIG_SLEW_RATE, <span class="number">0</span> &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="parse-dt-cfg"><a href="#parse-dt-cfg" class="headerlink" title="parse_dt_cfg"></a>parse_dt_cfg</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询设备节点np中存在的  params[count] 数组中的属性，</span></span><br><span class="line"><span class="comment">// 如果存在则按顺寻将该 params 可配置的引脚状态参数 pin_config_param </span></span><br><span class="line"><span class="comment">// 以及配置的默认状态 default_value 组合后,存入 cfg 指向的内存空间, 之后 ncfg 等于 cfg 数组长度</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parse_dt_cfg</span><span class="params">(struct device_node *np, <span class="keyword">const</span> struct pinconf_generic_params *params, <span class="keyword">unsigned</span> <span class="keyword">int</span> count, <span class="keyword">unsigned</span> <span class="keyword">long</span> *cfg, <span class="keyword">unsigned</span> <span class="keyword">int</span> *ncfg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        u32 val;</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line">        <span class="comment">//获取 params 中的 pinconf_generic_params</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinconf_generic_params</span> *<span class="title">par</span> =</span> &amp;params[i];</span><br><span class="line"></span><br><span class="line">        <span class="comment">//从np节点中查询是存在该属性</span></span><br><span class="line">        ret = of_property_read_u32(np, par-&gt;property, &amp;val);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果不存在结束本次循环</span></span><br><span class="line">        <span class="comment">/* property not found */</span></span><br><span class="line">        <span class="keyword">if</span> (ret == -EINVAL)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* use default value, when no value is specified */</span></span><br><span class="line">        <span class="comment">//如果存在这个属性则获取这个default属性的值</span></span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">            val = par-&gt;default_value;</span><br><span class="line"></span><br><span class="line">        pr_debug(<span class="string">&quot;found %s with value %u\n&quot;</span>, par-&gt;property, val);</span><br><span class="line">        <span class="comment">//将该params可配置的引脚状态参数 pin_config_param 以及配置的默认状态组合后写入到cfg所在的内存空间。</span></span><br><span class="line">        cfg[*ncfg] = pinconf_to_config_packed(par-&gt;param, val);</span><br><span class="line">        (*ncfg)++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">pinconf_to_config_packed</span><span class="params">(<span class="keyword">enum</span> pin_config_param param,</span></span></span><br><span class="line"><span class="function"><span class="params">                             u16 argument)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PIN_CONF_PACKED(param, argument);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIN_CONF_PACKED(p, a) ((a &lt;&lt; 16) | ((unsigned long) p &amp; 0xffffUL))</span></span><br></pre></td></tr></table></figure>
<h6 id="pinctrl-utils-reserve-map"><a href="#pinctrl-utils-reserve-map" class="headerlink" title="pinctrl_utils_reserve_map"></a>pinctrl_utils_reserve_map</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重新申请一片大小为 *num_maps + reserve 的内存空间，并将 map 的值复制过去，</span></span><br><span class="line"><span class="comment">// reserved_maps 之后的内存空间初始化为 0, 同时更新 pinctrl_map 的数量 reserved_maps</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pinctrl_utils_reserve_map</span><span class="params">(struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">        struct pinctrl_map **<span class="built_in">map</span>, <span class="keyword">unsigned</span> *reserved_maps,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">unsigned</span> *num_maps, <span class="keyword">unsigned</span> reserve)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> old_num = *reserved_maps; <span class="comment">// 0</span></span><br><span class="line">    <span class="keyword">unsigned</span> new_num = *num_maps + reserve; <span class="comment">// </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map</span> *<span class="title">new_map</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (old_num &gt;= new_num)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    new_map = krealloc(*<span class="built_in">map</span>, <span class="keyword">sizeof</span>(*new_map) * new_num, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!new_map) &#123;</span><br><span class="line">        dev_err(pctldev-&gt;dev, <span class="string">&quot;krealloc(map) failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(new_map + old_num, <span class="number">0</span>, (new_num - old_num) * <span class="keyword">sizeof</span>(*new_map));</span><br><span class="line"></span><br><span class="line">    *<span class="built_in">map</span> = new_map;</span><br><span class="line">    *reserved_maps = new_num;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="mtk-pctrl-find-group-by-pin"><a href="#mtk-pctrl-find-group-by-pin" class="headerlink" title="mtk_pctrl_find_group_by_pin"></a>mtk_pctrl_find_group_by_pin</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//返回该 pin 脚所在的 group，mtk平台每一个 pin 就是一个 group</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct mtk_pinctrl_group * <span class="title">mtk_pctrl_find_group_by_pin</span><span class="params">(struct mtk_pinctrl *pctl, u32 pin)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pctl-&gt;ngroups; i++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">mtk_pinctrl_group</span> *<span class="title">grp</span> =</span> pctl-&gt;groups + i;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (grp-&gt;pin == pin)</span><br><span class="line">            <span class="keyword">return</span> grp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mtk_pinctrl_group</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>  *name;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>   config;</span><br><span class="line">    <span class="keyword">unsigned</span>    pin;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h6 id="dt-remember-or-free-map"><a href="#dt-remember-or-free-map" class="headerlink" title="dt_remember_or_free_map"></a>dt_remember_or_free_map</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//进一步初始化 pinctrl_map, 并创建对应的 pinctrl_dt_map 映射</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dt_remember_or_free_map</span><span class="params">(struct pinctrl *p, <span class="keyword">const</span> <span class="keyword">char</span> *statename,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct pinctrl_map *<span class="built_in">map</span>, <span class="keyword">unsigned</span> num_maps)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_dt_map</span> *<span class="title">dt_map</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化 dev_name 这个很重要，转化为 pinctrl_settings 时这个作为判断条件</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_maps; i++) &#123;</span><br><span class="line">        <span class="built_in">map</span>[i].dev_name = dev_name(p-&gt;dev); <span class="comment">//初始化 pinctrl_map 所属的 pinctrl 的 dev_name</span></span><br><span class="line">        <span class="built_in">map</span>[i].name = statename; <span class="comment">//初始化 name</span></span><br><span class="line">        <span class="keyword">if</span> (pctldev)</span><br><span class="line">            <span class="built_in">map</span>[i].ctrl_dev_name = dev_name(pctldev-&gt;dev); <span class="comment">//设置所属的 pinctrl_dev 的 name</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建 pinctrl_dt_map</span></span><br><span class="line">    dt_map = kzalloc(<span class="keyword">sizeof</span>(*dt_map), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!dt_map) &#123;</span><br><span class="line">        dev_err(p-&gt;dev, <span class="string">&quot;failed to alloc struct pinctrl_dt_map\n&quot;</span>);</span><br><span class="line">        dt_free_map(pctldev, <span class="built_in">map</span>, num_maps);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 pinctrl_dt_map </span></span><br><span class="line">    dt_map-&gt;pctldev = pctldev; </span><br><span class="line">    dt_map-&gt;<span class="built_in">map</span> = <span class="built_in">map</span>;</span><br><span class="line">    dt_map-&gt;num_maps = num_maps;</span><br><span class="line">    list_add_tail(&amp;dt_map-&gt;node, &amp;p-&gt;dt_maps); <span class="comment">//将 dt_map 挂接到所属的 pinctrl</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pinctrl_register_map(<span class="built_in">map</span>, num_maps, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="pinctrl-register-map"><a href="#pinctrl-register-map" class="headerlink" title="pinctrl_register_map"></a>pinctrl_register_map</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pinctrl_register_map</span><span class="params">(struct pinctrl_map <span class="keyword">const</span> *maps, <span class="keyword">unsigned</span> num_maps,</span></span></span><br><span class="line"><span class="function"><span class="params">             <span class="keyword">bool</span> dup)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_maps</span> *<span class="title">maps_node</span>;</span></span><br><span class="line"></span><br><span class="line">    pr_debug(<span class="string">&quot;add %u pinctrl maps\n&quot;</span>, num_maps);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//首先检测 map 的合法性</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_maps; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!maps[i].dev_name) &#123; <span class="comment">//每一个 map 都要有所属的设备</span></span><br><span class="line">            pr_err(<span class="string">&quot;failed to register map %s (%d): no device given\n&quot;</span>,</span><br><span class="line">                   maps[i].name, i);</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!maps[i].name) &#123; <span class="comment">//每一个 map 都要有对应的 state</span></span><br><span class="line">            pr_err(<span class="string">&quot;failed to register map %d: no map name given\n&quot;</span>,</span><br><span class="line">                   i);</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//当 map 的类型不为 PIN_MAP_TYPE_DUMMY_STAT ，map 必须要有所属的 pinctl_dev</span></span><br><span class="line">        <span class="keyword">if</span> (maps[i].type != PIN_MAP_TYPE_DUMMY_STATE &amp;&amp;</span><br><span class="line">                !maps[i].ctrl_dev_name) &#123; E</span><br><span class="line">            pr_err(<span class="string">&quot;failed to register map %s (%d): no pin control device given\n&quot;</span>,</span><br><span class="line">                   maps[i].name, i);</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (maps[i].type) &#123;</span><br><span class="line">        <span class="keyword">case</span> PIN_MAP_TYPE_DUMMY_STATE:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> PIN_MAP_TYPE_MUX_GROUP:</span><br><span class="line">            ret = pinmux_validate_map(&amp;maps[i], i); <span class="comment">//检查 map-&gt;data.mux.function 是否存在</span></span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> PIN_MAP_TYPE_CONFIGS_PIN:</span><br><span class="line">        <span class="keyword">case</span> PIN_MAP_TYPE_CONFIGS_GROUP:</span><br><span class="line">            ret = pinconf_validate_map(&amp;maps[i], i);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            pr_err(<span class="string">&quot;failed to register map %s (%d): invalid type given\n&quot;</span>,</span><br><span class="line">                   maps[i].name, i);</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//动态创建一个 maps_node 用于挂接 pinctrl_maps</span></span><br><span class="line">    maps_node = kzalloc(<span class="keyword">sizeof</span>(*maps_node), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!maps_node) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;failed to alloc struct pinctrl_maps\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    maps_node-&gt;num_maps = num_maps; </span><br><span class="line">    <span class="keyword">if</span> (dup) &#123;</span><br><span class="line">        maps_node-&gt;maps = kmemdup(maps, <span class="keyword">sizeof</span>(*maps) * num_maps,</span><br><span class="line">                      GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (!maps_node-&gt;maps) &#123;</span><br><span class="line">            pr_err(<span class="string">&quot;failed to duplicate mapping table\n&quot;</span>);</span><br><span class="line">            kfree(maps_node);</span><br><span class="line">            <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        maps_node-&gt;maps = maps; <span class="comment">//跑这里</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutex_lock(&amp;pinctrl_maps_mutex);</span><br><span class="line">    list_add_tail(&amp;maps_node-&gt;node, &amp;pinctrl_maps); <span class="comment">//将 maps_node 链接到全局 pinctrl_maps</span></span><br><span class="line">    mutex_unlock(&amp;pinctrl_maps_mutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="b-将pinctrl-map转化为pinctrl-setting"><a href="#b-将pinctrl-map转化为pinctrl-setting" class="headerlink" title="b. 将pinctrl_map转化为pinctrl_setting"></a>b. 将pinctrl_map转化为pinctrl_setting</h5><h6 id="add-setting"><a href="#add-setting" class="headerlink" title="add_setting"></a>add_setting</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">add_setting</span><span class="params">(struct pinctrl *p, struct pinctrl_map <span class="keyword">const</span> *<span class="built_in">map</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_setting</span> *<span class="title">setting</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取对应的 state</span></span><br><span class="line">    state = find_state(p, <span class="built_in">map</span>-&gt;name);</span><br><span class="line">    <span class="keyword">if</span> (!state) <span class="comment">// 如果没有 state 则创建</span></span><br><span class="line">        state = create_state(p, <span class="built_in">map</span>-&gt;name);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(state))</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(state);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">map</span>-&gt;type == PIN_MAP_TYPE_DUMMY_STATE)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个 pinctrl_setting</span></span><br><span class="line">    setting = kzalloc(<span class="keyword">sizeof</span>(*setting), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (setting == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        dev_err(p-&gt;dev,</span><br><span class="line">            <span class="string">&quot;failed to alloc struct pinctrl_setting\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 type</span></span><br><span class="line">    setting-&gt;type = <span class="built_in">map</span>-&gt;type;</span><br><span class="line"></span><br><span class="line">    setting-&gt;pctldev = get_pinctrl_dev_from_devname(<span class="built_in">map</span>-&gt;ctrl_dev_name);</span><br><span class="line">    <span class="keyword">if</span> (setting-&gt;pctldev == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        kfree(setting);</span><br><span class="line">        <span class="comment">/* Do not defer probing of hogs (circular loop) */</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(<span class="built_in">map</span>-&gt;ctrl_dev_name, <span class="built_in">map</span>-&gt;dev_name))</span><br><span class="line">            <span class="keyword">return</span> -ENODEV;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * OK let us guess that the driver is not there yet, and</span></span><br><span class="line"><span class="comment">         * let&#x27;s defer obtaining this pinctrl handle to later...</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        dev_info(p-&gt;dev, <span class="string">&quot;unknown pinctrl device %s in map entry, deferring probe&quot;</span>,</span><br><span class="line">            <span class="built_in">map</span>-&gt;ctrl_dev_name);</span><br><span class="line">        <span class="keyword">return</span> -EPROBE_DEFER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setting-&gt;dev_name = <span class="built_in">map</span>-&gt;dev_name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (<span class="built_in">map</span>-&gt;type) &#123;</span><br><span class="line">    <span class="keyword">case</span> PIN_MAP_TYPE_MUX_GROUP:</span><br><span class="line">        <span class="comment">//转化引脚复用</span></span><br><span class="line">        ret = pinmux_map_to_setting(<span class="built_in">map</span>, setting);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> PIN_MAP_TYPE_CONFIGS_PIN:</span><br><span class="line">    <span class="keyword">case</span> PIN_MAP_TYPE_CONFIGS_GROUP:</span><br><span class="line">        <span class="comment">//转化pinconfig</span></span><br><span class="line">        ret = pinconf_map_to_setting(<span class="built_in">map</span>, setting);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        ret = -EINVAL;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        kfree(setting);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    list_add_tail(&amp;setting-&gt;node, &amp;state-&gt;settings);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="create-state"><a href="#create-state" class="headerlink" title="create_state"></a>create_state</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct pinctrl_state *<span class="title">create_state</span><span class="params">(struct pinctrl *p,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">state</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建一个 state</span></span><br><span class="line">    state = kzalloc(<span class="keyword">sizeof</span>(*state), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (state == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        dev_err(p-&gt;dev,</span><br><span class="line">            <span class="string">&quot;failed to alloc struct pinctrl_state\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    state-&gt;name = name; <span class="comment">//初始化 name</span></span><br><span class="line">    INIT_LIST_HEAD(&amp;state-&gt;settings);</span><br><span class="line"></span><br><span class="line">    list_add_tail(&amp;state-&gt;node, &amp;p-&gt;states); <span class="comment">//将其挂接到所属 pinctl 的states</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="pinmux-map-to-setting"><a href="#pinmux-map-to-setting" class="headerlink" title="pinmux_map_to_setting"></a>pinmux_map_to_setting</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pinmux_map_to_setting</span><span class="params">(struct pinctrl_map <span class="keyword">const</span> *<span class="built_in">map</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              struct pinctrl_setting *setting)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_dev</span> *<span class="title">pctldev</span> =</span> setting-&gt;pctldev;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinmux_ops</span> *<span class="title">pmxops</span> =</span> pctldev-&gt;desc-&gt;pmxops;</span><br><span class="line">    <span class="keyword">char</span> <span class="keyword">const</span> * <span class="keyword">const</span> *groups;</span><br><span class="line">    <span class="keyword">unsigned</span> num_groups;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *group;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pmxops) &#123;</span><br><span class="line">        dev_err(pctldev-&gt;dev, <span class="string">&quot;does not support mux function\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回 function所在数据结构的数组下标</span></span><br><span class="line">    ret = pinmux_func_name_to_selector(pctldev, <span class="built_in">map</span>-&gt;data.mux.function);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        dev_err(pctldev-&gt;dev, <span class="string">&quot;invalid function %s in map table\n&quot;</span>,</span><br><span class="line">            <span class="built_in">map</span>-&gt;data.mux.function);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将其赋值给对应的 setting</span></span><br><span class="line">    setting-&gt;data.mux.func = ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回当前  function 结构中支持的 groups</span></span><br><span class="line">    ret = pmxops-&gt;get_function_groups(pctldev, setting-&gt;data.mux.func, &amp;groups, &amp;num_groups);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        dev_err(pctldev-&gt;dev, <span class="string">&quot;can&#x27;t query groups for function %s\n&quot;</span>,</span><br><span class="line">            <span class="built_in">map</span>-&gt;data.mux.function);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!num_groups) &#123;</span><br><span class="line">        dev_err(pctldev-&gt;dev,</span><br><span class="line">            <span class="string">&quot;function %s can&#x27;t be selected on any group\n&quot;</span>,</span><br><span class="line">            <span class="built_in">map</span>-&gt;data.mux.function);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">map</span>-&gt;data.mux.group) &#123;</span><br><span class="line">        <span class="keyword">bool</span> found = <span class="literal">false</span>;</span><br><span class="line">        group = <span class="built_in">map</span>-&gt;data.mux.group;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_groups; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(group, groups[i])) &#123; <span class="comment">//查看是否支持 data.mux.group</span></span><br><span class="line">                found = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">            dev_err(pctldev-&gt;dev,</span><br><span class="line">                <span class="string">&quot;invalid group \&quot;%s\&quot; for function \&quot;%s\&quot;\n&quot;</span>,</span><br><span class="line">                group, <span class="built_in">map</span>-&gt;data.mux.function);</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        group = groups[<span class="number">0</span>]; <span class="comment">//如果没有  map-&gt;data.mux.group 则使用 groups[0] 作为默认状态</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在所有的 group 中查找该 group 的下标，并用来初始化 map-&gt;data.mux.group</span></span><br><span class="line">    ret = pinctrl_get_group_selector(pctldev, group);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        dev_err(pctldev-&gt;dev, <span class="string">&quot;invalid group %s in map table\n&quot;</span>,</span><br><span class="line">            <span class="built_in">map</span>-&gt;data.mux.group);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    setting-&gt;data.mux.group = ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="pinmux-func-name-to-selector"><a href="#pinmux-func-name-to-selector" class="headerlink" title="pinmux_func_name_to_selector"></a>pinmux_func_name_to_selector</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">pinmux_func_name_to_selector</span><span class="params">(struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">const</span> <span class="keyword">char</span> *function)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinmux_ops</span> *<span class="title">ops</span> =</span> pctldev-&gt;desc-&gt;pmxops;</span><br><span class="line">    <span class="keyword">unsigned</span> nfuncs = ops-&gt;get_functions_count(pctldev); <span class="comment">//获取 functions 的数量</span></span><br><span class="line">    <span class="keyword">unsigned</span> selector = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回 function 所在数据结构的数组下标</span></span><br><span class="line">    <span class="keyword">while</span> (selector &lt; nfuncs) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *fname = ops-&gt;get_function_name(pctldev, selector); <span class="comment">//返回 selector 下标中的 func name</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(function, fname))</span><br><span class="line">            <span class="keyword">return</span> selector; <span class="comment">//返回数组下标</span></span><br><span class="line"></span><br><span class="line">        selector++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dev_err(pctldev-&gt;dev, <span class="string">&quot;function &#x27;%s&#x27; not supported\n&quot;</span>, function);</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="pinctrl-get-group-selector"><a href="#pinctrl-get-group-selector" class="headerlink" title="pinctrl_get_group_selector"></a>pinctrl_get_group_selector</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在所有的 group 中查找该 group 的下标</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pinctrl_get_group_selector</span><span class="params">(struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">const</span> <span class="keyword">char</span> *pin_group)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_ops</span> *<span class="title">pctlops</span> =</span> pctldev-&gt;desc-&gt;pctlops; </span><br><span class="line">    <span class="keyword">unsigned</span> ngroups = pctlops-&gt;get_groups_count(pctldev); <span class="comment">//返回 group 的大小</span></span><br><span class="line">    <span class="keyword">unsigned</span> group_selector = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (group_selector &lt; ngroups) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *gname = pctlops-&gt;get_group_name(pctldev,</span><br><span class="line">                                group_selector);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(gname, pin_group)) &#123; </span><br><span class="line">            dev_dbg(pctldev-&gt;dev,</span><br><span class="line">                <span class="string">&quot;found group selector %u for %s\n&quot;</span>,</span><br><span class="line">                group_selector,</span><br><span class="line">                pin_group);</span><br><span class="line">            <span class="keyword">return</span> group_selector;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        group_selector++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dev_err(pctldev-&gt;dev, <span class="string">&quot;does not have pin group %s\n&quot;</span>,</span><br><span class="line">        pin_group);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="pinconf-map-to-setting"><a href="#pinconf-map-to-setting" class="headerlink" title="pinconf_map_to_setting"></a>pinconf_map_to_setting</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//pinconf_map_to_setting 将 conifg 对应的 map 转化为setting</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pinconf_map_to_setting</span><span class="params">(struct pinctrl_map <span class="keyword">const</span> *<span class="built_in">map</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">              struct pinctrl_setting *setting)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_dev</span> *<span class="title">pctldev</span> =</span> setting-&gt;pctldev;</span><br><span class="line">    <span class="keyword">int</span> pin;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (setting-&gt;type) &#123;</span><br><span class="line">    <span class="keyword">case</span> PIN_MAP_TYPE_CONFIGS_PIN:</span><br><span class="line">        <span class="comment">// 对应的 pin 脚</span></span><br><span class="line">        pin = pin_get_from_name(pctldev,</span><br><span class="line">                    <span class="built_in">map</span>-&gt;data.configs.group_or_pin);</span><br><span class="line">        <span class="keyword">if</span> (pin &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            dev_err(pctldev-&gt;dev, <span class="string">&quot;could not map pin config for \&quot;%s\&quot;&quot;</span>,</span><br><span class="line">                <span class="built_in">map</span>-&gt;data.configs.group_or_pin);</span><br><span class="line">            <span class="keyword">return</span> pin;</span><br><span class="line">        &#125;</span><br><span class="line">        setting-&gt;data.configs.group_or_pin = pin;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> PIN_MAP_TYPE_CONFIGS_GROUP:</span><br><span class="line">        <span class="comment">//返回对应的 group 的下标</span></span><br><span class="line">        pin = pinctrl_get_group_selector(pctldev,</span><br><span class="line">                     <span class="built_in">map</span>-&gt;data.configs.group_or_pin);</span><br><span class="line">        <span class="keyword">if</span> (pin &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            dev_err(pctldev-&gt;dev, <span class="string">&quot;could not map group config for \&quot;%s\&quot;&quot;</span>,</span><br><span class="line">                <span class="built_in">map</span>-&gt;data.configs.group_or_pin);</span><br><span class="line">            <span class="keyword">return</span> pin;</span><br><span class="line">        &#125;</span><br><span class="line">        setting-&gt;data.configs.group_or_pin = pin;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//config 的数量</span></span><br><span class="line">    setting-&gt;data.configs.num_configs = <span class="built_in">map</span>-&gt;data.configs.num_configs;</span><br><span class="line">    <span class="comment">//config </span></span><br><span class="line">    setting-&gt;data.configs.configs = <span class="built_in">map</span>-&gt;data.configs.configs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="pin-get-from-name"><a href="#pin-get-from-name" class="headerlink" title="pin_get_from_name"></a>pin_get_from_name</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过 name 返回对应的 pin 脚</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pin_get_from_name</span><span class="params">(struct pinctrl_dev *pctldev, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> i, pin;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The pin number can be retrived from the pin controller descriptor */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pctldev-&gt;desc-&gt;npins; i++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pin_desc</span> *<span class="title">desc</span>;</span></span><br><span class="line"></span><br><span class="line">        pin = pctldev-&gt;desc-&gt;pins[i].number;</span><br><span class="line">        desc = pin_desc_get(pctldev, pin);</span><br><span class="line">        <span class="comment">/* Pin space may be sparse */</span></span><br><span class="line">        <span class="keyword">if</span> (desc &amp;&amp; !<span class="built_in">strcmp</span>(name, desc-&gt;name))</span><br><span class="line">            <span class="keyword">return</span> pin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="四、pinctrl-子系统的使用"><a href="#四、pinctrl-子系统的使用" class="headerlink" title="四、pinctrl 子系统的使用"></a>四、pinctrl 子系统的使用</h2><p>使用就比较简单了接口如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取当前设备的 pinctrl 句柄</span></span><br><span class="line"><span class="function">struct pinctrl *<span class="title">pinctrl_get</span><span class="params">(struct device *dev)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取我们需要设置的 state</span></span><br><span class="line"><span class="function">struct pinctrl_state *<span class="title">pinctrl_lookup_state</span><span class="params">(struct pinctrl *p, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置为对应的state</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pinctrl_select_state</span><span class="params">(struct pinctrl *p, struct pinctrl_state *state)</span></span>;</span><br></pre></td></tr></table></figure>
<p>mtk 平台可以参考这篇文章 <a target="_blank" rel="noopener" href="https://my.oschina.net/u/4323904/blog/3937409">mtk-GPIO设置与应用</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>braon-z
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://example.com/2021/06/11/linux%E9%A9%B1%E5%8A%A8-pinctrl/" title="pinctrl 子系统">https://example.com/2021/06/11/linux驱动-pinctrl/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E9%A9%B1%E5%8A%A8/" rel="tag"><i class="fa fa-tag"></i> 驱动</a>
              <a href="/tags/pinctrl/" rel="tag"><i class="fa fa-tag"></i> pinctrl</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/05/06/linux%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F%E9%87%8D%E6%9E%84/" rel="prev" title="linux驱动-input子系统">
                  <i class="fa fa-chevron-left"></i> linux驱动-input子系统
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/06/16/%E9%A1%B9%E7%9B%AE%E6%9D%82%E8%AE%B0/" rel="next" title="linux驱动-项目杂记">
                  linux驱动-项目杂记 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">braon-z</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">477k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">7:13</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/local-search.js"></script>






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"VsC1eQwQ4Xltm5eA9iYGp3VU-gzGzoHsz","appKey":"kyfyE4RWl6aIojedbxcuJa3V","serverURLs":null,"placeholder":"Just go go","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":false,"comment_count":true,"recordIP":false,"enableQQ":false,"requiredFields":[]}, {
      el: '#valine-comments',
      path: "/2021/06/11/linux%E9%A9%B1%E5%8A%A8-pinctrl/",
      serverURLs: "https://vsc1eqwq.api.lncldglobal.com"
    }));
  }, window.Valine);
});
</script>




  <script src="/js/activate-power-mode.min.js"></script>
  <script>
    POWERMODE.colorful = true;
    POWERMODE.shake = false;
    document.body.addEventListener('input', POWERMODE);
  </script>
<div class="moon-menu">
  <div class="moon-menu-items">
    
    <div class="moon-menu-item" onclick="back2bottom()">
      <i class='fa fa-chevron-down'></i>    </div>
    
    <div class="moon-menu-item" onclick="back2top()">
      <i class='fa fa-chevron-up'></i>    </div>
    
  </div>
  <div class="moon-menu-button">
    <svg class="moon-menu-bg">
      <circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle>
      <circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle>
    </svg>
    <div class="moon-menu-content">
      <div class="moon-menu-icon"><i class='fas fa-ellipsis-v'></i></div>
      <div class="moon-menu-text"></div>
    </div>
  </div>
</div><script src="/js/injector.js"></script>
</body>
</html>
