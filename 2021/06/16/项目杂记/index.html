<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":"ture","mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="用于记录项目中乱七八糟的东西，不定期更新，没有排版。">
<meta property="og:type" content="article">
<meta property="og:title" content="linux驱动-项目杂记">
<meta property="og:url" content="https://example.com/2021/06/16/%E9%A1%B9%E7%9B%AE%E6%9D%82%E8%AE%B0/index.html">
<meta property="og:site_name" content="braon-z&#39;s blog">
<meta property="og:description" content="用于记录项目中乱七八糟的东西，不定期更新，没有排版。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/linux%E9%A9%B1%E5%8A%A8/G90%E9%A1%B9%E7%9B%AE/sim.png?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1610763714;88010677314&q-key-time=1610763714;88010677314&q-header-list=&q-url-param-list=&q-signature=1da371ae29efdf84b431edf5f87f58b688f98308">
<meta property="og:image" content="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/linux%E9%A9%B1%E5%8A%A8/G90%E9%A1%B9%E7%9B%AE/pmic_sdcard_det_n.png?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1610765551;88010679151&q-key-time=1610765551;88010679151&q-header-list=&q-url-param-list=&q-signature=111ac4de6885b0162b548936698497afe9a03fa8">
<meta property="og:image" content="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/linux%E9%A9%B1%E5%8A%A8/G90%E9%A1%B9%E7%9B%AE/tfcard.png?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1610765022;88010678622&q-key-time=1610765022;88010678622&q-header-list=&q-url-param-list=&q-signature=d9ed65e258e6dbbbcad0bf533de040fbb6809cbd">
<meta property="article:published_time" content="2021-06-16T01:14:17.000Z">
<meta property="article:modified_time" content="2021-08-09T04:12:24.736Z">
<meta property="article:author" content="braon-z">
<meta property="article:tag" content="驱动">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/linux%E9%A9%B1%E5%8A%A8/G90%E9%A1%B9%E7%9B%AE/sim.png?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1610763714;88010677314&q-key-time=1610763714;88010677314&q-header-list=&q-url-param-list=&q-signature=1da371ae29efdf84b431edf5f87f58b688f98308">


<link rel="canonical" href="https://example.com/2021/06/16/%E9%A1%B9%E7%9B%AE%E6%9D%82%E8%AE%B0/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>linux驱动-项目杂记 | braon-z's blog</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">braon-z's blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81G90-mt67850-SIM%E5%8D%A1%E5%8A%9F%E8%83%BD"><span class="nav-text">一、G90(mt67850)-SIM卡功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E6%94%AF%E6%8C%81%E5%8F%8C%E5%8D%A1%EF%BC%8C%E9%85%8D%E7%BD%AEconfig%E6%96%87%E4%BB%B6"><span class="nav-text">1、支持双卡，配置config文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E9%85%8D%E7%BD%AEdct%E6%96%87%E4%BB%B6"><span class="nav-text">2、配置dct文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81tf%E5%8D%A1%E9%85%8D%E7%BD%AE"><span class="nav-text">二、tf卡配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%AD%E6%96%AD%E5%BC%95%E8%84%9A"><span class="nav-text">1、配置中断引脚</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E9%85%8D%E7%BD%AE%E4%B8%8B%E7%94%B5%E6%96%B9%E5%BC%8F"><span class="nav-text">2、配置下电方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81G90-mt6785-%E5%BF%AB%E5%85%85%E9%85%8D%E7%BD%AE"><span class="nav-text">三、G90(mt6785)-快充配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E5%BF%AB%E5%85%85%E8%AF%B4%E6%98%8E"><span class="nav-text">1、快充说明</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%85%85%E7%94%B5%E7%AD%96%E7%95%A5"><span class="nav-text">1) 充电策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%B8%A9%E5%BA%A6%E6%8E%A7%E5%88%B6%E5%85%85%E7%94%B5"><span class="nav-text">2) 温度控制充电</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%85%85%E7%94%B5%E6%A3%80%E6%B5%8B"><span class="nav-text">3) 充电检测</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E5%85%85%E7%94%B5%E6%8C%A1%E4%BD%8D%E6%94%AF%E6%8C%81"><span class="nav-text">4) 充电挡位支持</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%EF%BC%89-mtk-%E7%94%B5%E9%87%8F%E8%AE%A1%E7%AE%97%E6%B3%95"><span class="nav-text">5） mtk 电量计算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-%E7%9B%B8%E5%85%B3%E5%8F%82%E6%95%B0%E5%90%AB%E4%B9%89"><span class="nav-text">6) 相关参数含义</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E6%89%93%E5%BC%80dts%E4%B8%AD%E7%9A%84%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE"><span class="nav-text">2、打开dts中的相关配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81%E4%BF%AE%E6%94%B9-kernel-%E4%B8%8B%E7%9A%84-config-%E6%96%87%E4%BB%B6"><span class="nav-text">3、修改 kernel 下的 config 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81vendor-%E7%9B%AE%E5%BD%95%E4%B8%8B%E4%BF%AE%E6%94%B9lk%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">4、vendor 目录下修改lk配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5%E3%80%81mt6360-pd-%E5%BF%AB%E5%85%85%E5%8D%87%E5%8E%8B%E9%80%BB%E8%BE%91gm3-0"><span class="nav-text">5、mt6360 pd 快充升压逻辑gm3.0</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%8D%87%E5%8E%8B%E7%AE%97%E6%B3%95"><span class="nav-text">1) 升压算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%EF%BC%89%E6%9B%B4%E6%96%B0%E5%BD%93%E5%89%8D%E6%8C%A1%E4%BD%8D%E4%B8%8B%E7%9A%84%E5%8D%87%E5%8E%8B%E3%80%81%E9%99%8D%E5%8E%8B-idx"><span class="nav-text">2）更新当前挡位下的升压、降压 idx</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81G90-mt6785-%E5%8A%9F%E6%94%BE%E8%B0%83%E8%AF%95%E4%B9%8B%E6%8E%A7%E5%88%B6"><span class="nav-text">四、G90(mt6785)-功放调试之控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E8%80%B3%E6%9C%BA%E6%A3%80%E6%B5%8B%E4%BB%A3%E7%A0%81"><span class="nav-text">1、耳机检测代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E8%80%B3%E6%9C%BA%E6%9C%89%E5%A3%B0%E9%9F%B3%E5%8A%9F%E6%94%BE%E6%B2%A1%E5%A3%B0%E9%9F%B3"><span class="nav-text">2、耳机有声音功放没声音</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81%E5%96%87%E5%8F%AD%E5%B0%BE%E9%9F%B3"><span class="nav-text">3、喇叭尾音</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E8%80%B3%E6%9C%BA%E7%AB%8B%E4%BD%93%E5%A3%B0%E4%BF%AE%E6%94%B9"><span class="nav-text">四、耳机立体声修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81-%E6%89%93%E5%BC%80-ATCI"><span class="nav-text">4、 打开 ATCI</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81G90-mt6785-sensorhub"><span class="nav-text">三、G90(mt6785)-sensorhub</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E8%83%8C%E5%85%89%E8%83%BD%E8%B0%83%E5%88%B0%E9%BB%91%E5%B1%8F"><span class="nav-text">四、背光能调到黑屏</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E6%91%84%E5%83%8F%E5%A4%B4"><span class="nav-text">五、摄像头</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E6%91%84%E5%83%8F%E5%A4%B4%E5%BC%95%E8%84%9A"><span class="nav-text">1、摄像头引脚</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E6%91%84%E5%83%8F%E5%A4%B4%E5%8E%BB%E6%8E%89af"><span class="nav-text">2、摄像头去掉af</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81%E4%BF%AE%E6%94%B9%E6%91%84%E5%83%8F%E5%A4%B4%E6%96%B9%E5%90%91%E4%BB%A5%E5%8F%8Amipi%E9%80%9A%E9%81%93"><span class="nav-text">3、修改摄像头方向以及mipi通道</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81%E6%91%84%E5%83%8F%E5%A4%B4%E8%BF%9E%E4%B8%8D%E4%B8%8Acct"><span class="nav-text">4、摄像头连不上cct</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81adb-remount"><span class="nav-text">六、adb remount</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E5%AE%89%E5%8D%9311%E6%89%93%E5%BC%80%E4%B8%B2%E5%8F%A3log"><span class="nav-text">七、安卓11打开串口log</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AB%E3%80%81%E5%AE%89%E5%8D%93%E6%8C%89%E9%94%AE%E6%98%A0%E5%B0%84"><span class="nav-text">八、安卓按键映射</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%9D%E3%80%81mtk-%E5%B9%B3%E5%8F%B0%E5%8F%8D%E6%B1%87%E7%BC%96-dts"><span class="nav-text">九、mtk 平台反汇编 dts</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E3%80%81%E5%BF%AB%E9%80%9F%E6%89%93%E5%8C%85patch"><span class="nav-text">十、快速打包patch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E6%89%93%E5%BC%80mtklog"><span class="nav-text">十一、打开mtklog</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81%E7%BB%99sys%E8%8A%82%E7%82%B9%E6%9D%83%E9%99%90"><span class="nav-text">十二、给sys节点权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%B8%89%E3%80%81%E5%AE%89%E5%8D%9311%E7%BC%96%E8%AF%91%E7%9B%B8%E5%85%B3"><span class="nav-text">十三、安卓11编译相关</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81-Split-command-build-for-system-product"><span class="nav-text">1、 Split command build for system product</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%EF%BC%89Build-system-project"><span class="nav-text">1）Build system project</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%EF%BC%89Partial-build"><span class="nav-text">2）Partial build</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81Split-command-build-for-vendor-product"><span class="nav-text">2、Split command build for vendor product</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1%EF%BC%89Build-vendor-project"><span class="nav-text">1）Build vendor project</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-Partial-build"><span class="nav-text">2) Partial build</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81Image-post-process"><span class="nav-text">3、Image post process</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-Normal-load"><span class="nav-text">1) Normal load</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-Normal-OTA"><span class="nav-text">2) Normal + OTA</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-Normal-CTS"><span class="nav-text">3) Normal + CTS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-Normal-OTA-CTS"><span class="nav-text">4) Normal + OTA + CTS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5%EF%BC%89%E7%BC%96%E8%AF%91%E5%91%BD%E4%BB%A4"><span class="nav-text">5）编译命令</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E5%9B%9B%E3%80%81linux-%E6%9F%A5%E7%9C%8B%E5%86%85%E5%AD%98%E7%A9%BA%E9%97%B4"><span class="nav-text">十四、linux 查看内存空间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%BA%94%E3%80%81%E8%AE%BE%E7%BD%AE%E8%93%9D%E7%89%99%E5%BC%80%E6%9C%BA%E9%BB%98%E8%AE%A4%E7%8A%B6%E6%80%81"><span class="nav-text">十五、设置蓝牙开机默认状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E5%85%AD%E3%80%81%E5%BF%AB%E9%80%9F%E8%8E%B7%E5%8F%96%E8%AE%BE%E5%A4%87%E8%B7%AF%E5%BE%84"><span class="nav-text">十六、快速获取设备路径</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%B8%83%E3%80%81lk-%E9%98%B6%E6%AE%B5%E5%88%B0-kernel-%E9%98%B6%E6%AE%B5%E5%B1%8F%E5%B9%95%E4%BC%9A%E9%97%AA%E4%B8%80%E4%B8%8B"><span class="nav-text">十七、lk 阶段到 kernel 阶段屏幕会闪一下</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E5%85%AB%E3%80%81%E5%AE%89%E5%8D%93-11-%E5%85%B3%E9%97%AD-lib-%E5%BA%93%E6%A0%A1%E9%AA%8C"><span class="nav-text">十八、安卓 11 关闭 lib 库校验</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%B9%9D%E3%80%81%E5%AE%89%E5%8D%93-9-%E7%BC%96%E8%AF%91%E6%89%93%E5%8C%85-dtbo"><span class="nav-text">十九、安卓 9 编译打包 dtbo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E5%8D%81%E3%80%81mkt-pclk%E8%AE%A1%E7%AE%97"><span class="nav-text">二十、mkt pclk计算</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E5%8D%81%E4%B8%80%E3%80%81%E9%97%AA%E5%B1%8Fdebug"><span class="nav-text">二十一、闪屏debug</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E5%8D%81%E4%BA%8C%E3%80%81g-sensor-%E7%B3%BB%E7%BB%9F%E4%B8%8D%E8%BD%AC"><span class="nav-text">二十二、g-sensor 系统不转</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="braon-z"
      src="/images/wallhaven.jfif">
  <p class="site-author-name" itemprop="name">braon-z</p>
  <div class="site-description" itemprop="description"> 爱一个人，攀一座山，追一次梦<br>不妨大胆一点，有很多事没有答案</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/yourname" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yourname@gmail.com" title="E-Mail → mailto:yourname@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


<div style="">
  <canvas id="canvas" style="width:60%;">当前浏览器不支持canvas，请更换浏览器后再试</canvas>
</div>
<script>
(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //声明canvas的宽高
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //存储时间数据
    var data = [];
    //存储运动的小球
    var balls = [];
    //设置粒子半径
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //存储时间数字，由十位小时、个位小时、冒号、十位分钟、个位分钟、冒号、十位秒钟、个位秒钟这7个数字组成
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*生成点阵数字*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*更新时钟*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //时间发生变化
            if(NewData[i] !== data[i]){
                //将变化的数字值和在data数组中的索引存储在changeNumArray数组中
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //增加小球
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*更新小球状态*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*增加要运动的小球*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*渲染*/
    function render(){
        //重置画布宽度，达到清空画布的效果
        canvas.height = 100;
        //渲染时钟
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //渲染小球
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //更新时钟
        updateDigitTime();
        //更新小球状态
        updateBalls();
        //渲染
        render();
    },50);
}

})();
</script>
        </div>
      </div>
        <div class="back-to-top animated" role="button">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://example.com/2021/06/16/%E9%A1%B9%E7%9B%AE%E6%9D%82%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/wallhaven.jfif">
      <meta itemprop="name" content="braon-z">
      <meta itemprop="description" content=" 爱一个人，攀一座山，追一次梦<br>不妨大胆一点，有很多事没有答案">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="braon-z's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          linux驱动-项目杂记
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-06-16 09:14:17" itemprop="dateCreated datePublished" datetime="2021-06-16T09:14:17+08:00">2021-06-16</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-09 12:12:24" itemprop="dateModified" datetime="2021-08-09T12:12:24+08:00">2021-08-09</time>
      </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Valine：</span>
  
    <a title="valine" href="/2021/06/16/%E9%A1%B9%E7%9B%AE%E6%9D%82%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/06/16/%E9%A1%B9%E7%9B%AE%E6%9D%82%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>27k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>24 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>用于记录项目中乱七八糟的东西，不定期更新，没有排版。</p>
<a id="more"></a>

<h2 id="一、G90-mt67850-SIM卡功能"><a href="#一、G90-mt67850-SIM卡功能" class="headerlink" title="一、G90(mt67850)-SIM卡功能"></a>一、G90(mt67850)-SIM卡功能</h2><h3 id="1、支持双卡，配置config文件"><a href="#1、支持双卡，配置config文件" class="headerlink" title="1、支持双卡，配置config文件"></a>1、支持双卡，配置config文件</h3><p>路径：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/device/mediateksample/k85v1_64/ProjectConfig.mk</span><br></pre></td></tr></table></figure>
<p>修改参数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MTK_SIM1_SOCKET_TYPE = <span class="number">1</span></span><br><span class="line">MTK_SIM2_SOCKET_TYPE = <span class="number">1</span></span><br><span class="line">MTK_SIM_CARD_ONOFF = <span class="number">2</span></span><br><span class="line">MTK_SIM_HOT_SWAP = yes</span><br><span class="line">MTK_SIM_HOT_SWAP_COMMON_SLOT = no</span><br><span class="line">MTK_SIM_LOCK_POWER_ON_WRITE_PROTECT = no</span><br><span class="line">MTK_SIM_RECOVERY = yes</span><br><span class="line"></span><br><span class="line">MTK_MULTI_SIM_SUPPORT = dsds <span class="comment">//一般只需修改这个就好了，其他都是默认配好的，单卡配置成ss</span></span><br><span class="line"></span><br><span class="line">SIM_ME_LOCK_MODE = <span class="number">3</span></span><br><span class="line">SIM_REFRESH_RESET_BY_MODEM = yes</span><br><span class="line">MTK_EAP_SIM_AKA = yes</span><br><span class="line">MTK_EXTERNAL_SIM_ONLY_SLOTS = <span class="number">0</span></span><br><span class="line">MTK_EXTERNAL_SIM_SUPPORT = no</span><br></pre></td></tr></table></figure>
<h3 id="2、配置dct文件"><a href="#2、配置dct文件" class="headerlink" title="2、配置dct文件"></a>2、配置dct文件</h3><p>路径：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">\vendor\mediatek\proprietary\scripts\dct\DrvGen.exe <span class="comment">//dct配置工具</span></span><br><span class="line">\vendor\mediatek\proprietary\bootable\bootloader\lk\target\k85v1_64\dct\dct\codegen.dws <span class="comment">//lk下dct路径</span></span><br><span class="line">\vendor\mediatek\proprietary\bootable\bootloader\preloader\custom\k85v1_64\dct\dct\codegen.dws <span class="comment">//pl下dct路径</span></span><br><span class="line">\kernel<span class="number">-4.14</span>\drivers\misc\mediatek\dws\mt6785\codegen.dws  <span class="comment">//kernel下dct路径</span></span><br></pre></td></tr></table></figure>
<p>配置根据中断检测脚状态来配置</p>
<blockquote>
<p>如果插入sim卡为高电平拔出时为低电平则配置 PlugOutPolarity 为低电平<br>如果插入sim卡为低电平拔出时为高电平则配置 PlugOutPolarity 为高电平</p>
</blockquote>
<p>我的为第一种情况因此如下配置：<br><img src="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/linux%E9%A9%B1%E5%8A%A8/G90%E9%A1%B9%E7%9B%AE/sim.png?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1610763714;88010677314&q-key-time=1610763714;88010677314&q-header-list=&q-url-param-list=&q-signature=1da371ae29efdf84b431edf5f87f58b688f98308"></p>
<h2 id="二、tf卡配置"><a href="#二、tf卡配置" class="headerlink" title="二、tf卡配置"></a>二、tf卡配置</h2><h3 id="1、配置中断引脚"><a href="#1、配置中断引脚" class="headerlink" title="1、配置中断引脚"></a>1、配置中断引脚</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">路径： /arch/arm64/boot/dts/mediatek/cust_mt6785_msdc.dtsi</span><br><span class="line"></span><br><span class="line">具体修改： 原理图使用的 msdc1</span><br><span class="line"></span><br><span class="line">        host_function = /bits/ <span class="number">8</span> &lt;MSDC_SD&gt;;</span><br><span class="line"></span><br><span class="line">-       cd_level = /bits/ <span class="number">8</span> &lt;MSDC_CD_LOW&gt;;</span><br><span class="line">+       cd_level = /bits/ <span class="number">8</span> &lt;MSDC_CD_HIGH&gt;; <span class="comment">//由于插入tf卡中断检测脚为高这里修改为高电平触发</span></span><br><span class="line">        cd-gpios = &lt;&amp;pio <span class="number">8</span> <span class="number">0</span>&gt;;</span><br></pre></td></tr></table></figure>
<h3 id="2、配置下电方式"><a href="#2、配置下电方式" class="headerlink" title="2、配置下电方式"></a>2、配置下电方式</h3><p>mt6360 的 sdcard 的下电方式可以配置选择</p>
<p><img src="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/linux%E9%A9%B1%E5%8A%A8/G90%E9%A1%B9%E7%9B%AE/pmic_sdcard_det_n.png?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1610765551;88010679151&q-key-time=1610765551;88010679151&q-header-list=&q-url-param-list=&q-signature=111ac4de6885b0162b548936698497afe9a03fa8"></p>
<p>我的原理图长这样</p>
<p><img src="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/linux%E9%A9%B1%E5%8A%A8/G90%E9%A1%B9%E7%9B%AE/tfcard.png?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1610765022;88010678622&q-key-time=1610765022;88010678622&q-header-list=&q-url-param-list=&q-signature=d9ed65e258e6dbbbcad0bf533de040fbb6809cbd"></p>
<p>=-= 我的原理图插入 sd 卡之后，EINT_SD 会被拉高，由于它和 SD_CARD_DET_N_PMU 短接在一起的，因此 SD_CARD_DET_N_PMU 跟着被拉高了，于是满图上图第一种情况 active high，LD05 被拉低。。。。。，sd卡的供电就被拉低了，现象就是插上tf卡供电就掉下来 =w= 导致tf卡没功能。这种情况需要配置为上图的第二种状态 active low，配置如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">路径： drivers/misc/mediatek/pmic/mt6360/ldo/mt6360_ldo_i2c.c</span><br><span class="line">具体修改：</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">mt6360_ldo_platform_data</span> <span class="title">def_platform_data</span> =</span> &#123;</span><br><span class="line">-       .sdcard_det_en = <span class="literal">true</span>,</span><br><span class="line">+       .sdcard_det_en = <span class="literal">false</span>,</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<p>除此之外记得检测卡托，卡托和卡座一定要匹配，不匹配的卡托可能会在插入的过程中短路，导致 pmic 因为自身的保护机制直接关掉对应的 ldo5 引脚供电，这种情况和上面出现的现象是一样的。</p>
<h2 id="三、G90-mt6785-快充配置"><a href="#三、G90-mt6785-快充配置" class="headerlink" title="三、G90(mt6785)-快充配置"></a>三、G90(mt6785)-快充配置</h2><p>这款芯片是支持快充的，默认没有打开需要手动配置一下</p>
<h3 id="1、快充说明"><a href="#1、快充说明" class="headerlink" title="1、快充说明"></a>1、快充说明</h3><h4 id="1-充电策略"><a href="#1-充电策略" class="headerlink" title="1) 充电策略"></a>1) 充电策略</h4><blockquote>
<p>VAT在比较小的时候，转换效率很低：假设VBAT=3.4V,IBAT=3A,当VBUS=7.5V的时候，转换效率为82.7%，当VBUS=12V的时候，转换效率为80.51%，差了接近%2；而当VBAT比较高的时候，转换效率对电压就不会很敏感，在VBAT=4V的情况下，最低一档的转换效率都有86.94%，所以mtk的充电策略：在保证充电功率的情况下，转换效率尽可能的高</p>
</blockquote>
<h4 id="2-温度控制充电"><a href="#2-温度控制充电" class="headerlink" title="2) 温度控制充电"></a>2) 温度控制充电</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">max_charge_temp = &lt;<span class="number">50</span>&gt;; <span class="comment">//大于50°停止充电</span></span><br><span class="line">max_charge_temp_minux_x_degree = &lt;<span class="number">47</span>&gt;; <span class="comment">//从50°降低到47°之后，允许充电</span></span><br></pre></td></tr></table></figure>
<h4 id="3-充电检测"><a href="#3-充电检测" class="headerlink" title="3) 充电检测"></a>3) 充电检测</h4><p>手机插入充电线之后，会走一个充电器类型检测，这个检测流程软硬件都有参与，要满足最基本的 BC1.2 协议才会充电，协议规定几种接口，DCP,SDP,CDP都是5v，mtk 有类似的机制在 dual charger 进入 PE40 的时候，会判断当前点量来决定跑不跑 dual charger 快充，涉及 dts 里面</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pe40_stop_battery_soc,pd_stop_battery_sooc</span><br></pre></td></tr></table></figure>
<h4 id="4-充电挡位支持"><a href="#4-充电挡位支持" class="headerlink" title="4) 充电挡位支持"></a>4) 充电挡位支持</h4><p>PE快充可以支持三档7v、9v、12v，三选一，</p>
<p>当使用 switch_charger 时没有这种机制，在 85% 电量的时候插入充电器，它一样是跑 switch_charger, 和手机插着充电器从 0% 开始一直充电没有差别</p>
<h4 id="5）-mtk-电量计算法"><a href="#5）-mtk-电量计算法" class="headerlink" title="5） mtk 电量计算法"></a>5） mtk 电量计算法</h4><p>MTK的电量算法是由 driver 和上层的 daemon组成的，<br>电量变化时 Gauge 的硬件产生中断来通知 driver，<br>然后由 driver 将电量计算要用的值传到上层 daemon，<br>上层计算出的 SOC 会用您问题中的 CMD FG_DAEMON_CMD_SET_KERNEL_UISOC 再写到 kernel。</p>
<h4 id="6-相关参数含义"><a href="#6-相关参数含义" class="headerlink" title="6) 相关参数含义"></a>6) 相关参数含义</h4><p>ICHG = “設定的充電電流”,<br>AICR = “AICR 保護下允許的最高抽電流”<br>MIVR = “設定的允許的充電器最低電壓”<br>IEOC = “設定的截止充電電流”<br>CV = “設定的Constant Voltage 值”<br>VSYS = “量測到的 VSYS 值”<br>VBAT = “测量到的电池电压”<br>IBAT = “测量到的充电电流”<br>IBUS = “测量到充电器的电流”<br>VBUS = “测量到充电器的电压”<br>soc  = 底层电量百分比<br>uiso = 上层显示电量百分比<br>CT = 充电器类型</p>
<h3 id="2、打开dts中的相关配置"><a href="#2、打开dts中的相关配置" class="headerlink" title="2、打开dts中的相关配置"></a>2、打开dts中的相关配置</h3><p>具体修改：<br>/kernel-4.14/arch/arm64/boot/dts/mediatek/mt6785.dts b/arch/arm64/boot/dts/mediatek/mt6785.dts</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">        charger: charger &#123;</span><br><span class="line">                compatible = <span class="string">&quot;mediatek,charger&quot;</span>;</span><br><span class="line">                algorithm_name = <span class="string">&quot;SwitchCharging&quot;</span>;</span><br><span class="line"><span class="comment">//修改前</span></span><br><span class="line">-               <span class="comment">/* enable_sw_jeita; */</span></span><br><span class="line">-               <span class="comment">/* enable_pe_plus; */</span></span><br><span class="line">-               <span class="comment">/* enable_pe_2; */</span></span><br><span class="line">-               <span class="comment">/* enable_pe_3; */</span></span><br><span class="line">-               <span class="comment">/* enable_pe_4; */</span></span><br><span class="line"><span class="comment">//修改后               </span></span><br><span class="line">+               enable_sw_jeita;</span><br><span class="line">+               enable_pe_plus;</span><br><span class="line">+               enable_pe_2;</span><br><span class="line">+               enable_pe_3;</span><br><span class="line">+               enable_pe_4;</span><br><span class="line">               </span><br><span class="line">                enable_type_c;</span><br><span class="line">                power_path_support;</span><br><span class="line">                enable_dynamic_mivr;</span><br><span class="line">                <span class="comment">/* common */</span></span><br><span class="line">                battery_cv = &lt;<span class="number">4350000</span>&gt;; <span class="comment">//cv 电压，如果想提高快充时间可以适当调高，不过要考虑到电池耐压。</span></span><br><span class="line">                max_charger_voltage = &lt;<span class="number">6500000</span>&gt;;</span><br><span class="line">                min_charger_voltage = &lt;<span class="number">4600000</span>&gt;;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* dynamic mivr */</span></span><br><span class="line">                min_charger_voltage_1 = &lt;<span class="number">4400000</span>&gt;;</span><br><span class="line">                min_charger_voltage_2 = &lt;<span class="number">4200000</span>&gt;;</span><br><span class="line">                max_dmivr_charger_current = &lt;<span class="number">1400000</span>&gt;;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* charging current */</span></span><br><span class="line">                usb_charger_current_suspend = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">                usb_charger_current_unconfigured = &lt;<span class="number">70000</span>&gt;;</span><br><span class="line">                usb_charger_current_configured = &lt;<span class="number">500000</span>&gt;;</span><br><span class="line">                usb_charger_current = &lt;<span class="number">500000</span>&gt;;</span><br><span class="line">                ac_charger_current = &lt;<span class="number">2050000</span>&gt;; <span class="comment">// 普通充电的 ichg </span></span><br><span class="line">                ac_charger_input_current = &lt;<span class="number">2050000</span>&gt;; <span class="comment">// ibus</span></span><br><span class="line">                non_std_ac_charger_current = &lt;<span class="number">500000</span>&gt;;</span><br><span class="line">                charging_host_charger_current = &lt;<span class="number">1500000</span>&gt;;</span><br><span class="line">                apple_1_0a_charger_current = &lt;<span class="number">650000</span>&gt;;</span><br><span class="line">                apple_2_1a_charger_current = &lt;<span class="number">800000</span>&gt;;</span><br><span class="line">                ta_ac_charger_current = &lt;<span class="number">3000000</span>&gt;; <span class="comment">//快充的 ichg</span></span><br><span class="line"></span><br><span class="line">                ......</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* PD */</span></span><br><span class="line">                pd_vbus_low_bound = &lt;<span class="number">5000000</span>&gt;; <span class="comment">//支持的充电最低电压，pd-&gt;vbus_l</span></span><br><span class="line">                pd_vbus_upper_bound = &lt;<span class="number">9000000</span>&gt;; <span class="comment">//支持的充电最高电压,pd-&gt;vbus_h</span></span><br><span class="line">                pd_ichg_level_threshold = &lt;<span class="number">1000000</span>&gt;; <span class="comment">/* uA */</span></span><br><span class="line">                pd_stop_battery_soc = &lt;<span class="number">90</span>&gt;; <span class="comment">//停止快充电量，gm3 已经舍弃</span></span><br><span class="line"></span><br><span class="line">                ibus_err = &lt;<span class="number">14</span>&gt;;</span><br><span class="line">                vsys_watt = &lt;<span class="number">5000000</span>&gt;;</span><br></pre></td></tr></table></figure>
<p>kernel-4.14/arch/arm64/boot/dts/mediatek/bat_setting/mt6765_battery_prop.dtsi</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">bat_gm30: battery&#123;</span><br><span class="line">    compatible = <span class="string">&quot;mediatek,bat_gm30&quot;</span>;</span><br><span class="line">     ......</span><br><span class="line"><span class="comment">/*  The ui_soc will keep 100% until SOC drop X percents after unplugged*/</span></span><br><span class="line">    R_FG_VALUE = &lt;(<span class="number">10</span>)&gt;; <span class="comment">//rf 电阻用于测量充电流，需要校准</span></span><br><span class="line">    ......</span><br><span class="line">    ACTIVE_TABLE = &lt;(<span class="number">4</span>)&gt;; <span class="comment">//这里要注意一下，我们用到的电池参数table一般为四个</span></span><br><span class="line"><span class="comment">/* Table numbers per battery*/</span></span><br><span class="line">    MULTI_TEMP_GAUGE0 = &lt;(<span class="number">1</span>)&gt;;</span><br><span class="line"><span class="comment">/* Multi gauge0 enable*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mt6785_battery_table.dtsi&quot;</span> <span class="comment">// ACTIVE_TABLE 的值就是里面的参数的数组数量。</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;mt6785_battery_prop_dim2_ext.dtsi&quot;</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="3、修改-kernel-下的-config-文件"><a href="#3、修改-kernel-下的-config-文件" class="headerlink" title="3、修改 kernel 下的 config 文件"></a>3、修改 kernel 下的 config 文件</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/kernel<span class="number">-4.14</span>/arch/arm64/configs/k85v1_64_defconfig b/arch/arm64/configs/k85v1_64_defconfig</span><br><span class="line"></span><br><span class="line"> CONFIG_ACCDET_EINT_IRQ=y</span><br><span class="line"> CONFIG_ACCDET_SUPPORT_EINT0=y</span><br><span class="line"> CONFIG_MTK_LENS=y</span><br><span class="line"></span><br><span class="line"><span class="comment">//增加相关配置</span></span><br><span class="line">+CONFIG_MTK_PUMP_EXPRESS_PLUS_SUPPORT=y</span><br><span class="line">+CONFIG_MTK_PUMP_EXPRESS_PLUS_20_SUPPORT=y</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/device/mediateksample/k85v1_64/ProjectConfig.mk b/mediateksample/k85v1_64/ProjectConfig.mk</span><br><span class="line"></span><br><span class="line"> MTK_PROTOCOL2_RAT_CONFIG = L/W/G</span><br><span class="line"> MTK_PROTOCOL3_RAT_CONFIG = G</span><br><span class="line"></span><br><span class="line"><span class="comment">//修改前</span></span><br><span class="line">-MTK_PUMP_EXPRESS_PLUS_SUPPORT = no</span><br><span class="line">-MTK_PUMP_EXPRESS_PLUS_20_SUPPORT = no</span><br><span class="line"></span><br><span class="line"> MTK_PUMP_EXPRESS_PLUS_30_SUPPORT = no</span><br><span class="line"></span><br><span class="line"><span class="comment">//修改后</span></span><br><span class="line">+MTK_PUMP_EXPRESS_PLUS_20_SUPPORT = yes</span><br><span class="line">+MTK_PUMP_EXPRESS_PLUS_SUPPORT = yes</span><br><span class="line"></span><br><span class="line"> MTK_PUMP_EXPRESS_SUPPORT = no</span><br><span class="line"> MTK_RADIOOFF_POWER_OFF_MD = no</span><br><span class="line"> MTK_RAT_WCDMA_PREFERRED = no</span><br></pre></td></tr></table></figure>
<h3 id="4、vendor-目录下修改lk配置文件"><a href="#4、vendor-目录下修改lk配置文件" class="headerlink" title="4、vendor 目录下修改lk配置文件"></a>4、vendor 目录下修改lk配置文件</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/vendor/mediatek/proprietary/bootable/bootloader/lk/project/k85v1_64.mk b/mediatek/proprietary/bootable/bootloader/lk/project/k85v1_64.mk</span><br><span class="line"></span><br><span class="line"> DEFINES += MTK_NEW_COMBO_EMMC_SUPPORT</span><br><span class="line"> DEFINES += MTK_GPT_SCHEME_SUPPORT</span><br><span class="line"> MTK_CHARGER_NEW_ARCH := yes</span><br><span class="line"></span><br><span class="line"><span class="comment">//修改前</span></span><br><span class="line">-MTK_PUMP_EXPRESS_PLUS_SUPPORT := no</span><br><span class="line"></span><br><span class="line"><span class="comment">//修改后</span></span><br><span class="line">+MTK_PUMP_EXPRESS_PLUS_SUPPORT := yes</span><br><span class="line"></span><br><span class="line"> MTK_CHARGER_INTERFACE := yes</span><br><span class="line"> MTK_MT6360_PMU_CHARGER_SUPPORT := yes</span><br><span class="line"> MTK_LCM_PHYSICAL_ROTATION = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h3 id="5、mt6360-pd-快充升压逻辑gm3-0"><a href="#5、mt6360-pd-快充升压逻辑gm3-0" class="headerlink" title="5、mt6360 pd 快充升压逻辑gm3.0"></a>5、mt6360 pd 快充升压逻辑gm3.0</h3><p>代码调用流程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">swchg_select_charging_current_limit</span><br><span class="line">    --&gt; mtk_pdc_get_setting <span class="comment">//这里判断是否要升压，并获取要设置的电压</span></span><br><span class="line">    --&gt; mtk_pdc_setup   <span class="comment">//设置当前应当使用的电压</span></span><br><span class="line">        --&gt; adapter_dev_set_cap(info-&gt;pd_adapter, MTK_PD,pd-&gt;cap.max_mv[idx], pd-&gt;cap.ma[idx]); <span class="comment">// 设置电压</span></span><br><span class="line">        --&gt; mtk_pdc_get_idx(info, idx, &amp;pd-&gt;pd_boost_idx, &amp;pd-&gt;pd_buck_idx); <span class="comment">// 基于当前设置的电压，更新升压，降压选项</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="1-升压算法"><a href="#1-升压算法" class="headerlink" title="1) 升压算法"></a>1) 升压算法</h4><p>pd 的升压逻辑很简单，就是检测当前需要的功耗是否达到了需要升压的高阈值。如果是则升压，如果低于低阈值则降压，否则使用当前电压。</p>
<p>pd_max_watt =  12400000 //升压功耗的高阈值<br>pd_min_watt =  7900000  // 升压的功耗低阈值<br>now_max_watt = cap-&gt;max_mv[idx] * ibus + chg2_watt; //当前经过计算需要的功耗</p>
<p>升压举例说明：</p>
<p>当前的 idx = 0 使用 5v 充电各个参数如下</p>
<p>idx = selected_idx = 0 //选择 5000<br>boost_idx = 1 // 选择 9000 ，当前挡位电压下的升压电压<br>buck_idx = 0  // 选择 5000 ，当前挡位下的降压电压</p>
<p>总结： 当 now_max_watt &gt; pd_max_watt 则选择升压到当前电压的高一级电压，当 now_max_watt &lt; pd_min_watt 则降低一级电压，在中间则保持不变。需要注意的是 chg1_mivr 和 chg2_mivr 也会决定了是否升压，至于这两个的判定条件是啥我也没研究清除，有大佬研究的可以告知一下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mtk_pdc_get_setting</span><span class="params">(struct charger_manager *info, <span class="keyword">int</span> *newvbus, <span class="keyword">int</span> *newcur,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> *newidx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> idx, selected_idx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> pd_max_watt, pd_min_watt, now_max_watt;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mtk_pdc</span> *<span class="title">pd</span> =</span> &amp;info-&gt;pdc;</span><br><span class="line">    <span class="keyword">int</span> ibus = <span class="number">0</span>, vbus;</span><br><span class="line">    <span class="keyword">int</span> ibat = <span class="number">0</span>, chg1_ibat = <span class="number">0</span>, chg2_ibat = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> chg2_watt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> boost = <span class="literal">false</span>, buck = <span class="literal">false</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">adapter_power_cap</span> *<span class="title">cap</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> mivr1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> mivr2 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">bool</span> chg1_mivr = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> chg2_mivr = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> chg2_enable = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    mtk_pdc_init_table(info); <span class="comment">//获取 cap-&gt;selected_cap_idx</span></span><br><span class="line">    mtk_pdc_get_reset_idx(info);</span><br><span class="line">    mtk_pdc_get_cap_max_watt(info); <span class="comment">//当前支持的获取最大的 watt </span></span><br><span class="line"></span><br><span class="line">    cap = &amp;pd-&gt;cap;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cap-&gt;nr == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (info-&gt;enable_hv_charging == <span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">goto</span> reset;</span><br><span class="line"></span><br><span class="line">    ret = charger_dev_get_ibus(info-&gt;chg1_dev, &amp;ibus);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        chr_err(<span class="string">&quot;[%s] get ibus fail, keep default voltage\n&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (info-&gt;data.parallel_vbus) &#123; <span class="comment">//计算出 chg2_watt 一般情况为0</span></span><br><span class="line">        ret = charger_dev_get_ibat(info-&gt;chg1_dev, &amp;chg1_ibat);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">            chr_err(<span class="string">&quot;[%s] get ibat fail\n&quot;</span>, __func__);</span><br><span class="line"></span><br><span class="line">        ret = charger_dev_get_ibat(info-&gt;chg2_dev, &amp;chg2_ibat);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ibat = battery_get_bat_current();</span><br><span class="line">            chg2_ibat = ibat * <span class="number">100</span> - chg1_ibat;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ibat &lt; <span class="number">0</span> || chg2_ibat &lt; <span class="number">0</span>)</span><br><span class="line">            chg2_watt = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            chg2_watt = chg2_ibat / <span class="number">1000</span> * battery_get_bat_voltage()</span><br><span class="line">                    / info-&gt;data.chg2_eff * <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">        chr_err(<span class="string">&quot;[%s] chg2_watt:%d ibat2:%d ibat1:%d ibat:%d\n&quot;</span>,</span><br><span class="line">            __func__, chg2_watt, chg2_ibat, chg1_ibat, ibat * <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    charger_dev_get_mivr_state(info-&gt;chg1_dev, &amp;chg1_mivr);</span><br><span class="line">    charger_dev_get_mivr(info-&gt;chg1_dev, &amp;mivr1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_dual_charger_supported(info)) &#123;</span><br><span class="line">        charger_dev_is_enabled(info-&gt;chg2_dev, &amp;chg2_enable);</span><br><span class="line">        <span class="keyword">if</span> (chg2_enable) &#123;</span><br><span class="line">            charger_dev_get_mivr_state(info-&gt;chg2_dev, &amp;chg2_mivr);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    vbus = battery_get_vbus();</span><br><span class="line">    ibus = ibus / <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((chg1_mivr &amp;&amp; (vbus &lt; mivr1 / <span class="number">1000</span> - <span class="number">500</span>)) ||</span><br><span class="line">        (chg2_mivr &amp;&amp; (vbus &lt; mivr2 / <span class="number">1000</span> - <span class="number">500</span>)))</span><br><span class="line">        <span class="keyword">goto</span> reset;</span><br><span class="line"></span><br><span class="line">    selected_idx = cap-&gt;selected_cap_idx; <span class="comment">//获取当前的 idx</span></span><br><span class="line">    idx = selected_idx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (idx &lt; <span class="number">0</span> || idx &gt;= ADAPTER_CAP_MAX_NR)</span><br><span class="line">        idx = selected_idx = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    pd_max_watt = cap-&gt;max_mv[idx] * (cap-&gt;ma[idx]</span><br><span class="line">            / <span class="number">100</span> * (<span class="number">100</span> - info-&gt;data.ibus_err) - <span class="number">100</span>); <span class="comment">// 高级功耗，一般为固定值从 log 读出为 12400000</span></span><br><span class="line"></span><br><span class="line">    now_max_watt = cap-&gt;max_mv[idx] * ibus + chg2_watt; <span class="comment">//当前经过计算需要的功耗</span></span><br><span class="line"></span><br><span class="line">    pd_min_watt = cap-&gt;max_mv[pd-&gt;pd_buck_idx] * cap-&gt;ma[pd-&gt;pd_buck_idx] <span class="comment">//低级功耗 7900000</span></span><br><span class="line">            / <span class="number">100</span> * (<span class="number">100</span> - info-&gt;data.ibus_err)</span><br><span class="line">            - info-&gt;data.vsys_watt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pd_min_watt &lt;= <span class="number">5000000</span>) <span class="comment">//pd 快充的最小功耗 5000000</span></span><br><span class="line">        pd_min_watt = <span class="number">5000000</span>;</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;pd-&gt;pd_boost_idx: %d, pd-&gt;pd_buck_idx: %d, selected_idx: %d\n&quot;</span>,</span><br><span class="line">            pd-&gt;pd_boost_idx, pd-&gt;pd_buck_idx, selected_idx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((now_max_watt &gt;= pd_max_watt) || chg1_mivr || chg2_mivr) &#123; </span><br><span class="line">        printk(<span class="string">&quot;1\n&quot;</span>);</span><br><span class="line">        *newidx = pd-&gt;pd_boost_idx; <span class="comment">// 选择 pd_boost_idx 也就是升压</span></span><br><span class="line">        boost = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (now_max_watt &lt;= pd_min_watt) &#123;</span><br><span class="line">        printk(<span class="string">&quot;2\n&quot;</span>);</span><br><span class="line">        *newidx = pd-&gt;pd_buck_idx;  <span class="comment">// 选择 pd_buck_idx 也就是降压</span></span><br><span class="line">        buck = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        printk(<span class="string">&quot;333\n&quot;</span>);</span><br><span class="line">        *newidx = selected_idx;      <span class="comment">// 不变继续当前挡位充电</span></span><br><span class="line">        boost = <span class="literal">false</span>;</span><br><span class="line">        buck = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *newvbus = cap-&gt;max_mv[*newidx]; <span class="comment">//获取对应的电压</span></span><br><span class="line">    *newcur = cap-&gt;ma[*newidx];      <span class="comment">//获取对应的电流</span></span><br><span class="line"></span><br><span class="line">    chr_err(<span class="string">&quot;[%s]watt:%d,%d,%d up:%d,%d vbus:%d ibus:%d, mivr:%d,%d\n&quot;</span>,</span><br><span class="line">        __func__,</span><br><span class="line">        pd_max_watt, now_max_watt, pd_min_watt,</span><br><span class="line">       boost, buck,</span><br><span class="line">        vbus, ibus, chg1_mivr, chg2_mivr);</span><br><span class="line"></span><br><span class="line">    chr_err(<span class="string">&quot;[%s]vbus:%d:%d:%d current:%d idx:%d default_idx:%d\n&quot;</span>,</span><br><span class="line">        __func__, pd-&gt;vbus_h, pd-&gt;vbus_l, *newvbus,</span><br><span class="line">        *newcur, *newidx, selected_idx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">reset:</span><br><span class="line">    mtk_pdc_reset(info);</span><br><span class="line">    *newidx = pd-&gt;pd_reset_idx;</span><br><span class="line">    *newvbus = cap-&gt;max_mv[*newidx];</span><br><span class="line">    *newcur = cap-&gt;ma[*newidx];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2）更新当前挡位下的升压、降压-idx"><a href="#2）更新当前挡位下的升压、降压-idx" class="headerlink" title="2）更新当前挡位下的升压、降压 idx"></a>2）更新当前挡位下的升压、降压 idx</h4><p>该函数基于当前的 selected_idx 来更新升压，降压 idx，举例说明：<br>6360 当前可以供选择的电压挡位如下</p>
<p>max_mv[0] = 5000 ，ma[0] = 3000  //数组下标就是 idx<br>max_mv[1] = 9000 ，ma[1] = 2660<br>max_mv[2] = 12000, ma[2] = 2000</p>
<p>maxwatt[i] = max_mv[i] * ma[i]; // 表示功率</p>
<p>maxwatt[0] = 15000000<br>maxwatt[1] = 23940000<br>maxwatt[2] = 24000000</p>
<p>pd 支持的范围为 5000 - 9000<br>第一次插上充电器，默认使用当前挡位为最低档 0 档即设置 5000 mv 充电，同时下面参数也是默认状态 0</p>
<p>idx = selected_idx = 0 //选择 5000<br>boost_idx = 0 // 选择 5000<br>buck_idx = 0  // 选择 5000</p>
<p>调用 mtk_pdc_get_idx 更新当前状态更新完状态后如下</p>
<p>idx = selected_idx = 0 //选择 5000<br>boost_idx = 1 // 选择 9000 ，当前挡位电压下的升压电压<br>buck_idx = 0  // 选择 5000 ，当前挡位下的降压电压</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    更新升压下标 boost_idx</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    1. 判断 max_mv[0] = 5000 是否在 5000 - 9000 范围内，明显是在的</span></span><br><span class="line"><span class="comment">    2. 判断 idx = 0 表示的功耗 maxwatt[idx] 是否小于 maxwatt[0] 明显是相等的</span></span><br><span class="line"><span class="comment">    3. 判断 max_mv[1] = 9000 是否在 5000 - 9000 范围内，明显是在的</span></span><br><span class="line"><span class="comment">    4. 判断 idx = 0 表示的功耗 maxwatt[idx] 是否小于 maxwatt[1] 明显后者更大，于是更新 idx = 1</span></span><br><span class="line"><span class="comment">    5. 判断 max_mv[2] = 12000 是否在 5000 - 9000 范围内，明显不在于是结束</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    更新 boost_idx 使用当前挡 idx 位下的更高电压即 1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    接下来更新降压下标 buck_idx 更新前重新初始化当前下标 idx = selected_idx = 0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    1. 判断 max_mv[0] = 5000 是否在 5000 - 9000 范围内，明显是在的</span></span><br><span class="line"><span class="comment">    2. 判断 idx = 0 表示的功耗 maxwatt[idx] 是否大于 maxwatt[0] 明显是相等的</span></span><br><span class="line"><span class="comment">    3. 判断 max_mv[1] = 9000 是否在 5000 - 9000 范围内，明显是在的</span></span><br><span class="line"><span class="comment">    4. 判断 idx = 0 表示的功耗 maxwatt[idx] 是否大于 maxwatt[1] 明显后者更大</span></span><br><span class="line"><span class="comment">    5. 判断 max_mv[2] = 12000 是否在 5000 - 9000 范围内，明显不在于是结束</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    更新 buck_idx 使用当前挡 idx 位下的更低电压即 0</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mtk_pdc_get_idx</span><span class="params">(struct charger_manager *info, <span class="keyword">int</span> selected_idx,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> *boost_idx, <span class="keyword">int</span> *buck_idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mtk_pdc</span> *<span class="title">pd</span> =</span> &amp;info-&gt;pdc;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">adapter_power_cap</span> *<span class="title">cap</span>;</span></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> idx = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    cap = &amp;pd-&gt;cap;</span><br><span class="line">    idx = selected_idx;  <span class="comment">//当前设置的电压</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        chr_err(<span class="string">&quot;[%s] invalid idx:%d\n&quot;</span>, __func__, idx);</span><br><span class="line">        *boost_idx = <span class="number">0</span>;</span><br><span class="line">        *buck_idx = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* get boost_idx */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cap-&gt;nr; i++) &#123;</span><br><span class="line"></span><br><span class="line">           chr_err(<span class="string">&quot;min_mv:%d %d %d %d\n&quot;</span>,</span><br><span class="line">                    cap-&gt;min_mv[i],</span><br><span class="line">                    cap-&gt;max_mv[i],</span><br><span class="line">                    pd-&gt;vbus_l,</span><br><span class="line">                    pd-&gt;vbus_h);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断 cap-&gt;mv 支付在 pd 快充支持的电压范围 </span></span><br><span class="line">        <span class="keyword">if</span> (cap-&gt;min_mv[i] &lt; pd-&gt;vbus_l ||</span><br><span class="line">            cap-&gt;max_mv[i] &lt; pd-&gt;vbus_l) &#123;</span><br><span class="line">            chr_err(<span class="string">&quot;min_mv error:%d %d %d\n&quot;</span>,</span><br><span class="line">                    cap-&gt;min_mv[i],</span><br><span class="line">                    cap-&gt;max_mv[i],</span><br><span class="line">                    pd-&gt;vbus_l);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cap-&gt;min_mv[i] &gt; pd-&gt;vbus_h ||</span><br><span class="line">            cap-&gt;max_mv[i] &gt; pd-&gt;vbus_h) &#123;</span><br><span class="line">            chr_err(<span class="string">&quot;max_mv error:%d %d %d\n&quot;</span>,</span><br><span class="line">                    cap-&gt;min_mv[i],</span><br><span class="line">                    cap-&gt;max_mv[i],</span><br><span class="line">                    pd-&gt;vbus_h);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (idx == selected_idx) &#123;  <span class="comment">//如果当前i下标对应的功率更大，则使用更新 idx 使用更大功率表示的下标</span></span><br><span class="line">            <span class="keyword">if</span> (cap-&gt;maxwatt[i] &gt; cap-&gt;maxwatt[idx])</span><br><span class="line">                idx = i;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (cap-&gt;maxwatt[i] &lt; cap-&gt;maxwatt[idx] &amp;&amp;</span><br><span class="line">                cap-&gt;maxwatt[i] &gt; cap-&gt;maxwatt[selected_idx])</span><br><span class="line">                idx = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *boost_idx = idx;</span><br><span class="line">    idx = selected_idx;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* get buck_idx */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cap-&gt;nr; i++) &#123;</span><br><span class="line"></span><br><span class="line">            chr_err(<span class="string">&quot;min_mv error:%d %d %d %d\n&quot;</span>,</span><br><span class="line">                    cap-&gt;min_mv[i],</span><br><span class="line">                    cap-&gt;max_mv[i],</span><br><span class="line">                    pd-&gt;vbus_l,</span><br><span class="line">                    pd-&gt;vbus_h);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cap-&gt;min_mv[i] &lt; pd-&gt;vbus_l ||</span><br><span class="line">            cap-&gt;max_mv[i] &lt; pd-&gt;vbus_l) &#123;</span><br><span class="line">            chr_err(<span class="string">&quot;min_mv error:%d %d %d\n&quot;</span>,</span><br><span class="line">                    cap-&gt;min_mv[i],</span><br><span class="line">                    cap-&gt;max_mv[i],</span><br><span class="line">                    pd-&gt;vbus_l);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (cap-&gt;min_mv[i] &gt; pd-&gt;vbus_h ||</span><br><span class="line">            cap-&gt;max_mv[i] &gt; pd-&gt;vbus_h) &#123;</span><br><span class="line">            chr_err(<span class="string">&quot;max_mv error:%d %d %d\n&quot;</span>,</span><br><span class="line">                    cap-&gt;min_mv[i],</span><br><span class="line">                    cap-&gt;max_mv[i],</span><br><span class="line">                    pd-&gt;vbus_h);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (idx == selected_idx) &#123;  <span class="comment">//如果当前i下标对应的功率更小，则使用 i 更新 idx 使用更小功率表示的下标</span></span><br><span class="line">            <span class="keyword">if</span> (cap-&gt;maxwatt[i] &lt; cap-&gt;maxwatt[idx])</span><br><span class="line">                idx = i;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (cap-&gt;maxwatt[i] &gt; cap-&gt;maxwatt[idx] &amp;&amp;</span><br><span class="line">                cap-&gt;maxwatt[i] &lt; cap-&gt;maxwatt[selected_idx])</span><br><span class="line">                idx = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *buck_idx = idx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="四、G90-mt6785-功放调试之控制"><a href="#四、G90-mt6785-功放调试之控制" class="headerlink" title="四、G90(mt6785)-功放调试之控制"></a>四、G90(mt6785)-功放调试之控制</h2><h3 id="1、耳机检测代码"><a href="#1、耳机检测代码" class="headerlink" title="1、耳机检测代码"></a>1、耳机检测代码</h3><p>G90 的功放和 8788 平台的有点不一样，在插上耳机的时候功放不会自动停止播放，因此在耳机检测的时候手动添加开关功放的使能引脚的功能。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">/drivers/misc/mediatek/accdet/mt6359/accdet.c</span><br><span class="line"></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">if</span> PMIC_ACCDET_KERNEL</span></span><br><span class="line"> <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">eint_work_callback</span><span class="params">(struct work_struct *work)</span></span></span><br><span class="line"><span class="function"> <span class="meta">#<span class="meta-keyword">else</span></span></span></span><br><span class="line"><span class="function"> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">eint_work_callback</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"> <span class="meta">#<span class="meta-keyword">endif</span></span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     pr_info(<span class="string">&quot;accdet %s(),DCC EINT func\n&quot;</span>, __func__);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (cur_eint_state == EINT_PIN_PLUG_IN) &#123; <span class="comment">//检测到耳机插入跑这里</span></span><br><span class="line">         <span class="comment">/* wk, disable vusb LP */</span></span><br><span class="line">         pmic_write(PMIC_RG_LDO_VUSB_HW0_OP_EN_ADDR, <span class="number">0x8000</span>);</span><br><span class="line">         pr_info(<span class="string">&quot;%s VUSB LP dis\n&quot;</span>, __func__);</span><br><span class="line"></span><br><span class="line">         pr_info(<span class="string">&quot;accdet cur: plug-in, cur_eint_state = %d\n&quot;</span>,</span><br><span class="line">             cur_eint_state);</span><br><span class="line"></span><br><span class="line">         amplifier_control_off();<span class="comment">/* 关闭功放， 这个函数是自己添加的 */</span></span><br><span class="line"></span><br><span class="line">         mutex_lock(&amp;accdet_eint_irq_sync_mutex);</span><br><span class="line">         eint_accdet_sync_flag = <span class="literal">true</span>;</span><br><span class="line">         mutex_unlock(&amp;accdet_eint_irq_sync_mutex);</span><br><span class="line">         __pm_wakeup_event(accdet_timer_lock,</span><br><span class="line">             jiffies_to_msecs(<span class="number">7</span> * HZ));</span><br><span class="line"></span><br><span class="line">         accdet_init();</span><br><span class="line"></span><br><span class="line">         pr_info(<span class="string">&quot;%s VUSB LP dis done\n&quot;</span>, __func__);</span><br><span class="line">         enable_accdet(<span class="number">0</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;  <span class="comment">//检测到耳机拔出跑这里</span></span><br><span class="line">         pr_info(<span class="string">&quot;accdet cur:plug-out, cur_eint_state = %d\n&quot;</span>,</span><br><span class="line">             cur_eint_state);</span><br><span class="line"></span><br><span class="line">         amplifier_control_on();<span class="comment">/* 打开功放，这个函数是自己添加的 */</span></span><br><span class="line"></span><br><span class="line">         mutex_lock(&amp;accdet_eint_irq_sync_mutex);</span><br><span class="line">         eint_accdet_sync_flag = <span class="literal">false</span>;</span><br><span class="line">         accdet_thing_in_flag = <span class="literal">false</span>;</span><br><span class="line">         mutex_unlock(&amp;accdet_eint_irq_sync_mutex);</span><br><span class="line">         <span class="keyword">if</span> (accdet_dts.moisture_detect_mode != <span class="number">0x5</span>)</span><br><span class="line">             del_timer_sync(&amp;micbias_timer);</span><br><span class="line"></span><br><span class="line">         <span class="comment">/* disable accdet_sw_en=0</span></span><br><span class="line"><span class="comment">          */</span></span><br><span class="line">         pmic_write_clr(PMIC_ACCDET_SW_EN_ADDR,</span><br><span class="line">             PMIC_ACCDET_SW_EN_SHIFT);</span><br><span class="line">         disable_accdet();</span><br><span class="line">         headset_plug_out();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ACCDET_EINT_IRQ</span></span><br><span class="line"> <span class="keyword">if</span> (get_moisture_det_en() == <span class="number">0x1</span>)</span><br><span class="line">     recover_moisture_setting(gmoistureID);</span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line">     recover_eint_setting(gmoistureID);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_ACCDET_EINT</span></span><br><span class="line"> enable_irq(accdet_irq);</span><br><span class="line"> pr_info(<span class="string">&quot;accdet %s enable_irq !!\n&quot;</span>, __func__);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2、耳机有声音功放没声音"><a href="#2、耳机有声音功放没声音" class="headerlink" title="2、耳机有声音功放没声音"></a>2、耳机有声音功放没声音</h3><p>插上耳机 pmu 才有功放信号输出，拔出耳机就没有信号输出，这里的信号指 pmu 端的信号，其实就是外置功放修改，修改如下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/device/mediateksample/k85v1_64/ProjectConfig.mk b/mediateksample/k85v1_64/ProjectConfig.mk</span><br><span class="line"></span><br><span class="line"> MTK_AUDIO_MIC_INVERSE = no</span><br><span class="line"> MTK_AUDIO_NUMBER_OF_MIC = <span class="number">2</span></span><br><span class="line"> MTK_AUDIO_NUMBER_OF_SPEAKER = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//修改前</span></span><br><span class="line">-MTK_AUDIO_SPEAKER_PATH = smartpa_mtk_mt6660</span><br><span class="line"></span><br><span class="line"><span class="comment">//修改后</span></span><br><span class="line">+MTK_AUDIO_SPEAKER_PATH = int_hp_buf</span><br><span class="line"> MTK_AUDIO_TUNING_TOOL_VERSION = V2<span class="number">.2</span></span><br><span class="line"> MTK_AUDIO_TUNNELING_SUPPORT = no</span><br><span class="line"> MTK_AUIDO_MIC_INVERSE = no</span><br></pre></td></tr></table></figure>
<h3 id="3、喇叭尾音"><a href="#3、喇叭尾音" class="headerlink" title="3、喇叭尾音"></a>3、喇叭尾音</h3><p>Android系统默认播放停止后3秒会进入Standby模式以节省电源.standby里面有pcm_close接口，会关闭speaker的输出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/av/services/audioflinger/AudioFlinger.h b/av/services/audioflinger/AudioFlinger.h</span><br><span class="line">old mode <span class="number">100644</span></span><br><span class="line"><span class="keyword">new</span> mode <span class="number">100755</span></span><br><span class="line">index <span class="number">978</span>d39132.<span class="number">.73</span>db1b203</span><br><span class="line">--- a/av/services/audioflinger/AudioFlinger.h</span><br><span class="line">+++ b/av/services/audioflinger/AudioFlinger.h</span><br><span class="line">@@ <span class="number">-97</span>,<span class="number">7</span> +<span class="number">97</span>,<span class="number">7</span> @@ class ServerProxy;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// ----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">-<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">nsecs_t</span> kDefaultStandbyTimeInNsecs = seconds(<span class="number">3</span>);</span><br><span class="line">+<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">nsecs_t</span> kDefaultStandbyTimeInNsecs = milliseconds(<span class="number">200</span>);</span><br><span class="line"> <span class="comment">//MTK_AUDIO_FIX_DEFAULT_DEFECT</span></span><br><span class="line"> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">nsecs_t</span> kDefaultA2dpStandbyTimeInNsecs = milliseconds(<span class="number">500</span>);</span><br></pre></td></tr></table></figure>
<h3 id="四、耳机立体声修改"><a href="#四、耳机立体声修改" class="headerlink" title="四、耳机立体声修改"></a>四、耳机立体声修改</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vendor/mediatek/proprietary/custom/tb8788p1_64_bsp/hal/audioflinger/audio/audio_custom_exp.h</span><br><span class="line"><span class="comment">//在这个文件中增加宏 #define ENABLE_STEREO_SPEAKER</span></span><br></pre></td></tr></table></figure>
<h3 id="4、-打开-ATCI"><a href="#4、-打开-ATCI" class="headerlink" title="4、 打开 ATCI"></a>4、 打开 ATCI</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*#*#<span class="number">3646633</span>#*#*</span><br></pre></td></tr></table></figure>
<p>Log and Debugging -&gt; ATCI -&gt; ALWAYS ENABLE ATCI</p>
<p><strong>喇叭文件频响曲线存放目录</strong><br>device/mediatek/common/audio_param</p>
<h2 id="三、G90-mt6785-sensorhub"><a href="#三、G90-mt6785-sensorhub" class="headerlink" title="三、G90(mt6785)-sensorhub"></a>三、G90(mt6785)-sensorhub</h2><h2 id="四、背光能调到黑屏"><a href="#四、背光能调到黑屏" class="headerlink" title="四、背光能调到黑屏"></a>四、背光能调到黑屏</h2><p>当打开自动调节背光功能的时候，手动调节设置中背光滚动条将背光设置到最小，屏幕会完全变黑，这种现象可能与lcm的最小亮度有关，可以采用如下方式解决：</p>
<p>1、adb comand设置背光，确定可以使lcm点亮的最小背光值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell echo xx &gt;/sys/<span class="class"><span class="keyword">class</span>/<span class="title">leds</span>/<span class="title">lcd</span>-<span class="title">backlight</span>/<span class="title">brightness</span>    <span class="title">xx</span>为<span class="title">backlight</span> <span class="title">level</span></span></span><br></pre></td></tr></table></figure>
<p>2、修改alps/frameworks/base/core/res/res/values/config.xml中如下参数的值为步骤1中所获取的最小背光值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- Minimum allowable screen brightness to use in a very dark room.</span><br><span class="line">This value sets the <span class="built_in">floor</span> <span class="keyword">for</span> the darkest possible <span class="keyword">auto</span>-brightness</span><br><span class="line">adjustment. It is expected to be somewhat less than the first entry in</span><br><span class="line">config_autoBrightnessLcdBacklightValues so as to allow the user to have</span><br><span class="line">some range of adjustment to dim the screen further than usual in very</span><br><span class="line">dark rooms. The contents of the screen must still be clearly visible</span><br><span class="line">in darkness (although they may not be visible in a bright room). --&gt;</span><br><span class="line">&lt;integer name=<span class="string">&quot;config_screenBrightnessDark&quot;</span>&gt;<span class="number">1</span>&lt;/integer&gt;</span><br></pre></td></tr></table></figure>
<h2 id="五、摄像头"><a href="#五、摄像头" class="headerlink" title="五、摄像头"></a>五、摄像头</h2><h3 id="1、摄像头引脚"><a href="#1、摄像头引脚" class="headerlink" title="1、摄像头引脚"></a>1、摄像头引脚</h3><p>IOVDD(input output vdd): 负责i2c电压，没有这路电无法读到id，电压一般为 1.8, 少数为2.8内部转化为1.8</p>
<p>DVDD(digital vdd): 用于给数字信号供电，1.2v</p>
<p>AVDD( VDD)：用于给 cmos 供电，放大模拟信号，2.8v</p>
<p>PWDN(power wdn): 给摄像头芯片供电，1.8</p>
<p>RESET: 芯片复位信号</p>
<p>MCLK:一般为 24/26MHZ</p>
<h3 id="2、摄像头去掉af"><a href="#2、摄像头去掉af" class="headerlink" title="2、摄像头去掉af"></a>2、摄像头去掉af</h3><p>vendor/mediatek/proprietary/custom/mt6785/hal/imgsensor_metadata/gc5035_mipi_raw/config_static_metadata.module.gc5035mipiraw.h</p>
<p>将 MTK_CONTROL_AF_MODE_CONTINUOUS_PICTRUE 改为 MTK_CONTROL_AF_MODE_OFF</p>
<p>同时修改<br>vendor/mediatek/proprietary/custom/mt6785/hal/lens/src/lenslist.cpp<br>将对应的配置改为 “Dummy” 如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;S5K3M3_SENSOR_ID, DUMMY_MODULE_ID, AK7371AF_LENS_ID, <span class="string">&quot;Dummy&quot;</span>, pAK7371AF_MAIN2_getDefaultData&#125;,</span><br></pre></td></tr></table></figure>
<h3 id="3、修改摄像头方向以及mipi通道"><a href="#3、修改摄像头方向以及mipi通道" class="headerlink" title="3、修改摄像头方向以及mipi通道"></a>3、修改摄像头方向以及mipi通道</h3><p>vendor\mediatek\proprietary\custom\mt8168\hal\imgsensor_src\cfg_setting_imgsensor.cpp</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> CUSTOM_CFG gCustomCfg[] = &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        .sensorIdx     = IMGSENSOR_SENSOR_IDX_MAIN,</span><br><span class="line"><span class="comment">//        .mclk          = CUSTOM_CFG_MCLK_1,</span></span><br><span class="line"><span class="comment">//        .port          = CUSTOM_CFG_CSI_PORT_0,</span></span><br><span class="line">        .mclk          = CUSTOM_CFG_MCLK_3, <span class="comment">//修改mipi通道为 3</span></span><br><span class="line">        .port          = CUSTOM_CFG_CSI_PORT_2,</span><br><span class="line">        .dir           = CUSTOM_CFG_DIR_REAR,</span><br><span class="line">        .bitOrder      = CUSTOM_CFG_BITORDER_9_2,</span><br><span class="line">        .orientation   = <span class="number">90</span>, <span class="comment">//设置方向</span></span><br><span class="line">        .horizontalFov = <span class="number">67</span>,</span><br><span class="line">        .verticalFov   = <span class="number">49</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .sensorIdx     = IMGSENSOR_SENSOR_IDX_SUB,</span><br><span class="line"> <span class="comment">//       .mclk          = CUSTOM_CFG_MCLK_3,</span></span><br><span class="line"> <span class="comment">//       .port          = CUSTOM_CFG_CSI_PORT_2,</span></span><br><span class="line">        .mclk          = CUSTOM_CFG_MCLK_1,</span><br><span class="line">        .port          = CUSTOM_CFG_CSI_PORT_0,</span><br><span class="line">        .dir           = CUSTOM_CFG_DIR_FRONT,</span><br><span class="line">        .bitOrder      = CUSTOM_CFG_BITORDER_9_2,</span><br><span class="line">        .orientation   = <span class="number">270</span>,</span><br><span class="line">        .horizontalFov = <span class="number">63</span>,</span><br><span class="line">        .verticalFov   = <span class="number">40</span>,</span><br><span class="line">        .secure        = CUSTOM_CFG_SECURE_M0</span><br><span class="line">    &#125;,</span><br><span class="line">.......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="4、摄像头连不上cct"><a href="#4、摄像头连不上cct" class="headerlink" title="4、摄像头连不上cct"></a>4、摄像头连不上cct</h3><p>请检查是否设置了 SENSOR_OUTPUT_FORMAT_RAW_Gb</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+++ b/drivers/misc/mediatek/imgsensor/src/common/v1_1/s5k5e9_mipi_raw/s5k5e9mipiraw_Sensor.c</span><br><span class="line">@@ <span class="number">-156</span>,<span class="number">7</span> +<span class="number">156</span>,<span class="number">7</span> @@ <span class="keyword">static</span> imgsensor_info_struct imgsensor_info = &#123;</span><br><span class="line">        .sensor_interface_type = SENSOR_INTERFACE_TYPE_MIPI,</span><br><span class="line">        .mipi_sensor_type = MIPI_OPHY_NCSI2, <span class="comment">//0,MIPI_OPHY_NCSI2;  1,MIPI_OPHY_CSI2</span></span><br><span class="line">        .mipi_settle_delay_mode = MIPI_SETTLEDELAY_AUTO,<span class="comment">//0,MIPI_SETTLEDELAY_AUTO; 1,MIPI_SETTLEDELAY_MANNUAL</span></span><br><span class="line">-       .sensor_output_dataformat = SENSOR_OUTPUT_FORMAT_RAW_Gb,</span><br><span class="line">+       .sensor_output_dataformat = SENSOR_OUTPUT_FORMAT_RAW_Gr,</span><br><span class="line">        .mclk = <span class="number">24</span>,</span><br><span class="line">        .mipi_lane_num = SENSOR_MIPI_2_LANE,</span><br><span class="line">        .i2c_addr_table = &#123;<span class="number">0x5a</span>,<span class="number">0x20</span>,<span class="number">0xff</span>&#125;,</span><br><span class="line">@@ <span class="number">-165</span>,<span class="number">7</span> +<span class="number">165</span>,<span class="number">7</span> @@ <span class="keyword">static</span> imgsensor_info_struct imgsensor_info = &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="keyword">static</span> imgsensor_struct imgsensor = &#123;</span><br><span class="line">-       .mirror = IMAGE_HV_MIRROR,                              <span class="comment">//mirrorflip information</span></span><br><span class="line">+       .mirror = IMAGE_NORMAL,                         <span class="comment">//mirrorflip information</span></span><br><span class="line">        .sensor_mode = IMGSENSOR_MODE_INIT, <span class="comment">//IMGSENSOR_MODE enum value,record current sensor mode,such as: INIT, Preview, Ca       pture, Video,High Speed Video, Slim Video</span></span><br><span class="line">        .shutter = <span class="number">0x3D0</span>,                                       <span class="comment">//current shutter</span></span><br><span class="line">        .gain = <span class="number">0x100</span>,                                          <span class="comment">//current gain</span></span><br></pre></td></tr></table></figure>
<h2 id="六、adb-remount"><a href="#六、adb-remount" class="headerlink" title="六、adb remount"></a>六、adb remount</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">adb reboot bootloader </span><br><span class="line">echo 等待进入bootloader</span><br><span class="line">pause</span><br><span class="line">fastboot flashing unlock</span><br><span class="line">echo 按照界面提示按小机音量+按键</span><br><span class="line">pause</span><br><span class="line">fastboot reboot</span><br><span class="line">echo 等待开机完成</span><br><span class="line">pause</span><br><span class="line">adb root</span><br><span class="line">pause</span><br><span class="line">adb disable-verity </span><br><span class="line">adb reboot</span><br><span class="line">pause</span><br><span class="line">adb root </span><br><span class="line">adb remount</span><br><span class="line">pause</span><br></pre></td></tr></table></figure>
<h2 id="七、安卓11打开串口log"><a href="#七、安卓11打开串口log" class="headerlink" title="七、安卓11打开串口log"></a>七、安卓11打开串口log</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">--- a/drivers/misc/mediatek/mtprintk/mtk_printk_ctrl.c</span><br><span class="line">+++ b/drivers/misc/mediatek/mtprintk/mtk_printk_ctrl.c</span><br><span class="line">@@ <span class="number">-34</span>,<span class="number">7</span> +<span class="number">34</span>,<span class="number">7</span> @@</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MTK_ENG_BUILD</span></span><br><span class="line"> <span class="keyword">int</span> printk_ctrl;</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">-<span class="keyword">int</span> printk_ctrl = <span class="number">1</span>;</span><br><span class="line">+<span class="keyword">int</span> printk_ctrl = <span class="number">0</span>;</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"> module_param_named(disable_uart, printk_ctrl, <span class="keyword">int</span>, <span class="number">0644</span>);</span><br><span class="line">@@ <span class="number">-51</span>,<span class="number">7</span> +<span class="number">51</span>,<span class="number">7</span> @@ <span class="function"><span class="keyword">bool</span> <span class="title">mt_get_uartlog_status</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"> <span class="keyword">void</span> <span class="title">mt_disable_uart</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">        <span class="comment">/* uart print not always enable */</span></span><br><span class="line">-       <span class="keyword">if</span> (printk_ctrl != <span class="number">2</span>)</span><br><span class="line">+       <span class="keyword">if</span> (printk_ctrl != <span class="number">0</span>)</span><br><span class="line">                printk_ctrl = <span class="number">1</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="八、安卓按键映射"><a href="#八、安卓按键映射" class="headerlink" title="八、安卓按键映射"></a>八、安卓按键映射</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\out\target\product\tb8168p1_64_bsp\system\usr\keylayout\Generic.kl</span><br></pre></td></tr></table></figure>
<h2 id="九、mtk-平台反汇编-dts"><a href="#九、mtk-平台反汇编-dts" class="headerlink" title="九、mtk 平台反汇编 dts"></a>九、mtk 平台反汇编 dts</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">out/target/product/tb8788p1_64_bsp/obj/KERNEL_OBJ/scripts/dtc/dtc -I dtb -O dts -o out/target/product/tb8788p1_64_bsp/obj/KERNEL_OBJ/arch/arm64/boot/dts/mediatek/mt6771.dtb</span><br></pre></td></tr></table></figure>
<p>1、dtbo img -&gt; dtb</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./out/host/linux-x86/bin/mkdtimg dump out/target/product/tb8788p1_64_bsp/dtbo-verified.img -b a<span class="number">.0</span></span><br><span class="line">执行后生成a<span class="number">.0</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>
<p>2、dtb-&gt;dts</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./out/target/product/tb8788p1_64_bsp/obj/KERNEL_OBJ/scripts/dtc/dtc -I dtb -O dts -o x100.dts a<span class="number">.0</span><span class="number">.0</span></span><br><span class="line">执行后生成x100.dts</span><br></pre></td></tr></table></figure>
<h2 id="十、快速打包patch"><a href="#十、快速打包patch" class="headerlink" title="十、快速打包patch"></a>十、快速打包patch</h2><ol>
<li>将脚本 outdiff 拷贝进需要打包的目录</li>
<li>运行 git status &gt; a.txt 创建 a.txt 文件</li>
<li>运行脚本 ./outdiff 创建出 patch 目录 out_diff 该目录有 modified 文件</li>
<li>对比 a.txt 将新曾文件拷贝进对应目录</li>
</ol>
<h2 id="十一、打开mtklog"><a href="#十一、打开mtklog" class="headerlink" title="十一、打开mtklog"></a>十一、打开mtklog</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -n com.mediatek.mtklogger/com.mediatek.mtklogger.MainActivity</span><br></pre></td></tr></table></figure>
<h2 id="十二、给sys节点权限"><a href="#十二、给sys节点权限" class="headerlink" title="十二、给sys节点权限"></a>十二、给sys节点权限</h2><p>1.并非所有的 Linux distributions 都支持 SELinux<br> 目前 SELinux 支持三种模式，分别如下：<br>enforcing ： 强制模式，代表 SELInux 运作中，且已经 正确的开始限制domain/type<br>permisssive:宽容模式，代表 SELinux 运座钟，不过仅会有警告讯息并不会限制<br>domain/type的存取。这个模式可以用来运作为 SELinux 的 debug 之用。<br>disabled： 关闭， SELinux 并没有实际运作</p>
<p>2.查看 SELinux 的模式<br> get enforcing =》enforcing<br>在 MTK 的平台下查看 SELinux 的方法是使用 getenforce<br>如果显示是 enforcing 就说明 SELinux 是打开的<br>如果显示是 disabled 就说明 SELinux 是关闭</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">第一处修改</span><br><span class="line">system/core/init/selinux.cpp</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">bool</span> <span class="title">IsEnforcing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">+       <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">//这里返回false</span></span><br><span class="line">     <span class="keyword">if</span> (ALLOW_PERMISSIVE_SELINUX) &#123;</span><br><span class="line">         <span class="keyword">return</span> StatusFromCmdline() == SELINUX_ENFORCING;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">第二处修改</span><br><span class="line">diff --git a/mediateksample/k71v1_64_bsp/init.project.rc b/mediateksample/k71v1_64_bsp/init.project.rc</span><br><span class="line">index <span class="number">8722</span>a5a5..c87338c3 <span class="number">100755</span></span><br><span class="line">--- a/mediateksample/k71v1_64_bsp/init.project.rc</span><br><span class="line">+++ b/mediateksample/k71v1_64_bsp/init.project.rc</span><br><span class="line">@@ <span class="number">-35</span>,<span class="number">6</span> +<span class="number">35</span>,<span class="number">11</span> @@ on post-fs-data</span><br><span class="line">     chmod <span class="number">0660</span> /dev/spm</span><br><span class="line">     chown system system /dev/spm</span><br><span class="line"></span><br><span class="line">+#ADDNODE</span><br><span class="line">+       chmod <span class="number">0666</span> /sys/<span class="class"><span class="keyword">class</span>/<span class="title">led_ctrl</span>/<span class="title">led_ctrl</span></span></span><br><span class="line"><span class="class">+       <span class="title">chmod</span> 0666 /<span class="title">sys</span>/<span class="keyword">class</span>/<span class="title">hall</span>/<span class="title">hall_1</span></span></span><br><span class="line"><span class="class">+       <span class="title">chmod</span> 0666 /<span class="title">sys</span>/<span class="keyword">class</span>/<span class="title">hall</span>/<span class="title">hall_2</span></span></span><br></pre></td></tr></table></figure>
<h2 id="十三、安卓11编译相关"><a href="#十三、安卓11编译相关" class="headerlink" title="十三、安卓11编译相关"></a>十三、安卓11编译相关</h2><h3 id="1、-Split-command-build-for-system-product"><a href="#1、-Split-command-build-for-system-product" class="headerlink" title="1、 Split command build for system product"></a>1、 Split command build for system product</h3><h4 id="1）Build-system-project"><a href="#1）Build-system-project" class="headerlink" title="1）Build system project"></a>1）Build system project</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">source build/envsetup.sh</span><br><span class="line"><span class="keyword">export</span> OUT_DIR=out_sys</span><br><span class="line">lunch sys_mssi_64_ww-eng</span><br><span class="line">make sys_images</span><br></pre></td></tr></table></figure>
<h4 id="2）Partial-build"><a href="#2）Partial-build" class="headerlink" title="2）Partial build"></a>2）Partial build</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">source build/envsetup.sh</span><br><span class="line"><span class="keyword">export</span> OUT_DIR=out_sys</span><br><span class="line">lunch sys_mssi_64_ww-eng</span><br><span class="line">mmma system/related/paths</span><br><span class="line">(<span class="keyword">or</span> make system_module_name, <span class="keyword">or</span> mm, mmm google <span class="keyword">default</span> command.)</span><br></pre></td></tr></table></figure>
<h3 id="2、Split-command-build-for-vendor-product"><a href="#2、Split-command-build-for-vendor-product" class="headerlink" title="2、Split command build for vendor product"></a>2、Split command build for vendor product</h3><h4 id="1）Build-vendor-project"><a href="#1）Build-vendor-project" class="headerlink" title="1）Build vendor project"></a>1）Build vendor project</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">source build/envsetup.sh</span><br><span class="line"><span class="keyword">export</span> OUT_DIR=out</span><br><span class="line">lunch vnd_k71v1_64_bsp-eng</span><br><span class="line">make vnd_images krn_images</span><br></pre></td></tr></table></figure>
<h4 id="2-Partial-build"><a href="#2-Partial-build" class="headerlink" title="2) Partial build"></a>2) Partial build</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">source build/envsetup.sh</span><br><span class="line"><span class="keyword">export</span> OUT_DIR=out</span><br><span class="line">lunch vnd_k71v1_64_bsp-eng</span><br><span class="line">mmma vendor/related/paths</span><br></pre></td></tr></table></figure>
<h3 id="3、Image-post-process"><a href="#3、Image-post-process" class="headerlink" title="3、Image post process"></a>3、Image post process</h3><h4 id="1-Normal-load"><a href="#1-Normal-load" class="headerlink" title="1) Normal load"></a>1) Normal load</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python out/target/product/mssi_t_64_cn/images/split_build.py --system-dir out/target/product/mssi_t_64_cn/images --vendor-dir out/target/product/tb8789p2_64/images --kernel-dir out/target/product/tb8789p2_64/images --output-dir out/target/product/tb8789p2_64/merged</span><br></pre></td></tr></table></figure>
<h4 id="2-Normal-OTA"><a href="#2-Normal-OTA" class="headerlink" title="2) Normal + OTA"></a>2) Normal + OTA</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python out_sys/target/product/mssi_64_ww/images/split_build.py --system-dir out_sys/target/product/mssi</span><br><span class="line">_64_ww/images --vendor-dir out/target/product/k71v1_64_bsp/images --kernel-dir out/target/product/k71v1</span><br><span class="line">_64_bsp/images --output-dir output_load --otapackage</span><br></pre></td></tr></table></figure>
<h4 id="3-Normal-CTS"><a href="#3-Normal-CTS" class="headerlink" title="3) Normal + CTS"></a>3) Normal + CTS</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python out_sys/target/product/mssi_64_ww/images/split_build.py --system-dir out_sys/target/product/mssi</span><br><span class="line">_64_ww/images --vendor-dir out/target/product/k71v1_64_bsp/images --kernel-dir out/target/product/k71v1</span><br><span class="line">_64_bsp/images --output-dir output_load --certs-dir $CTS_SECURITY_KEY</span><br></pre></td></tr></table></figure>
<h4 id="4-Normal-OTA-CTS"><a href="#4-Normal-OTA-CTS" class="headerlink" title="4) Normal + OTA + CTS"></a>4) Normal + OTA + CTS</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python out_sys/target/product/mssi_64_ww/images/split_build.py --system-dir out_sys/target/product/mssi</span><br><span class="line">_64_ww/images --vendor-dir out/target/product/k71v1_64_bsp/images --kernel-dir out/target/product/k71v1</span><br><span class="line">_64_bsp/images --output-dir output_load --otapackage --certs-dir $CTS_SECURITY_KEY</span><br></pre></td></tr></table></figure>
<h4 id="5）编译命令"><a href="#5）编译命令" class="headerlink" title="5）编译命令"></a>5）编译命令</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source build/envsetup.sh &amp;&amp; lunch sys_mssi_t_64_cn-userdebug &amp;&amp; make sys_images &amp;&amp; lunch vnd_tb8789p2_64-userdebug &amp;&amp; make -j24 vnd_images krn_images</span><br></pre></td></tr></table></figure>
<h2 id="十四、linux-查看内存空间"><a href="#十四、linux-查看内存空间" class="headerlink" title="十四、linux 查看内存空间"></a>十四、linux 查看内存空间</h2><p>df -h</p>
<h2 id="十五、设置蓝牙开机默认状态"><a href="#十五、设置蓝牙开机默认状态" class="headerlink" title="十五、设置蓝牙开机默认状态"></a>十五、设置蓝牙开机默认状态</h2><p>开机设置系统将 wifi 蓝牙 gsensor 默认打开</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vendor/mediatek/proprietary/packages/apps/SettingsProvider/ res/values/defaults.xml</span><br><span class="line">&lt;<span class="keyword">bool</span> name=<span class="string">&quot;def_accelerometer_rotation&quot;</span>&gt;<span class="literal">true</span>&lt;/<span class="keyword">bool</span>&gt;</span><br><span class="line">&lt;integer name=<span class="string">&quot;def_user_rotation&quot;</span>&gt;<span class="number">1</span>&lt;/integer&gt;</span><br><span class="line">&lt;<span class="keyword">bool</span> name=<span class="string">&quot;def_bluetooth_on&quot;</span>&gt;<span class="literal">true</span>&lt;/<span class="keyword">bool</span>&gt;</span><br><span class="line">&lt;<span class="keyword">bool</span> name=<span class="string">&quot;def_wifi_on&quot;</span>&gt;<span class="literal">true</span>&lt;/<span class="keyword">bool</span>&gt;</span><br></pre></td></tr></table></figure>
<h2 id="十六、快速获取设备路径"><a href="#十六、快速获取设备路径" class="headerlink" title="十六、快速获取设备路径"></a>十六、快速获取设备路径</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">path = kobject_get_path(&amp;dev-&gt;dev.kobj, GFP_KERNEL);</span><br><span class="line">pr_info(<span class="string">&quot;%s as %s\n&quot;</span>,</span><br><span class="line">    dev-&gt;name ? dev-&gt;name : <span class="string">&quot;Unspecified device&quot;</span>,</span><br><span class="line">    path ? path : <span class="string">&quot;N/A&quot;</span>);</span><br></pre></td></tr></table></figure>
<h2 id="十七、lk-阶段到-kernel-阶段屏幕会闪一下"><a href="#十七、lk-阶段到-kernel-阶段屏幕会闪一下" class="headerlink" title="十七、lk 阶段到 kernel 阶段屏幕会闪一下"></a>十七、lk 阶段到 kernel 阶段屏幕会闪一下</h2><p>抓取 mipi 波形发现，mipi 波形从 lk 到 kernel 阶段时波形被拉宽了<br>最终发现原因如下 lk 阶段直接使用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 代码路径</span></span><br><span class="line">mediatek/proprietary/bootable/bootloader/lk/platform/mt6785/ddp_dsi.c </span><br><span class="line"></span><br><span class="line">    horizontal_backporch_byte =</span><br><span class="line">          ((dsi_params-&gt;horizontal_backporch +</span><br><span class="line">            dsi_params-&gt;horizontal_sync_active) * dsiTmpBufBpp - <span class="number">10</span>);</span><br></pre></td></tr></table></figure>
<p>这个公式计算这里的 horizontal_sync_active = 16 计算出来得到 188<br>但是 kernel 阶段对 t_hsa 多做了一个处理</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//代码路径</span></span><br><span class="line">drivers/misc/mediatek/video/mt6785/dispsys/ddp_dsi.c </span><br><span class="line"></span><br><span class="line">t_hsa = ALIGN_TO(t_hsa * dsiTmpBufBpp - <span class="number">4</span>, <span class="number">4</span>); <span class="comment">// kernel多了这个计算</span></span><br><span class="line"></span><br><span class="line"> ASSERT((t_hbp + t_hsa) * dsiTmpBufBpp &gt; <span class="number">9</span>);</span><br><span class="line">t_hbp = ALIGN_TO((t_hbp + t_hsa) * dsiTmpBufBpp - <span class="number">10</span>, <span class="number">4</span>);</span><br></pre></td></tr></table></figure>
<p>在kernel 多了这个算法使得 t_hsa  从 16 变成了 44， 最终导致 计算结果变成了 272 ，mtk 给的解决方案如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改前面的第三行代码为如下</span></span><br><span class="line">t_hbp = ALIGN_TO((t_hbp + dsi_params-&gt;horizontal_sync_active) * dsiTmpBufBpp - <span class="number">10</span>, <span class="number">4</span>);</span><br></pre></td></tr></table></figure>
<p>同时对于<strong>行同步型号</strong> hsa，hbp 等都会调用 ALIGN_TO 函数对 4 做取整的操作(mtk 说是和内部设计相关)。因此我们填写参数可以直接将行同步信号填为 4 的整数倍</p>
<h2 id="十八、安卓-11-关闭-lib-库校验"><a href="#十八、安卓-11-关闭-lib-库校验" class="headerlink" title="十八、安卓 11 关闭 lib 库校验"></a>十八、安卓 11 关闭 lib 库校验</h2><p>安卓 9 是默认关闭的，在 Android.mk 中增加</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_CHECK_ELF_FILES := <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h2 id="十九、安卓-9-编译打包-dtbo"><a href="#十九、安卓-9-编译打包-dtbo" class="headerlink" title="十九、安卓 9 编译打包 dtbo"></a>十九、安卓 9 编译打包 dtbo</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make dtboimage -j8 <span class="number">2</span>&gt;&amp;<span class="number">1</span> | tee build.<span class="built_in">log</span></span><br><span class="line">./vendor/mediatek/proprietary/scripts/sign-image/sign_image.sh</span><br></pre></td></tr></table></figure>
<h2 id="二十、mkt-pclk计算"><a href="#二十、mkt-pclk计算" class="headerlink" title="二十、mkt pclk计算"></a>二十、mkt pclk计算</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">params-&gt;dsi.PLL_CLOCK  = (vertical_sync_active + vertical_backporch + vertical_frontporch + FRAME_HEIGHT) * (horizontal_sync_active + horizontal_backporch + horizontal_frontporch + FRAME_WIDTH) * fps * <span class="number">24</span> / (<span class="number">4</span> * <span class="number">2</span>)；</span><br></pre></td></tr></table></figure>
<h2 id="二十一、闪屏debug"><a href="#二十一、闪屏debug" class="headerlink" title="二十一、闪屏debug"></a>二十一、闪屏debug</h2><ol>
<li>排除背光。<br> a、  把背光接固定背光，如果仍然闪屏，说明不是背光的问题；<br>如果屏不闪，说明是背光问题。<br> b、 如果是背光问题，继续分析是否有开AAL功能，如果有开<br>AAL功能，请将AAL功能关闭。如果关闭AAL功能后，屏不闪，说明是<br>AAL导致的屏闪，请提issue给MTK。如果关闭AAL功能后，屏仍然闪，<br>请内部确认贵司是否有在framework层做改动，很多情况是由于改动<br>Framework，绕过LightService直接控制背光结点导致的问题。<br> c、 其实当定位到是背光的问题了，这个时候就可以提问题给<br>MTK了，抓取Mobile log给MTK。</li>
<li>排除ESD。<br> a、如果通过第一步（a）排除说不是背光闪,第二步可以检查是否由于ESD check<br>导致的闪屏。可以先关闭ESD功能，看显示是否仍然会闪。如果关闭ESD功能后，lcm不<br>再闪动，说明是ESD check导致的闪屏。这个时候就可以提把Mobile log抓过来给MTK看了。<br>如果关闭ESD功能后，lcm仍然闪动，说明和ESD check无关。</li>
<li>其他情况。<br>  a、如果背光和ESD都给排除了，这个时候是bug的概率比较大。（常见的情况是待机<br>的时候不定时的闪屏），抓取Mobilelog过来给MTK check。</li>
</ol>
<h2 id="二十二、g-sensor-系统不转"><a href="#二十二、g-sensor-系统不转" class="headerlink" title="二十二、g-sensor 系统不转"></a>二十二、g-sensor 系统不转</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/res/res/values/config.xml</span><br><span class="line">&lt;<span class="keyword">bool</span> name=<span class="string">&quot;config_allowAllRotations&quot;</span>&gt;<span class="literal">true</span>&lt;/<span class="keyword">bool</span>&gt;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>braon-z
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://example.com/2021/06/16/%E9%A1%B9%E7%9B%AE%E6%9D%82%E8%AE%B0/" title="linux驱动-项目杂记">https://example.com/2021/06/16/项目杂记/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E9%A9%B1%E5%8A%A8/" rel="tag"><i class="fa fa-tag"></i> 驱动</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/06/11/linux%E9%A9%B1%E5%8A%A8-pinctrl/" rel="prev" title="pinctrl 子系统">
                  <i class="fa fa-chevron-left"></i> pinctrl 子系统
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/07/03/mtk%E5%B9%B3%E5%8F%B0-lcd%E6%98%BE%E7%A4%BA%E6%8E%A5%E5%8F%A3/" rel="next" title="番外篇-mtk平台logo显示接口">
                  番外篇-mtk平台logo显示接口 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">braon-z</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">477k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">7:13</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/local-search.js"></script>






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"VsC1eQwQ4Xltm5eA9iYGp3VU-gzGzoHsz","appKey":"kyfyE4RWl6aIojedbxcuJa3V","serverURLs":null,"placeholder":"Just go go","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":false,"comment_count":true,"recordIP":false,"enableQQ":false,"requiredFields":[]}, {
      el: '#valine-comments',
      path: "/2021/06/16/%E9%A1%B9%E7%9B%AE%E6%9D%82%E8%AE%B0/",
      serverURLs: "https://vsc1eqwq.api.lncldglobal.com"
    }));
  }, window.Valine);
});
</script>




  <script src="/js/activate-power-mode.min.js"></script>
  <script>
    POWERMODE.colorful = true;
    POWERMODE.shake = false;
    document.body.addEventListener('input', POWERMODE);
  </script>
<div class="moon-menu">
  <div class="moon-menu-items">
    
    <div class="moon-menu-item" onclick="back2bottom()">
      <i class='fa fa-chevron-down'></i>    </div>
    
    <div class="moon-menu-item" onclick="back2top()">
      <i class='fa fa-chevron-up'></i>    </div>
    
  </div>
  <div class="moon-menu-button">
    <svg class="moon-menu-bg">
      <circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle>
      <circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle>
    </svg>
    <div class="moon-menu-content">
      <div class="moon-menu-icon"><i class='fas fa-ellipsis-v'></i></div>
      <div class="moon-menu-text"></div>
    </div>
  </div>
</div><script src="/js/injector.js"></script>
</body>
</html>
