<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":"ture","mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="分析总结pinctrl子系统框架结构，平台 mtk8788 内核版本 kernel-4.4 , 本文所有的分析均基于此版本。">
<meta property="og:type" content="article">
<meta property="og:title" content="pinctrl 子系统">
<meta property="og:url" content="https://example.com/2021/04/01/linux%E9%A9%B1%E5%8A%A8pinctrl/index.html">
<meta property="og:site_name" content="braon-z&#39;s blog">
<meta property="og:description" content="分析总结pinctrl子系统框架结构，平台 mtk8788 内核版本 kernel-4.4 , 本文所有的分析均基于此版本。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-04-01T01:14:17.000Z">
<meta property="article:modified_time" content="2021-04-01T09:24:08.030Z">
<meta property="article:author" content="braon-z">
<meta property="article:tag" content="驱动">
<meta property="article:tag" content="pinctrl">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://example.com/2021/04/01/linux%E9%A9%B1%E5%8A%A8pinctrl/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>pinctrl 子系统 | braon-z's blog</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">braon-z's blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">一、基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81pin"><span class="nav-text">1、pin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81pin-group"><span class="nav-text">2、pin group</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81pinconfig"><span class="nav-text">3、pinconfig</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E5%BC%95%E8%84%9A%E5%A4%8D%E7%94%A8-pinmux"><span class="nav-text">4、引脚复用(pinmux)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5%E3%80%81%E5%BC%95%E8%84%9A%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-text">5、引脚控制器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6%E3%80%81%E5%BC%95%E8%84%9A%E7%8A%B6%E6%80%81-pinctrl-state"><span class="nav-text">6、引脚状态(pinctrl_state)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7%E3%80%81pinctrl"><span class="nav-text">7、pinctrl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8%E3%80%81pinctrl-dev"><span class="nav-text">8、pinctrl_dev</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9%E3%80%81pinctrl-maps"><span class="nav-text">9、pinctrl_maps</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10%E3%80%81pinctrl-dt-map"><span class="nav-text">10、pinctrl_dt_map</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11%E3%80%81pinctrl-maps"><span class="nav-text">11、pinctrl_maps</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%B3%A8%E5%86%8C-pinctrl-dev"><span class="nav-text">二、注册 pinctrl_dev</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#pinctrl-register"><span class="nav-text">pinctrl_register</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#pinctrl-register-pins"><span class="nav-text">pinctrl_register_pins</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pinctrl-register-one-pin"><span class="nav-text">pinctrl_register_one_pin</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%88%9B%E5%BB%BA-pinctrl-%E7%9A%84%E6%97%B6%E6%9C%BA"><span class="nav-text">三、创建 pinctrl 的时机</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E5%88%9B%E5%BB%BA-pinctrl"><span class="nav-text">四、创建 pinctrl</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#pinctrl-get"><span class="nav-text">pinctrl_get</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#find-pinctrl"><span class="nav-text">find_pinctrl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#create-pinctrl"><span class="nav-text">create_pinctrl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pinctrl-dt-to-map"><span class="nav-text">pinctrl_dt_to_map</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dt-to-map-one-config"><span class="nav-text">dt_to_map_one_config</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#get-pinctrl-dev-from-of-node"><span class="nav-text">get_pinctrl_dev_from_of_node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mtk-pctrl-dt-node-to-map"><span class="nav-text">mtk_pctrl_dt_node_to_map</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mtk-pctrl-dt-subnode-to-map"><span class="nav-text">mtk_pctrl_dt_subnode_to_map</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mtk-pctrl-dt-node-to-map-func"><span class="nav-text">mtk_pctrl_dt_node_to_map_func</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mtk-pctrl-is-function-valid"><span class="nav-text">mtk_pctrl_is_function_valid</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pinctrl-utils-add-map-configs"><span class="nav-text">pinctrl_utils_add_map_configs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pinconf-generic-parse-dt-config"><span class="nav-text">pinconf_generic_parse_dt_config</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#parse-dt-cfg"><span class="nav-text">parse_dt_cfg</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pinctrl-utils-reserve-map"><span class="nav-text">pinctrl_utils_reserve_map</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mtk-pctrl-find-group-by-pin"><span class="nav-text">mtk_pctrl_find_group_by_pin</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dt-remember-or-free-map"><span class="nav-text">dt_remember_or_free_map</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pinctrl-register-map"><span class="nav-text">pinctrl_register_map</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#add-setting"><span class="nav-text">add_setting</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#create-state"><span class="nav-text">create_state</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pinmux-map-to-setting"><span class="nav-text">pinmux_map_to_setting</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pinmux-func-name-to-selector"><span class="nav-text">pinmux_func_name_to_selector</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pinctrl-get-group-selector"><span class="nav-text">pinctrl_get_group_selector</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pinconf-map-to-setting"><span class="nav-text">pinconf_map_to_setting</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pin-get-from-name"><span class="nav-text">pin_get_from_name</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E4%BD%BF%E7%94%A8-pinctrl"><span class="nav-text">五、使用 pinctrl</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="braon-z"
      src="/images/wallhaven.jfif">
  <p class="site-author-name" itemprop="name">braon-z</p>
  <div class="site-description" itemprop="description"> 爱一个人，攀一座山，追一次梦<br>不妨大胆一点，有很多事没有答案</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/yourname" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yourname@gmail.com" title="E-Mail → mailto:yourname@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


<div style="">
  <canvas id="canvas" style="width:60%;">当前浏览器不支持canvas，请更换浏览器后再试</canvas>
</div>
<script>
(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //声明canvas的宽高
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //存储时间数据
    var data = [];
    //存储运动的小球
    var balls = [];
    //设置粒子半径
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //存储时间数字，由十位小时、个位小时、冒号、十位分钟、个位分钟、冒号、十位秒钟、个位秒钟这7个数字组成
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*生成点阵数字*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*更新时钟*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //时间发生变化
            if(NewData[i] !== data[i]){
                //将变化的数字值和在data数组中的索引存储在changeNumArray数组中
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //增加小球
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*更新小球状态*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*增加要运动的小球*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*渲染*/
    function render(){
        //重置画布宽度，达到清空画布的效果
        canvas.height = 100;
        //渲染时钟
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //渲染小球
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //更新时钟
        updateDigitTime();
        //更新小球状态
        updateBalls();
        //渲染
        render();
    },50);
}

})();
</script>
        </div>
      </div>
        <div class="back-to-top animated" role="button">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://example.com/2021/04/01/linux%E9%A9%B1%E5%8A%A8pinctrl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/wallhaven.jfif">
      <meta itemprop="name" content="braon-z">
      <meta itemprop="description" content=" 爱一个人，攀一座山，追一次梦<br>不妨大胆一点，有很多事没有答案">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="braon-z's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          pinctrl 子系统
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-04-01 09:14:17 / 修改时间：17:24:08" itemprop="dateCreated datePublished" datetime="2021-04-01T09:14:17+08:00">2021-04-01</time>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Valine：</span>
  
    <a title="valine" href="/2021/04/01/linux%E9%A9%B1%E5%8A%A8pinctrl/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/04/01/linux%E9%A9%B1%E5%8A%A8pinctrl/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>54k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>49 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>分析总结pinctrl子系统框架结构，平台 mtk8788 内核版本 kernel-4.4 , 本文所有的分析均基于此版本。</p>
<a id="more"></a>

<h1 id="一、基本概念"><a href="#一、基本概念" class="headerlink" title="一、基本概念"></a>一、基本概念</h1><p>&nbsp;&nbsp;&nbsp;&nbsp; pinctrl 子系统，我们也可以将其称为引脚控制子系统(pin control subsystem)，和设备模型一样是基本系统之一。 对于一块 soc 的 cpu 上有很多引脚，驱动工程师要做的使其处于我们需要的状态，例如配置某个引脚为 gpio 或者 配置其为 i2c。对于不同的 cpu 其寄存器的地址往往是不一样的，比如 S3C2440 的 gpio 控制器的基地址为 0x53000000，而 mtk 的 gpio 地址为 0x10005000，而且寄存器的地址的位也表示不同的含义，而内核为了兼容不同的芯片于是创建出 pinctrl 子系统，该系统用于<font color=red>将板级信息从内核分离出来</font>，对于真正的寄存器的操作，由 soc 厂家来完成(bsp工程师)，而对于内核来讲将 pin 的功能抽象出来提供统一的接口给驱动工程师使用。</p>
<blockquote>
<p>小贴士：注意区分引脚(pin)和 gpio 的区别，引脚可以复用为gpio，也可以复用为i2c。或者引脚本身就是 gpio , 这由硬件设计决定。</p>
</blockquote>
<h2 id="1、pin"><a href="#1、pin" class="headerlink" title="1、pin"></a>1、pin</h2><p>&nbsp;&nbsp;&nbsp;&nbsp; soc上有大量引脚，每一个引脚使用 pinctrl_pin_desc 来描述</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//内核中用其描述 pin 的信息</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_pin_desc</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> number;  <span class="comment">// pin 引脚号</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name; <span class="comment">// 此引脚的名称，将用来初始化 pin_desc 的 name，如果为空将使用 PIN + number 例如：PIN0</span></span><br><span class="line">    <span class="keyword">void</span> *drv_data;   <span class="comment">// 私有数据</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>例： 当我们的板子上的pin信息如下时</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">     A   B   C   D   E   F   G   H</span><br><span class="line"></span><br><span class="line"><span class="number">8</span>    o   o   o   o   o   o   o   o</span><br><span class="line"></span><br><span class="line"><span class="number">7</span>    o   o   o   o   o   o   o   o</span><br><span class="line"></span><br><span class="line"><span class="number">6</span>    o   o   o   o   o   o   o   o</span><br><span class="line"></span><br><span class="line"><span class="number">5</span>    o   o   o   o   o   o   o   o</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>    o   o   o   o   o   o   o   o</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>    o   o   o   o   o   o   o   o</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>    o   o   o   o   o   o   o   o</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>    o   o   o   o   o   o   o   o</span><br></pre></td></tr></table></figure>
<p>我们使用下面信息描述这块板子的一组引脚</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const <span class="keyword">struct</span> pinctrl_pin_desc foo_pins<span class="literal">[]</span> = &#123;</span><br><span class="line">      <span class="constructor">PINCTRL_PIN(0, <span class="string">&quot;A8&quot;</span>)</span>, <span class="comment">//第 0 个引脚</span></span><br><span class="line">      <span class="constructor">PINCTRL_PIN(1, <span class="string">&quot;B8&quot;</span>)</span>,</span><br><span class="line">      <span class="constructor">PINCTRL_PIN(2, <span class="string">&quot;C8&quot;</span>)</span>,</span><br><span class="line">      ...</span><br><span class="line">      <span class="constructor">PINCTRL_PIN(61, <span class="string">&quot;F1&quot;</span>)</span>,</span><br><span class="line">      <span class="constructor">PINCTRL_PIN(62, <span class="string">&quot;G1&quot;</span>)</span>,</span><br><span class="line">      <span class="constructor">PINCTRL_PIN(63, <span class="string">&quot;H1&quot;</span>)</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>具体怎么描述由具体的bsp工程师来决定</p>
<h2 id="2、pin-group"><a href="#2、pin-group" class="headerlink" title="2、pin group"></a>2、pin group</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;对于引脚的使用，有时候一次性会使用到多个引脚，I2C接口会同时使用2个引脚，SPI接口会同时使用4个引脚。需要以 group 为单位，访问控制多个 pin，这就是 pin groups，pinctrl 子系统提供了获取 pin group 信息的接口</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> pinctrl_ops &#123;</span><br><span class="line">    <span class="comment">// 获取 pin group 的数量</span></span><br><span class="line">    <span class="keyword">int</span> (*get_groups_count) (<span class="keyword">struct</span> pinctrl_dev *pctldev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取使用 selector 作为数组下标指定 group 的名称</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *(*get_group_name) (<span class="keyword">struct</span> pinctrl_dev *pctldev, <span class="keyword">unsigned</span> selector);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 selector 作为数组下标返回指定 group 所用到的 pins 以及 pin 的数量 num_pins</span></span><br><span class="line">    <span class="keyword">int</span> (*get_group_pins) (<span class="keyword">struct</span> pinctrl_dev *pctldev, <span class="keyword">unsigned</span> selector, <span class="keyword">const</span> <span class="keyword">unsigned</span> **pins, <span class="keyword">unsigned</span> *num_pins);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// debug相关</span></span><br><span class="line">    <span class="keyword">void</span> (*pin_dbg_show) (<span class="keyword">struct</span> pinctrl_dev *pctldev, <span class="keyword">struct</span> seq_file *s, <span class="keyword">unsigned</span> offset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于将设备树中的引脚配置转换为对应的 pinctrl_map</span></span><br><span class="line">    <span class="keyword">int</span> (*dt_node_to_map) (<span class="keyword">struct</span> pinctrl_dev *pctldev, <span class="keyword">struct</span> device_node *np_config, <span class="keyword">struct</span> pinctrl_map **map, <span class="keyword">unsigned</span> *num_maps);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于释放前面创建的 pinctrl_map</span></span><br><span class="line">    <span class="keyword">void</span> (*dt_free_map) (<span class="keyword">struct</span> pinctrl_dev *pctldev, <span class="keyword">struct</span> pinctrl_map *map, <span class="keyword">unsigned</span> num_maps);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;需要注意的是该接口除了能够获取 pin group 信息之外,还有一个非常重要的回调接口 dt_node_to_map ，用于<font color=red>将设备树中的引脚配置转换为对应的 pinctrl_map</font>。 该接口的实现通常由soc原厂实现。举个栗子，假设我们有一组用于{0，8，16，24}上的SPI接口的引脚，以及一组用于{24，25}上的I2C接口的引脚。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo_group</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> *pins;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> num_pins;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> spi0_pins[] = &#123; <span class="number">0</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">24</span> &#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> i2c0_pins[] = &#123; <span class="number">24</span>, <span class="number">25</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">foo_group</span> <span class="title">foo_groups</span>[] =</span> &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        .name = <span class="string">&quot;spi0_grp&quot;</span>,</span><br><span class="line">        .pins = spi0_pins,</span><br><span class="line">        .num_pins = ARRAY_SIZE(spi0_pins),</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .name = <span class="string">&quot;i2c0_grp&quot;</span>,</span><br><span class="line">        .pins = i2c0_pins,</span><br><span class="line">        .num_pins = ARRAY_SIZE(i2c0_pins),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">foo_get_groups_count</span><span class="params">(struct pinctrl_dev *pctldev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ARRAY_SIZE(foo_groups);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">foo_get_group_name</span><span class="params">(struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">unsigned</span> selector)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> foo_groups[selector].name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">foo_get_group_pins</span><span class="params">(struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> selector,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">const</span> <span class="keyword">unsigned</span> **pins,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">unsigned</span> *num_pins)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *pins = (<span class="keyword">unsigned</span> *) foo_groups[selector].pins;</span><br><span class="line">    *num_pins = foo_groups[selector].num_pins;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_ops</span> <span class="title">foo_pctrl_ops</span> =</span> &#123;</span><br><span class="line">    .get_groups_count = foo_get_groups_count, <span class="comment">//用于返回 group 的数量</span></span><br><span class="line">    .get_group_name = foo_get_group_name,     <span class="comment">//返回 group 的 name</span></span><br><span class="line">    .get_group_pins = foo_get_group_pins,     <span class="comment">//返回 group 使用到的 pin</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_desc</span> <span class="title">foo_desc</span> =</span> &#123;</span><br><span class="line">       ...</span><br><span class="line">       .pctlops = &amp;foo_pctrl_ops,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="3、pinconfig"><a href="#3、pinconfig" class="headerlink" title="3、pinconfig"></a>3、pinconfig</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;对于每一个引脚都有其特定的电器特性，如上拉、下拉、三态、强推挽输出等用 pinconfig 来描述，pinctrl子系统同样也给出了电器特性的操作函数回调接口。对于电器特性的操作既可以操作一个引脚，也可以操作一组引脚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinconf_ops</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_GENERIC_PINCONF</span></span><br><span class="line">    <span class="keyword">bool</span> is_generic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="comment">//获取一个引脚的 pinconfig</span></span><br><span class="line">    <span class="keyword">int</span> (*pin_config_get) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> pin, <span class="keyword">unsigned</span> <span class="keyword">long</span> *config);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置一个引脚的 pinconfig</span></span><br><span class="line">    <span class="keyword">int</span> (*pin_config_set) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> pin, <span class="keyword">unsigned</span> <span class="keyword">long</span> *configs, <span class="keyword">unsigned</span> num_configs);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取一个 group 描述的 pin 的 pinconfig</span></span><br><span class="line">    <span class="keyword">int</span> (*pin_config_group_get) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> selector, <span class="keyword">unsigned</span> <span class="keyword">long</span> *config);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置一个 group 描述的 pin 的 pinconfig</span></span><br><span class="line">    <span class="keyword">int</span> (*pin_config_group_set) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> selector, <span class="keyword">unsigned</span> <span class="keyword">long</span> *configs, <span class="keyword">unsigned</span> num_configs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//后面这写接口基本用不着，debug相关接口</span></span><br><span class="line">    <span class="keyword">int</span> (*pin_config_dbg_parse_modify) (struct pinctrl_dev *pctldev, <span class="keyword">const</span> <span class="keyword">char</span> *arg, <span class="keyword">unsigned</span> <span class="keyword">long</span> *config);</span><br><span class="line">    <span class="keyword">void</span> (*pin_config_dbg_show) (struct pinctrl_dev *pctldev, struct seq_file *s, <span class="keyword">unsigned</span> offset);</span><br><span class="line">    <span class="keyword">void</span> (*pin_config_group_dbg_show) (struct pinctrl_dev *pctldev, struct seq_file *s, <span class="keyword">unsigned</span> selector);</span><br><span class="line">    <span class="keyword">void</span> (*pin_config_config_dbg_show) (struct pinctrl_dev *pctldev, struct seq_file *s, <span class="keyword">unsigned</span> <span class="keyword">long</span> config);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>同样的举个栗子</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">foo_pin_config_get</span><span class="params">(struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">unsigned</span> offset,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">unsigned</span> <span class="keyword">long</span> *<span class="built_in">config</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">my_conftype</span> <span class="title">conf</span>;</span></span><br><span class="line"></span><br><span class="line">    ... Find setting <span class="keyword">for</span> pin @ offset ...</span><br><span class="line"></span><br><span class="line">    *<span class="built_in">config</span> = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) conf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">foo_pin_config_set</span><span class="params">(struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">unsigned</span> offset,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">config</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">my_conftype</span> *<span class="title">conf</span> =</span> (struct my_conftype *) <span class="built_in">config</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (conf) &#123;</span><br><span class="line">        <span class="keyword">case</span> PLATFORM_X_PULL_UP:</span><br><span class="line">        ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">foo_pin_config_group_get</span> <span class="params">(struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">unsigned</span> selector,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">unsigned</span> <span class="keyword">long</span> *<span class="built_in">config</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">foo_pin_config_group_set</span> <span class="params">(struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">unsigned</span> selector,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">config</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinconf_ops</span> <span class="title">foo_pconf_ops</span> =</span> &#123;</span><br><span class="line">    .pin_config_get = foo_pin_config_get,</span><br><span class="line">    .pin_config_set = foo_pin_config_set,</span><br><span class="line">    .pin_config_group_get = foo_pin_config_group_get,</span><br><span class="line">    .pin_config_group_set = foo_pin_config_group_set,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_desc</span> <span class="title">foo_desc</span> =</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    .confops = &amp;foo_pconf_ops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="4、引脚复用-pinmux"><a href="#4、引脚复用-pinmux" class="headerlink" title="4、引脚复用(pinmux)"></a>4、引脚复用(pinmux)</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;引脚复用这个概念就不做解释了，需要注意的是引脚复用和引脚的电器特性(pinconfig)并不是相同的概念, pinctrl子系统中引脚的复用类型用 <font color=red>func</font> 来描述，例如，某 pin 可以复用为 i2c 也可复用为 spi，那么这个引脚则拥有两个 func。 pinctrl子系统也提供了对应的接口。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinmux_ops</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查某个 pin 是否已作它用，用于管脚复用时的互斥（避免多个功能同时使用某个 pin 而不知道，导致奇怪的错误）。</span></span><br><span class="line">    <span class="keyword">int</span> (*request) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> offset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> (*<span class="built_in">free</span>) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> offset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回 functions 支持的引脚复用的类型的总数，即 func 的数量，例如控制器支持、spi0、i2c0、mmc0 这三种类型则应该返回 3   </span></span><br><span class="line">    <span class="keyword">int</span> (*get_functions_count) (struct pinctrl_dev *pctldev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过数组下标 selector 返回 functions 数组中对应的引脚复用名称，即对应 func 的名称</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *(*get_function_name) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> selector);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过数组下标 selector，返回 functions 数组中对应的 func 以及该 func 的长度</span></span><br><span class="line">    <span class="keyword">int</span> (*get_function_groups) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> selector, <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> **groups, <span class="keyword">unsigned</span> *num_groups);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将指定的  grpoups[group_selector] 设置为指定的 function[func_selector]</span></span><br><span class="line">    <span class="keyword">int</span> (*set_mux) (struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> func_selector, <span class="keyword">unsigned</span> group_selector);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下面是gpio相关</span></span><br><span class="line">    <span class="keyword">int</span> (*gpio_request_enable) (struct pinctrl_dev *pctldev, struct pinctrl_gpio_range *range, <span class="keyword">unsigned</span> offset);</span><br><span class="line">    <span class="keyword">void</span> (*gpio_disable_free) (struct pinctrl_dev *pctldev, struct pinctrl_gpio_range *range, <span class="keyword">unsigned</span> offset);</span><br><span class="line">    <span class="keyword">int</span> (*gpio_set_direction) (struct pinctrl_dev *pctldev, struct pinctrl_gpio_range *range, <span class="keyword">unsigned</span> offset, <span class="keyword">bool</span> input);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> strict;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>引脚复用存在一种情况，{ 0, 8, 16, 24 }这组 pin 和 { 38, 46, 54, 62 } 这组 pin 都可以复用为 spi0 接口。 结合上面的内容举个栗子</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo_group</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> *pins;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> num_pins;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">unsigned</span> spi0_0_pins[] = &#123; <span class="number">0</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">24</span> &#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">unsigned</span> spi0_1_pins[] = &#123; <span class="number">38</span>, <span class="number">46</span>, <span class="number">54</span>, <span class="number">62</span> &#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">unsigned</span> i2c0_pins[] = &#123; <span class="number">24</span>, <span class="number">25</span> &#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">unsigned</span> mmc0_1_pins[] = &#123; <span class="number">56</span>, <span class="number">57</span> &#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">unsigned</span> mmc0_2_pins[] = &#123; <span class="number">58</span>, <span class="number">59</span> &#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">unsigned</span> mmc0_3_pins[] = &#123; <span class="number">60</span>, <span class="number">61</span>, <span class="number">62</span>, <span class="number">63</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">foo_group</span> <span class="title">foo_groups</span>[] =</span> &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        .name = <span class="string">&quot;spi0_0_grp&quot;</span>,</span><br><span class="line">        .pins = spi0_0_pins,</span><br><span class="line">        .num_pins = ARRAY_SIZE(spi0_0_pins),</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .name = <span class="string">&quot;spi0_1_grp&quot;</span>,</span><br><span class="line">        .pins = spi0_1_pins,</span><br><span class="line">        .num_pins = ARRAY_SIZE(spi0_1_pins),</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .name = <span class="string">&quot;i2c0_grp&quot;</span>,</span><br><span class="line">        .pins = i2c0_pins,</span><br><span class="line">        .num_pins = ARRAY_SIZE(i2c0_pins),</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .name = <span class="string">&quot;mmc0_1_grp&quot;</span>,</span><br><span class="line">        .pins = mmc0_1_pins,</span><br><span class="line">        .num_pins = ARRAY_SIZE(mmc0_1_pins),</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .name = <span class="string">&quot;mmc0_2_grp&quot;</span>,</span><br><span class="line">        .pins = mmc0_2_pins,</span><br><span class="line">        .num_pins = ARRAY_SIZE(mmc0_2_pins),</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .name = <span class="string">&quot;mmc0_3_grp&quot;</span>,</span><br><span class="line">        .pins = mmc0_3_pins,</span><br><span class="line">        .num_pins = ARRAY_SIZE(mmc0_3_pins),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">foo_get_groups_count</span><span class="params">(struct pinctrl_dev *pctldev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ARRAY_SIZE(foo_groups);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">foo_get_group_name</span><span class="params">(struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">                       <span class="keyword">unsigned</span> selector)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> foo_groups[selector].name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">foo_get_group_pins</span><span class="params">(struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> selector,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">unsigned</span> ** <span class="keyword">const</span> pins,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">unsigned</span> * <span class="keyword">const</span> num_pins)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *pins = (<span class="keyword">unsigned</span> *) foo_groups[selector].pins;</span><br><span class="line">    *num_pins = foo_groups[selector].num_pins;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_ops</span> <span class="title">foo_pctrl_ops</span> =</span> &#123;</span><br><span class="line">    .get_groups_count = foo_get_groups_count,</span><br><span class="line">    .get_group_name = foo_get_group_name,</span><br><span class="line">    .get_group_pins = foo_get_group_pins,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo_pmx_func</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> *groups;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> num_groups;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> spi0_groups[] = &#123; <span class="string">&quot;spi0_0_grp&quot;</span>, <span class="string">&quot;spi0_1_grp&quot;</span> &#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> i2c0_groups[] = &#123; <span class="string">&quot;i2c0_grp&quot;</span> &#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> mmc0_groups[] = &#123; <span class="string">&quot;mmc0_1_grp&quot;</span>, <span class="string">&quot;mmc0_2_grp&quot;</span>, <span class="string">&quot;mmc0_3_grp&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">foo_pmx_func</span> <span class="title">foo_functions</span>[] =</span> &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        .name = <span class="string">&quot;spi0&quot;</span>,</span><br><span class="line">        .groups = spi0_groups,</span><br><span class="line">        .num_groups = ARRAY_SIZE(spi0_groups),</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .name = <span class="string">&quot;i2c0&quot;</span>,</span><br><span class="line">        .groups = i2c0_groups,</span><br><span class="line">        .num_groups = ARRAY_SIZE(i2c0_groups),</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        .name = <span class="string">&quot;mmc0&quot;</span>,</span><br><span class="line">        .groups = mmc0_groups,</span><br><span class="line">        .num_groups = ARRAY_SIZE(mmc0_groups),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">foo_get_functions_count</span><span class="params">(struct pinctrl_dev *pctldev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ARRAY_SIZE(foo_functions);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">foo_get_fname</span><span class="params">(struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> selector)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> foo_functions[selector].name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">foo_get_groups</span><span class="params">(struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> selector,</span></span></span><br><span class="line"><span class="function"><span class="params">              <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> **groups,</span></span></span><br><span class="line"><span class="function"><span class="params">              <span class="keyword">unsigned</span> * <span class="keyword">const</span> num_groups)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *groups = foo_functions[selector].groups;</span><br><span class="line">    *num_groups = foo_functions[selector].num_groups;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">foo_set_mux</span><span class="params">(struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> selector,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">unsigned</span> group)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u8 regbit = (<span class="number">1</span> &lt;&lt; selector + group);</span><br><span class="line"></span><br><span class="line">    writeb((readb(MUX)|regbit), MUX)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinmux_ops</span> <span class="title">foo_pmxops</span> =</span> &#123;</span><br><span class="line">    .get_functions_count = foo_get_functions_count,</span><br><span class="line">    .get_function_name = foo_get_fname,</span><br><span class="line">    .get_function_groups = foo_get_groups,</span><br><span class="line">    .set_mux = foo_set_mux,</span><br><span class="line">    .strict = <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Pinmux operations are handled by some pin controller */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_desc</span> <span class="title">foo_desc</span> =</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    .pctlops = &amp;foo_pctrl_ops,</span><br><span class="line">    .pmxops = &amp;foo_pmxops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="5、引脚控制器"><a href="#5、引脚控制器" class="headerlink" title="5、引脚控制器"></a>5、引脚控制器</h2><p>引脚控制器是软件上抽象出来的概念，抽象这个结构是为了方便代码的编写，实际硬件并不存在这样的控制器，它包含了下面内容</p>
<ol>
<li>soc 要处理的所有引脚的软件描述</li>
<li>每个/组引脚的电器特性(pinconfig)操作接口</li>
<li>每组引脚的复用(pinmux)操作接口</li>
<li>支持客制化 pinconfig</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引脚控制器描述符，将其注册到引脚控制子系统</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_desc</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;                    <span class="comment">// 引脚控制器的名称</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_pin_desc</span> *<span class="title">pins</span>;</span> <span class="comment">// 引脚描述符数组，描述此引脚控制器处理的所有引脚</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> npins;                  <span class="comment">// 数组中描述符的数量，通常只是上面的 pin 字段的 ARRAY_SIZE()</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_ops</span> *<span class="title">pctlops</span>;</span>   <span class="comment">// 用于获取pin group 信息以及将设备树中的引脚配置(引脚复用以及pinconfig)转换为对应的 pinctrl_map</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinmux_ops</span> *<span class="title">pmxops</span>;</span>     <span class="comment">// pin 复用相关操作，以 group 为单位进行操作</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinconf_ops</span> *<span class="title">confops</span>;</span>   <span class="comment">// 配饰 pin 的 pinconfg(上拉、下拉、输出方式等)，以 pin 或 group 为操作对象</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span>                <span class="comment">// 提供引脚控制器的模块，用于重新计数</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_GENERIC_PINCONF</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> num_custom_params;      <span class="comment">// 客制化引脚支持的 pinconfig 的数量</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinconf_generic_params</span> *<span class="title">custom_params</span>;</span> <span class="comment">// 客制化引脚支持的 pinconfig</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pin_config_item</span> *<span class="title">custom_conf_items</span>;</span>    <span class="comment">// 有关如何在 debugfs 中打印 @params 的信息，必须与 @custom_params 大小相同，即 @num_custom_params</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="6、引脚状态-pinctrl-state"><a href="#6、引脚状态-pinctrl-state" class="headerlink" title="6、引脚状态(pinctrl_state)"></a>6、引脚状态(pinctrl_state)</h2><p>顾名思义引脚状态表示引脚所处的状态。包括两个部分的内容引脚复用(pinmux)、和引脚的电器特性(pinconfig)。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span> <span class="comment">// 挂接到所属的 pinctrl</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;      <span class="comment">// 对应的 pinctrl_map 的 name</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">settings</span>;</span> <span class="comment">//挂接该 state 下所有的 setting</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>对于某一个 pin 它的引脚复用只有一种状态，但是电器特性却有可以有多个，如上拉的同时强推挽输出。他们统一由数据结构 pinctrl_setting 表示。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_setting</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span>       <span class="comment">// 挂接到所属的 state</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">pinctrl_map_type</span> <span class="title">type</span>;</span>  <span class="comment">// 该 setting 的 pinctrl_map 的类型</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_dev</span> *<span class="title">pctldev</span>;</span> <span class="comment">// 该 pinctrl_map 所属的 pinctrl_dev</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *dev_name;        <span class="comment">// 被设置为 pinctrl_map-&gt;dev_name</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_setting_mux</span> <span class="title">mux</span>;</span> <span class="comment">//如果 type 为 PIN_MAP_TYPE_MUX_GROUP 则使用这个结构来保存引脚复用相关参数</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_setting_configs</span> <span class="title">configs</span>;</span> <span class="comment">//如果 type 为 PIN_MAP_TYPE_CONFIGS_PIN 或者  PIN_MAP_TYPE_CONFIGS_GROUP 则使用这个结构来保存引脚电器特性相关参数</span></span><br><span class="line">    &#125; data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_setting_mux</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> group; <span class="comment">// 要用到的  pin group 的数组下标</span></span><br><span class="line">    <span class="keyword">unsigned</span> func;  <span class="comment">// 要用到的 func</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_setting_configs</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> group_or_pin;  <span class="comment">// 要配置的 pin 或者 pin group</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *configs; <span class="comment">// 对应的 pinconfig</span></span><br><span class="line">    <span class="keyword">unsigned</span> num_configs;   <span class="comment">// config 数量</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>一个 setting 只能表示一个引脚复用(pinmux)或者一组电器特性(pinconfig)，怎么进行区分呢？使用 pinctrl_map_type 进行区分。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">pinctrl_map_type</span> &#123;</span></span><br><span class="line">    PIN_MAP_TYPE_INVALID,</span><br><span class="line">    PIN_MAP_TYPE_DUMMY_STATE,</span><br><span class="line">    PIN_MAP_TYPE_MUX_GROUP,      <span class="comment">//表示该 setting 或 pinctrl_map 为引脚复用</span></span><br><span class="line">    PIN_MAP_TYPE_CONFIGS_PIN,    <span class="comment">//表示该 setting 或 pinctrl_map 为pinconfig，这个表示一个 pin</span></span><br><span class="line">    PIN_MAP_TYPE_CONFIGS_GROUP,  <span class="comment">//表示该 setting 或 pinctrl_map 为pinconfig，这个表示一组 pin</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>由此可以知道一个 pinctrl_state 上可以有多个 pinctrl_setting 他们都链接到 pinctrl_state-&gt;settings 链表</p>
<h2 id="7、pinctrl"><a href="#7、pinctrl" class="headerlink" title="7、pinctrl"></a>7、pinctrl</h2><p>pinctrl_state 是对于设备来说的，对于一个设备上的引脚可以有多种 pinctrl_state 供我们选择，而这些 state 由 pinctrl 来进行统一的管理，当前设备下没有pin state，pinctrl也是不会创建的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span>        <span class="comment">// 挂接到全局的 pinctrl_list</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span>           <span class="comment">// 表示所属的 dev</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">states</span>;</span>      <span class="comment">// 挂接该 pinctrl 所有的 state</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">state</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">dt_maps</span>;</span>     <span class="comment">// 用来挂接 pinctrl_dt_map ，该结构管理着 pinctrl 下所有的 pinctrl_map</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">users</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="8、pinctrl-dev"><a href="#8、pinctrl-dev" class="headerlink" title="8、pinctrl_dev"></a>8、pinctrl_dev</h2><p>一般一个 soc 有一个 pinctrl_dev</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_dev</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span>                <span class="comment">// 挂接到全局 pinctrldev_list</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_desc</span> *<span class="title">desc</span>;</span>            <span class="comment">// 引脚控制器描述符</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">radix_tree_root</span> <span class="title">pin_desc_tree</span>;</span> <span class="comment">// 用于挂接所有的 pin_desc, pinctrl_desc-&gt;pins，将转换为 pin_desc 并用 pinctrl_desc-&gt;number 作为索引将其存入 pin_desc_tree</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">gpio_ranges</span>;</span>         <span class="comment">// </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *driver_data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl</span> *<span class="title">p</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">hog_default</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">hog_sleep</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_FS</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">device_root</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="9、pinctrl-maps"><a href="#9、pinctrl-maps" class="headerlink" title="9、pinctrl_maps"></a>9、pinctrl_maps</h2><p>前面我们讲到了 pinctrl_setting 表示引脚复用(pinmux)、和引脚的电器特性(pinconfig)，它是最终的表示形式，在它之前还有个<font color=red>中间结构</font> pinctrl_maps 和它的功能一样，它表示由dts获取的引脚状态。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map</span> &#123;</span> <span class="comment">//三个 name 都是在 pinctrl_dt_to_map 函数获取，在 dt_remember_or_free_map 函数进行初始化。</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *dev_name;       <span class="comment">// 所属 pinctrl 的 name</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;           <span class="comment">// 设备树中的 pinctrl-names 的属性值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当前 pinctrl_map 所属的类别，一般用到的有两大类，复用(mux) 和 pinconfig,</span></span><br><span class="line">    <span class="comment">// 当使用 mux 时使用 pinctrl_map_mux，而 pinconfig 则使用 pinctrl_map_configs</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">pinctrl_map_type</span> <span class="title">type</span>;</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *ctrl_dev_name;  <span class="comment">// 所属的 pinctrl_dev 的 name</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map_mux</span> <span class="title">mux</span>;</span> <span class="comment">// 当 type 为 PIN_MAP_TYPE_MUX_GROUP 则使用这个</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map_configs</span> <span class="title">configs</span>;</span> <span class="comment">// 当 type为 IN_MAP_TYPE_CONFIGS_PIN、PIN_MAP_TYPE_CONFIGS_GROUP 使用这个</span></span><br><span class="line">    &#125; data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map_mux</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *group;       <span class="comment">//使用的 group</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *function;    <span class="comment">//要用到的复用函数名</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map_configs</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *group_or_pin; <span class="comment">// 该 pin 或者pin group的名字</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *configs;   <span class="comment">// 要设置的 pinconfig 数组首地址</span></span><br><span class="line">    <span class="keyword">unsigned</span> num_configs;     <span class="comment">// 数组大小</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="10、pinctrl-dt-map"><a href="#10、pinctrl-dt-map" class="headerlink" title="10、pinctrl_dt_map"></a>10、pinctrl_dt_map</h2><p>用于管理 pinctrl 下的 pinctrl_map ，每一组 pinctrl_map 都会利用这个结构创建一个 dt_map，并将其链接到所属的 pinctrl</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_dt_map</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span>        <span class="comment">// 挂接到所属的 pinctrl</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_dev</span> *<span class="title">pctldev</span>;</span>  <span class="comment">// 指向所属的 pinctrl_dev</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map</span> *<span class="title">map</span>;</span>      <span class="comment">// 指向挂接的 pinctrl_map 数组的首地址</span></span><br><span class="line">    <span class="keyword">unsigned</span> num_maps;            <span class="comment">// 上面 map 的数量</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="11、pinctrl-maps"><a href="#11、pinctrl-maps" class="headerlink" title="11、pinctrl_maps"></a>11、pinctrl_maps</h2><p>管理所有的 pinctrl_map 数组，每一组 pinctrl_map 都会 struct pinctrl_maps *maps_nod, 初始化后将 map_node 其挂接到全局链表pinctrl_maps上</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_maps</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">node</span>;</span>          <span class="comment">// 连接到 pinctrl_maps 全局链表</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map</span> <span class="title">const</span> *<span class="title">maps</span>;</span> <span class="comment">// 指向 pinctrl_map 数组首地址</span></span><br><span class="line">    <span class="keyword">unsigned</span> num_maps;              <span class="comment">// pinctrl_map 的数量</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="二、注册-pinctrl-dev"><a href="#二、注册-pinctrl-dev" class="headerlink" title="二、注册 pinctrl_dev"></a>二、注册 pinctrl_dev</h1><p>pinctrl子系统的注册可以分为两个部分，pinctrl_dev 的注册以及 pinctrl 的注册，pinctrl_dev 用来描述 soc 的 pin 控制信息包括，pin 的名字，编号，数量，pin 的复用调函数，电器特性回调函数等，由于它也是一个设备的抽象因此它也有属于自己的 pinctrl，但大部情况都不会用到(一般不在 pinctrl 根节点描述 pin state)。 </p>
<h2 id="pinctrl-register"><a href="#pinctrl-register" class="headerlink" title="pinctrl_register"></a>pinctrl_register</h2><p>pinctrl_register 做的事情其实也挺简单的，对于大部分soc</p>
<ol>
<li>关联pctldesc与pctldev</li>
<li>对 pctldesc-&gt;pins 数组中的每一个 pinctrl_pin_desc ,  创建一个 pin_desc 并将其挂接到 pin_desc_tree</li>
<li>将 pctldev 挂接进入 pinctrldev_list 全局链表</li>
<li>创建 dbugfs 相关目录</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">struct pinctrl_dev *<span class="title">pinctrl_register</span><span class="params">(struct pinctrl_desc *pctldesc, struct device *dev, <span class="keyword">void</span> *driver_data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_dev</span> *<span class="title">pctldev</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pctldesc)</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line">    <span class="keyword">if</span> (!pctldesc-&gt;name)</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//动态创建 pinctrl_dev</span></span><br><span class="line">    pctldev = kzalloc(<span class="keyword">sizeof</span>(*pctldev), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (pctldev == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        dev_err(dev, <span class="string">&quot;failed to alloc struct pinctrl_dev\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/* Initialize pin control device struct */</span></span><br><span class="line">    pctldev-&gt;owner = pctldesc-&gt;owner;</span><br><span class="line">    pctldev-&gt;desc = pctldesc;</span><br><span class="line">    pctldev-&gt;driver_data = driver_data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化 pin_desc_tree 用于挂接所有的 gpio_desc</span></span><br><span class="line">    INIT_RADIX_TREE(&amp;pctldev-&gt;pin_desc_tree, GFP_KERNEL);</span><br><span class="line">    INIT_LIST_HEAD(&amp;pctldev-&gt;gpio_ranges);</span><br><span class="line">    pctldev-&gt;dev = dev; <span class="comment">//设置所属的dev</span></span><br><span class="line">    mutex_init(&amp;pctldev-&gt;mutex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* check core ops for sanity */</span></span><br><span class="line">    ret = pinctrl_check_ops(pctldev);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        dev_err(dev, <span class="string">&quot;pinctrl ops lacks necessary functions\n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> out_err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If we&#x27;re implementing pinmuxing, check the ops for sanity */</span></span><br><span class="line">    <span class="keyword">if</span> (pctldesc-&gt;pmxops) &#123;</span><br><span class="line">        ret = pinmux_check_ops(pctldev);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">            <span class="keyword">goto</span> out_err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If we&#x27;re implementing pinconfig, check the ops for sanity */</span></span><br><span class="line">    <span class="keyword">if</span> (pctldesc-&gt;confops) &#123;</span><br><span class="line">        ret = pinconf_check_ops(pctldev);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">            <span class="keyword">goto</span> out_err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Register all the pins */</span></span><br><span class="line">    dev_dbg(dev, <span class="string">&quot;try to register %d pins ...\n&quot;</span>,  pctldesc-&gt;npins);</span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">     * 对 pctldesc-&gt;pins 数组中的每一个 pinctrl_pin_desc , </span></span><br><span class="line"><span class="comment">     * 创建一个 pin_desc 并将其挂接到 pin_desc_tree</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ret = pinctrl_register_pins(pctldev, pctldesc-&gt;pins, pctldesc-&gt;npins);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        dev_err(dev, <span class="string">&quot;error during pin registration\n&quot;</span>);</span><br><span class="line">        pinctrl_free_pindescs(pctldev, pctldesc-&gt;pins,</span><br><span class="line">                      pctldesc-&gt;npins);</span><br><span class="line">        <span class="keyword">goto</span> out_err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutex_lock(&amp;pinctrldev_list_mutex);</span><br><span class="line">    list_add_tail(&amp;pctldev-&gt;node, &amp;pinctrldev_list);<span class="comment">//将pctldev 挂接进入 pinctrldev_list 全局链表</span></span><br><span class="line">    mutex_unlock(&amp;pinctrldev_list_mutex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在 pinctrl_list 中查找属于本 dev 的 pinctrl,如果没有则判断当前节点是否存在，pinctrl-*,有则创建 pinctrl，</span></span><br><span class="line">    <span class="comment">// 一般情况是不会在创建 pinctrl_dev 的时候创建pinctrl的</span></span><br><span class="line">    pctldev-&gt;p = pinctrl_get(pctldev-&gt;dev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!IS_ERR(pctldev-&gt;p)) &#123;</span><br><span class="line">        <span class="comment">//查找出 default 的 state</span></span><br><span class="line">        pctldev-&gt;hog_default =</span><br><span class="line">            pinctrl_lookup_state(pctldev-&gt;p, PINCTRL_STATE_DEFAULT);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(pctldev-&gt;hog_default)) &#123;</span><br><span class="line">            dev_dbg(dev, <span class="string">&quot;failed to lookup the default state\n&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//设置pin状态为default状态</span></span><br><span class="line">            <span class="keyword">if</span> (pinctrl_select_state(pctldev-&gt;p,</span><br><span class="line">                        pctldev-&gt;hog_default))</span><br><span class="line">                dev_err(dev,</span><br><span class="line">                    <span class="string">&quot;failed to select default state\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取sleep state</span></span><br><span class="line">        pctldev-&gt;hog_sleep =</span><br><span class="line">            pinctrl_lookup_state(pctldev-&gt;p,</span><br><span class="line">                            PINCTRL_STATE_SLEEP);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(pctldev-&gt;hog_sleep))</span><br><span class="line">            dev_dbg(dev, <span class="string">&quot;failed to lookup the sleep state\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pinctrl_init_device_debugfs(pctldev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pctldev;</span><br><span class="line"></span><br><span class="line">out_err:</span><br><span class="line">    mutex_destroy(&amp;pctldev-&gt;mutex);</span><br><span class="line">    kfree(pctldev);</span><br><span class="line">    <span class="keyword">return</span> ERR_PTR(ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="pinctrl-register-pins"><a href="#pinctrl-register-pins" class="headerlink" title="pinctrl_register_pins"></a>pinctrl_register_pins</h3><p>对 pctldesc-&gt;pins 数组中的每一个 pinctrl_pin_desc , 使用 pins[i].number 作为索引，创建一个 pin_desc 并将其挂接到 pin_desc_tree</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">pinctrl_register_pins</span><span class="params">(struct pinctrl_dev *pctldev, struct pinctrl_pin_desc <span class="keyword">const</span> *pins, <span class="keyword">unsigned</span> num_descs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> i;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_descs; i++) &#123;</span><br><span class="line">        ret = pinctrl_register_one_pin(pctldev,</span><br><span class="line">                           pins[i].number, pins[i].name);</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="pinctrl-register-one-pin"><a href="#pinctrl-register-one-pin" class="headerlink" title="pinctrl_register_one_pin"></a>pinctrl_register_one_pin</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">pinctrl_register_one_pin</span><span class="params">(struct pinctrl_dev *pctldev, <span class="keyword">unsigned</span> number, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pin_desc</span> *<span class="title">pindesc</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 判断是否已经注册了pin_desc</span></span><br><span class="line"><span class="comment">    static inline struct pin_desc *pin_desc_get(struct  pinctrl_dev *pctldev, unsigned int pin)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        return radix_tree_lookup(&amp;pctldev-&gt;pin_desc_tree, pin);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    pindesc = pin_desc_get(pctldev, number);</span><br><span class="line">    <span class="keyword">if</span> (pindesc != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        dev_err(pctldev-&gt;dev, <span class="string">&quot;pin %d already registered\n&quot;</span>, number);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//动态创建一个 pin_desc</span></span><br><span class="line">    pindesc = kzalloc(<span class="keyword">sizeof</span>(*pindesc), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (pindesc == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        dev_err(pctldev-&gt;dev, <span class="string">&quot;failed to alloc struct pin_desc\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set owner */</span></span><br><span class="line">    pindesc-&gt;pctldev = pctldev; <span class="comment">//设置 pin_desc 所属的 pinctrl_dev</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Copy basic pin info */</span></span><br><span class="line">    <span class="comment">//初始化 name 为传入的 pinctrl_pin_desc 中的 name，如果传入的 name 为空则使用 PIN + number 作为 name</span></span><br><span class="line">    <span class="keyword">if</span> (name) &#123;</span><br><span class="line">        pindesc-&gt;name = name;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pindesc-&gt;name = kasprintf(GFP_KERNEL, <span class="string">&quot;PIN%u&quot;</span>, number);</span><br><span class="line">        <span class="keyword">if</span> (pindesc-&gt;name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            kfree(pindesc);</span><br><span class="line">            <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        &#125;</span><br><span class="line">        pindesc-&gt;dynamic_name = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用 number 作为索引将 pindesc 插入到 pctldev-&gt;pin_desc_tree 中</span></span><br><span class="line">    radix_tree_insert(&amp;pctldev-&gt;pin_desc_tree, number, pindesc);</span><br><span class="line">    pr_debug(<span class="string">&quot;registered pin %d (%s) on %s\n&quot;</span>,</span><br><span class="line">         number, pindesc-&gt;name, pctldev-&gt;desc-&gt;name);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="三、创建-pinctrl-的时机"><a href="#三、创建-pinctrl-的时机" class="headerlink" title="三、创建 pinctrl 的时机"></a>三、创建 pinctrl 的时机</h1><p>我们知道 pinctrl state 是针对设备而言的，因此创建 pinctrl 的最佳时机就是内核的设备模型，在设备模型的匹配过程中创建</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">really_probe</span><span class="params">(struct device *dev, struct device_driver *drv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ....</span><br><span class="line">    <span class="comment">/* If using pinctrl, bind pins now before probing */</span></span><br><span class="line">    ret = pinctrl_bind_pins(dev);</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于设备模型在另一篇文章<a target="_blank" rel="noopener" href="https://baron-z.cn/2021/01/03/linux%E9%A9%B1%E5%8A%A8-%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9E%8B-%E9%87%8D%E6%9E%84/#more">linux设备模型</a>有详细的分析, 从注释也可看出在 pinctrl_bind_pins 建立当前设备的 pin state</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">int pinctrl_bind_pins(struct device *dev)</span><br><span class="line">&#123;</span><br><span class="line">    int ret;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">dev</span>-&gt;</span><span class="function"><span class="title">pins</span> = devm_kzalloc(dev, sizeof(*(dev-&gt;</span>pins)), GFP_KERNEL);</span><br><span class="line">    <span class="function"><span class="title">if</span> (!dev-&gt;</span>pins)</span><br><span class="line">        return -ENOMEM;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">dev</span>-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span>p = devm_pinctrl_get(dev); <span class="comment">// 调用 pinctrl_get 扫描当前设备节点下的 pin state 如果有则创建对应的 pinctrl 以及对应的 setting</span></span><br><span class="line">    <span class="function"><span class="title">if</span> (IS_ERR(dev-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span>p)) &#123;</span><br><span class="line">        dev_dbg(dev, <span class="string">&quot;no pinctrl handle\n&quot;</span>);</span><br><span class="line">        <span class="function"><span class="title">ret</span> = PTR_ERR(dev-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span>p);</span><br><span class="line">        goto cleanup_alloc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查找 default 的 state</span></span><br><span class="line">    <span class="function"><span class="title">dev</span>-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span><span class="function"><span class="title">default_state</span> = pinctrl_lookup_state(dev-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span>p,</span><br><span class="line">                    PINCTRL_STATE_DEFAULT);</span><br><span class="line">    <span class="function"><span class="title">if</span> (IS_ERR(dev-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span>default_state)) &#123;</span><br><span class="line">        dev_dbg(dev, <span class="string">&quot;no default pinctrl state\n&quot;</span>);</span><br><span class="line">        ret = <span class="number">0</span>;</span><br><span class="line">        goto cleanup_get;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 查找 init 的 state 如果不存在则设置为 default 否则设置为 init</span></span><br><span class="line">    <span class="function"><span class="title">dev</span>-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span><span class="function"><span class="title">init_state</span> = pinctrl_lookup_state(dev-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span>p,</span><br><span class="line">                    PINCTRL_STATE_INIT);</span><br><span class="line">    <span class="function"><span class="title">if</span> (IS_ERR(dev-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span>init_state)) &#123;</span><br><span class="line">        <span class="comment">/* Not supplying this state is perfectly legal */</span></span><br><span class="line">        dev_dbg(dev, <span class="string">&quot;no init pinctrl state\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="title">ret</span> = pinctrl_select_state(dev-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span>p,</span><br><span class="line">                       <span class="function"><span class="title">dev</span>-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span>default_state);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="function"><span class="title">ret</span> = pinctrl_select_state(dev-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span><span class="function"><span class="title">p</span>, dev-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span>init_state);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        dev_dbg(dev, <span class="string">&quot;failed to activate initial pinctrl state\n&quot;</span>);</span><br><span class="line">        goto cleanup_get;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_PM</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If power management is enabled, we also look for the optional</span></span><br><span class="line"><span class="comment">     * sleep and idle pin states, with semantics as defined in</span></span><br><span class="line"><span class="comment">     * &lt;linux/pinctrl/pinctrl-state.h&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="comment">//查找 sleep 的 state</span></span><br><span class="line">    <span class="function"><span class="title">dev</span>-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span><span class="function"><span class="title">sleep_state</span> = pinctrl_lookup_state(dev-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span>p,</span><br><span class="line">                    PINCTRL_STATE_SLEEP);</span><br><span class="line">    <span class="function"><span class="title">if</span> (IS_ERR(dev-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span>sleep_state))</span><br><span class="line">        <span class="comment">/* Not supplying this state is perfectly legal */</span></span><br><span class="line">        dev_dbg(dev, <span class="string">&quot;no sleep pinctrl state\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">dev</span>-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span><span class="function"><span class="title">idle_state</span> = pinctrl_lookup_state(dev-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span>p,</span><br><span class="line">                    PINCTRL_STATE_IDLE);</span><br><span class="line">    <span class="function"><span class="title">if</span> (IS_ERR(dev-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span>idle_state))</span><br><span class="line">        <span class="comment">/* Not supplying this state is perfectly legal */</span></span><br><span class="line">        dev_dbg(dev, <span class="string">&quot;no idle pinctrl state\n&quot;</span>);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    return <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * If no pinctrl handle or default state was found for this device,</span></span><br><span class="line"><span class="comment">     * let&#x27;s explicitly free the pin container in the device, there is</span></span><br><span class="line"><span class="comment">     * no point in keeping it around.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">cleanup_get:</span><br><span class="line">    <span class="function"><span class="title">devm_pinctrl_put</span>(dev-&gt;</span><span class="function"><span class="title">pins</span>-&gt;</span>p);</span><br><span class="line">cleanup_alloc:</span><br><span class="line">    <span class="function"><span class="title">devm_kfree</span>(dev, dev-&gt;</span>pins);</span><br><span class="line">    <span class="function"><span class="title">dev</span>-&gt;</span>pins = NULL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Only return deferrals */</span></span><br><span class="line">    <span class="keyword">if</span> (ret != -EPROBE_DEFER)</span><br><span class="line">        ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设备模型也给我们提供了对应的数据结构</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PINCTRL</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dev_pin_info</span> *<span class="title">pins</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dev_pin_info</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl</span> *<span class="title">p</span>;</span>   <span class="comment">//该设备的 pinctrl</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">default_state</span>;</span> <span class="comment">//默认的 state</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">init_state</span>;</span>    <span class="comment">//如果有则初始化为这个 state 否则初始化为 default</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PM</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">sleep_state</span>;</span>   <span class="comment">//休眠 state</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">idle_state</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="四、创建-pinctrl"><a href="#四、创建-pinctrl" class="headerlink" title="四、创建 pinctrl"></a>四、创建 pinctrl</h1><p>pinctrl 的创建流程如下</p>
<ol>
<li>根据 dts 中的 pin state 创建出 pinctrl_map</li>
<li>将 pinctrl_map 转换为对应的 pinctrl_setting</li>
</ol>
<h2 id="pinctrl-get"><a href="#pinctrl-get" class="headerlink" title="pinctrl_get"></a>pinctrl_get</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 在 pinctrl_list 链表中查找属于本设备的 pinctrl</span></span><br><span class="line"><span class="comment">// 2. 如果不存在则注册一个 pinctrl</span></span><br><span class="line"><span class="function">struct pinctrl *<span class="title">pinctrl_get</span><span class="params">(struct device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl</span> *<span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (WARN_ON(!dev))</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(-EINVAL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * See if somebody else (such as the device core) has already</span></span><br><span class="line"><span class="comment">     * obtained a handle to the pinctrl for this device. In that case,</span></span><br><span class="line"><span class="comment">     * return another pointer to it.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="comment">//如果 pinctrl 被注册则直接返回</span></span><br><span class="line">    p = find_pinctrl(dev);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        dev_dbg(dev, <span class="string">&quot;obtain a copy of previously claimed pinctrl\n&quot;</span>);</span><br><span class="line">        kref_get(&amp;p-&gt;users);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> create_pinctrl(dev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="find-pinctrl"><a href="#find-pinctrl" class="headerlink" title="find_pinctrl"></a>find_pinctrl</h3><p>在 pinctrl_list 链表中查找属于本设备的 pinctrl，从这里也可以得出结论，pinctrl 和 pinctrl 的连结是通过两者所属的设备来完成的。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">static <span class="keyword">struct</span> pinctrl *find<span class="constructor">_pinctrl(<span class="params">struct</span> <span class="params">device</span> <span class="operator">*</span><span class="params">dev</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">struct</span> pinctrl *p;</span><br><span class="line"></span><br><span class="line">    mutex<span class="constructor">_lock(&amp;<span class="params">pinctrl_list_mutex</span>)</span>;</span><br><span class="line">    <span class="built_in">list</span><span class="constructor">_for_each_entry(<span class="params">p</span>, &amp;<span class="params">pinctrl_list</span>, <span class="params">node</span>)</span></span><br><span class="line">        <span class="keyword">if</span> (p-&gt;dev<span class="operator"> == </span>dev) &#123;</span><br><span class="line">            mutex<span class="constructor">_unlock(&amp;<span class="params">pinctrl_list_mutex</span>)</span>;</span><br><span class="line">            return p;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    mutex<span class="constructor">_unlock(&amp;<span class="params">pinctrl_list_mutex</span>)</span>;</span><br><span class="line">    return NULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="create-pinctrl"><a href="#create-pinctrl" class="headerlink" title="create_pinctrl"></a>create_pinctrl</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct pinctrl *<span class="title">create_pinctrl</span><span class="params">(struct device *dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl</span> *<span class="title">p</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *devname;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_maps</span> *<span class="title">maps_node</span>;</span> <span class="comment">//map索引</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map</span> <span class="title">const</span> *<span class="title">map</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * create the state cookie holder struct pinctrl for each</span></span><br><span class="line"><span class="comment">     * mapping, this is what consumers will get when requesting</span></span><br><span class="line"><span class="comment">     * a pin control handle with pinctrl_get()</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//创建 pinctrl</span></span><br><span class="line">    p = kzalloc(<span class="keyword">sizeof</span>(*p), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        dev_err(dev, <span class="string">&quot;failed to alloc struct pinctrl\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p-&gt;dev = dev; <span class="comment">//初始化所属的dev</span></span><br><span class="line">    INIT_LIST_HEAD(&amp;p-&gt;states); <span class="comment">//初始化 states 链表</span></span><br><span class="line">    INIT_LIST_HEAD(&amp;p-&gt;dt_maps); <span class="comment">//初始化 dt_maps链表</span></span><br><span class="line"></span><br><span class="line">    ret = pinctrl_dt_to_map(p);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        kfree(p);</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(ret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	devname = dev_name(dev);</span><br><span class="line"></span><br><span class="line">    mutex_lock(&amp;pinctrl_maps_mutex);</span><br><span class="line">    <span class="comment">/* Iterate over the pin control maps to locate the right ones */</span></span><br><span class="line">    <span class="comment">//对于 maps_node 中的每一组属于该设备的 map 调用 add_setting，将对应的 pinctrl_map 转换为 pinctrl_setting</span></span><br><span class="line">    for_each_maps(maps_node, i, <span class="built_in">map</span>) &#123;</span><br><span class="line">        <span class="comment">/* Map must be for this device */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(<span class="built_in">map</span>-&gt;dev_name, devname))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">	</span><br><span class="line">        ret = add_setting(p, <span class="built_in">map</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * At this point the adding of a setting may:</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * - Defer, if the pinctrl device is not yet available</span></span><br><span class="line"><span class="comment">         * - Fail, if the pinctrl device is not yet available,</span></span><br><span class="line"><span class="comment">         *   AND the setting is a hog. We cannot defer that, since</span></span><br><span class="line"><span class="comment">         *   the hog will kick in immediately after the device</span></span><br><span class="line"><span class="comment">         *   is registered.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * If the error returned was not -EPROBE_DEFER then we</span></span><br><span class="line"><span class="comment">         * accumulate the errors to see if we end up with</span></span><br><span class="line"><span class="comment">         * an -EPROBE_DEFER later, as that is the worst case.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (ret == -EPROBE_DEFER) &#123;</span><br><span class="line">            pinctrl_free(p, <span class="literal">false</span>);</span><br><span class="line">            mutex_unlock(&amp;pinctrl_maps_mutex);</span><br><span class="line">            <span class="keyword">return</span> ERR_PTR(ret);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutex_unlock(&amp;pinctrl_maps_mutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* If some other error than deferral occured, return here */</span></span><br><span class="line">        pinctrl_free(p, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">return</span> ERR_PTR(ret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kref_init(&amp;p-&gt;users);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Add the pinctrl handle to the global list */</span></span><br><span class="line">    mutex_lock(&amp;pinctrl_list_mutex);</span><br><span class="line">    list_add_tail(&amp;p-&gt;node, &amp;pinctrl_list);</span><br><span class="line">    mutex_unlock(&amp;pinctrl_list_mutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="pinctrl-dt-to-map"><a href="#pinctrl-dt-to-map" class="headerlink" title="pinctrl_dt_to_map"></a>pinctrl_dt_to_map</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 从state = 0开始，递增判断 pinctrl 所属的设备的的设备树节点是否存在 pinctrl-state ，不存在则直接返回</span></span><br><span class="line"><span class="comment">// 2. 如果存在则使用 pinctrl- 后面的参数作为索引，例如：pinctrl-0 则使用 0 作为 index 获取 pinctrl-names 属性的值 statename</span></span><br><span class="line"><span class="comment">// 3. 遍历 pinctrl-0 属性的值所表示的节点，在 pinctrldev_list 中查找属于该节点的父节点的 pinctrl_dev, </span></span><br><span class="line"><span class="comment">//    然后调用 pctldev-&gt;desc-&gt;pctlops-&gt;dt_node_to_map(pctldev, np_config, &amp;map, &amp;num_maps); 函数, 创建出需要的  pinctrl_map </span></span><br><span class="line"><span class="comment">// 4. 进一步初始化 pinctrl_map</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pinctrl_dt_to_map</span><span class="params">(struct pinctrl *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np</span> =</span> p-&gt;dev-&gt;of_node; <span class="comment">//获取到 pinctrl 所属的设备的设备节点</span></span><br><span class="line">    <span class="keyword">int</span> state, ret;</span><br><span class="line">    <span class="keyword">char</span> *propname;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">property</span> *<span class="title">prop</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *statename;</span><br><span class="line">    <span class="keyword">const</span> __be32 *<span class="built_in">list</span>;</span><br><span class="line">    <span class="keyword">int</span> size, config;</span><br><span class="line">    phandle phandle;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np_config</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* CONFIG_OF enabled, p-&gt;dev not instantiated from DT */</span></span><br><span class="line">    <span class="keyword">if</span> (!np) &#123;</span><br><span class="line">        <span class="keyword">if</span> (of_have_populated_dt())</span><br><span class="line">            dev_dbg(p-&gt;dev,</span><br><span class="line">                <span class="string">&quot;no of_node; not parsing pinctrl DT\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We may store pointers to property names within the node */</span></span><br><span class="line">    of_node_get(np); <span class="comment">// 增加节点引用计数</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/*  //dts 示例</span></span><br><span class="line"><span class="comment">    * &amp;lcm &#123;//                第0个state         第1个state</span></span><br><span class="line"><span class="comment">    *     pinctrl-names = &quot;lcm_1v8_en_low&quot; , &quot;lcm_1v8_en_high&quot;;</span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    *     pinctrl-0 = &lt;&amp;gpio_lcm_pwr1v8_low&gt;;  //----这是一个 pinctrl_state</span></span><br><span class="line"><span class="comment">    *     pinctrl-1 = &lt;&amp;gpio_lcm_pwr1v8_high&gt;; //----这是一个 pinctrl_state</span></span><br><span class="line"><span class="comment">    *     status = &quot;okay&quot;;</span></span><br><span class="line"><span class="comment">    * &#125;;</span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    * &amp;pio &#123; </span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    *     gpio_lcm_pwr1v8_low: gpio_lcm_pwr1v8_low &#123; //----这是一组 pinctrl_map </span></span><br><span class="line"><span class="comment">    *         pins_cmd_dat &#123;</span></span><br><span class="line"><span class="comment">    *             pinmux = &lt;PINMUX_GPIO5__FUNC_GPIO5&gt;; //这被解析到一个 pinctrl_map-&gt;data-&gt;mux</span></span><br><span class="line"><span class="comment">    *             slew-rate = &lt;1&gt;;                     //这被解析到一个 pinctrl_map-&gt;data-&gt;configs   </span></span><br><span class="line"><span class="comment">    *             output-low;                          //这被解析到一个 pinctrl_map-&gt;data-&gt;configs</span></span><br><span class="line"><span class="comment">    *         &#125;; //于是这里将创建有3个 pinctrl_map 的数组</span></span><br><span class="line"><span class="comment">    *     &#125;;</span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    *     gpio_lcm_pwr1v8_high: gpio_lcm_pwr1v8_high &#123; //----这是一组 pinctrl_map </span></span><br><span class="line"><span class="comment">    *         pins_cmd_dat &#123;</span></span><br><span class="line"><span class="comment">    *             pinmux = &lt;PINMUX_GPIO5__FUNC_GPIO5&gt;; //这被解析到一个 pinctrl_map-&gt;data-&gt;mux</span></span><br><span class="line"><span class="comment">    *             output-high;                         //这被解析到一个 pinctrl_map-&gt;data-&gt;configs</span></span><br><span class="line"><span class="comment">    *         &#125;; /于是这里将创建有2个 pinctrl_map 的数组</span></span><br><span class="line"><span class="comment">    * &#125;;</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* For each defined state ID */</span></span><br><span class="line">    <span class="keyword">for</span> (state = <span class="number">0</span>; ; state++) &#123;</span><br><span class="line">        </span><br><span class="line">        propname = kasprintf(GFP_KERNEL, <span class="string">&quot;pinctrl-%d&quot;</span>, state);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 通过 propname 获得对应设备树中的属性，pinctrl-0 属性的值为设备节点的引用，即为 phandle 属性。</span></span><br><span class="line">        prop = of_find_property(np, propname, &amp;size);</span><br><span class="line">        kfree(propname);</span><br><span class="line">        <span class="keyword">if</span> (!prop)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="built_in">list</span> = prop-&gt;value;    <span class="comment">// 获取到属性值</span></span><br><span class="line">        size /= <span class="keyword">sizeof</span>(*<span class="built_in">list</span>); <span class="comment">// 获取属性值的个数，即上面dts中的 &lt;&amp;gpio_lcm_pwr1v8_low&gt; 的个数明显这里只有一个</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过 pinctrl-names, 获取对应的 state 的名字，一般情况下 state = 0 的名字为 default</span></span><br><span class="line">        <span class="comment">// 这里可以看出，pinctrl-names 属性的值，和 pinctrl-* 是一一对应的。</span></span><br><span class="line">        ret = of_property_read_string_index(np, <span class="string">&quot;pinctrl-names&quot;</span>, state, &amp;statename);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If not, statename is just the integer state ID. But rather</span></span><br><span class="line"><span class="comment">         * than dynamically allocate it and have to free it later,</span></span><br><span class="line"><span class="comment">         * just point part way into the property name for the string.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">/* strlen(&quot;pinctrl-&quot;) == 8 */</span></span><br><span class="line">            statename = prop-&gt;name + <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* For every referenced pin configuration node in it */</span></span><br><span class="line">        <span class="keyword">for</span> (config = <span class="number">0</span>; config &lt; size; config++) &#123; <span class="comment">//</span></span><br><span class="line">           <span class="comment">//将属性值转化为 pandle，只是保证数据的大小端一致性</span></span><br><span class="line">            phandle = be32_to_cpup(<span class="built_in">list</span>++);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Look up the pin configuration node */</span></span><br><span class="line">            <span class="comment">//通过 phandle 获取到其所在的设备节点 gpio_lcm_pwr1v8_low</span></span><br><span class="line">            np_config = of_find_node_by_phandle(phandle);</span><br><span class="line">            <span class="keyword">if</span> (!np_config) &#123;</span><br><span class="line">                dev_err(p-&gt;dev,</span><br><span class="line">                    <span class="string">&quot;prop %s index %i invalid phandle\n&quot;</span>,</span><br><span class="line">                    prop-&gt;name, config);</span><br><span class="line">                ret = -EINVAL;</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Parse the node */</span></span><br><span class="line">            <span class="comment">// 在 pinctrldev_list 中查找属于 gpio_lcm_pwr1v8_low 所在节点根节点的中的 pinctrl_dev, </span></span><br><span class="line">            <span class="comment">// 然后调用 pctldev-&gt;desc-&gt;pctlops-&gt;dt_node_to_map(pctldev, np_config, &amp;map, &amp;num_maps); 函数, 创建出需要的 pinctrl_map</span></span><br><span class="line">            <span class="comment">// 进一步初始化 pinctrl_map ，创建 pinctrl_dt_map 初始化之后 将，dt_map 挂接到所属的 pinctrl</span></span><br><span class="line">            <span class="comment">// 检查 pinctrl_map 的合法性，动态创建一个 maps_node 初始化之后挂接到全局  pinctrl_maps</span></span><br><span class="line">            ret = dt_to_map_one_config(p, statename, np_config);</span><br><span class="line">            of_node_put(np_config);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err:</span><br><span class="line">    pinctrl_dt_free_maps(p);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="dt-to-map-one-config"><a href="#dt-to-map-one-config" class="headerlink" title="dt_to_map_one_config"></a>dt_to_map_one_config</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 pinctrldev_list 中查找属于 gpio_lcm_pwr1v8_low 所在节点根节点的中的 pinctrl_dev, </span></span><br><span class="line"><span class="comment">// 然后调用 pctldev-&gt;desc-&gt;pctlops-&gt;dt_node_to_map(pctldev, np_config, &amp;map, &amp;num_maps); 函数, 创建出需要的 pinctrl_map</span></span><br><span class="line"><span class="comment">// 进一步初始化 pinctrl_map ，创建 pinctrl_dt_map 初始化之后 将，dt_map 挂接到所属的 pinctrl</span></span><br><span class="line"><span class="comment">// 检查 pinctrl_map 的合法性，动态创建一个 maps_node 初始化之后挂接到全局  pinctrl_maps</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">dt_to_map_one_config</span><span class="params">(struct pinctrl *p, <span class="keyword">const</span> <span class="keyword">char</span> *statename, struct device_node *np_config)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np_pctldev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_dev</span> *<span class="title">pctldev</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map</span> *<span class="title">map</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> num_maps;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Find the pin controller containing np_config */</span></span><br><span class="line">    np_pctldev = of_node_get(np_config); <span class="comment">//增加节点引用计数</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="comment">//获取 np_pctldev 所在的设备节点的父节点，即pinctrl-0 指向的设备节点 gpio_lcm_pwr1v8_low 的父节点，即 pintrl 根节点</span></span><br><span class="line">        np_pctldev = of_get_next_parent(np_pctldev);</span><br><span class="line">        <span class="keyword">if</span> (!np_pctldev || of_node_is_root(np_pctldev)) &#123;</span><br><span class="line">            dev_info(p-&gt;dev, <span class="string">&quot;could not find pctldev for node %s, deferring probe\n&quot;</span>,</span><br><span class="line">                np_config-&gt;full_name);</span><br><span class="line">            of_node_put(np_pctldev);</span><br><span class="line">            <span class="comment">/* OK let&#x27;s just assume this will appear later then */</span></span><br><span class="line">            <span class="keyword">return</span> -EPROBE_DEFER;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获取 pintrl 根节点的 pinctrl_dev</span></span><br><span class="line">        pctldev = get_pinctrl_dev_from_of_node(np_pctldev);</span><br><span class="line">        <span class="keyword">if</span> (pctldev) <span class="comment">//如果存在推出循环</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">/* Do not defer probing of hogs (circular loop) */</span></span><br><span class="line">        <span class="keyword">if</span> (np_pctldev == p-&gt;dev-&gt;of_node) &#123;</span><br><span class="line">            of_node_put(np_pctldev);</span><br><span class="line">            <span class="keyword">return</span> -ENODEV;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    of_node_put(np_pctldev); <span class="comment">//减少节点引用计数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Call pinctrl driver to parse device tree node, and</span></span><br><span class="line"><span class="comment">     * generate mapping table entries</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="comment">//获取其 pinctrl_ops </span></span><br><span class="line">    ops = pctldev-&gt;desc-&gt;pctlops;</span><br><span class="line">    <span class="keyword">if</span> (!ops-&gt;dt_node_to_map) &#123;</span><br><span class="line">        dev_err(p-&gt;dev, <span class="string">&quot;pctldev %s doesn&#x27;t support DT\n&quot;</span>,</span><br><span class="line">            dev_name(pctldev-&gt;dev));</span><br><span class="line">        <span class="keyword">return</span> -ENODEV;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 调用 dt_node_to_map 函数， 对于 gpio_lcm_pwr1v8_low 的所有子节点调用 mtk_pctrl_dt_subnode_to_map</span></span><br><span class="line">    <span class="comment">// 从设备树中获取对应的配置，并创建对应的 pinctrl_map</span></span><br><span class="line">    ret = ops-&gt;dt_node_to_map(pctldev, np_config, &amp;<span class="built_in">map</span>, &amp;num_maps);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Stash the mapping table chunk away for later use */</span></span><br><span class="line">	<span class="comment">// 进一步初始化 pinctrl_map ，创建 pinctrl_dt_map 初始化之后 将，dt_map 挂接到所属的 pinctrl</span></span><br><span class="line">    <span class="comment">// 检查 pinctrl_map 的合法性，动态创建一个 maps_node 初始化之后挂接到全局  pinctrl_maps</span></span><br><span class="line">    <span class="keyword">return</span> 	dt_remember_or_free_map(p, statename, pctldev, <span class="built_in">map</span>, num_maps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="get-pinctrl-dev-from-of-node"><a href="#get-pinctrl-dev-from-of-node" class="headerlink" title="get_pinctrl_dev_from_of_node"></a>get_pinctrl_dev_from_of_node</h3><p>在 pinctrldev_list 中查找属于当前节点的 pinctrl_dev,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct pinctrl_dev *<span class="title">get_pinctrl_dev_from_of_node</span><span class="params">(struct device_node *np)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_dev</span> *<span class="title">pctldev</span>;</span></span><br><span class="line"></span><br><span class="line">    mutex_lock(&amp;pinctrldev_list_mutex);</span><br><span class="line"></span><br><span class="line">    list_for_each_entry(pctldev, &amp;pinctrldev_list, node)</span><br><span class="line">        <span class="keyword">if</span> (pctldev-&gt;dev-&gt;of_node == np) &#123;</span><br><span class="line">            mutex_unlock(&amp;pinctrldev_list_mutex);</span><br><span class="line">            <span class="keyword">return</span> pctldev;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    mutex_unlock(&amp;pinctrldev_list_mutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="mtk-pctrl-dt-node-to-map"><a href="#mtk-pctrl-dt-node-to-map" class="headerlink" title="mtk_pctrl_dt_node_to_map"></a>mtk_pctrl_dt_node_to_map</h3><p>对于 np_config(就是前面的 gpio_lcm_pwr1v8_low)的所有子节点调用 mtk_pctrl_dt_subnode_to_map, 从设备树中获取对应的配置，并创建对应的 pinctrl_map</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mtk_pctrl_dt_node_to_map</span><span class="params">(struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">                 struct device_node *np_config,</span></span></span><br><span class="line"><span class="function"><span class="params">                 struct pinctrl_map **<span class="built_in">map</span>, <span class="keyword">unsigned</span> *num_maps)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> reserved_maps;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    *<span class="built_in">map</span> = <span class="literal">NULL</span>;</span><br><span class="line">    *num_maps = <span class="number">0</span>; <span class="comment">//表示 pinctrl_map 的数组下标</span></span><br><span class="line">    reserved_maps = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* </span></span><br><span class="line"><span class="comment">    * 对于 gpio_lcm_pwr1v8_low 的所有子节点调用 mtk_pctrl_dt_subnode_to_map,</span></span><br><span class="line"><span class="comment">    * 从设备树中获取对应的配置，并创建对应的 pinctrl_map</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    for_each_child_of_node(np_config, np) &#123;</span><br><span class="line">        ret = mtk_pctrl_dt_subnode_to_map(pctldev, np, <span class="built_in">map</span>,</span><br><span class="line">                &amp;reserved_maps, num_maps);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            pinctrl_utils_dt_free_map(pctldev, *<span class="built_in">map</span>, *num_maps);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="mtk-pctrl-dt-subnode-to-map"><a href="#mtk-pctrl-dt-subnode-to-map" class="headerlink" title="mtk_pctrl_dt_subnode_to_map"></a>mtk_pctrl_dt_subnode_to_map</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//从设备树中获取对应的配置，并创建对应的 pinctrl_map</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mtk_pctrl_dt_subnode_to_map</span><span class="params">(struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">                      struct device_node *node,</span></span></span><br><span class="line"><span class="function"><span class="params">                      struct pinctrl_map **<span class="built_in">map</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">unsigned</span> *reserved_maps,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">unsigned</span> *num_maps)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">property</span> *<span class="title">pins</span>;</span></span><br><span class="line">    u32 pinfunc, pin, func;</span><br><span class="line">    <span class="keyword">int</span> num_pins, num_funcs, maps_per_pin;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *configs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> num_configs;</span><br><span class="line">    <span class="keyword">bool</span> has_config = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> i, err;</span><br><span class="line">    <span class="keyword">unsigned</span> reserve = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mtk_pinctrl_group</span> *<span class="title">grp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mtk_pinctrl</span> *<span class="title">pctl</span> =</span> pinctrl_dev_get_drvdata(pctldev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取 pin 的属性，从这里可以知道本平台兼容两种 pin 属性的写法，</span></span><br><span class="line">    <span class="comment">// 一种是 pinmux，一种是 pins</span></span><br><span class="line">    pins = of_find_property(node, <span class="string">&quot;pinmux&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!pins) &#123;</span><br><span class="line">        pins = of_find_property(node, <span class="string">&quot;pins&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (!pins) &#123;</span><br><span class="line">        dev_err(pctl-&gt;dev, <span class="string">&quot;missing pins property in node %s .\n&quot;</span>,</span><br><span class="line">                node-&gt;name);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在设备节点查找 dt_params 以及 pctldev-&gt;desc-&gt;custom_params 中的支持的 pinconfig</span></span><br><span class="line">    <span class="comment">// 如果存在则按顺寻将 params 和 custom_params 可配置的 pinconfig 参数 pin_config_param </span></span><br><span class="line">    <span class="comment">// 以及配置的默认状态 default_value 组合后,存入 configs 指向的内存空间, 并返回 configs 的长度</span></span><br><span class="line">    err = pinconf_generic_parse_dt_config(node, pctldev, &amp;configs,</span><br><span class="line">        &amp;num_configs);</span><br><span class="line">    <span class="keyword">if</span> (err)</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (num_configs)</span><br><span class="line">        has_config = <span class="number">1</span>; <span class="comment">//是否需要配置 configs</span></span><br><span class="line"></span><br><span class="line">    num_pins = pins-&gt;length / <span class="keyword">sizeof</span>(u32); <span class="comment">//获取 dts 配置的 pin 的数量</span></span><br><span class="line">    num_funcs = num_pins; <span class="comment">//计算出 func 的数量</span></span><br><span class="line">    maps_per_pin = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (num_funcs)</span><br><span class="line">        maps_per_pin++; <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (has_config &amp;&amp; num_pins &gt;= <span class="number">1</span>) <span class="comment">//如果有配置的 config 以及需要配置的 pin &gt;= 1</span></span><br><span class="line">        maps_per_pin++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!num_pins || !maps_per_pin) &#123;</span><br><span class="line">        err = -EINVAL;</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reserve = num_pins * maps_per_pin; <span class="comment">//计算需要的 pinctrl_map 的数量</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 重新申请一片大小为 *num_maps + reserve 的内存空间，并将 map 的值复制过去，</span></span><br><span class="line">    <span class="comment">// reserved_maps 之后的内存空间初始化为 0, 同时更新 pinctrl_map 的数量 reserved_maps</span></span><br><span class="line">    <span class="comment">// num_maps 表示有效的 pinctrl_map 的数量</span></span><br><span class="line">    err = pinctrl_utils_reserve_map(pctldev, <span class="built_in">map</span>,</span><br><span class="line">            reserved_maps, num_maps, reserve);</span><br><span class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_pins; i++) &#123;</span><br><span class="line">        err = of_property_read_u32_index(node, <span class="string">&quot;pinmux&quot;</span>,</span><br><span class="line">                i, &amp;pinfunc);</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            err = of_property_read_u32_index(node, <span class="string">&quot;pins&quot;</span>,</span><br><span class="line">                i, &amp;pinfunc);</span><br><span class="line">            <span class="keyword">if</span> (err)</span><br><span class="line">                <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        pin = MTK_GET_PIN_NO(pinfunc); <span class="comment">//获取配置的 pin 脚</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获取该引脚对应的复用状态，复用状态在 include/dt-bindings/pinctrl/mt6771-pinfunc.h 文件中配置</span></span><br><span class="line">        func = MTK_GET_PIN_FUNC(pinfunc);  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pin &gt;= pctl-&gt;devdata-&gt;npins ||</span><br><span class="line">                func &gt;= ARRAY_SIZE(mtk_gpio_functions)) &#123;</span><br><span class="line">            dev_err(pctl-&gt;dev, <span class="string">&quot;invalid pins value.\n&quot;</span>);</span><br><span class="line">            err = -EINVAL;</span><br><span class="line">            <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//返回该 pin 所对应的 group</span></span><br><span class="line">        grp = mtk_pctrl_find_group_by_pin(pctl, pin);</span><br><span class="line">        <span class="keyword">if</span> (!grp) &#123;</span><br><span class="line">            dev_err(pctl-&gt;dev, <span class="string">&quot;unable to match pin %d to group\n&quot;</span>,</span><br><span class="line">                    pin);</span><br><span class="line">            err = -EINVAL;</span><br><span class="line">            <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 初始化 pinctrl_map 的 type 为 PIN_MAP_TYPE_MUX_GROUP，</span></span><br><span class="line">        <span class="comment">// 初始化 data.mux.group 为 grp-&gt;name;</span></span><br><span class="line">        <span class="comment">// 初始化 ata.mux.function 为 mtk_gpio_functions[fnum];</span></span><br><span class="line">        err = mtk_pctrl_dt_node_to_map_func(pctl, pin, func, grp, <span class="built_in">map</span>,</span><br><span class="line">                reserved_maps, num_maps);</span><br><span class="line">        <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (has_config) &#123; <span class="comment">//如果有 config 则设置 config 对应的 pinctrl_map</span></span><br><span class="line">            err = pinctrl_utils_add_map_configs(pctldev, <span class="built_in">map</span>,</span><br><span class="line">                    reserved_maps, num_maps, grp-&gt;name,</span><br><span class="line">                    configs, num_configs,</span><br><span class="line">                    PIN_MAP_TYPE_CONFIGS_GROUP);</span><br><span class="line">            <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">goto</span> <span class="built_in">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span>:</span><br><span class="line">    kfree(configs);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MTK_PIN_NO(x) ((x) &lt;&lt; 8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MTK_GET_PIN_NO(x) ((x) &gt;&gt; 8)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MTK_GET_PIN_FUNC(x) ((x) &amp; 0xf)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINMUX_GPIO0__FUNC_GPIO0 (MTK_PIN_NO(0) | 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINMUX_GPIO0__FUNC_MRG_SYNC (MTK_PIN_NO(0) | 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINMUX_GPIO0__FUNC_PCM0_SYNC (MTK_PIN_NO(0) | 2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINMUX_GPIO0__FUNC_TP_GPIO0_AO (MTK_PIN_NO(0) | 3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINMUX_GPIO0__FUNC_SRCLKENAI0 (MTK_PIN_NO(0) | 4)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINMUX_GPIO0__FUNC_SCP_SPI2_CS (MTK_PIN_NO(0) | 5)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINMUX_GPIO0__FUNC_I2S3_MCK (MTK_PIN_NO(0) | 6)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PINMUX_GPIO0__FUNC_SPI2_CSB (MTK_PIN_NO(0) | 7)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="mtk-pctrl-dt-node-to-map-func"><a href="#mtk-pctrl-dt-node-to-map-func" class="headerlink" title="mtk_pctrl_dt_node_to_map_func"></a>mtk_pctrl_dt_node_to_map_func</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化 pinctrl_map 的 type 为 PIN_MAP_TYPE_MUX_GROUP，</span></span><br><span class="line"><span class="comment">// 初始化 data.mux.group 为 grp-&gt;name;</span></span><br><span class="line"><span class="comment">// 初始化 ata.mux.function 为 mtk_gpio_functions[fnum];</span></span><br><span class="line"><span class="keyword">static</span> int mtk_pctrl_dt_node_to_map_func(<span class="class"><span class="keyword">struct</span> <span class="title">mtk_pinctrl</span></span> *pctl,</span><br><span class="line">        <span class="built_in">u32</span> pin, <span class="built_in">u32</span> fnum, <span class="class"><span class="keyword">struct</span> <span class="title">mtk_pinctrl_group</span></span> *grp,</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map</span></span> **map, unsigned *reserved_maps,</span><br><span class="line">        unsigned *num_maps)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">bool</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*num_maps == *reserved_maps)</span><br><span class="line">        <span class="keyword">return</span> -ENOSPC;</span><br><span class="line"></span><br><span class="line">    (*map)[*num_maps].<span class="keyword">type</span> = PIN_MAP_TYPE_MUX_GROUP; <span class="comment">// 初始化 pinctrl_map 的 type</span></span><br><span class="line">    (*map)[*num_maps].data.mux.group = grp-&gt;name; <span class="comment">//初始化 data.mux.group</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//该 pin 的引脚复用 fnum 有效性检查</span></span><br><span class="line">    ret = mtk_pctrl_is_function_valid(pctl, pin, fnum);</span><br><span class="line">    <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">        dev_err(pctl-&gt;dev, <span class="string">&quot;invalid function %d on pin %d .\n&quot;</span>,</span><br><span class="line">                fnum, pin);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//初始化对应 pin 脚复用的函数名</span></span><br><span class="line">    (*map)[*num_maps].data.mux.function = mtk_gpio_functions[fnum];</span><br><span class="line">    (*num_maps)++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="mtk-pctrl-is-function-valid"><a href="#mtk-pctrl-is-function-valid" class="headerlink" title="mtk_pctrl_is_function_valid"></a>mtk_pctrl_is_function_valid</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//该 pin_num 的引脚复用 fnum 有效性检查</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">bool</span> mtk_pctrl_is_function_valid(<span class="class"><span class="keyword">struct</span> <span class="title">mtk_pinctrl</span></span> *pctl,</span><br><span class="line">        <span class="built_in">u32</span> pin_num, <span class="built_in">u32</span> fnum)</span><br><span class="line">&#123;</span><br><span class="line">    int i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pctl-&gt;devdata-&gt;npins; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">mtk_desc_pin</span></span> *pin = pctl-&gt;devdata-&gt;pins + i;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pin-&gt;pin.number == pin_num) &#123; 找到该 pin 对应的 mtk_desc_pin</span><br><span class="line">            <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">mtk_desc_function</span></span> *func =</span><br><span class="line">                    pin-&gt;functions; <span class="comment">//获取到对应的 functions</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (func &amp;&amp; func-&gt;name) &#123; <span class="comment">//查找对应的 functions 是否有对应的引脚复用 fnum</span></span><br><span class="line">                <span class="keyword">if</span> (func-&gt;muxval == fnum) </span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                func++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mtk_desc_function</span></span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">char</span> *name;</span><br><span class="line">    unsigned <span class="built_in">char</span> muxval;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mtk_desc_pin</span></span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_pin_desc</span></span> pin;</span><br><span class="line">#ifdef CONFIG_MTK_EINT_MULTI_TRIGGER_DESIGN</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mtk_desc_eint</span></span> eint;</span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">mtk_desc_eint</span></span> eint;</span><br><span class="line">#endif</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">mtk_desc_function</span></span>  *functions;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mtk_desc_function</span></span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">char</span> *name;</span><br><span class="line">    unsigned <span class="built_in">char</span> muxval;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="pinctrl-utils-add-map-configs"><a href="#pinctrl-utils-add-map-configs" class="headerlink" title="pinctrl_utils_add_map_configs"></a>pinctrl_utils_add_map_configs</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pinctrl_utils_add_map_configs</span><span class="params">(struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">        struct pinctrl_map **<span class="built_in">map</span>, <span class="keyword">unsigned</span> *reserved_maps,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">unsigned</span> *num_maps, <span class="keyword">const</span> <span class="keyword">char</span> *group,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">unsigned</span> <span class="keyword">long</span> *configs, <span class="keyword">unsigned</span> num_configs,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">enum</span> pinctrl_map_type type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *dup_configs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (WARN_ON(*num_maps == *reserved_maps)) <span class="comment">//防止数组越界</span></span><br><span class="line">        <span class="keyword">return</span> -ENOSPC;</span><br><span class="line"></span><br><span class="line">    dup_configs = kmemdup(configs, num_configs * <span class="keyword">sizeof</span>(*dup_configs),</span><br><span class="line">                  GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!dup_configs) &#123;</span><br><span class="line">        dev_err(pctldev-&gt;dev, <span class="string">&quot;kmemdup(configs) failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    (*<span class="built_in">map</span>)[*num_maps].type = type;</span><br><span class="line">    (*<span class="built_in">map</span>)[*num_maps].data.configs.group_or_pin = group;</span><br><span class="line">    (*<span class="built_in">map</span>)[*num_maps].data.configs.configs = dup_configs;</span><br><span class="line">    (*<span class="built_in">map</span>)[*num_maps].data.configs.num_configs = num_configs;</span><br><span class="line">    (*num_maps)++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="pinconf-generic-parse-dt-config"><a href="#pinconf-generic-parse-dt-config" class="headerlink" title="pinconf_generic_parse_dt_config"></a>pinconf_generic_parse_dt_config</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在设备节点 device_node 查找 dt_params 以及 pctldev-&gt;desc-&gt;custom_params 中的支持的引脚状态</span></span><br><span class="line"><span class="comment">// 如果存在则按顺寻将 params 和 custom_params 可配置的引脚状态参数 pin_config_param </span></span><br><span class="line"><span class="comment">// 以及配置的默认状态 default_value 组合后,存入 configs 指向的内存空间, 并返回 configs 的长度nconfigs</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pinconf_generic_parse_dt_config</span><span class="params">(struct device_node *np,</span></span></span><br><span class="line"><span class="function"><span class="params">                    struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">unsigned</span> <span class="keyword">long</span> **configs,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">unsigned</span> <span class="keyword">int</span> *nconfigs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *cfg;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> max_cfg, ncfg = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!np)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* allocate a temporary array big enough to hold one of each option */</span></span><br><span class="line">    <span class="comment">//获取 dt_params 的中 config 的数量</span></span><br><span class="line">    max_cfg = ARRAY_SIZE(dt_params);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pctldev) </span><br><span class="line">        max_cfg += pctldev-&gt;desc-&gt;num_custom_params;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每个 config 都由 unsigned long 表示，申请 max_cfg 个 unsigned long</span></span><br><span class="line">    cfg = kcalloc(max_cfg, <span class="keyword">sizeof</span>(*cfg), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!cfg)</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 查询设备节点 np 中存在的  params[] 数组中的属性，</span></span><br><span class="line">   <span class="comment">// 如果存在则按顺寻将该 params 可配置的引脚状态参数 pin_config_param </span></span><br><span class="line">   <span class="comment">// 以及配置的默认状态 default_value 组合后,存入 cfg 指向的内存空间, ncfg 表示 cfg 的长度</span></span><br><span class="line">    parse_dt_cfg(np, dt_params, ARRAY_SIZE(dt_params), cfg, &amp;ncfg);</span><br><span class="line">    <span class="keyword">if</span> (pctldev &amp;&amp; pctldev-&gt;desc-&gt;num_custom_params &amp;&amp; pctldev-&gt;desc-&gt;custom_params)</span><br><span class="line">        <span class="comment">//如果存在 custom_params 则同样查询该节点存在的属性，并返回其值</span></span><br><span class="line">        parse_dt_cfg(np, pctldev-&gt;desc-&gt;custom_params,</span><br><span class="line">                 pctldev-&gt;desc-&gt;num_custom_params, cfg, &amp;ncfg);</span><br><span class="line"></span><br><span class="line">    ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* no configs found at all */</span></span><br><span class="line">    <span class="keyword">if</span> (ncfg == <span class="number">0</span>) &#123;</span><br><span class="line">        *configs = <span class="literal">NULL</span>;</span><br><span class="line">        *nconfigs = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Now limit the number of configs to the real number of</span></span><br><span class="line"><span class="comment">     * found properties.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//为了节省内存空间，这里将值复制到 configs 之后释放掉 cfg 所占的多余的内存空间</span></span><br><span class="line">    *configs = kmemdup(cfg, ncfg * <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">long</span>), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!*configs) &#123;</span><br><span class="line">        ret = -ENOMEM;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *nconfigs = ncfg;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">    kfree(cfg);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pinconf_generic_params</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> property;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">pin_config_param</span> <span class="title">param</span>;</span></span><br><span class="line">    u32 default_value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//文件中定义的全局变量，表示支持的引脚状态</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinconf_generic_params</span> <span class="title">dt_params</span>[] =</span> &#123;</span><br><span class="line">    <span class="comment">// bias-bus-hold 属性名，在设备树中使用该名字，</span></span><br><span class="line">    <span class="comment">// PIN_CONFIG_BIAS_BUS_HOLD 引脚的状态，</span></span><br><span class="line">    <span class="comment">// 0 引脚状态的值</span></span><br><span class="line">    &#123; <span class="string">&quot;bias-bus-hold&quot;</span>, PIN_CONFIG_BIAS_BUS_HOLD, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;bias-disable&quot;</span>, PIN_CONFIG_BIAS_DISABLE, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;bias-high-impedance&quot;</span>, PIN_CONFIG_BIAS_HIGH_IMPEDANCE, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;bias-pull-up&quot;</span>, PIN_CONFIG_BIAS_PULL_UP, <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;bias-pull-pin-default&quot;</span>, PIN_CONFIG_BIAS_PULL_PIN_DEFAULT, <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;bias-pull-down&quot;</span>, PIN_CONFIG_BIAS_PULL_DOWN, <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;drive-open-drain&quot;</span>, PIN_CONFIG_DRIVE_OPEN_DRAIN, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;drive-open-source&quot;</span>, PIN_CONFIG_DRIVE_OPEN_SOURCE, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;drive-push-pull&quot;</span>, PIN_CONFIG_DRIVE_PUSH_PULL, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;drive-strength&quot;</span>, PIN_CONFIG_DRIVE_STRENGTH, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;input-debounce&quot;</span>, PIN_CONFIG_INPUT_DEBOUNCE, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;input-disable&quot;</span>, PIN_CONFIG_INPUT_ENABLE, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;input-enable&quot;</span>, PIN_CONFIG_INPUT_ENABLE, <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;input-schmitt&quot;</span>, PIN_CONFIG_INPUT_SCHMITT, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;input-schmitt-disable&quot;</span>, PIN_CONFIG_INPUT_SCHMITT_ENABLE, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;input-schmitt-enable&quot;</span>, PIN_CONFIG_INPUT_SCHMITT_ENABLE, <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;low-power-disable&quot;</span>, PIN_CONFIG_LOW_POWER_MODE, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;low-power-enable&quot;</span>, PIN_CONFIG_LOW_POWER_MODE, <span class="number">1</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;output-high&quot;</span>, PIN_CONFIG_OUTPUT, <span class="number">1</span>, &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;output-low&quot;</span>, PIN_CONFIG_OUTPUT, <span class="number">0</span>, &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;power-source&quot;</span>, PIN_CONFIG_POWER_SOURCE, <span class="number">0</span> &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;slew-rate&quot;</span>, PIN_CONFIG_SLEW_RATE, <span class="number">0</span> &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="parse-dt-cfg"><a href="#parse-dt-cfg" class="headerlink" title="parse_dt_cfg"></a>parse_dt_cfg</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询设备节点np中存在的  params[count] 数组中的属性，</span></span><br><span class="line"><span class="comment">// 如果存在则按顺寻将该 params 可配置的引脚状态参数 pin_config_param </span></span><br><span class="line"><span class="comment">// 以及配置的默认状态 default_value 组合后,存入 cfg 指向的内存空间, 之后 ncfg 等于 cfg 数组长度</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parse_dt_cfg</span><span class="params">(struct device_node *np, <span class="keyword">const</span> struct pinconf_generic_params *params, <span class="keyword">unsigned</span> <span class="keyword">int</span> count, <span class="keyword">unsigned</span> <span class="keyword">long</span> *cfg, <span class="keyword">unsigned</span> <span class="keyword">int</span> *ncfg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        u32 val;</span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line">        <span class="comment">//获取 params 中的 pinconf_generic_params</span></span><br><span class="line">        <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinconf_generic_params</span> *<span class="title">par</span> =</span> &amp;params[i];</span><br><span class="line"></span><br><span class="line">        <span class="comment">//从np节点中查询是存在该属性</span></span><br><span class="line">        ret = of_property_read_u32(np, par-&gt;property, &amp;val);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果不存在结束本次循环</span></span><br><span class="line">        <span class="comment">/* property not found */</span></span><br><span class="line">        <span class="keyword">if</span> (ret == -EINVAL)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* use default value, when no value is specified */</span></span><br><span class="line">        <span class="comment">//如果存在这个属性则获取这个default属性的值</span></span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">            val = par-&gt;default_value;</span><br><span class="line"></span><br><span class="line">        pr_debug(<span class="string">&quot;found %s with value %u\n&quot;</span>, par-&gt;property, val);</span><br><span class="line">        <span class="comment">//将该params可配置的引脚状态参数 pin_config_param 以及配置的默认状态组合后写入到cfg所在的内存空间。</span></span><br><span class="line">        cfg[*ncfg] = pinconf_to_config_packed(par-&gt;param, val);</span><br><span class="line">        (*ncfg)++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">pinconf_to_config_packed</span><span class="params">(<span class="keyword">enum</span> pin_config_param param,</span></span></span><br><span class="line"><span class="function"><span class="params">                             u16 argument)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PIN_CONF_PACKED(param, argument);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PIN_CONF_PACKED(p, a) ((a &lt;&lt; 16) | ((unsigned long) p &amp; 0xffffUL))</span></span><br></pre></td></tr></table></figure>
<h3 id="pinctrl-utils-reserve-map"><a href="#pinctrl-utils-reserve-map" class="headerlink" title="pinctrl_utils_reserve_map"></a>pinctrl_utils_reserve_map</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重新申请一片大小为 *num_maps + reserve 的内存空间，并将 map 的值复制过去，</span></span><br><span class="line"><span class="comment">// reserved_maps 之后的内存空间初始化为 0, 同时更新 pinctrl_map 的数量 reserved_maps</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pinctrl_utils_reserve_map</span><span class="params">(struct pinctrl_dev *pctldev,</span></span></span><br><span class="line"><span class="function"><span class="params">        struct pinctrl_map **<span class="built_in">map</span>, <span class="keyword">unsigned</span> *reserved_maps,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">unsigned</span> *num_maps, <span class="keyword">unsigned</span> reserve)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> old_num = *reserved_maps; <span class="comment">// 0</span></span><br><span class="line">    <span class="keyword">unsigned</span> new_num = *num_maps + reserve; <span class="comment">// </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map</span> *<span class="title">new_map</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (old_num &gt;= new_num)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    new_map = krealloc(*<span class="built_in">map</span>, <span class="keyword">sizeof</span>(*new_map) * new_num, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!new_map) &#123;</span><br><span class="line">        dev_err(pctldev-&gt;dev, <span class="string">&quot;krealloc(map) failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(new_map + old_num, <span class="number">0</span>, (new_num - old_num) * <span class="keyword">sizeof</span>(*new_map));</span><br><span class="line"></span><br><span class="line">    *<span class="built_in">map</span> = new_map;</span><br><span class="line">    *reserved_maps = new_num;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="mtk-pctrl-find-group-by-pin"><a href="#mtk-pctrl-find-group-by-pin" class="headerlink" title="mtk_pctrl_find_group_by_pin"></a>mtk_pctrl_find_group_by_pin</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct mtk_pinctrl_group * <span class="title">mtk_pctrl_find_group_by_pin</span><span class="params">(struct mtk_pinctrl *pctl, u32 pin)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pctl-&gt;ngroups; i++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">mtk_pinctrl_group</span> *<span class="title">grp</span> =</span> pctl-&gt;groups + i;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (grp-&gt;pin == pin)</span><br><span class="line">            <span class="keyword">return</span> grp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mtk_pinctrl_group</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>  *name;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>   config;</span><br><span class="line">    <span class="keyword">unsigned</span>    pin;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="dt-remember-or-free-map"><a href="#dt-remember-or-free-map" class="headerlink" title="dt_remember_or_free_map"></a>dt_remember_or_free_map</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> int dt_remember_or_free_map(<span class="class"><span class="keyword">struct</span> <span class="title">pinctrl</span></span> *p, <span class="keyword">const</span> <span class="built_in">char</span> *statename,</span><br><span class="line">                   <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_dev</span></span> *pctldev,</span><br><span class="line">                   <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_map</span></span> *map, unsigned num_maps)</span><br><span class="line">&#123;</span><br><span class="line">    int i;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_dt_map</span></span> *dt_map;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize common mapping table entry fields */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_maps; i++) &#123;</span><br><span class="line">        map[i].dev_name = dev_name(p-&gt;dev); <span class="comment">//初始化 pinctrl_map 所属的 dev_name</span></span><br><span class="line">        map[i].name = statename; <span class="comment">//初始化 name</span></span><br><span class="line">        <span class="keyword">if</span> (pctldev)</span><br><span class="line">            map[i].ctrl_dev_name = dev_name(pctldev-&gt;dev); <span class="comment">//设置所属的 pinctrl_dev 的 name</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Remember the converted mapping table entries */</span></span><br><span class="line">    dt_map = kzalloc(sizeof(*dt_map), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!dt_map) &#123;</span><br><span class="line">        dev_err(p-&gt;dev, <span class="string">&quot;failed to alloc struct pinctrl_dt_map\n&quot;</span>);</span><br><span class="line">        dt_free_map(pctldev, map, num_maps);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 初始化 pinctrl_dt_map </span></span><br><span class="line">    dt_map-&gt;pctldev = pctldev; </span><br><span class="line">    dt_map-&gt;map = map;</span><br><span class="line">    dt_map-&gt;num_maps = num_maps;</span><br><span class="line">    list_add_tail(&amp;dt_map-&gt;node, &amp;p-&gt;dt_maps); <span class="comment">//将 dt_map 挂接到所属的 pinctrl</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pinctrl_register_map(map, num_maps, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="pinctrl-register-map"><a href="#pinctrl-register-map" class="headerlink" title="pinctrl_register_map"></a>pinctrl_register_map</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">int pinctrl_register_map(struct pinctrl_map <span class="keyword">const</span> *maps, unsigned num_maps,</span><br><span class="line">             bool dup)</span><br><span class="line">&#123;</span><br><span class="line">    int i, ret;</span><br><span class="line">    struct pinctrl_maps *maps_node;</span><br><span class="line"></span><br><span class="line">    pr_debug(<span class="string">&quot;add %u pinctrl maps\n&quot;</span>, num_maps);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* First sanity check the new mapping */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_maps; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!maps[i].dev_name) &#123; <span class="comment">//每一个 map 都要有所属的设备</span></span><br><span class="line">            pr_err(<span class="string">&quot;failed to register map %s (%d): no device given\n&quot;</span>,</span><br><span class="line">                   maps[i].name, i);</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!maps[i].name) &#123; <span class="comment">//每一个 map 都要有对应的 state</span></span><br><span class="line">            pr_err(<span class="string">&quot;failed to register map %d: no map name given\n&quot;</span>,</span><br><span class="line">                   i);</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//当 map 的类型不为 PIN_MAP_TYPE_DUMMY_STAT ，map 必须要有所属的 pinctl_dev</span></span><br><span class="line">        <span class="keyword">if</span> (maps[i].type != PIN_MAP_TYPE_DUMMY_STATE &amp;&amp;</span><br><span class="line">                !maps[i].ctrl_dev_name) &#123; E</span><br><span class="line">            pr_err(<span class="string">&quot;failed to register map %s (%d): no pin control device given\n&quot;</span>,</span><br><span class="line">                   maps[i].name, i);</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (maps[i].type) &#123;</span><br><span class="line">        <span class="keyword">case</span> PIN_MAP_TYPE_DUMMY_STATE:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> PIN_MAP_TYPE_MUX_GROUP:</span><br><span class="line">            ret = pinmux_validate_map(&amp;maps[i], i); <span class="comment">//检查 map-&gt;data.mux.function 是否存在</span></span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> PIN_MAP_TYPE_CONFIGS_PIN:</span><br><span class="line">        <span class="keyword">case</span> PIN_MAP_TYPE_CONFIGS_GROUP:</span><br><span class="line">            ret = pinconf_validate_map(&amp;maps[i], i);</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            pr_err(<span class="string">&quot;failed to register map %s (%d): invalid type given\n&quot;</span>,</span><br><span class="line">                   maps[i].name, i);</span><br><span class="line">            <span class="keyword">return</span> -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//动态创建一个 maps_node 用于挂接 pinctrl_maps</span></span><br><span class="line">    maps_node = kzalloc(sizeof(*maps_node), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!maps_node) &#123;</span><br><span class="line">        pr_err(<span class="string">&quot;failed to alloc struct pinctrl_maps\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    maps_node-&gt;num_maps = num_maps; </span><br><span class="line">    <span class="keyword">if</span> (dup) &#123;</span><br><span class="line">        maps_node-&gt;maps = kmemdup(maps, sizeof(*maps) * num_maps,</span><br><span class="line">                      GFP_KERNEL);</span><br><span class="line">        <span class="keyword">if</span> (!maps_node-&gt;maps) &#123;</span><br><span class="line">            pr_err(<span class="string">&quot;failed to duplicate mapping table\n&quot;</span>);</span><br><span class="line">            kfree(maps_node);</span><br><span class="line">            <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        maps_node-&gt;maps = maps; <span class="comment">//跑这里</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutex_lock(&amp;pinctrl_maps_mutex);</span><br><span class="line">    list_add_tail(&amp;maps_node-&gt;node, &amp;pinctrl_maps); <span class="comment">//将 maps_node 链接到全局 pinctrl_maps</span></span><br><span class="line">    mutex_unlock(&amp;pinctrl_maps_mutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="add-setting"><a href="#add-setting" class="headerlink" title="add_setting"></a>add_setting</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">add_setting</span><span class="params">(struct pinctrl *p, struct pinctrl_map <span class="keyword">const</span> *<span class="built_in">map</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_state</span> *<span class="title">state</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_setting</span> *<span class="title">setting</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 获取对应的 state</span></span><br><span class="line">    state = find_state(p, <span class="built_in">map</span>-&gt;name);</span><br><span class="line">    <span class="keyword">if</span> (!state) <span class="comment">// 如果没有 state 则创建</span></span><br><span class="line">        state = create_state(p, <span class="built_in">map</span>-&gt;name);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(state))</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(state);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">map</span>-&gt;type == PIN_MAP_TYPE_DUMMY_STATE)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个 pinctrl_setting</span></span><br><span class="line">    setting = kzalloc(<span class="keyword">sizeof</span>(*setting), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (setting == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        dev_err(p-&gt;dev,</span><br><span class="line">            <span class="string">&quot;failed to alloc struct pinctrl_setting\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 type</span></span><br><span class="line">    setting-&gt;type = <span class="built_in">map</span>-&gt;type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    setting-&gt;pctldev = get_pinctrl_dev_from_devname(<span class="built_in">map</span>-&gt;ctrl_dev_name);</span><br><span class="line">    <span class="keyword">if</span> (setting-&gt;pctldev == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        kfree(setting);</span><br><span class="line">        <span class="comment">/* Do not defer probing of hogs (circular loop) */</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(<span class="built_in">map</span>-&gt;ctrl_dev_name, <span class="built_in">map</span>-&gt;dev_name))</span><br><span class="line">            <span class="keyword">return</span> -ENODEV;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * OK let us guess that the driver is not there yet, and</span></span><br><span class="line"><span class="comment">         * let&#x27;s defer obtaining this pinctrl handle to later...</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        dev_info(p-&gt;dev, <span class="string">&quot;unknown pinctrl device %s in map entry, deferring probe&quot;</span>,</span><br><span class="line">            <span class="built_in">map</span>-&gt;ctrl_dev_name);</span><br><span class="line">        <span class="keyword">return</span> -EPROBE_DEFER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setting-&gt;dev_name = <span class="built_in">map</span>-&gt;dev_name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (<span class="built_in">map</span>-&gt;type) &#123;</span><br><span class="line">    <span class="keyword">case</span> PIN_MAP_TYPE_MUX_GROUP:</span><br><span class="line">         <span class="comment">//初始化 setting-&gt;data.mux.func 和 setting-&gt;data.mux.group</span></span><br><span class="line">        ret = pinmux_map_to_setting(<span class="built_in">map</span>, setting);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> PIN_MAP_TYPE_CONFIGS_PIN:</span><br><span class="line">    <span class="keyword">case</span> PIN_MAP_TYPE_CONFIGS_GROUP:</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        ret = pinconf_map_to_setting(<span class="built_in">map</span>, setting);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        ret = -EINVAL;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        kfree(setting);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    list_add_tail(&amp;setting-&gt;node, &amp;state-&gt;settings);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="create-state"><a href="#create-state" class="headerlink" title="create_state"></a>create_state</h3><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">static struct pinctrl_state *create_state(struct pinctrl *p,</span><br><span class="line">                      <span class="keyword">const</span> char *name)</span><br><span class="line">&#123;</span><br><span class="line">    struct pinctrl_state *<span class="keyword">state</span>;</span><br><span class="line"></span><br><span class="line">	//创建一个 <span class="keyword">state</span></span><br><span class="line">    <span class="keyword">state</span> = kzalloc(sizeof(*<span class="keyword">state</span>), GFP_KERNEL);</span><br><span class="line">    if (<span class="keyword">state</span> == NULL) &#123;</span><br><span class="line">        dev_err(p-&gt;dev,</span><br><span class="line">            <span class="string">&quot;failed to alloc struct pinctrl_state\n&quot;</span>);</span><br><span class="line">        return ERR_PTR(-ENOMEM);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    state-&gt;name = name; //初始化 name</span><br><span class="line">    INIT_LIST_HEAD(&amp;state-&gt;settings);</span><br><span class="line"></span><br><span class="line">    list_add_tail(&amp;state-&gt;node, &amp;p-&gt;states); //将其挂接到所属 pinctl 的states</span><br><span class="line"></span><br><span class="line">    return <span class="keyword">state</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="pinmux-map-to-setting"><a href="#pinmux-map-to-setting" class="headerlink" title="pinmux_map_to_setting"></a>pinmux_map_to_setting</h3><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">int pinmux_map_to_setting(struct pinctrl_map const *map,</span><br><span class="line">              struct pinctrl_setting *setting)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="title">struct</span> pinctrl_dev *pctldev = setting-&gt;</span>pctldev;</span><br><span class="line">    <span class="function"><span class="title">const</span> struct pinmux_ops *pmxops = pctldev-&gt;</span><span class="function"><span class="title">desc</span>-&gt;</span>pmxops;</span><br><span class="line">    char const * const *groups;</span><br><span class="line">    unsigned num_groups;</span><br><span class="line">    int ret;</span><br><span class="line">    const char *group;</span><br><span class="line">    int i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pmxops) &#123;</span><br><span class="line">        <span class="function"><span class="title">dev_err</span>(pctldev-&gt;</span>dev, <span class="string">&quot;does not support mux function\n&quot;</span>);</span><br><span class="line">        return -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//返回 function 的数组下标</span></span><br><span class="line">    <span class="function"><span class="title">ret</span> = pinmux_func_name_to_selector(pctldev, map-&gt;</span><span class="keyword">data</span>.mux.function);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="function"><span class="title">dev_err</span>(pctldev-&gt;</span>dev, <span class="string">&quot;invalid function %s in map table\n&quot;</span>,</span><br><span class="line">            <span class="function"><span class="title">map</span>-&gt;</span><span class="keyword">data</span>.mux.function);</span><br><span class="line">        return ret;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//将其赋值给对应的 setting</span></span><br><span class="line">    <span class="function"><span class="title">setting</span>-&gt;</span><span class="keyword">data</span>.mux.func = ret;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">ret</span> = pmxops-&gt;</span><span class="function"><span class="title">get_function_groups</span>(pctldev, setting-&gt;</span><span class="keyword">data</span>.mux.func,</span><br><span class="line">                      &amp;groups, &amp;num_groups);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="function"><span class="title">dev_err</span>(pctldev-&gt;</span>dev, <span class="string">&quot;can&#x27;t query groups for function %s\n&quot;</span>,</span><br><span class="line">            <span class="function"><span class="title">map</span>-&gt;</span><span class="keyword">data</span>.mux.function);</span><br><span class="line">        return ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!num_groups) &#123;</span><br><span class="line">        <span class="function"><span class="title">dev_err</span>(pctldev-&gt;</span>dev,</span><br><span class="line">            <span class="string">&quot;function %s can&#x27;t be selected on any group\n&quot;</span>,</span><br><span class="line">            <span class="function"><span class="title">map</span>-&gt;</span><span class="keyword">data</span>.mux.function);</span><br><span class="line">        return -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">if</span> (map-&gt;</span><span class="keyword">data</span>.mux.group) &#123;</span><br><span class="line">        bool found = <span class="literal">false</span>;</span><br><span class="line">        <span class="function"><span class="title">group</span> = map-&gt;</span><span class="keyword">data</span>.mux.group;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_groups; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!strcmp(group, groups[i])) &#123;</span><br><span class="line">                found = <span class="literal">true</span>;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">            <span class="function"><span class="title">dev_err</span>(pctldev-&gt;</span>dev,</span><br><span class="line">                <span class="string">&quot;invalid group \&quot;</span>%s\<span class="string">&quot; for function \&quot;</span>%s\<span class="string">&quot;\n&quot;</span>,</span><br><span class="line">                <span class="function"><span class="title">group</span>, map-&gt;</span><span class="keyword">data</span>.mux.function);</span><br><span class="line">            return -EINVAL;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        group = groups[<span class="number">0</span>]; <span class="comment">// 初始化 group </span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = pinctrl_get_group_selector(pctldev, group);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="function"><span class="title">dev_err</span>(pctldev-&gt;</span>dev, <span class="string">&quot;invalid group %s in map table\n&quot;</span>,</span><br><span class="line">            <span class="function"><span class="title">map</span>-&gt;</span><span class="keyword">data</span>.mux.group);</span><br><span class="line">        return ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">setting</span>-&gt;</span><span class="keyword">data</span>.mux.group = ret;</span><br><span class="line"></span><br><span class="line">    return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="pinmux-func-name-to-selector"><a href="#pinmux-func-name-to-selector" class="headerlink" title="pinmux_func_name_to_selector"></a>pinmux_func_name_to_selector</h3><figure class="highlight zephir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> pinmux_func_name_to_selector(struct pinctrl_dev *pctldev,</span><br><span class="line">                    <span class="keyword">const</span> <span class="keyword">char</span> *<span class="function"><span class="keyword">function</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> struct pinmux_ops *ops = pctldev-&gt;desc-&gt;pmxops;</span><br><span class="line">    <span class="keyword">unsigned</span> nfuncs = ops-&gt;get_functions_count(pctldev); <span class="comment">//获取 functions 的数量</span></span><br><span class="line">    <span class="keyword">unsigned</span> selector = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* See if this pctldev has this function */</span></span><br><span class="line">    <span class="keyword">while</span> (selector &lt; nfuncs) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *fname = ops-&gt;get_function_name(pctldev, selector); <span class="comment">//返回 selector 下标中的 func name</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!strcmp(<span class="function"><span class="keyword">function</span>, <span class="title">fname</span>))</span></span><br><span class="line"><span class="function">            <span class="title">return</span> <span class="title">selector</span></span>; <span class="comment">//返回数组下标</span></span><br><span class="line"></span><br><span class="line">        selector++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dev_err(pctldev-&gt;dev, <span class="string">&quot;function &#x27;%s&#x27; not supported\n&quot;</span>, <span class="function"><span class="keyword">function</span>)</span>;</span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="pinctrl-get-group-selector"><a href="#pinctrl-get-group-selector" class="headerlink" title="pinctrl_get_group_selector"></a>pinctrl_get_group_selector</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">int pinctrl_get_group_selector(<span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_dev</span></span> *pctldev,</span><br><span class="line">                   <span class="keyword">const</span> <span class="built_in">char</span> *pin_group)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pinctrl_ops</span></span> *pctlops = pctldev-&gt;desc-&gt;pctlops; </span><br><span class="line">    unsigned ngroups = pctlops-&gt;get_groups_count(pctldev); <span class="comment">//返回 group 的大小</span></span><br><span class="line">    unsigned group_selector = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (group_selector &lt; ngroups) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">char</span> *gname = pctlops-&gt;get_group_name(pctldev,</span><br><span class="line">                                group_selector);</span><br><span class="line">        <span class="keyword">if</span> (!strcmp(gname, pin_group)) &#123;</span><br><span class="line">            dev_dbg(pctldev-&gt;dev,</span><br><span class="line">                <span class="string">&quot;found group selector %u for %s\n&quot;</span>,</span><br><span class="line">                group_selector,</span><br><span class="line">                pin_group);</span><br><span class="line">            <span class="keyword">return</span> group_selector;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        group_selector++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dev_err(pctldev-&gt;dev, <span class="string">&quot;does not have pin group %s\n&quot;</span>,</span><br><span class="line">        pin_group);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="pinconf-map-to-setting"><a href="#pinconf-map-to-setting" class="headerlink" title="pinconf_map_to_setting"></a>pinconf_map_to_setting</h3><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">int pinconf_map_to_setting(struct pinctrl_map const *map,</span><br><span class="line">              struct pinctrl_setting *setting)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="title">struct</span> pinctrl_dev *pctldev = setting-&gt;</span>pctldev;</span><br><span class="line">    int pin;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">switch</span> (setting-&gt;</span>type) &#123;</span><br><span class="line">    case PIN_MAP_TYPE_CONFIGS_PIN:</span><br><span class="line">        pin = pin_get_from_name(pctldev,</span><br><span class="line">                    <span class="function"><span class="title">map</span>-&gt;</span><span class="keyword">data</span>.configs.group_or_pin);</span><br><span class="line">        <span class="keyword">if</span> (pin &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="function"><span class="title">dev_err</span>(pctldev-&gt;</span>dev, <span class="string">&quot;could not map pin config for \&quot;</span>%s\<span class="string">&quot;&quot;</span>,</span><br><span class="line">                <span class="function"><span class="title">map</span>-&gt;</span><span class="keyword">data</span>.configs.group_or_pin);</span><br><span class="line">            return pin;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="title">setting</span>-&gt;</span><span class="keyword">data</span>.configs.group_or_pin = pin;</span><br><span class="line">        break;</span><br><span class="line">    case PIN_MAP_TYPE_CONFIGS_GROUP:</span><br><span class="line">        pin = pinctrl_get_group_selector(pctldev,</span><br><span class="line">                     <span class="function"><span class="title">map</span>-&gt;</span><span class="keyword">data</span>.configs.group_or_pin);</span><br><span class="line">        <span class="keyword">if</span> (pin &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="function"><span class="title">dev_err</span>(pctldev-&gt;</span>dev, <span class="string">&quot;could not map group config for \&quot;</span>%s\<span class="string">&quot;&quot;</span>,</span><br><span class="line">                <span class="function"><span class="title">map</span>-&gt;</span><span class="keyword">data</span>.configs.group_or_pin);</span><br><span class="line">            return pin;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="title">setting</span>-&gt;</span><span class="keyword">data</span>.configs.group_or_pin = pin;</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        return -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">setting</span>-&gt;</span><span class="function"><span class="title">data</span>.configs.num_configs = map-&gt;</span><span class="keyword">data</span>.configs.num_configs;</span><br><span class="line">    <span class="function"><span class="title">setting</span>-&gt;</span><span class="function"><span class="title">data</span>.configs.configs = map-&gt;</span><span class="keyword">data</span>.configs.configs;</span><br><span class="line"></span><br><span class="line">    return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="pin-get-from-name"><a href="#pin-get-from-name" class="headerlink" title="pin_get_from_name"></a>pin_get_from_name</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> pin_get_from_name(struct pinctrl_dev *pctldev, const <span class="type">char</span> *<span class="type">name</span>)</span><br><span class="line">&#123;</span><br><span class="line">    unsigned i, pin;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The pin number can be retrived from the pin controller descriptor */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pctldev-&gt;<span class="keyword">desc</span>-&gt;npins; i++) &#123;</span><br><span class="line">        struct pin_desc *<span class="keyword">desc</span>;</span><br><span class="line"></span><br><span class="line">        pin = pctldev-&gt;<span class="keyword">desc</span>-&gt;pins[i].number;</span><br><span class="line">        <span class="keyword">desc</span> = pin_desc_get(pctldev, pin);</span><br><span class="line">        <span class="comment">/* Pin space may be sparse */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">desc</span> &amp;&amp; !strcmp(<span class="type">name</span>, <span class="keyword">desc</span>-&gt;<span class="type">name</span>))</span><br><span class="line">            <span class="keyword">return</span> pin;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="五、使用-pinctrl"><a href="#五、使用-pinctrl" class="headerlink" title="五、使用 pinctrl"></a>五、使用 pinctrl</h1><p>使用就比较简单了接口如下</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取当前设备的 pinctrl 句柄</span></span><br><span class="line"><span class="keyword">struct</span> pinctrl *pinctrl<span class="constructor">_get(<span class="params">struct</span> <span class="params">device</span> <span class="operator">*</span><span class="params">dev</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取我们需要设置的 state</span></span><br><span class="line"><span class="keyword">struct</span> pinctrl_state *pinctrl<span class="constructor">_lookup_state(<span class="params">struct</span> <span class="params">pinctrl</span> <span class="operator">*</span><span class="params">p</span>, <span class="params">const</span> <span class="params">char</span> <span class="operator">*</span><span class="params">name</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置为对应的state</span></span><br><span class="line"><span class="built_in">int</span> pinctrl<span class="constructor">_select_state(<span class="params">struct</span> <span class="params">pinctrl</span> <span class="operator">*</span><span class="params">p</span>, <span class="params">struct</span> <span class="params">pinctrl_state</span> <span class="operator">*</span><span class="params">state</span>)</span>;</span><br></pre></td></tr></table></figure>
    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>braon-z
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://example.com/2021/04/01/linux%E9%A9%B1%E5%8A%A8pinctrl/" title="pinctrl 子系统">https://example.com/2021/04/01/linux驱动pinctrl/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E9%A9%B1%E5%8A%A8/" rel="tag"><i class="fa fa-tag"></i> 驱动</a>
              <a href="/tags/pinctrl/" rel="tag"><i class="fa fa-tag"></i> pinctrl</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/01/18/makfile%E4%B8%93%E9%A2%98/" rel="prev" title="makefile专题">
                  <i class="fa fa-chevron-left"></i> makefile专题
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">braon-z</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">342k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">5:11</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/local-search.js"></script>






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"VsC1eQwQ4Xltm5eA9iYGp3VU-gzGzoHsz","appKey":"kyfyE4RWl6aIojedbxcuJa3V","serverURLs":null,"placeholder":"Just go go","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":false,"comment_count":true,"recordIP":false,"enableQQ":false,"requiredFields":[]}, {
      el: '#valine-comments',
      path: "/2021/04/01/linux%E9%A9%B1%E5%8A%A8pinctrl/",
      serverURLs: "https://vsc1eqwq.api.lncldglobal.com"
    }));
  }, window.Valine);
});
</script>




  <script src="/js/activate-power-mode.min.js"></script>
  <script>
    POWERMODE.colorful = true;
    POWERMODE.shake = false;
    document.body.addEventListener('input', POWERMODE);
  </script>
<div class="moon-menu">
  <div class="moon-menu-items">
    
    <div class="moon-menu-item" onclick="back2bottom()">
      <i class='fa fa-chevron-down'></i>    </div>
    
    <div class="moon-menu-item" onclick="back2top()">
      <i class='fa fa-chevron-up'></i>    </div>
    
  </div>
  <div class="moon-menu-button">
    <svg class="moon-menu-bg">
      <circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle>
      <circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle>
    </svg>
    <div class="moon-menu-content">
      <div class="moon-menu-icon"><i class='fas fa-ellipsis-v'></i></div>
      <div class="moon-menu-text"></div>
    </div>
  </div>
</div><script src="/js/injector.js"></script>
</body>
</html>
