<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":"ture","mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="记录 makefile 基本知识，学习资料来自狄泰软件学院可在淘宝购买学习">
<meta property="og:type" content="article">
<meta property="og:title" content="makefile专题">
<meta property="og:url" content="https://example.com/2021/08/18/makfile%E4%B8%93%E9%A2%98/index.html">
<meta property="og:site_name" content="braon-z&#39;s blog">
<meta property="og:description" content="记录 makefile 基本知识，学习资料来自狄泰软件学院可在淘宝购买学习">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/makefile/makefile%E8%A7%84%E5%88%99.jpg?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1629268646;865629182246&q-key-time=1629268646;865629182246&q-header-list=&q-url-param-list=&q-signature=1c3d5df851ddaf2283419ee996ae55dad55ed2d7">
<meta property="og:image" content="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/makefile/%E5%8F%98%E9%87%8F%E7%9A%84%E5%AE%9A%E4%B9%89%E5%92%8C%E4%BD%BF%E7%94%A8.png?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1629172213;88029085813&q-key-time=1629172213;88029085813&q-header-list=&q-url-param-list=&q-signature=340dd806fca1d9e879119a25be61b36aa9e5493a">
<meta property="og:image" content="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/1.png">
<meta property="og:image" content="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/3.png">
<meta property="og:image" content="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/4.png">
<meta property="og:image" content="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/2.png">
<meta property="og:image" content="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/5.png">
<meta property="og:image" content="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/6.png">
<meta property="og:image" content="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/7.jpg">
<meta property="og:image" content="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/8.jpg">
<meta property="og:image" content="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/9.jpg">
<meta property="og:image" content="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/10.jpg">
<meta property="article:published_time" content="2021-08-18T08:37:19.872Z">
<meta property="article:modified_time" content="2021-08-30T07:19:06.840Z">
<meta property="article:author" content="braon-z">
<meta property="article:tag" content="基础知识">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/makefile/makefile%E8%A7%84%E5%88%99.jpg?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1629268646;865629182246&q-key-time=1629268646;865629182246&q-header-list=&q-url-param-list=&q-signature=1c3d5df851ddaf2283419ee996ae55dad55ed2d7">


<link rel="canonical" href="https://example.com/2021/08/18/makfile%E4%B8%93%E9%A2%98/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>makefile专题 | braon-z's blog</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">braon-z's blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81make-%E5%92%8C-makefile"><span class="nav-text">一、make 和 makefile</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81make-%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="nav-text">1、make 的本质</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81makefile-%E7%9A%84%E6%9C%AC%E8%B4%A8"><span class="nav-text">2、makefile 的本质</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81make-%E5%92%8C-makefile%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="nav-text">3、make 和 makefile之间的关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84-makefle-%E7%A8%8B%E5%BA%8F"><span class="nav-text">4、最简单的 makefle 程序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5%E3%80%81make-%E7%A8%8B%E5%BA%8F%E7%AE%80%E5%86%99"><span class="nav-text">5、make 程序简写</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%88%9D%E8%AF%86-makefile-%E7%9A%84%E7%BB%93%E6%9E%84"><span class="nav-text">二、初识 makefile 的结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81makefile-%E7%9A%84%E6%84%8F%E4%B9%89"><span class="nav-text">1、makefile 的意义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E8%A7%84%E5%88%99"><span class="nav-text">3、规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E7%AC%AC%E4%B8%80%E4%B8%AA-make-%E7%9A%84%E7%BC%96%E8%AF%91%E6%A1%88%E4%BE%8B"><span class="nav-text">3、第一个 make 的编译案例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E4%BC%AA%E7%9B%AE%E6%A0%87"><span class="nav-text">三、伪目标</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E4%BC%AA%E7%9B%AE%E6%A0%87%E7%9A%84%E5%BC%95%E5%85%A5"><span class="nav-text">1、伪目标的引入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E7%BB%95%E5%BC%80-PHONY-%E5%85%B3%E9%94%AE%E5%AD%97%E5%AE%9A%E4%B9%89%E4%BC%AA%E7%9B%AE%E6%A0%87"><span class="nav-text">2、绕开 .PHONY 关键字定义伪目标</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E5%8F%98%E9%87%8F%E5%92%8C%E4%B8%8D%E5%90%8C%E7%9A%84%E8%B5%8B%E5%80%BC%E6%96%B9%E5%BC%8F"><span class="nav-text">四、变量和不同的赋值方式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81makefile%E4%B8%AD%E7%9A%84%E5%8F%98%E9%87%8F"><span class="nav-text">1、makefile中的变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E5%8F%98%E9%87%8F%E7%9A%84%E5%AE%9A%E4%B9%89%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="nav-text">2、变量的定义和使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81makefile%E4%B8%AD%E5%8F%98%E9%87%8F%E7%9A%84%E8%B5%8B%E5%80%BC%E6%96%B9%E5%BC%8F"><span class="nav-text">3、makefile中变量的赋值方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%AE%80%E5%8D%95%E8%B5%8B%E5%80%BC"><span class="nav-text">1)    简单赋值 :&#x3D;</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%80%92%E5%BD%92%E8%B5%8B%E5%80%BC"><span class="nav-text">2)    递归赋值 &#x3D;</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%9D%A1%E4%BB%B6%E8%B5%8B%E5%80%BC"><span class="nav-text">3) 条件赋值 ?&#x3D;</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E8%BF%BD%E5%8A%A0%E8%B5%8B%E5%80%BC"><span class="nav-text">4) 追加赋值 +&#x3D;</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E9%A2%84%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">五、预定义变量的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E8%87%AA%E5%8A%A8%E5%8F%98%E9%87%8F"><span class="nav-text">1. 自动变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E8%87%AA%E5%8A%A8%E5%8F%98%E9%87%8F%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">2、自动变量的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E7%89%B9%E6%AE%8A%E5%8F%98%E9%87%8F"><span class="nav-text">3、特殊变量</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%8F%98%E9%87%8F%E7%9A%84%E9%AB%98%E7%BA%A7%E4%B8%BB%E9%A2%98"><span class="nav-text">六、变量的高级主题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%B8%B8%E7%94%A8%E8%AF%AD%E6%B3%95"><span class="nav-text">1. 常用语法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89-%E5%8F%98%E9%87%8F%E5%80%BC%E7%9A%84%E6%9B%BF%E6%8D%A2"><span class="nav-text">1） 变量值的替换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E5%8F%98%E9%87%8F%E7%9A%84%E6%A8%A1%E5%BC%8F%E6%9B%BF%E6%8D%A2"><span class="nav-text">2）变量的模式替换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89%E8%A7%84%E5%88%99%E4%B8%AD%E7%9A%84%E6%A8%A1%E5%BC%8F%E6%9B%BF%E6%8D%A2"><span class="nav-text">3）规则中的模式替换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%EF%BC%89%E5%8F%98%E9%87%8F%E5%80%BC%E7%9A%84%E5%B5%8C%E5%A5%97%E5%BC%95%E7%94%A8"><span class="nav-text">4）变量值的嵌套引用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5%EF%BC%89%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%98%E9%87%8F"><span class="nav-text">5）命令行变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6%EF%BC%89override-%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-text">6）override 关键字</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7%EF%BC%89define%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-text">7）define关键字</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%EF%BC%88%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%EF%BC%89"><span class="nav-text">2、环境变量（全局变量）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E7%9B%AE%E6%A0%87%E5%8F%98%E9%87%8F%EF%BC%88%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%EF%BC%89"><span class="nav-text">3、目标变量（局部变量）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E6%A8%A1%E5%BC%8F%E5%8F%98%E9%87%8F%EF%BC%88%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%EF%BC%89"><span class="nav-text">4、模式变量（局部变量）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD%E8%AF%AD%E5%8F%A5"><span class="nav-text">七、条件判断语句</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81makefile%E4%B8%AD%E7%9A%84%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD%E8%AF%AD%E5%8F%A5"><span class="nav-text">1、makefile中的条件判断语句</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-text">2、条件判断关键字</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E5%B7%A5%E7%A8%8B%E4%BD%BF%E7%94%A8%E5%B0%8F%E7%BB%93"><span class="nav-text">3、工程使用小结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5%E3%80%81%E4%B8%BE%E4%BE%8B%E8%AF%B4%E6%98%8E"><span class="nav-text">5、举例说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD%E5%85%B3%E9%94%AE%E5%AD%97%E7%A8%8B%E5%BA%8F%E5%AE%9E%E4%BE%8B"><span class="nav-text">1）条件判断关键字程序实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E6%9D%A1%E4%BB%B6%E5%88%A4%E6%96%AD%E5%85%B3%E9%94%AE%E5%AD%97%E5%BC%82%E5%B8%B8%E5%88%86%E6%9E%90"><span class="nav-text">2）条件判断关键字异常分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a%EF%BC%89%E5%BC%82%E5%B8%B8%E6%83%85%E5%86%B51"><span class="nav-text">a）异常情况1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b%EF%BC%89%E5%BC%82%E5%B8%B8%E6%83%85%E5%86%B52"><span class="nav-text">b）异常情况2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c%EF%BC%89%E5%BC%82%E5%B8%B8%E6%83%85%E5%86%B53"><span class="nav-text">c）异常情况3</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AB%E3%80%81%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%9A%E4%B9%89%E4%BB%A5%E5%8F%8A%E8%B0%83%E7%94%A8"><span class="nav-text">八、函数的定义以及调用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81makefile-%E6%94%AF%E6%8C%81%E5%87%BD%E6%95%B0%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="nav-text">1、makefile 支持函数的概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0%E8%AF%AD%E6%B3%95"><span class="nav-text">2、自定义函数语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0"><span class="nav-text">3、深入理解自定义函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%AE%9E%E4%BE%8B%E5%88%86%E6%9E%90"><span class="nav-text">4. 实例分析</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B9%9D%E3%80%81%E5%8F%98%E9%87%8F%E4%B8%8E%E5%87%BD%E6%95%B0%E7%9A%84%E7%BB%BC%E5%90%88%E7%A4%BA%E4%BE%8B"><span class="nav-text">九、变量与函数的综合示例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E5%AE%9E%E6%88%98%E9%9C%80%E6%B1%82"><span class="nav-text">1、实战需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E5%B7%A5%E5%85%B7%E5%8E%9F%E6%96%99"><span class="nav-text">2、工具原料</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E5%85%B3%E9%94%AE%E6%8A%80%E5%B7%A7"><span class="nav-text">3、关键技巧</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E7%BC%96%E8%AF%91%E8%A7%84%E5%88%99%E7%9A%84%E4%BE%9D%E8%B5%96"><span class="nav-text">4、编译规则的依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E7%BC%96%E7%A8%8B%E5%AE%9E%E7%8E%B0"><span class="nav-text">5. 编程实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E3%80%81include-%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-text"> 十、include 关键字</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-include-%E5%85%B3%E9%94%AE%E5%AD%97%E7%9A%84%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F"><span class="nav-text">1. include 关键字的处理方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E6%90%9C%E7%B4%A2%E6%88%90%E5%8A%9F"><span class="nav-text">1）搜索成功</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E6%90%9C%E7%B4%A2%E5%A4%B1%E8%B4%A5"><span class="nav-text">2）搜索失败</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a%EF%BC%89%E8%A7%84%E5%88%99%E5%AD%98%E5%9C%A8"><span class="nav-text">a）规则存在</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b%EF%BC%89%E8%A7%84%E5%88%99%E4%B8%8D%E5%AD%98%E5%9C%A8"><span class="nav-text">b）规则不存在</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-include%E5%85%B3%E9%94%AE%E5%AD%97%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93"><span class="nav-text">2. include关键字使用总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E5%BD%93%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E4%B8%8D%E5%AD%98%E5%9C%A8"><span class="nav-text">1）当目标文件不存在</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E5%BD%93%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E5%AD%98%E5%9C%A8"><span class="nav-text">2）当目标文件存在</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%87%8F%E5%8F%B7-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">3) 减号 - 的使用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB"><span class="nav-text">十一、自动生成依赖关系</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E7%BC%96%E8%AF%91%E8%A1%8C%E4%B8%BA%E5%B8%A6%E6%9D%A5%E7%9A%84%E7%BC%BA%E9%99%B7"><span class="nav-text">1、编译行为带来的缺陷</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E3%80%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">2.、解决方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86"><span class="nav-text">3、预备知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-sed-%E6%B5%81%E7%BC%96%E8%BE%91%E5%99%A8"><span class="nav-text">1) sed 流编辑器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-gcc-%E5%85%B3%E9%94%AE%E7%BC%96%E8%AF%91%E9%80%89%E9%A1%B9"><span class="nav-text">2) gcc 关键编译选项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%8B%86%E5%88%86%E7%9B%AE%E6%A0%87%E7%9A%84%E4%BE%9D%E8%B5%96"><span class="nav-text">3) 拆分目标的依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-make-%E4%B8%AD%E7%9A%84%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6"><span class="nav-text">4) make 中的命令执行机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB"><span class="nav-text">4、自动生成依赖关系</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E4%BE%9D%E8%B5%96%E6%96%87%E4%BB%B6"><span class="nav-text">1）自动生成依赖文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%9B%86%E4%B8%AD%E7%AE%A1%E7%90%86-dep-%E6%96%87%E4%BB%B6"><span class="nav-text">2) 集中管理 .dep 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E4%B8%80%E4%BA%9B-dep-%E6%96%87%E4%BB%B6%E4%BC%9A%E8%A2%AB%E9%87%8D%E5%A4%8D%E5%88%9B%E5%BB%BA%E5%A4%9A%E6%AC%A1"><span class="nav-text">3) 一些 .dep 文件会被重复创建多次</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E4%BE%9D%E8%B5%96%E7%9A%84%E6%9C%80%E7%BB%88%E5%AE%9E%E7%8E%B0"><span class="nav-text">4) 自动生成依赖的最终实现</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81make-%E7%9A%84%E9%9A%90%E5%BC%8F%E8%A7%84%E5%88%99"><span class="nav-text">十二、make 的隐式规则</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81makfile-%E4%B8%AD%E5%87%BA%E7%8E%B0%E5%90%8C%E5%90%8D%E7%9B%AE%E6%A0%87%E6%97%B6"><span class="nav-text">1、makfile 中出现同名目标时</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E9%9A%90%E5%BC%8F%E8%A7%84%E5%88%99"><span class="nav-text">2、隐式规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E9%9A%90%E5%BC%8F%E8%A7%84%E5%88%99%E7%9A%84%E5%89%AF%E4%BD%9C%E7%94%A8"><span class="nav-text">3、隐式规则的副作用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E5%90%8E%E7%BC%80%E8%A7%84%E5%88%99"><span class="nav-text">4、后缀规则</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E4%B8%89%E3%80%81makefile-%E4%B8%AD%E7%9A%84%E8%B7%AF%E5%BE%84%E6%90%9C%E7%B4%A2"><span class="nav-text">十三、makefile 中的路径搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E7%89%B9%E6%AE%8A%E7%9A%84%E9%A2%84%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F-VPATH%EF%BC%88%E5%85%A8%E5%A4%A7%E5%86%99%EF%BC%89"><span class="nav-text">1、特殊的预定义变量 VPATH（全大写）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89make-%E5%AF%B9%E4%BA%8E-VAPATH-%E5%80%BC%E5%BE%97%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F"><span class="nav-text">1）make 对于 VAPATH 值得处理方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89VAPATH-%E4%BD%BF%E7%94%A8%E5%AE%9E%E4%BE%8B"><span class="nav-text">2）VAPATH 使用实例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E5%8F%96%E6%B6%88%E6%90%9C%E7%B4%A2%E8%A7%84%E5%88%99"><span class="nav-text">2、取消搜索规则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="nav-text">3、问题分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E5%B7%A5%E7%A8%8B%E5%BB%BA%E8%AE%AE"><span class="nav-text">4、工程建议</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5%E3%80%81%E8%B7%AF%E5%BE%84%E6%90%9C%E7%B4%A2%E7%9A%84%E7%BB%BC%E5%90%88%E7%A4%BA%E4%BE%8B"><span class="nav-text">5、路径搜索的综合示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="nav-text">1) 需求分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%B7%A5%E5%85%B7%E5%8E%9F%E6%96%99"><span class="nav-text">2) 工具原料</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%85%B3%E9%94%AE%E6%8A%80%E5%B7%A7"><span class="nav-text">3) 关键技巧</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E7%BC%96%E7%A8%8B%E5%AE%9E%E7%8E%B0"><span class="nav-text">4) 编程实现</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8D%81%E5%9B%9B%E3%80%81%E6%89%93%E9%80%A0%E4%B8%93%E4%B8%9A%E7%9A%84%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83"><span class="nav-text">十四、打造专业的编译环境</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E5%A4%A7%E5%9E%8B%E9%A1%B9%E7%9B%AE%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84-%E6%97%A0%E7%AC%AC%E4%B8%89%E5%BA%93"><span class="nav-text">1、大型项目目录结构(无第三库)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E9%9C%80%E8%A6%81%E6%89%93%E9%80%A0%E7%9A%84%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83"><span class="nav-text">2、需要打造的编译环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%88%86%E6%9E%90"><span class="nav-text">3、项目架构设计分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E5%AE%9E%E7%8E%B0%E9%98%B6%E6%AE%B5%E5%88%86%E6%9E%90"><span class="nav-text">1）实现阶段分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-Compile-%E9%98%B6%E6%AE%B5%E5%AE%9E%E7%8E%B0"><span class="nav-text">a. Compile 阶段实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-Link-%E9%98%B6%E6%AE%B5%E5%AE%9E%E7%8E%B0"><span class="nav-text">b. Link 阶段实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96"><span class="nav-text">2) 编译优化</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="braon-z"
      src="/images/wallhaven.jfif">
  <p class="site-author-name" itemprop="name">braon-z</p>
  <div class="site-description" itemprop="description"> 爱一个人，攀一座山，追一次梦<br>不妨大胆一点，有很多事没有答案</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/yourname" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yourname@gmail.com" title="E-Mail → mailto:yourname@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


<div style="">
  <canvas id="canvas" style="width:60%;">当前浏览器不支持canvas，请更换浏览器后再试</canvas>
</div>
<script>
(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //声明canvas的宽高
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //存储时间数据
    var data = [];
    //存储运动的小球
    var balls = [];
    //设置粒子半径
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //存储时间数字，由十位小时、个位小时、冒号、十位分钟、个位分钟、冒号、十位秒钟、个位秒钟这7个数字组成
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*生成点阵数字*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*更新时钟*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //时间发生变化
            if(NewData[i] !== data[i]){
                //将变化的数字值和在data数组中的索引存储在changeNumArray数组中
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //增加小球
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*更新小球状态*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*增加要运动的小球*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*渲染*/
    function render(){
        //重置画布宽度，达到清空画布的效果
        canvas.height = 100;
        //渲染时钟
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //渲染小球
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //更新时钟
        updateDigitTime();
        //更新小球状态
        updateBalls();
        //渲染
        render();
    },50);
}

})();
</script>
        </div>
      </div>
        <div class="back-to-top animated" role="button">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://example.com/2021/08/18/makfile%E4%B8%93%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/wallhaven.jfif">
      <meta itemprop="name" content="braon-z">
      <meta itemprop="description" content=" 爱一个人，攀一座山，追一次梦<br>不妨大胆一点，有很多事没有答案">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="braon-z's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          makefile专题
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-18 16:37:19" itemprop="dateCreated datePublished" datetime="2021-08-18T16:37:19+08:00">2021-08-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-30 15:19:06" itemprop="dateModified" datetime="2021-08-30T15:19:06+08:00">2021-08-30</time>
      </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Valine：</span>
  
    <a title="valine" href="/2021/08/18/makfile%E4%B8%93%E9%A2%98/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/08/18/makfile%E4%B8%93%E9%A2%98/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>34k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>31 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>记录 makefile 基本知识，学习资料来自狄泰软件学院可在淘宝购买学习</p>
<a id="more"></a>

<h1 id="一、make-和-makefile"><a href="#一、make-和-makefile" class="headerlink" title="一、make 和 makefile"></a><div align=center>一、make 和 makefile</h1><h2 id="1、make-的本质"><a href="#1、make-的本质" class="headerlink" title="1、make 的本质"></a>1、make 的本质</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;make 是一个应用程序，用于<font color=blue>解析源程序之间的依赖关系</font>，根据依赖关系<font color=red>自动维护</font>编译工作，执行宿主操作系统中的各种命令</p>
<h2 id="2、makefile-的本质"><a href="#2、makefile-的本质" class="headerlink" title="2、makefile 的本质"></a>2、makefile 的本质</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;makefile 是一个描述文件, 可以 <font color=purple>定义一系列的规则</font>来指定源文件编译的先后顺, <font color=orange>拥有特定的语法规则</font>，支持函数定义和函数调用, 能够<font color=blue>直接集成</font>操作系统中的各种命令</p>
<h2 id="3、make-和-makefile之间的关系"><a href="#3、make-和-makefile之间的关系" class="headerlink" title="3、make 和 makefile之间的关系"></a>3、make 和 makefile之间的关系</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;makefile 中的描述用于指导 make 如何完成工作，make 根据 makefile 中的规则执行命令，最后完成编译输出</p>
<h2 id="4、最简单的-makefle-程序"><a href="#4、最简单的-makefle-程序" class="headerlink" title="4、最简单的 makefle 程序"></a>4、最简单的 makefle 程序</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">hello </span>: </span><br><span class="line">	<span class="variable">@echo</span> “hello makefile”</span><br><span class="line"></span><br><span class="line">程序说明：</span><br><span class="line">	hello --&gt; 目标     </span><br><span class="line">	<span class="variable">@echo</span> “hello makefile” -&gt; 实现目标所需要执行的命令</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：目标后的命令需要用tab键（’\t’）隔开！<br>要运行 makefile 在 linux 下执行以下命令：</p>
</blockquote>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">make</span> –<span class="selector-tag">f</span> <span class="selector-tag">mf</span><span class="selector-class">.txt</span> <span class="selector-tag">hello</span></span><br><span class="line"></span><br><span class="line">运行结果：<span class="selector-tag">hello</span> <span class="selector-tag">makefile</span></span><br></pre></td></tr></table></figure>
<p>命令功能说明：以 hello 关键字作为目标查找 mf.txt 文件，并执行 hello 目标处的命令</p>
<h2 id="5、make-程序简写"><a href="#5、make-程序简写" class="headerlink" title="5、make 程序简写"></a>5、make 程序简写</h2><p>上述的命令显示的太长，我们可以对其进行简写,有两种方式：1. <font color=red>make hello</font>, 这句话表示以 hello 为关键字作为目标查找 <font color=dark>makeflie</font> 或 Makefile 文件，并执行 hello 处的命令。2. <font color=red>make</font>，这句话表示查找 makefile 或 Makefile 文件中<font color=purple>最顶层目标</font>，并执行<font color=purple>最顶层目标</font>的命令</p>
<h1 id="二、初识-makefile-的结构"><a href="#二、初识-makefile-的结构" class="headerlink" title="二、初识 makefile 的结构"></a><div align=center>二、初识 makefile 的结构</h1><h2 id="1、makefile-的意义"><a href="#1、makefile-的意义" class="headerlink" title="1、makefile 的意义"></a>1、makefile 的意义</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;makefile 用于定义源文件之间的依赖关系，说明如何编译各个源文件并生成可执行文件，依赖的定义如下</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">targets : prerequisite ; <span class="keyword">command</span>1</span><br><span class="line">	‘\t’ <span class="keyword">command</span>2 <span class="comment">#使用这个方式可以省略分号</span></span><br></pre></td></tr></table></figure>
<p><strong>targets(目标)：</strong><br>&nbsp;&nbsp;&nbsp;&nbsp;通常是需要生成的<font color=purple>目标文件名</font>，make 所需执行的命令名称，可以包含多个目标，使用空格对将多个目标隔开</p>
<p><strong>prerequisite(依赖)：</strong><br>&nbsp;&nbsp;&nbsp;&nbsp;当前目标所依赖的其他<font color=dark>目标</font>或<font color=blue>文件</font>，可以包含多个依赖，使用空格对将多个依赖隔开，如果省略不写，就意味着只要执行后续的命令那么目标就可以完成了。</p>
<p><strong>command(命令)：</strong><br>&nbsp;&nbsp;&nbsp;&nbsp;完成目标所需要执行的命令，规则中的注意事项，[tab]键：’\t’ ，每一个命令必须以[tab]字符开始，[tab]字符告诉 make 此行是一个命令行。<font color=brown>只要命令成功执行完，则认为目标完成</font>。</p>
<p><strong>续行符：‘\’</strong>：<br>&nbsp;&nbsp;&nbsp;&nbsp;可以将内容分开写到下一行，提高可读性</p>
<h2 id="3、规则"><a href="#3、规则" class="headerlink" title="3、规则"></a>3、规则</h2><img width src="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/makefile/makefile%E8%A7%84%E5%88%99.jpg?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1629268646;865629182246&q-key-time=1629268646;865629182246&q-header-list=&q-url-param-list=&q-signature=1c3d5df851ddaf2283419ee996ae55dad55ed2d7">

<p>该图描述了 makefile 的规则，举例说明</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">all </span>: test</span><br><span class="line">    <span class="variable">@echo</span> <span class="string">&quot;make all&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">test </span>:</span><br><span class="line">    <span class="variable">@echo</span> <span class="string">&quot;make test&quot;</span></span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line">make test</span><br><span class="line">make all</span><br></pre></td></tr></table></figure>
<p>上述 makefile 定义了两条规则，all 这个目标依赖于 test，如果 test 这个依赖表示的目标成立，就执行 echo “make all” 这个命令，如果 test 不成立，就会以 test 为目标查找其规则。 以 test 为目标的规则没有依赖，因此只需要执行 echo “make test” 命令， test 就会成立。<font color=red>test 成立之后，也就是 all 的依赖完成，因此执行 all 规则的命令 @echo “make all”</font></p>
<h2 id="3、第一个-make-的编译案例"><a href="#3、第一个-make-的编译案例" class="headerlink" title="3、第一个 make 的编译案例"></a>3、第一个 make 的编译案例</h2><p>func.c 文件内容如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> i = <span class="number">5</span>;</span><br></pre></td></tr></table></figure>
<p>main.c 文件内容如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;i = %d\n&quot;</span>, i);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>makefile 文件内容如下</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">hello</span><span class="selector-class">.out</span> : <span class="selector-tag">main</span><span class="selector-class">.o</span> <span class="selector-tag">func</span><span class="selector-class">.o</span></span><br><span class="line">	<span class="selector-tag">gcc</span> <span class="selector-tag">-o</span> <span class="selector-tag">hello</span><span class="selector-class">.out</span> <span class="selector-tag">main</span><span class="selector-class">.o</span> <span class="selector-tag">func</span><span class="selector-class">.o</span></span><br><span class="line"><span class="selector-tag">main</span><span class="selector-class">.o</span> : </span><br><span class="line">	<span class="selector-tag">gcc</span> <span class="selector-tag">-o</span> <span class="selector-tag">main</span><span class="selector-class">.o</span> <span class="selector-tag">-c</span> <span class="selector-tag">main</span><span class="selector-class">.c</span></span><br><span class="line"><span class="selector-tag">func</span><span class="selector-class">.o</span> : </span><br><span class="line">	<span class="selector-tag">gcc</span> <span class="selector-tag">-o</span> <span class="selector-tag">func</span><span class="selector-class">.o</span> <span class="selector-tag">-c</span> <span class="selector-tag">func</span><span class="selector-class">.c</span></span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line"><span class="selector-tag">gcc</span> <span class="selector-tag">-o</span> <span class="selector-tag">main</span><span class="selector-class">.o</span> <span class="selector-tag">-c</span> <span class="selector-tag">main</span><span class="selector-class">.c</span></span><br><span class="line"><span class="selector-tag">gcc</span> <span class="selector-tag">-o</span> <span class="selector-tag">func</span><span class="selector-class">.o</span> <span class="selector-tag">-c</span> <span class="selector-tag">func</span><span class="selector-class">.c</span></span><br><span class="line"><span class="selector-tag">gcc</span> <span class="selector-tag">-o</span> <span class="selector-tag">hello</span><span class="selector-class">.out</span> <span class="selector-tag">main</span><span class="selector-class">.o</span> <span class="selector-tag">func</span><span class="selector-class">.o</span></span><br></pre></td></tr></table></figure>
<p>小技巧：工程开发中可以将最终可执行文件名和 all 同时作为 makefile 中第一条规则</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">hello</span><span class="selector-class">.out</span> <span class="selector-tag">all</span> : <span class="selector-tag">main</span><span class="selector-class">.o</span> <span class="selector-tag">func</span><span class="selector-class">.o</span> </span><br><span class="line">	<span class="selector-tag">gcc</span> <span class="selector-tag">-o</span> <span class="selector-tag">hello</span><span class="selector-class">.out</span> <span class="selector-tag">main</span><span class="selector-class">.o</span> <span class="selector-tag">fun</span><span class="selector-class">.o</span></span><br></pre></td></tr></table></figure>
<p>当我们想手动编译时执行 make all 就会编译，直接 make 则会检测 hello.out。</p>
<h1 id="三、伪目标"><a href="#三、伪目标" class="headerlink" title="三、伪目标"></a><div align=center>三、伪目标</h1><h2 id="1、伪目标的引入"><a href="#1、伪目标的引入" class="headerlink" title="1、伪目标的引入"></a>1、伪目标的引入</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;默认情况下，make 认为<font color=dark>目标对应着一个文件</font>，make <font color=blue>比较目标文件和依赖文件的新旧关系</font>，决定是否执行命令，make 以<font color=purple>文件处理</font>作为第一优先级。但有时候我们希望我们的目录并不是一个文件如下所示：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">clean</span> :</span><br><span class="line">	<span class="selector-tag">rm</span> <span class="selector-tag">main</span><span class="selector-class">.o</span> <span class="selector-tag">func</span><span class="selector-class">.o</span></span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;这个时候通过 .PHONY 关键字声明一个伪目标, 伪目标不对应任何实际的文件,不管目标的依赖是否更新，命令总是执行, 伪目标的语法如下</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : <span class="type">Target</span> </span><br></pre></td></tr></table></figure>
<p>伪目标的本质是 make 中特殊目标 .PHONY 的依赖，先声明、后使用。</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : <span class="type">clean</span> rebuild <span class="keyword">all</span> </span><br><span class="line"></span><br><span class="line">## other rules ## </span><br><span class="line"></span><br><span class="line">rebuile : <span class="type">clean</span> <span class="keyword">all</span></span><br><span class="line"></span><br><span class="line">clean : </span><br><span class="line">	rm *o hello.<span class="keyword">out</span></span><br></pre></td></tr></table></figure>
<p>原理：当一个目标的依赖包含伪目标时，伪目标所定义的命令总是会被执行</p>
<h2 id="2、绕开-PHONY-关键字定义伪目标"><a href="#2、绕开-PHONY-关键字定义伪目标" class="headerlink" title="2、绕开 .PHONY 关键字定义伪目标"></a>2、绕开 .PHONY 关键字定义伪目标</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;如果一个规则没有命令或者依赖，并且它的目标不是一个存在的文件名；在执行此规则时，目标总是被认为是最新的。</p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clean : <span class="keyword">FORCE</span></span><br><span class="line">	rm *.o hello.<span class="keyword">out</span></span><br><span class="line"><span class="keyword">FORCE</span> :</span><br></pre></td></tr></table></figure>
<h1 id="四、变量和不同的赋值方式"><a href="#四、变量和不同的赋值方式" class="headerlink" title="四、变量和不同的赋值方式"></a><div align=center>四、变量和不同的赋值方式</h1><h2 id="1、makefile中的变量"><a href="#1、makefile中的变量" class="headerlink" title="1、makefile中的变量"></a>1、makefile中的变量</h2><p>&nbsp;&nbsp;&nbsp;&nbsp; makefile 中支持程序设计语言中<font color=dark>变量的概念</font>，makefile 中变量只代表<font color=purple>文本数据</font>。makefile 中变量命名规则如下所示</p>
<blockquote>
<ol>
<li>变量名大小写敏感</li>
<li>变量名可以包含字符，数字，下划线</li>
<li>不能包含 “:” , “#” , “=” , 或 “ “</li>
<li>makefile 未赋值的变量的值为空值</li>
</ol>
</blockquote>
<h2 id="2、变量的定义和使用"><a href="#2、变量的定义和使用" class="headerlink" title="2、变量的定义和使用"></a>2、变量的定义和使用</h2><img src="https://myblog-1258129986.cos.ap-chengdu.myqcloud.com/makefile/%E5%8F%98%E9%87%8F%E7%9A%84%E5%AE%9A%E4%B9%89%E5%92%8C%E4%BD%BF%E7%94%A8.png?q-sign-algorithm=sha1&q-ak=AKIDhKF3mfZXf8SeirDbHrMiLZbzDlsoqM1W&q-sign-time=1629172213;88029085813&q-key-time=1629172213;88029085813&q-header-list=&q-url-param-list=&q-signature=340dd806fca1d9e879119a25be61b36aa9e5493a">

<p>修改前面的 makefile 验证</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">CC := gcc</span><br><span class="line">TARGET := hello.out</span><br><span class="line"></span><br><span class="line">$(TARGET) : main<span class="selector-class">.o</span> func.o</span><br><span class="line">    $(CC) -o $(TARGET) main<span class="selector-class">.o</span> func.o</span><br><span class="line">main<span class="selector-class">.o</span> : main.c</span><br><span class="line">    $(CC) -o main<span class="selector-class">.o</span> -c main.c</span><br><span class="line">func<span class="selector-class">.o</span> : func.c</span><br><span class="line">    $(CC) -o func<span class="selector-class">.o</span> -c func.c</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.PHONY</span> : rebuild clean all</span><br><span class="line"></span><br><span class="line">rebuile : clean all</span><br><span class="line"></span><br><span class="line">all : $(TARGET)</span><br><span class="line"></span><br><span class="line">clean :</span><br><span class="line">    rm *<span class="selector-class">.o</span> $(TARGET)</span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line">gcc -o main<span class="selector-class">.o</span> -c main.c</span><br><span class="line">gcc -o func<span class="selector-class">.o</span> -c func.c</span><br><span class="line">gcc -o hello<span class="selector-class">.out</span> main<span class="selector-class">.o</span> func.o</span><br></pre></td></tr></table></figure>
<h2 id="3、makefile中变量的赋值方式"><a href="#3、makefile中变量的赋值方式" class="headerlink" title="3、makefile中变量的赋值方式"></a>3、makefile中变量的赋值方式</h2><h3 id="1-简单赋值"><a href="#1-简单赋值" class="headerlink" title="1)    简单赋值 :="></a>1)    简单赋值 :=</h3><p>程序设计语言中的通用赋值方式, <font color=green>只针对当前语句变量有效</font></p>
<figure class="highlight gml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">x</span> := foo</span><br><span class="line"><span class="symbol">y</span> := $(<span class="symbol">x</span>)b</span><br><span class="line"><span class="symbol">x</span> := new</span><br><span class="line"></span><br><span class="line">.PHONY : test</span><br><span class="line">test :</span><br><span class="line">	@echo “<span class="symbol">x</span> = $(<span class="symbol">x</span>)”</span><br><span class="line">	@echo “<span class="symbol">y</span> = $(<span class="symbol">y</span>)”</span><br><span class="line"></span><br><span class="line">输出结果：</span><br><span class="line">	<span class="symbol">x</span> = new</span><br><span class="line">	<span class="symbol">y</span> = foob</span><br></pre></td></tr></table></figure>
<h3 id="2-递归赋值"><a href="#2-递归赋值" class="headerlink" title="2)    递归赋值 ="></a>2)    递归赋值 =</h3><p>赋值操作可能影响多个其他变量, <font color=blue>所有与目标变量相关的其他变量将受到影响</font></p>
<figure class="highlight gml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">x</span> = foo</span><br><span class="line"><span class="symbol">y</span> = $(<span class="symbol">x</span>)b</span><br><span class="line"><span class="symbol">x</span> = new</span><br><span class="line"></span><br><span class="line">.PHONY : test</span><br><span class="line">test :</span><br><span class="line">	@echo “<span class="symbol">x</span> = $(<span class="symbol">x</span>)”</span><br><span class="line">	@echo “<span class="symbol">y</span> = $(<span class="symbol">y</span>)”</span><br><span class="line"></span><br><span class="line">输出结果：</span><br><span class="line">	<span class="symbol">x</span> = new</span><br><span class="line">	<span class="symbol">y</span> = newb</span><br></pre></td></tr></table></figure>
<h3 id="3-条件赋值"><a href="#3-条件赋值" class="headerlink" title="3) 条件赋值 ?="></a>3) 条件赋值 ?=</h3><p>如果变量未定义，使用赋值符号中的值定义变量, <font color=purple>如果变量已经定义，赋值无效</font></p>
<figure class="highlight gml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">x</span> := foo</span><br><span class="line"><span class="symbol">y</span> := $(<span class="symbol">x</span>)b</span><br><span class="line"><span class="symbol">x</span> ?= new</span><br><span class="line"></span><br><span class="line">.PHONY : test</span><br><span class="line">test :</span><br><span class="line">	@echo “<span class="symbol">x</span> = $(<span class="symbol">x</span>)”</span><br><span class="line">	@echo “<span class="symbol">y</span> = $(<span class="symbol">y</span>)”</span><br><span class="line"></span><br><span class="line">输出结果：</span><br><span class="line">	<span class="symbol">x</span> = foo</span><br><span class="line">	<span class="symbol">y</span> = foob</span><br></pre></td></tr></table></figure>
<h3 id="4-追加赋值"><a href="#4-追加赋值" class="headerlink" title="4) 追加赋值 +="></a>4) 追加赋值 +=</h3><p>原变量值之后加上一个新值, <font color=dark>原变量值与新值之间由空格隔开</font></p>
<figure class="highlight gml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">x</span> := foo</span><br><span class="line"><span class="symbol">y</span> := $(<span class="symbol">x</span>)b</span><br><span class="line"><span class="symbol">x</span> += $(<span class="symbol">y</span>)</span><br><span class="line"></span><br><span class="line">.PHONY : test</span><br><span class="line">test :</span><br><span class="line">	@echo “<span class="symbol">x</span> = $(<span class="symbol">x</span>)”</span><br><span class="line">	@echo “<span class="symbol">y</span> = $(<span class="symbol">y</span>)”</span><br><span class="line"></span><br><span class="line">输出结果：</span><br><span class="line">	<span class="symbol">x</span> = foo foob</span><br><span class="line">	<span class="symbol">y</span> = foob</span><br></pre></td></tr></table></figure>
<h1 id="五、预定义变量的使用"><a href="#五、预定义变量的使用" class="headerlink" title="五、预定义变量的使用"></a><div align=center>五、预定义变量的使用</h1><p>在 makefile 中存在一些预定义的变量，常用的有自动变量以及特殊变量</p>
<h2 id="1-自动变量"><a href="#1-自动变量" class="headerlink" title="1. 自动变量"></a>1. 自动变量</h2><p><strong>$@</strong>  当前规则中触发命令被执行的目标, 即当前规则中的目标<br><strong>$^</strong> 当前规则中的所有依赖<br><strong>$&lt;</strong>  当前规则中的第一个依赖</p>
<h2 id="2、自动变量的使用"><a href="#2、自动变量的使用" class="headerlink" title="2、自动变量的使用"></a>2、自动变量的使用</h2><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PHONY : <span class="keyword">all</span> first second third</span><br><span class="line"></span><br><span class="line"><span class="keyword">all</span> : first second third</span><br><span class="line">	@echo “\<span class="symbol">$</span><span class="symbol">$</span>@ =&gt; <span class="symbol">$</span>@”</span><br><span class="line">	@echo “<span class="symbol">$</span><span class="symbol">$</span>^ =&gt; <span class="symbol">$</span><span class="symbol">$</span>^”</span><br><span class="line">	@echo “<span class="symbol">$</span><span class="symbol">$</span>&lt; =&gt; <span class="symbol">$</span>&lt;”</span><br><span class="line"></span><br><span class="line">first :</span><br><span class="line">second : </span><br><span class="line">third : </span><br><span class="line"></span><br><span class="line">输出结果：</span><br><span class="line">	<span class="symbol">$</span>@ =&gt; <span class="keyword">all</span></span><br><span class="line">	<span class="symbol">$</span>^ =&gt; first second third</span><br><span class="line">	<span class="symbol">$</span>&lt; =&gt; first</span><br></pre></td></tr></table></figure>
<blockquote>
<p>小贴士：<br>&nbsp;&nbsp;&nbsp;&nbsp;”$” 对于 makefile 有特殊含义，输出时加上一个 $ 进行转义<br>&nbsp;&nbsp;&nbsp;&nbsp;”$@” 对于Bash Shell 有特殊含义，输出时加上 \ 进行转义</p>
</blockquote>
<p>使用自动变量改写前面的 makefile</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">CC := gcc</span><br><span class="line">TARGET := hello.out</span><br><span class="line"></span><br><span class="line"><span class="symbol">$</span>(TARGET) : main.o func.o</span><br><span class="line">    <span class="symbol">$</span>(CC) -o <span class="symbol">$</span>@ <span class="symbol">$</span>^</span><br><span class="line">main.o : main.c</span><br><span class="line">    <span class="symbol">$</span>(CC) -o <span class="symbol">$</span>@ -c <span class="symbol">$</span>^</span><br><span class="line">func.o : func.c</span><br><span class="line">    <span class="symbol">$</span>(CC) -o <span class="symbol">$</span>@ -c <span class="symbol">$</span>^</span><br><span class="line"></span><br><span class="line">.PHONY : rebuild clean <span class="keyword">all</span></span><br><span class="line"></span><br><span class="line">rebuile : clean <span class="keyword">all</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">all</span> : <span class="symbol">$</span>(TARGET)</span><br><span class="line"></span><br><span class="line">clean :</span><br><span class="line">    rm *.o <span class="symbol">$</span>(TARGET)</span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line">gcc -o main.o -c main.c</span><br><span class="line">gcc -o func.o -c func.c</span><br><span class="line">gcc -o hello.out main.o func.o</span><br></pre></td></tr></table></figure>
<h2 id="3、特殊变量"><a href="#3、特殊变量" class="headerlink" title="3、特殊变量"></a>3、特殊变量</h2><ul>
<li><p><strong>$(MAKE)</strong>: 当前 make 解释器的文件名</p>
</li>
<li><p><strong>$(MAKECMDGOALS)</strong>: 命令中指定的目标名（ make 的命令行参数）</p>
</li>
<li><p><strong>$(MAKEFILE_LIST)</strong>: make 所需要处理的 makefile 文件列表, 当前 makefile 的文件名总是位于列表的最后, 文件名之间以空格进行划分</p>
</li>
<li><p><strong>$(MAKE_VERSION)</strong>: 当前 make 解释器的版本</p>
</li>
<li><p><strong>$(CURDIR)</strong>: 当前 make 解释器的工作目录</p>
</li>
<li><p><strong>$(.VARIABLES)</strong>: 所有已经定义的变量名列表，其中包括预定义变量和自定义变量</p>
</li>
</ul>
<p>编程实验 1</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : all out test <span class="keyword">first</span> <span class="keyword">second</span> <span class="keyword">third</span></span><br><span class="line"></span><br><span class="line">all out : <span class="keyword">first</span> <span class="keyword">second</span> <span class="keyword">third</span></span><br><span class="line">    @echo <span class="string">&quot;$(MAKE)&quot;</span></span><br><span class="line">    @echo <span class="string">&quot;$(MAKECMDGOALS)&quot;</span></span><br><span class="line">    @echo <span class="string">&quot;$(MAKEFILE_LIST)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">first</span> :</span><br><span class="line">    @echo <span class="string">&quot;first&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">second</span> :</span><br><span class="line">    @echo <span class="string">&quot;second&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">third</span> :</span><br><span class="line">    @echo <span class="string">&quot;third&quot;</span></span><br><span class="line"></span><br><span class="line">test :</span><br><span class="line">    @$(MAKE) <span class="keyword">first</span></span><br><span class="line">    @$(MAKE) <span class="keyword">second</span></span><br><span class="line">    @$(MAKE) <span class="keyword">third</span></span><br><span class="line"></span><br><span class="line">运行 make 结果：</span><br><span class="line"><span class="keyword">first</span></span><br><span class="line"><span class="keyword">second</span></span><br><span class="line"><span class="keyword">third</span></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"> makefile</span><br><span class="line"></span><br><span class="line">运行 make test 结果</span><br><span class="line">make[<span class="number">1</span>]: Entering <span class="built_in">directory</span> <span class="string">&#x27;/home/book/c/mkfile&#x27;</span></span><br><span class="line"><span class="keyword">first</span></span><br><span class="line">make[<span class="number">1</span>]: Leaving <span class="built_in">directory</span> <span class="string">&#x27;/home/book/c/mkfile&#x27;</span></span><br><span class="line">make[<span class="number">1</span>]: Entering <span class="built_in">directory</span> <span class="string">&#x27;/home/book/c/mkfile&#x27;</span></span><br><span class="line"><span class="keyword">second</span></span><br><span class="line">make[<span class="number">1</span>]: Leaving <span class="built_in">directory</span> <span class="string">&#x27;/home/book/c/mkfile&#x27;</span></span><br><span class="line">make[<span class="number">1</span>]: Entering <span class="built_in">directory</span> <span class="string">&#x27;/home/book/c/mkfile&#x27;</span></span><br><span class="line"><span class="keyword">third</span></span><br><span class="line">make[<span class="number">1</span>]: Leaving <span class="built_in">directory</span> <span class="string">&#x27;/home/book/c/mkfile&#x27;</span></span><br></pre></td></tr></table></figure>
<p>编程实验 2</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : test1 test2</span><br><span class="line"></span><br><span class="line">test1 :</span><br><span class="line">    @echo <span class="string">&quot;$(MAKE_VERSION)&quot;</span></span><br><span class="line">    @echo <span class="string">&quot;$(CURDIR)&quot;</span></span><br><span class="line">    @echo <span class="string">&quot;$(.VARIABLES)&quot;</span></span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line"><span class="number">4.1</span> </span><br><span class="line">/home/book/c/mkfile </span><br><span class="line">&lt;D ?F .SHELLFLAGS CWEAVE ?D @D @F MAKE_VERSION CURDIR SHELL RM CO <span class="module-access"><span class="module"><span class="identifier">COMPILE</span>.</span></span><span class="keyword">mod</span> _ PREPROCESS.F <span class="module-access"><span class="module"><span class="identifier">LINK</span>.</span></span>m <span class="module-access"><span class="module"><span class="identifier">LINK</span>.</span></span>o OUTPUT_OPTION <span class="module-access"><span class="module"><span class="identifier">COMPILE</span>.</span></span>cpp MAKEFILE_LIST GNUMAKEFLAGS <span class="module-access"><span class="module"><span class="identifier">LINK</span>.</span></span>p XDG_DATA_DIRS DBUS_SESSION_BUS_ADDRESS CC CHECKOUT,v LESSOPEN CPP <span class="module-access"><span class="module"><span class="identifier">LINK</span>.</span></span>cc SSH_CONNECTION PATH LD TEXI2DVI YACC SSH_TTY XDG_RUNTIME_DIR ARFLAGS <span class="module-access"><span class="module"><span class="identifier">LINK</span>.</span></span>r LINT <span class="module-access"><span class="module"><span class="identifier">COMPILE</span>.</span></span>f <span class="module-access"><span class="module"><span class="identifier">LINT</span>.</span></span>c <span class="module-access"><span class="module"><span class="identifier">YACC</span>.</span></span>m <span class="module-access"><span class="module"><span class="identifier">YACC</span>.</span></span>y AR .FEATURES TANGLE LS_COLORS GET %F DISPLAY COMPILE.F CTANGLE .LIBPATTERNS LINK.C PWD LINK.S <span class="module-access"><span class="module"><span class="identifier">PREPROCESS</span>.</span></span>r *D <span class="module-access"><span class="module"><span class="identifier">LINK</span>.</span></span>c <span class="module-access"><span class="module"><span class="identifier">LINK</span>.</span></span>s HOME LESSCLOSE LOGNAME ^D MAKELEVEL <span class="module-access"><span class="module"><span class="identifier">COMPILE</span>.</span></span>m MAKE SHLVL AS PREPROCESS.S <span class="module-access"><span class="module"><span class="identifier">COMPILE</span>.</span></span>p XDG_SESSION_ID USER FC .DEFAULT_GOAL %D WEAVE MAKE_COMMAND <span class="module-access"><span class="module"><span class="identifier">LINK</span>.</span></span>cpp F77 OLDPWD .VARIABLES PC *F <span class="module-access"><span class="module"><span class="identifier">COMPILE</span>.</span></span>def LEX ARCH MAKEFLAGS MFLAGS SSH_CLIENT MAIL <span class="module-access"><span class="module"><span class="identifier">LEX</span>.</span></span>l <span class="module-access"><span class="module"><span class="identifier">LEX</span>.</span></span>m +D <span class="module-access"><span class="module"><span class="identifier">COMPILE</span>.</span></span>r MAKE_TERMOUT +F M2C CROSS_COMPILE MAKEFILES <span class="module-access"><span class="module"><span class="identifier">COMPILE</span>.</span></span>cc &lt;F CXX COFLAGS COMPILE.C ^F COMPILE.S LINK.F SUFFIXES <span class="module-access"><span class="module"><span class="identifier">COMPILE</span>.</span></span>c <span class="module-access"><span class="module"><span class="identifier">COMPILE</span>.</span></span>s .INCLUDE_DIRS .RECIPEPREFIX MAKEINFO MAKE_TERMERR OBJC MAKE_HOST TEX LANG TERM F77FLAGS <span class="module-access"><span class="module"><span class="identifier">LINK</span>.</span></span>f</span><br></pre></td></tr></table></figure>

<h1 id="六、变量的高级主题"><a href="#六、变量的高级主题" class="headerlink" title="六、变量的高级主题"></a><div align=center>六、变量的高级主题</h1><h2 id="1-常用语法"><a href="#1-常用语法" class="headerlink" title="1. 常用语法"></a>1. 常用语法</h2><h3 id="1）-变量值的替换"><a href="#1）-变量值的替换" class="headerlink" title="1） 变量值的替换"></a>1） 变量值的替换</h3><p>使用<font color=blue>指定字符（串）</font>替换变量中的<font color=green>后缀字符（串）</font>，语法格式如下</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(var:<span class="attribute">a</span>=b) 或 <span class="variable">$&#123;var:a=b&#125;</span></span><br></pre></td></tr></table></figure>
<p>替换表达式中<font color=red>不能有任何的空格</font>，make 中支持使用 <font color=purple>${}</font> 对变量进行取值</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">src := a.cc b.cc c.cc</span><br><span class="line">obj := $(src:cc=o)</span><br><span class="line"><span class="keyword">test </span>:</span><br><span class="line">	@echo ”obj =&gt; $(obj)”</span><br><span class="line"></span><br><span class="line">输出结果：obj = &gt; a.o b.o c.o</span><br></pre></td></tr></table></figure>
<h3 id="2）变量的模式替换"><a href="#2）变量的模式替换" class="headerlink" title="2）变量的模式替换"></a>2）变量的模式替换</h3><p><font color=blue>使用 % 保留变量值中的指定字符</font>，替换其他字符,语法格式如下</p>
<figure class="highlight gml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="keyword">var</span>:a%b=<span class="symbol">x</span>%<span class="symbol">y</span>)或$&#123;<span class="keyword">var</span>:a%b=<span class="symbol">x</span>%<span class="symbol">y</span>&#125;</span><br></pre></td></tr></table></figure>
<p>替换表达式中<font color=dark>不能有任何的空格</font>, make 中支持使用 <font color=purple>${}</font> 对变量进行取值</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">src :<span class="operator">=</span> a<span class="number">1</span>b.<span class="keyword">c</span> a<span class="number">2</span>b.<span class="keyword">c</span> a<span class="number">3</span>b.<span class="keyword">c</span></span><br><span class="line"></span><br><span class="line">obj :<span class="operator">=</span> $(src:a<span class="variable">%b.c</span><span class="operator">=</span><span class="keyword">x</span><span class="variable">%y</span>)</span><br><span class="line"></span><br><span class="line">.PHONY : test</span><br><span class="line"></span><br><span class="line">test :</span><br><span class="line">	<span class="title">@echo</span> <span class="string">&quot;obj =&gt; $(obj)&quot;</span></span><br><span class="line"></span><br><span class="line">输出结果：</span><br><span class="line">	obj <span class="operator">=</span>&gt; <span class="keyword">x</span><span class="number">1</span>y <span class="keyword">x</span><span class="number">2</span>y <span class="keyword">x</span><span class="number">3</span>y</span><br></pre></td></tr></table></figure>
<h3 id="3）规则中的模式替换"><a href="#3）规则中的模式替换" class="headerlink" title="3）规则中的模式替换"></a>3）规则中的模式替换</h3><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">targets : <span class="type">targets</span>-pattern : <span class="type">prereq</span>-pattern</span><br><span class="line">	command1</span><br><span class="line">	command2</span><br><span class="line">	…</span><br></pre></td></tr></table></figure>
<p>当 targets(目标) 的依赖的规则不存在时，通过 targets-pattern 从 targets 中匹配子目标,再通过 prereq-pattern 从子目标生成依赖, 进而构成完整的规则, 举例说明如下。</p>
<figure class="highlight m"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : rebuild clean <span class="built_in">all</span></span><br><span class="line"></span><br><span class="line">CC :<span class="built_in">=</span> gcc</span><br><span class="line">TARGET :<span class="built_in">=</span> hello.out</span><br><span class="line">OBJS :<span class="built_in">=</span> main.o <span class="keyword">func</span>.o</span><br><span class="line"></span><br><span class="line">$(TARGET) : $(OBJS)</span><br><span class="line">    $(CC) -o $@ $^</span><br><span class="line"></span><br><span class="line">##############################</span><br><span class="line">$(OBJS) : <span class="comment">%.o : %.c   // 规则中的模式替换</span></span><br><span class="line">    $(CC) -o $@ -c $^</span><br><span class="line">#############################</span><br><span class="line"></span><br><span class="line">rebuild : clean <span class="built_in">all</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">all</span> : $(TARGET)</span><br><span class="line"></span><br><span class="line">clean :</span><br><span class="line">    rm -rf *.o $(TARGET)</span><br></pre></td></tr></table></figure>
<p>上述 makefile 等价于</p>
<figure class="highlight m"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : rebuild clean <span class="built_in">all</span></span><br><span class="line"></span><br><span class="line">CC :<span class="built_in">=</span> gcc</span><br><span class="line">TARGET :<span class="built_in">=</span> hello.out</span><br><span class="line">OBJS :<span class="built_in">=</span> main.o <span class="keyword">func</span>.o</span><br><span class="line"></span><br><span class="line">$(TARGET) : $(OBJS)</span><br><span class="line">    $(CC) -o $@ $^</span><br><span class="line"></span><br><span class="line">##############################</span><br><span class="line">mian.o : main.c</span><br><span class="line">	gcc -o mian.o -c mian.c</span><br><span class="line"><span class="keyword">func</span>.o : <span class="keyword">func</span>.c</span><br><span class="line">	gcc -o <span class="keyword">func</span>.o -c <span class="keyword">func</span>.o</span><br><span class="line">#############################</span><br><span class="line"></span><br><span class="line">rebuild : clean <span class="built_in">all</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">all</span> : $(TARGET)</span><br><span class="line"></span><br><span class="line">clean :</span><br><span class="line">    rm -rf *.o $(TARGET)</span><br></pre></td></tr></table></figure>
<p>除此之外呢，我们还可以省略掉 targets 如下所示</p>
<figure class="highlight m"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : rebuild clean <span class="built_in">all</span></span><br><span class="line"></span><br><span class="line">CC :<span class="built_in">=</span> gcc</span><br><span class="line">TARGET :<span class="built_in">=</span> hello.out</span><br><span class="line">OBJS :<span class="built_in">=</span> main.o <span class="keyword">func</span>.o</span><br><span class="line"></span><br><span class="line">$(TARGET) : $(OBJS)</span><br><span class="line">    $(CC) -o $@ $^</span><br><span class="line"></span><br><span class="line">##############################</span><br><span class="line"><span class="comment">%.o : %.c   // 规则中的模式替换</span></span><br><span class="line">    $(CC) -o $@ -c $^</span><br><span class="line">#############################</span><br><span class="line"></span><br><span class="line">rebuild : clean <span class="built_in">all</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">all</span> : $(TARGET)</span><br><span class="line"></span><br><span class="line">clean :</span><br><span class="line">    rm -rf *.o $(TARGET)</span><br></pre></td></tr></table></figure>
<p>示例代码在大部分情况可以理解为等价的，特殊情况如下</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%.o : %.c   </span><br><span class="line">    $(CC) -o $@ -c $^</span><br><span class="line"></span><br><span class="line">$(OBJS) : %.o : %.c   <span class="comment">// 规则中的模式替换</span></span><br><span class="line">    $(CC) -o $@ -c $^</span><br></pre></td></tr></table></figure>
<p>当他们同时存在的时候，$(CC) -o $@ -c $^ 代码会被执行两次。并且 $(OBJS) : %.o : %.c 的规则会被替换为 %.o : %.c 的规则</p>
<h3 id="4）变量值的嵌套引用"><a href="#4）变量值的嵌套引用" class="headerlink" title="4）变量值的嵌套引用"></a>4）变量值的嵌套引用</h3><p>一个变量名之中可以包含对其他变量的引用，嵌套引用的本质是使用一个变量表示另一个变量</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">x := y</span><br><span class="line">y := z</span><br><span class="line">a := $($(x))</span><br><span class="line"></span><br><span class="line"><span class="keyword">test </span>:</span><br><span class="line">	@echo &quot;a ==&gt; $(a)&quot;</span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line">	a ==&gt; z</span><br></pre></td></tr></table></figure>
<h3 id="5）命令行变量"><a href="#5）命令行变量" class="headerlink" title="5）命令行变量"></a>5）命令行变量</h3><p>运行 make 时，在命令行定义变量，命令行变量<font color=dark>默认覆盖 makefile 中定义的变量</font></p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hm := hello makefile</span><br><span class="line"><span class="keyword">test </span>:</span><br><span class="line">	@echo “hm =&gt; $(hm)”</span><br><span class="line"></span><br><span class="line">执行：make hm := cmd</span><br><span class="line"></span><br><span class="line">运行结果：hm =&gt; cmd</span><br></pre></td></tr></table></figure>
<h3 id="6）override-关键字"><a href="#6）override-关键字" class="headerlink" title="6）override 关键字"></a>6）override 关键字</h3><p>用于指示 makefile 中定义的变量<font color=blue>不能被覆盖</font>, 变量的定义和赋值都要用到 override 关键字</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">override var := test</span><br><span class="line"><span class="keyword">test </span>: </span><br><span class="line">	@echo “var =&gt; $(var)”</span><br><span class="line"></span><br><span class="line">执行：make var:=cmd</span><br><span class="line"></span><br><span class="line">执行结果：hm =&gt; test</span><br></pre></td></tr></table></figure>
<h3 id="7）define关键字"><a href="#7）define关键字" class="headerlink" title="7）define关键字"></a>7）define关键字</h3><p>用于在 makefile 中定义多行变量, 多行变量的定义从变量名开始到 endef 结束, 可以使用 override 关键字防止变量被覆盖, define 定义的变量<font color=purple>等价于</font>使用 = 定义的变量</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">define foo</span><br><span class="line">I’m fool:</span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line">override define <span class="keyword">cmd</span></span><br><span class="line"><span class="bash">@<span class="built_in">echo</span> <span class="string">&quot;run cmd begin ...&quot;</span></span></span><br><span class="line">@echo <span class="string">&quot;run cmd end ...&quot;</span></span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line">test :</span><br><span class="line">	@echo <span class="string">&quot;$(foo)&quot;</span></span><br><span class="line">	$(<span class="keyword">cmd</span><span class="bash">)</span></span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line">	I’m fool:</span><br><span class="line">	<span class="keyword">run</span><span class="bash"> cmd begin ...</span></span><br><span class="line">	<span class="keyword">run</span><span class="bash"> cmd end ...</span></span><br></pre></td></tr></table></figure>
<h2 id="2、环境变量（全局变量）"><a href="#2、环境变量（全局变量）" class="headerlink" title="2、环境变量（全局变量）"></a>2、环境变量（全局变量）</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;makefile 中能够直接使用环境变量的值，<font color=red>定义了同名变量</font>，默认环境变量将被覆盖。运行 make 时<font color=blue>指定 “-e” 选项</font>使用系统默认环境变量。环境变量可以在所有的 makefile 中使用，过多的依赖环境变量会使系统的移植性降低。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;变量在不同的 makefile 中的传递方式有三种：<font color=purple>直接在外部定义环境变量进行传递</font>、使用 <font color=brown>export</font> 定义变量进行传递(定义临时环境变量)、定义 make <font color=dark>命令行变量进行传递</font>(推荐)。</p>
<p>编程实验, makefile 文件如下</p>
<figure class="highlight m"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PWD :<span class="built_in">=</span> pwd                    # 修改系统环境变量</span><br><span class="line">export var :<span class="built_in">=</span> D.T.Software    # 定义临时环境变量</span><br><span class="line">version :<span class="built_in">=</span> v1                 # 普通变量</span><br><span class="line">user :<span class="built_in">=</span>baron                  # 普通变量</span><br><span class="line"></span><br><span class="line">test :</span><br><span class="line">    @echo <span class="string">&quot;PWD ==&gt; $(PWD)&quot;</span></span><br><span class="line">    @echo <span class="string">&quot;make another file ...&quot;</span></span><br><span class="line">    $(MAKE) -f makefile2</span><br><span class="line">    $(MAKE) -f makefile2 user:<span class="built_in">=</span>$(user)  # 将 user 这个变量通过 make 进行传递</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>makefile2 文件如下</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">test </span>:</span><br><span class="line">    <span class="variable">@echo</span> <span class="string">&quot;PWD ==&gt; $(PWD)&quot;</span></span><br><span class="line">    <span class="variable">@echo</span> <span class="string">&quot;var = $(var)&quot;</span></span><br><span class="line">    <span class="variable">@echo</span> <span class="string">&quot;version = $(version)&quot;</span></span><br><span class="line">    <span class="variable">@echo</span> <span class="string">&quot;user = $(user)&quot;</span></span><br></pre></td></tr></table></figure>
<p>运行结果如下</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PWD ==&gt; <span class="keyword">pwd</span></span><br><span class="line"><span class="keyword">make</span> another <span class="keyword">file</span> ...</span><br><span class="line"><span class="keyword">make</span> -<span class="keyword">f</span> makefile2</span><br><span class="line"><span class="keyword">make</span>[<span class="number">1</span>]: Entering directory <span class="string">&#x27;/home/book/c/mkfile&#x27;</span></span><br><span class="line">PWD ==&gt; <span class="keyword">pwd</span></span><br><span class="line">var = D.T.Software</span><br><span class="line"><span class="keyword">version</span> =</span><br><span class="line">user =</span><br><span class="line"><span class="keyword">make</span>[<span class="number">1</span>]: Leaving directory <span class="string">&#x27;/home/book/c/mkfile&#x27;</span></span><br><span class="line"><span class="keyword">make</span> -<span class="keyword">f</span> makefile2 user:=baron</span><br><span class="line"><span class="keyword">make</span>[<span class="number">1</span>]: Entering directory <span class="string">&#x27;/home/book/c/mkfile&#x27;</span></span><br><span class="line">PWD ==&gt; <span class="keyword">pwd</span></span><br><span class="line">var = D.T.Software</span><br><span class="line"><span class="keyword">version</span> =</span><br><span class="line">user = baron</span><br><span class="line"><span class="keyword">make</span>[<span class="number">1</span>]: Leaving directory <span class="string">&#x27;/home/book/c/mkfile&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="3、目标变量（局部变量）"><a href="#3、目标变量（局部变量）" class="headerlink" title="3、目标变量（局部变量）"></a>3、目标变量（局部变量）</h2><p>作用域只在<font color=red>指定目标</font>及<font color=purple>连带规则中</font></p>
<p><strong>语法格式</strong></p>
<figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">target : <span class="keyword">variable</span><span class="number">_n</span>ame := <span class="keyword">variable</span>-<span class="keyword">value</span></span><br></pre></td></tr></table></figure>
<p><strong>举例说明</strong></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">var <span class="symbol">:</span>= D.T.Software</span><br><span class="line">test : var <span class="symbol">:</span>= test-var</span><br><span class="line"></span><br><span class="line">test : test1</span><br><span class="line">    <span class="variable">@echo</span> <span class="string">&quot;test:&quot;</span></span><br><span class="line">    <span class="variable">@echo</span> <span class="string">&quot;var =&gt; $(var)&quot;</span></span><br><span class="line"></span><br><span class="line">test1 <span class="symbol">:</span></span><br><span class="line">    <span class="variable">@echo</span> <span class="string">&quot;test1:&quot;</span></span><br><span class="line">    <span class="variable">@echo</span> <span class="string">&quot;var ==&gt; $(var)&quot;</span></span><br><span class="line"></span><br><span class="line">test2 : </span><br><span class="line">	<span class="variable">@echo</span> <span class="string">&quot;test2:&quot;</span></span><br><span class="line">	<span class="variable">@echo</span> <span class="string">&quot;var ==&gt; $(var)&quot;</span></span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line">book<span class="variable">@100ask</span><span class="symbol">:~/c/mkfile</span><span class="variable">$ </span>make</span><br><span class="line">test1</span><br><span class="line">var ==&gt; test-var</span><br><span class="line"><span class="symbol">test:</span></span><br><span class="line">var =&gt; test-var</span><br><span class="line">book<span class="variable">@100ask</span><span class="symbol">:~/c/mkfile</span>$</span><br><span class="line">book<span class="variable">@100ask</span><span class="symbol">:~/c/mkfile</span><span class="variable">$ </span>make test2</span><br><span class="line"><span class="symbol">test2:</span></span><br><span class="line">var ==&gt; D.T.Software</span><br></pre></td></tr></table></figure>
<h2 id="4、模式变量（局部变量）"><a href="#4、模式变量（局部变量）" class="headerlink" title="4、模式变量（局部变量）"></a>4、模式变量（局部变量）</h2><p>模式变量是目标变量的扩展，<font color=brown>作用域只在符合模式的目标及连带规则中</font></p>
<p><strong>语法格式</strong></p>
<figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%target : <span class="keyword">variable</span><span class="number">_n</span>ame := <span class="keyword">variable</span>-<span class="keyword">value</span></span><br></pre></td></tr></table></figure>
<p><strong>举例说明</strong></p>
<p>当前要定义一个名为 new 的局部变量，new 的作用域是所有已 e 结尾的目标及连带规则。</p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> := TDelphi</span><br><span class="line">%e : <span class="keyword">override</span> <span class="keyword">new</span> := test-<span class="keyword">new</span></span><br><span class="line">rule :</span><br><span class="line">    <span class="keyword">@echo</span> <span class="string">&quot;rule:&quot;</span></span><br><span class="line">    <span class="keyword">@echo</span> <span class="string">&quot;new =&gt; $(new)&quot;</span></span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line">rule:</span><br><span class="line"><span class="keyword">new</span> =&gt; test-<span class="keyword">new</span></span><br></pre></td></tr></table></figure>
<h1 id="七、条件判断语句"><a href="#七、条件判断语句" class="headerlink" title="七、条件判断语句"></a><div align=center>七、条件判断语句</h1><h2 id="1、makefile中的条件判断语句"><a href="#1、makefile中的条件判断语句" class="headerlink" title="1、makefile中的条件判断语句"></a>1、makefile中的条件判断语句</h2><p>可以<font color=brown>根据条件值</font>来决定 make 的执行、可以<font color=blue>比较</font>两个不同变量或变量和常量值。基本形式如下：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ifxxx (arg1,arg2) <span class="meta">#注意括号里面不能使用空格</span></span><br><span class="line"> <span class="meta"># for true</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"> <span class="meta"># for false</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>
<p>其他合法形式</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ifxxx <span class="string">&quot;arg1&quot;</span> <span class="string">&quot;arg2&quot;</span></span><br><span class="line">ifxxx <span class="string">&quot;arg1&quot;</span> &#x27;arg2&#x27;</span><br><span class="line">ifxxx &#x27;arg1&#x27; <span class="string">&quot;arg2&quot;</span></span><br><span class="line">ifxxx &#x27;arg1&#x27; <span class="string">&quot;arg2&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="2、条件判断关键字"><a href="#2、条件判断关键字" class="headerlink" title="2、条件判断关键字"></a>2、条件判断关键字</h2><table>
<thead>
<tr>
<th>关键字</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>ifeq  ($(x),$(y))</td>
<td>判断参数是否相等，相等为 true ，否则为 false</td>
</tr>
<tr>
<td>ifneq ($(x),$(y))</td>
<td>判断参数是否不相等，不相等则为 true，否则为false</td>
</tr>
<tr>
<td>ifdef  x</td>
<td>判断变量是否有值，有值为 true，否则为false</td>
</tr>
<tr>
<td>ifndef x</td>
<td>判断变量是否没有值，没有为 true，否则为false</td>
</tr>
</tbody></table>
<blockquote>
<p>注意：条件判断语句只能用与控制 make 中实际执行的语句；但是，不能控制规则中命令的执行过程。</p>
</blockquote>
<h2 id="3、工程使用小结"><a href="#3、工程使用小结" class="headerlink" title="3、工程使用小结"></a>3、工程使用小结</h2><ul>
<li>条件判断语句之前可以有空格，<font color=red>但不能有tab字符 (‘t&#39;)</font></li>
<li>在条件判断语句中<font color=blue>不要用自动变量</font> ($@,$^,$&lt;)</li>
<li>一条完整的条件语句<font color=purple>必须</font>位于同一个 makefile 中</li>
<li>条件判断类似于 c 语言中的宏，<font color=brown>预处理阶段有效，执行阶段无效</font></li>
<li>make 在加载 makefile 时首先计算表达式的值（<font color=green>赋值方式不同计算方式不同</font>）,根据判断语句的表达式决定执行的内容</li>
</ul>
<h2 id="5、举例说明"><a href="#5、举例说明" class="headerlink" title="5、举例说明"></a>5、举例说明</h2><h3 id="1）条件判断关键字程序实例"><a href="#1）条件判断关键字程序实例" class="headerlink" title="1）条件判断关键字程序实例"></a>1）条件判断关键字程序实例</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : test  </span><br><span class="line">	  </span><br><span class="line">var1 := cmd</span><br><span class="line">var2 := $(var1)</span><br><span class="line"></span><br><span class="line">test:  </span><br><span class="line">    ife<span class="string">q ($(var1)</span>,$(var2)) <span class="comment"># 注意最前面不是 table 隔开是 4 个空格</span></span><br><span class="line">	@echo <span class="string">&quot;var1 == var2&quot;</span></span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">	@echo <span class="string">&quot;var1 != var2&quot;</span></span><br><span class="line">    endif</span><br><span class="line"></span><br><span class="line">    ifne<span class="string">q ($(var1)</span>,$(var2))</span><br><span class="line">	@echo <span class="string">&quot;var1 != var2&quot;</span></span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">	@echo <span class="string">&quot;var1 == var2&quot;</span></span><br><span class="line">    endif</span><br><span class="line">    </span><br><span class="line">    ifdef var1</span><br><span class="line">	@echo <span class="string">&quot;var1 is NOT empty&quot;</span> </span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	@echo <span class="string">&quot;var1 is empty&quot;</span></span><br><span class="line">    endif</span><br><span class="line">	</span><br><span class="line">    ifndef var1</span><br><span class="line">	@echo <span class="string">&quot;var1 is empty&quot;</span> </span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	@echo <span class="string">&quot;var1 is NOT empty&quot;</span></span><br><span class="line">    endif</span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line">	var1 == var2</span><br><span class="line">	var1 == var2</span><br><span class="line">	var1 is NOT empty</span><br><span class="line">	var1 is NOT empty</span><br></pre></td></tr></table></figure>
<h3 id="2）条件判断关键字异常分析"><a href="#2）条件判断关键字异常分析" class="headerlink" title="2）条件判断关键字异常分析"></a>2）条件判断关键字异常分析</h3><h4 id="a）异常情况1"><a href="#a）异常情况1" class="headerlink" title="a）异常情况1"></a>a）异常情况1</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : test</span><br><span class="line"></span><br><span class="line">var3 =</span><br><span class="line">var4 = <span class="variable">$(</span>var3)</span><br><span class="line"></span><br><span class="line"><span class="symbol">test:</span></span><br><span class="line">    <span class="keyword">if</span><span class="function"><span class="keyword">def</span> <span class="title">var3</span> </span></span><br><span class="line">	<span class="variable">@echo</span> <span class="string">&quot;var3 is defined&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	<span class="variable">@echo</span> <span class="string">&quot;var3 is NOT defined&quot;</span></span><br><span class="line">    endif</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span><span class="function"><span class="keyword">def</span> <span class="title">var4</span></span></span><br><span class="line">	<span class="variable">@echo</span> <span class="string">&quot;var4 is defined&quot;</span>    </span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	<span class="variable">@echo</span> <span class="string">&quot;var4 is NOT defined&quot;</span>    </span><br><span class="line">    endif</span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line">	var3 is NOT <span class="function"><span class="keyword">def</span><span class="title">ined</span></span></span><br><span class="line">	var4 is <span class="function"><span class="keyword">def</span><span class="title">ined</span></span></span><br></pre></td></tr></table></figure>
<p><strong>运行结果分析</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;我们所期望的运行结果是 var3 与 var4 都是未定义，但这里运行结果表示 var4 的值为定义。</p>
<p><strong>原因分析</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;产生这个结果的原因就是，make 在加载 makefile 时首先计算表达式的值，由于我们使用的赋值表达式为 = 因此，makfile 在预处理 ifdef var4 时无法确定 var4 的值是否定义，因此 make 解释器在这里默认为 var4 的值为已定义的值。</p>
<h4 id="b）异常情况2"><a href="#b）异常情况2" class="headerlink" title="b）异常情况2"></a>b）异常情况2</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : test</span><br><span class="line"></span><br><span class="line">var3 =</span><br><span class="line">var4 = <span class="variable">$(</span>var3)</span><br><span class="line"></span><br><span class="line"><span class="symbol">test:</span></span><br><span class="line">    <span class="keyword">if</span><span class="function"><span class="keyword">def</span> <span class="title">var3</span></span></span><br><span class="line">	<span class="variable">@echo</span> <span class="string">&quot;var3 is defined&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	<span class="variable">@echo</span> <span class="string">&quot;var3 is NOT defined&quot;</span></span><br><span class="line">    endif</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span><span class="function"><span class="keyword">def</span> <span class="title">var4</span></span></span><br><span class="line">	<span class="variable">@echo</span> <span class="string">&quot;var4 is defined&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	<span class="variable">@echo</span> <span class="string">&quot;var4 is NOT defined&quot;</span></span><br><span class="line">    endif</span><br><span class="line">    </span><br><span class="line">var3 = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line">	var3 is NOT <span class="function"><span class="keyword">def</span><span class="title">ined</span></span></span><br><span class="line">	var4 is <span class="function"><span class="keyword">def</span><span class="title">ined</span></span></span><br></pre></td></tr></table></figure>
<h4 id="c）异常情况3"><a href="#c）异常情况3" class="headerlink" title="c）异常情况3"></a>c）异常情况3</h4><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : test</span><br><span class="line"></span><br><span class="line">var3 =</span><br><span class="line">var4 = <span class="variable">$(</span>var3)</span><br><span class="line">var3 = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">test:</span></span><br><span class="line">    <span class="keyword">if</span><span class="function"><span class="keyword">def</span> <span class="title">var3</span></span></span><br><span class="line">	<span class="variable">@echo</span> <span class="string">&quot;var3 is defined&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	<span class="variable">@echo</span> <span class="string">&quot;var3 is NOT defined&quot;</span></span><br><span class="line">    endif</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span><span class="function"><span class="keyword">def</span> <span class="title">var4</span></span></span><br><span class="line">	<span class="variable">@echo</span> <span class="string">&quot;var4 is defined&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	<span class="variable">@echo</span> <span class="string">&quot;var4 is NOT defined&quot;</span></span><br><span class="line">    endif</span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line">	var3 is <span class="function"><span class="keyword">def</span><span class="title">ined</span></span></span><br><span class="line">	var4 is <span class="function"><span class="keyword">def</span><span class="title">ined</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>小贴士：a为不对 var3 赋值, b、c 为 var 赋值的位置不同产生的结果不同</p>
</blockquote>
<h1 id="八、函数的定义以及调用"><a href="#八、函数的定义以及调用" class="headerlink" title="八、函数的定义以及调用"></a><div align=center>八、函数的定义以及调用</h1><h2 id="1、makefile-支持函数的概念"><a href="#1、makefile-支持函数的概念" class="headerlink" title="1、makefile 支持函数的概念"></a>1、makefile 支持函数的概念</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;make 解释器<font color=purple>提供了一系列的函数</font>供 makefile 调用。在 makefile 中<font color=dark>支持自定义函数实现</font>，并调用执行。通过 <font color=blue>define</font> 关键字实现自定义函数</p>
<h2 id="2、自定义函数语法"><a href="#2、自定义函数语法" class="headerlink" title="2、自定义函数语法"></a>2、自定义函数语法</h2><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">define func1</span><br><span class="line">	<span class="meta">@echo</span> “My name <span class="keyword">is</span> $(<span class="number">0</span>)”</span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line">define func2</span><br><span class="line">	<span class="meta">@echo</span> “My name <span class="keyword">is</span> $(<span class="number">0</span>)”</span><br><span class="line">	<span class="meta">@echo</span> “Param =&gt; $(<span class="number">1</span>)”</span><br><span class="line">endef</span><br></pre></td></tr></table></figure>
<p>函数调用：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">test </span>: </span><br><span class="line">	$(call func1)</span><br><span class="line">	$(call func2,D.T.Software)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>函数通过call关键字调用，$(0)、$(1)、$(3)、…代表依次传入的参数</p>
</blockquote>
<h2 id="3、深入理解自定义函数"><a href="#3、深入理解自定义函数" class="headerlink" title="3、深入理解自定义函数"></a>3、深入理解自定义函数</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;自定义函数是<font color=red>一个多行变量</font>，无法直接调用。自定义函数是一个<font color=blue>过程调用</font>，没有任何返回值。自定义函数<font color=brown>用于定义命令集合</font>，并应用于规则中</p>
<h2 id="4-实例分析"><a href="#4-实例分析" class="headerlink" title="4. 实例分析"></a>4. 实例分析</h2><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">define func1</span><br><span class="line">	@<span class="built_in">echo</span> <span class="string">&quot;My name is $(0)&quot;</span></span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line">define func2</span><br><span class="line">	@<span class="built_in">echo</span> <span class="string">&quot;My name is $(0)&quot;</span></span><br><span class="line">	@<span class="built_in">echo</span> <span class="string">&quot;Param =&gt; $(1)&quot;</span></span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line">.PHONY : test</span><br><span class="line"></span><br><span class="line">test :</span><br><span class="line">	$(func1)</span><br><span class="line">	$(func2)</span><br><span class="line">	@<span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">	$(<span class="built_in">call</span> func1)</span><br><span class="line">	$(<span class="built_in">call</span> func2, Delphi)</span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line">	My <span class="built_in">name</span> is </span><br><span class="line">	My <span class="built_in">name</span> is </span><br><span class="line">	<span class="built_in">Param</span> =&gt; </span><br><span class="line">	</span><br><span class="line">	My <span class="built_in">name</span> is func1</span><br><span class="line">	My <span class="built_in">name</span> is func2</span><br><span class="line">	<span class="built_in">Param</span> =&gt;  Delphi</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;函数调用的本质就是宏替换的过程，<font color=red>通过 call 可以将相应的 “形参” 替换成 “实参” </font> $(0)、$(1)、$(3)、…，因此上述代码在运行的时候等价于</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">define func1</span><br><span class="line">	@<span class="built_in">echo</span> <span class="string">&quot;My name is <span class="subst">$(0)</span>&quot;</span></span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line">define func2</span><br><span class="line">	@<span class="built_in">echo</span> <span class="string">&quot;My name is <span class="subst">$(0)</span>&quot;</span></span><br><span class="line">	@<span class="built_in">echo</span> <span class="string">&quot;Param =&gt; <span class="subst">$(1)</span>&quot;</span></span><br><span class="line">endef</span><br><span class="line"></span><br><span class="line">.PHONY : <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">test</span> :</span><br><span class="line">	@<span class="built_in">echo</span> <span class="string">&quot;My name is &quot;</span></span><br><span class="line">	@<span class="built_in">echo</span> <span class="string">&quot;My name is &quot;</span></span><br><span class="line">	@<span class="built_in">echo</span> <span class="string">&quot;Param =&gt; &quot;</span></span><br><span class="line">	@<span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">	@<span class="built_in">echo</span> <span class="string">&quot;My name is func1&quot;</span></span><br><span class="line">	@<span class="built_in">echo</span> <span class="string">&quot;My name is func2&quot;</span></span><br><span class="line">	@<span class="built_in">echo</span> <span class="string">&quot;Param =&gt; Delphi&quot;</span></span><br></pre></td></tr></table></figure>
<h1 id="九、变量与函数的综合示例"><a href="#九、变量与函数的综合示例" class="headerlink" title="九、变量与函数的综合示例"></a><div align=center>九、变量与函数的综合示例</h1><h2 id="1、实战需求"><a href="#1、实战需求" class="headerlink" title="1、实战需求"></a>1、实战需求</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;<font color=dark>自动生成 target 文件夹</font>存放可执行文件, <font color=blue>自动生成 bojs 文件夹</font>存放编译生成的目标文件（*.o），支持<font color=purple>调试版本</font>的编译选项，考虑代码的扩展性</p>
<h2 id="2、工具原料"><a href="#2、工具原料" class="headerlink" title="2、工具原料"></a>2、工具原料</h2><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor">$(<span class="params">wildcard</span> <span class="params">_pattern</span>)</span></span><br></pre></td></tr></table></figure>
<p>获取当前工作目录中满足 _pattern 的文件或目录列表</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor">$(<span class="params">addprefix</span> <span class="params">_prefix</span>, <span class="params">_names</span>)</span></span><br></pre></td></tr></table></figure>
<p>给名字列表 _name 中的每一个名字增加前缀 _prefix </p>
<h2 id="3、关键技巧"><a href="#3、关键技巧" class="headerlink" title="3、关键技巧"></a>3、关键技巧</h2><ul>
<li><strong>1) 自动获取当前目录小的文件列表（函数调用）</strong></li>
</ul>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SRCS := <span class="variable">$(<span class="built_in">wildcard</span> *.c)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>2) 根据源文件列表生成目标文件列表（变量的值替换）</strong></li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">OBJS :</span>= $(<span class="attr">SRCS:</span>.c=.o)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>3) 对每个目标文件加上前缀路径（函数调用）</strong></li>
</ul>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">addprefix</span> apth/,<span class="variable">$(OBJS)</span>)</span></span><br></pre></td></tr></table></figure>
<h2 id="4、编译规则的依赖"><a href="#4、编译规则的依赖" class="headerlink" title="4、编译规则的依赖"></a>4、编译规则的依赖</h2><img width=600 src="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/1.png" >

<h2 id="5-编程实现"><a href="#5-编程实现" class="headerlink" title="5. 编程实现"></a>5. 编程实现</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">CC := gcc</span><br><span class="line">RM := rm -rf</span><br><span class="line">MKDIR := mkdir</span><br><span class="line"></span><br><span class="line">DIR_OBJS := objs</span><br><span class="line">DIR_TARGETS := target</span><br><span class="line"></span><br><span class="line">DIR := <span class="variable">$(DIR_OBJS)</span> <span class="variable">$(DIR_TARGETS)</span></span><br><span class="line"></span><br><span class="line">TARGET := <span class="variable">$(DIR_TARGETS)</span>/hello.out</span><br><span class="line"></span><br><span class="line">SRCS := <span class="variable">$(<span class="built_in">wildcard</span> *.c)</span></span><br><span class="line">OBJS := $(SRCS:.c=.o)</span><br><span class="line">OBJS := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_OBJS)</span>/,<span class="variable">$(OBJS)</span>)</span></span><br><span class="line"></span><br><span class="line">.PHONY := rebuild clean all</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span> : <span class="variable">$(DIR)</span> <span class="variable">$(OBJS)</span></span><br><span class="line">    <span class="variable">$(CC)</span> -o <span class="variable">$@</span> <span class="variable">$(OBJS)</span></span><br><span class="line">    @echo <span class="string">&quot;Target File ==&gt; <span class="variable">$@</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(DIR)</span> :</span><br><span class="line">    <span class="variable">$(MKDIR)</span> <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(DIR_OBJS)</span>/%.o : %.c</span><br><span class="line">    <span class="keyword">ifeq</span> (<span class="variable">$(DEBUG)</span>,true)</span><br><span class="line">        <span class="variable">$(CC)</span> -o <span class="variable">$@</span> -g -c <span class="variable">$^</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="variable">$(CC)</span> -o <span class="variable">$@</span> -c <span class="variable">$^</span></span><br><span class="line">    <span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line">clean :</span><br><span class="line">    <span class="variable">$(RM)</span> <span class="variable">$(DIR)</span></span><br><span class="line"></span><br><span class="line">rebuild : clean all</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;在当前目录下创建 objs target 文件，编译链接当前目录下 .c 文件，将生成的 .o 文件存放到 objs 文件夹，生成的可执行文件 app.out 存放在 target 文件夹，最后运行可执行程序 app.out 。其中当 DEBUG=true 时添加编译选项 -g 实现调试功能</p>
<h1 id="十、include-关键字"><a href="#十、include-关键字" class="headerlink" title=" 十、include 关键字"></a><div align=center> 十、include 关键字</h1><h2 id="1-include-关键字的处理方式"><a href="#1-include-关键字的处理方式" class="headerlink" title="1. include 关键字的处理方式"></a>1. include 关键字的处理方式</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;在当前目录搜索或指定目录搜索目标文件</p>
<h3 id="1）搜索成功"><a href="#1）搜索成功" class="headerlink" title="1）搜索成功"></a>1）搜索成功</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;类似于 c 语言中 include 关键字，<font color=blue>将文件内容直接搬到</font> makefile 中, 编程实验如下</p>
<p>test.txt 文件中的内容</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">test </span>:</span><br><span class="line">	<span class="variable">@echo</span> <span class="string">&quot;this is test&quot;</span></span><br></pre></td></tr></table></figure>
<p>makefile 内容</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : <span class="keyword">all</span> clean</span><br><span class="line"></span><br><span class="line">include test.txt </span><br><span class="line"> </span><br><span class="line"><span class="keyword">all</span> :</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;this is all&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">make</span> <span class="keyword">all</span> 运行结果：</span><br><span class="line">	this <span class="keyword">is</span> test</span><br></pre></td></tr></table></figure>
<h3 id="2）搜索失败"><a href="#2）搜索失败" class="headerlink" title="2）搜索失败"></a>2）搜索失败</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;产生警告，以<font color=dark>文件作为目标查找并执行相应规则</font>，当文件名对应的规则不存在时，最终产生错误</p>
<h4 id="a）规则存在"><a href="#a）规则存在" class="headerlink" title="a）规则存在"></a>a）规则存在</h4><p>test.txt 文件不存在</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">include test.txt </span><br><span class="line"> </span><br><span class="line"><span class="keyword">all</span> :</span><br><span class="line">	@echo <span class="string">&quot;this is all&quot;</span></span><br><span class="line"></span><br><span class="line">test.txt :</span><br><span class="line">	@echo <span class="string">&quot;test.txt is not exist&quot;</span></span><br><span class="line"></span><br><span class="line">make <span class="keyword">all</span> 运行结果：</span><br><span class="line">	makefile:<span class="number">2</span>: test.txt: 没有那个文件或目录</span><br><span class="line">	test.txt <span class="keyword">is</span> <span class="keyword">not</span> exist</span><br><span class="line">	this <span class="keyword">is</span> <span class="keyword">all</span></span><br></pre></td></tr></table></figure>
<h4 id="b）规则不存在"><a href="#b）规则不存在" class="headerlink" title="b）规则不存在"></a>b）规则不存在</h4><p>test.txt 文件不存在</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">include</span> <span class="selector-tag">test</span><span class="selector-class">.txt</span> </span><br><span class="line"> </span><br><span class="line"><span class="selector-tag">all</span> :</span><br><span class="line">	<span class="keyword">@echo</span> <span class="string">&quot;this is all&quot;</span></span><br><span class="line"></span><br><span class="line">make all 运行结果：</span><br><span class="line">	<span class="attribute">makefile:</span><span class="number">2</span>: test.<span class="attribute">txt:</span> 没有那个文件或目录</span><br><span class="line">	<span class="attribute">make:</span> *** 没有规则可以创建目标“test.txt”。 停止。</span><br></pre></td></tr></table></figure>
<h2 id="2-include关键字使用总结"><a href="#2-include关键字使用总结" class="headerlink" title="2. include关键字使用总结"></a>2. include关键字使用总结</h2><h3 id="1）当目标文件不存在"><a href="#1）当目标文件不存在" class="headerlink" title="1）当目标文件不存在"></a>1）当目标文件不存在</h3><img src="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/3.png" >

<h3 id="2）当目标文件存在"><a href="#2）当目标文件存在" class="headerlink" title="2）当目标文件存在"></a>2）当目标文件存在</h3><img src="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/4.png" >

<h3 id="3-减号-的使用"><a href="#3-减号-的使用" class="headerlink" title="3) 减号 - 的使用"></a>3) 减号 - 的使用</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;使用减号 - 不但关闭了 include 发出的警告，同时关闭了错误；<font color=red>当错误发生时 make 将忽略这些错误</font>。</p>
<h1 id="十一、自动生成依赖关系"><a href="#十一、自动生成依赖关系" class="headerlink" title="十一、自动生成依赖关系"></a><div align=center>十一、自动生成依赖关系</h1><h2 id="1、编译行为带来的缺陷"><a href="#1、编译行为带来的缺陷" class="headerlink" title="1、编译行为带来的缺陷"></a>1、编译行为带来的缺陷</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;预处理器直接将头文件中的代码直接插入源文件，编译器只通过预处理后的源文件产生目标文件，因此，规则中<font color = red>以源文件为依赖，修改头文件后，命令可能无法执行</font></p>
<h2 id="2-、解决方案"><a href="#2-、解决方案" class="headerlink" title="2.、解决方案"></a>2.、解决方案</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;<font color=blue>可以将头文件作为依赖条件出现于每一个目标对应的规则中</font>，当头文件改动，<font color = brown>任何源文件都将被重新编译</font>（编译低效），但是这种方案当项目中头文件数量巨大时，<font color=green>makefile 将很难维护</font></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;由于上述方案存在的缺陷，思考是否可以<font color=dark>自动生成</font>依赖解决,通过命令<font color=purple>自动生成</font>对头文件的依赖，将生成的依赖<font color=blue>自动包含</font>进 makefile 中，当头文件改动后，自动确认需要重新编译的文件。</p>
<h2 id="3、预备知识"><a href="#3、预备知识" class="headerlink" title="3、预备知识"></a>3、预备知识</h2><p>自动生成依赖文件需要一些预备知识</p>
<h3 id="1-sed-流编辑器"><a href="#1-sed-流编辑器" class="headerlink" title="1) sed 流编辑器"></a>1) sed 流编辑器</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;sed 是一个流编辑器，用于流文本的修改（增/删/查/改），sed 可以用于流文本中的字符串替换，sed 字符串替换方式为：<font color=dark>sed ‘s:src:des:g’</font>。sed 字符串替换实例如下：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : test</span><br><span class="line"></span><br><span class="line"><span class="keyword">test </span>:</span><br><span class="line">	@echo &quot;test = &gt; abc+abc=abc&quot; | sed &#x27;s:abc:xyz:g&#x27;</span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line">	test =&gt; xyz+xyz=xyz</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp; sed 还支持正则表达式，在 sed 中可以用正则表达式匹配替换目标，并且可以使用匹配的目标生成替换结果</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed &#x27;s,<span class="symbol">\(</span>.*<span class="symbol">\)</span><span class="symbol">\.</span>o[ :]*,objs/<span class="symbol">\1</span>.o : ,g&#x27;</span><br></pre></td></tr></table></figure>
<p>该表达式的结果为将流文本中的.o文件加上路径前缀 objs/</p>
<h3 id="2-gcc-关键编译选项"><a href="#2-gcc-关键编译选项" class="headerlink" title="2) gcc 关键编译选项"></a>2) gcc 关键编译选项</h3><p>获取目标的完整依赖关系，即包含 “” 和 &lt;&gt; 两者的头文件</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -M <span class="keyword">test</span>.c</span><br></pre></td></tr></table></figure>
<pre><code>获取目标的部分依赖关系，即用 &quot;&quot; 包含的头文件</code></pre>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -MM <span class="keyword">test</span>.c</span><br></pre></td></tr></table></figure>
<h3 id="3-拆分目标的依赖"><a href="#3-拆分目标的依赖" class="headerlink" title="3) 拆分目标的依赖"></a>3) 拆分目标的依赖</h3><p>将目标的完整依赖拆分为多个部分依赖</p>
<img width=600 src="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/2.png" >

<h3 id="4-make-中的命令执行机制"><a href="#4-make-中的命令执行机制" class="headerlink" title="4) make 中的命令执行机制"></a>4) make 中的命令执行机制</h3><p>规则中的每个命令默认是在一个新的进程中执行（shell）</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : all</span><br><span class="line"></span><br><span class="line">all :</span><br><span class="line">	<span class="keyword">mkdir</span> <span class="keyword">test</span></span><br><span class="line">	<span class="keyword">cd</span> <span class="keyword">test</span> </span><br><span class="line">	<span class="keyword">mkdir</span> subtest</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>运行结果</strong><br>&nbsp;&nbsp;&nbsp;&nbsp;期待的运行结果为，创建一个文件夹 test，在 test 中创建子文件夹 subtest，但实际运行结果为在当前目录下创建出两个文件夹分别为 test 和 subtest</p>
</li>
<li><p><strong>运行结果分析</strong><br>&nbsp;&nbsp;&nbsp;&nbsp;make 创建一个进程执行 mkdir test，执行完后进程结束，回到当前目录。make 又创建一个进程执行 cd test，执行完后进程结束，回到当前目录。make 再次创建一个进程执行 mkdir subtest，执行完后进程结束，回到当前目录。因此最终结果在当前目录下创建两个文件夹 test 和 subtest。</p>
</li>
<li><p><strong>解决方案</strong><br>&nbsp;&nbsp;&nbsp;&nbsp;set-e 指定发生错误后立即退出执行。可以通过分号 ; 和接续符 \ 将多个命令组合成一个命令。组合的命令一次在同一个进程中被执行，无论是否出错。</p>
</li>
<li><p><strong>代码修改</strong></p>
</li>
</ul>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : all</span><br><span class="line"></span><br><span class="line">all :</span><br><span class="line">	<span class="keyword">set</span> -<span class="keyword">e</span>; \</span><br><span class="line">	<span class="keyword">mkdir</span> <span class="keyword">test</span>; \</span><br><span class="line">	<span class="keyword">cd</span> <span class="keyword">test</span>; \</span><br><span class="line">	<span class="keyword">mkdir</span> subtest</span><br></pre></td></tr></table></figure>
<h2 id="4、自动生成依赖关系"><a href="#4、自动生成依赖关系" class="headerlink" title="4、自动生成依赖关系"></a>4、自动生成依赖关系</h2><h3 id="1）自动生成依赖文件"><a href="#1）自动生成依赖文件" class="headerlink" title="1）自动生成依赖文件"></a>1）自动生成依赖文件</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;通过 include 指令包含所有的 .dep 依赖文件，当 .dep 依赖文件不存在时，使用规则自动生成</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : all clean</span><br><span class="line"></span><br><span class="line">CC := gcc</span><br><span class="line">RM := rm -rf</span><br><span class="line">MKDIR := mkdir</span><br><span class="line"></span><br><span class="line">SRCS := <span class="variable">$(<span class="built_in">wildcard</span> *.c)</span></span><br><span class="line">DEPS := $(SRCS:.c=.dep)</span><br><span class="line"></span><br><span class="line"><span class="keyword">-include</span> <span class="variable">$(DEPS)</span></span><br><span class="line"></span><br><span class="line">all :</span><br><span class="line">	@echo all</span><br><span class="line"></span><br><span class="line">%.dep : %.c</span><br><span class="line">	@echo <span class="string">&quot;Creating <span class="variable">$@</span>...&quot;</span></span><br><span class="line">	set -e;\</span><br><span class="line">	<span class="variable">$(CC)</span> -MM <span class="variable">$^</span> | sed &#x27;s,\(.*\)\.o[ :]*,objs/\1.o : ,g&#x27; &gt; <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	<span class="variable">$(RM)</span> *.dep</span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line">	Creating func.dep ...</span><br><span class="line">	Creating main.dep ...</span><br><span class="line">	make: Nothing to be done for &#x27;objs/main.o&#x27;.</span><br></pre></td></tr></table></figure>
<h3 id="2-集中管理-dep-文件"><a href="#2-集中管理-dep-文件" class="headerlink" title="2) 集中管理 .dep 文件"></a>2) 集中管理 .dep 文件</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;当 include 发现 .dep 文件不存在，<font color=dark>通过规则和命令创建 deps 文件夹</font>，<font color=blue>将所有的 .dep 文件创建到 deps 文件夹</font>，<font color=purple>.dep 文件中记录目标文件的依赖关系</font></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : all clean</span><br><span class="line"></span><br><span class="line">MKDIR := mkdir</span><br><span class="line">RM := rm -fr</span><br><span class="line">CC := gcc</span><br><span class="line"></span><br><span class="line">DIR_DEPS := deps</span><br><span class="line"></span><br><span class="line">SRCS := <span class="variable">$(<span class="built_in">wildcard</span> *.c)</span></span><br><span class="line">DEPS := $(SRCS:.c=.dep)</span><br><span class="line">DEPS := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_DEPS)</span>/,<span class="variable">$(DEPS)</span>)</span></span><br><span class="line">	</span><br><span class="line"><span class="keyword">-include</span> <span class="variable">$(DEPS)</span></span><br><span class="line"></span><br><span class="line">all :</span><br><span class="line">	@echo <span class="string">&quot;all&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(DIR_DEPS)</span>:</span><br><span class="line">	<span class="variable">$(MKDIR)</span> <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(DIR_DEPS)</span>/%.dep : <span class="variable">$(DIR_DEPS)</span> %.c</span><br><span class="line">	@echo <span class="string">&quot;Creating <span class="variable">$@</span> ...&quot;</span></span><br><span class="line">	@set -e; \</span><br><span class="line">	<span class="variable">$(CC)</span> -MM -E <span class="variable">$(<span class="built_in">filter</span> %.c, <span class="variable">$^</span>)</span> | sed &#x27;s,\(.*\)\.o[ :]*,objs/\1.o : ,g&#x27; &gt; <span class="variable">$@</span></span><br><span class="line">	 </span><br><span class="line">clean :</span><br><span class="line">	<span class="variable">$(RM)</span> <span class="variable">$(DIR_DEPS)</span></span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line">	mkdir deps</span><br><span class="line">	Creating deps/sub.dep ...</span><br><span class="line">	Creating deps/add.dep ...</span><br><span class="line">	Creating deps/a.dep ...</span><br><span class="line">	Creating deps/sub.dep ...</span><br><span class="line">	all	</span><br></pre></td></tr></table></figure>
<h3 id="3-一些-dep-文件会被重复创建多次"><a href="#3-一些-dep-文件会被重复创建多次" class="headerlink" title="3) 一些 .dep 文件会被重复创建多次"></a>3) 一些 .dep 文件会被重复创建多次</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;deps 文件夹的时间属性会因为依赖文件创建而发生改变，make 发现 deps 文件夹比对应的目标更新，触发相应规则的重新解析和命令的执行</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>解决方案</strong>,添加宏代码块进行判断，当不存在 deps 文件添加文件依赖关系，否则取消文件依赖关系</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ifeq ($(wildcard $(DIR_DEPS)), )</span><br><span class="line">$(DIR_DEPS)/%.dep : $(DIR_DEPS) %.c</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">$(DIR_DEPS)/%.dep : %.c</span><br></pre></td></tr></table></figure>
<h3 id="4-自动生成依赖的最终实现"><a href="#4-自动生成依赖的最终实现" class="headerlink" title="4) 自动生成依赖的最终实现"></a>4) 自动生成依赖的最终实现</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : all clean</span><br><span class="line"></span><br><span class="line">MKDIR := mkdir</span><br><span class="line">RM := rm -fr</span><br><span class="line">CC := gcc</span><br><span class="line"></span><br><span class="line">DIR_DEPS := deps</span><br><span class="line">DIR_OBJS := objs</span><br><span class="line">DIR_EXE  := exes</span><br><span class="line">DIRS := <span class="variable">$(DIR_OBJS)</span> <span class="variable">$(DIR_EXE)</span></span><br><span class="line"></span><br><span class="line">APP = <span class="variable">$(DIR_EXE)</span>/app.out</span><br><span class="line"></span><br><span class="line">SRCS := <span class="variable">$(<span class="built_in">wildcard</span> *.c)</span></span><br><span class="line">DEPS := $(SRCS:.c=.dep)</span><br><span class="line">DEPS := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_DEPS)</span>/,<span class="variable">$(DEPS)</span>)</span></span><br><span class="line">OBJS := $(SRCS:.c=.o)</span><br><span class="line">OBJS := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_OBJS)</span>/,<span class="variable">$(OBJS)</span>)</span></span><br><span class="line">	</span><br><span class="line">all : <span class="variable">$(APP)</span></span><br><span class="line">	./<span class="variable">$(APP)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(APP)</span> : <span class="variable">$(DIRS)</span> <span class="variable">$(OBJS)</span></span><br><span class="line">	@echo <span class="string">&quot;target ==&gt; <span class="variable">$@</span>&quot;</span></span><br><span class="line">	<span class="variable">$(CC)</span> -o <span class="variable">$@</span> <span class="variable">$(OBJS)</span></span><br><span class="line">	</span><br><span class="line"><span class="variable">$(DIRS)</span> :</span><br><span class="line">	<span class="variable">$(MKDIR)</span> <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(DIR_OBJS)</span>/%.o : %.c</span><br><span class="line">	<span class="variable">$(CC)</span> -c <span class="variable">$(<span class="built_in">filter</span> %.c, <span class="variable">$^</span>)</span> -o <span class="variable">$@</span></span><br><span class="line">	</span><br><span class="line"><span class="keyword">ifeq</span> (<span class="string">&quot;<span class="variable">$(MAKECMDGOALS)</span>&quot;</span>,<span class="string">&quot;all&quot;</span>)</span><br><span class="line"><span class="keyword">-include</span> <span class="variable">$(DEPS)</span> </span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="string">&quot;<span class="variable">$(MAKECMDGOALS)</span>&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="keyword">-include</span> <span class="variable">$(DEPS)</span> </span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(DIR_DEPS)</span>:</span><br><span class="line">	<span class="variable">$(MKDIR)</span> <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(<span class="built_in">wildcard</span> <span class="variable">$(DIR_DEPS)</span>)</span>, )</span><br><span class="line"><span class="variable">$(DIR_DEPS)</span>/%.dep : <span class="variable">$(DIR_DEPS)</span> %.c</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="variable">$(DIR_DEPS)</span>/%.dep : %.c</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line">	@echo <span class="string">&quot;Creating <span class="variable">$@</span> ...&quot;</span></span><br><span class="line">	@set -e; \</span><br><span class="line">	<span class="variable">$(CC)</span> -MM -E <span class="variable">$(<span class="built_in">filter</span> %.c, <span class="variable">$^</span>)</span> | sed &#x27;s,\(.*\)\.o[ :]*,objs/\1.o : ,g&#x27; &gt; <span class="variable">$@</span></span><br><span class="line">	</span><br><span class="line">clean :</span><br><span class="line">	<span class="variable">$(RM)</span> <span class="variable">$(DIR_DEPS)</span> <span class="variable">$(DIRS)</span></span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;代码存在问题，当头文件中包含其他头文件时可能出现修改头文件，make 无法执行的情况。解决方案，将依赖文件名，作为目标加入自动生成的依赖关系中，通过 include 加载依赖文件时判断是否执行规则，在规则执行时重新生成依赖关系文件，最后加载新的依赖文件。即修改上述代码 52 行,在冒号前加入 $@</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(CC) -MM -E $(<span class="keyword">filter</span> %.c, $^) | sed <span class="string">&#x27;s,\(.*\)\.o[ :]*,objs/\1.o $@: ,g&#x27;</span> &gt; $@</span><br></pre></td></tr></table></figure>
<h1 id="十二、make-的隐式规则"><a href="#十二、make-的隐式规则" class="headerlink" title="十二、make 的隐式规则"></a><div align=center>十二、make 的隐式规则</h1><h2 id="1、makfile-中出现同名目标时"><a href="#1、makfile-中出现同名目标时" class="headerlink" title="1、makfile 中出现同名目标时"></a>1、makfile 中出现同名目标时</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;<font color=red>所有的依赖合并在一起，成为目标的最终依赖</font>。当多处出现同一目标命令时，make 发出警告。<font color=purple>所有之前定义的命令被最后定义的命令取代.</font></p>
<blockquote>
<p>注意事项：<br>当使用 include 关键字包含其他文件时，<font color=brown>需要确保被包含文件中的同名目标只有依赖</font>，<font color=blue>没有命令否则</font>，同名文件将被覆盖！</p>
</blockquote>
<h2 id="2、隐式规则"><a href="#2、隐式规则" class="headerlink" title="2、隐式规则"></a>2、隐式规则</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;<font color=green>make 提供了一些常用的，预定义的规则实现</font>。make 提供了生成目标文件的隐式规则，隐式规则会使用预定义变量完成编译工作，改变预定义变量将部分改变隐式规则的行为，当存在自定义规则时，不在使用隐式规则，当相应目标的规则未提供时，make 尝试使用隐式规则。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SRCS := <span class="variable">$(<span class="built_in">wildcard</span> *.c)</span></span><br><span class="line">OBJS := $(SRCS:.c=.o)</span><br><span class="line"></span><br><span class="line">app.out : <span class="variable">$(OBJS)</span></span><br><span class="line">    <span class="variable">$(CC)</span> -o <span class="variable">$@</span> <span class="variable">$^</span></span><br><span class="line">    <span class="variable">$(RM)</span> <span class="variable">$^</span></span><br><span class="line">    @echo <span class="string">&quot;Target ==&gt; <span class="variable">$@</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">运行结果:</span></span><br><span class="line">cc    -c -o main.o main.c</span><br><span class="line">cc    -c -o func.o func.c</span><br><span class="line">cc -o app.out main.o func.o</span><br><span class="line">rm -f main.o func.o</span><br><span class="line">Target ==&gt; app.out</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp; 上述 makefile 没有 $(OBJS) 的规则，为什么能正常运行，就是因为 make 的标准库中提供了对应的规则，当 make 发现目标的依赖不存在时，尝试通过依赖名逐一查找隐式规则，并且通过依赖名推到可能需要的源文件。最后根据文件后缀自动推导编译命令。</p>
<h2 id="3、隐式规则的副作用"><a href="#3、隐式规则的副作用" class="headerlink" title="3、隐式规则的副作用"></a>3、隐式规则的副作用</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;<font color=dark>编译行为难以控制</font>，大量使用隐式规则可能产生意想不到的编译行为。<font color=purple>编译效率低下</font>，make 从隐式规则和自定义规则中选择最终使用的规则。<font color=blue>隐式规则链</font>，当依赖目标存在时，make 会极力组合各种隐式规则对目标进行创建，进而产生意料之外的编译行为！查看隐式规则的方式如下。</p>
<p>查看所有规则</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">make -p</span></span><br></pre></td></tr></table></figure>
<p>查看具体规则</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">make</span> -<span class="keyword">p</span> | <span class="keyword">grep</span> <span class="string">&quot;XXX&quot;</span></span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;除此之外还可以使用前面提到的 .VARIABLES 预定义变量查看 make 的自定义变量。我们可以通过下面方式禁用隐式规则。<font color=dark>在 makefile 中自定义规则</font>，<font color=brown>在 makefile 中自定义模式（如：%.o : %.c）</font>，<font color=blue>全局禁用：make -r</font>。</p>
<h2 id="4、后缀规则"><a href="#4、后缀规则" class="headerlink" title="4、后缀规则"></a>4、后缀规则</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;后缀规则是旧式的“模式规则”，可以通过后缀描述的方式自定义规则</p>
<img width=600 src="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/5.png">

<p>&nbsp;&nbsp;&nbsp;&nbsp;双后缀规则，定义一对文件后缀（依赖文件后缀和目标文件后缀）</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">.cpp.o</span> &lt;==&gt; %<span class="string">.o</span> : %<span class="string">.cpp</span></span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;单后缀规则，定义单个后缀文件（源文件后缀）</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.c  &lt;==&gt; <span class="meta">%</span> : <span class="meta">%</span>.c</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;后缀规则需要注意，后缀规则中<font color=red>不允许有依赖</font>。后缀规则<font color=brown>必须有命令</font>，否则无意义。后缀规则将逐步被模式规则取代。</p>
<h1 id="十三、makefile-中的路径搜索"><a href="#十三、makefile-中的路径搜索" class="headerlink" title="十三、makefile 中的路径搜索"></a><div align=center>十三、makefile 中的路径搜索</h1><p>&nbsp;&nbsp;&nbsp;&nbsp;项目中的 makefile <font color=red>必须能够正确的定位源文件和依赖文件</font>，最终编译生成可执行程序。常用的源代码管理方式如下</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Project</span><br><span class="line">   |</span><br><span class="line"><span class="string">   </span>|</span><br><span class="line">   |<span class="string">---------&gt;Module1</span></span><br><span class="line"><span class="string">   </span>|<span class="string">             </span>|</span><br><span class="line">   |<span class="string">             </span>|<span class="string">---------&gt;inc</span></span><br><span class="line"><span class="string">   </span>|<span class="string">             </span>|</span><br><span class="line">   |<span class="string">             </span>|<span class="string">---------&gt;src</span></span><br><span class="line"><span class="string">   </span>|</span><br><span class="line">   |<span class="string">---------&gt;Module2</span></span><br><span class="line"><span class="string">                </span>|</span><br><span class="line">                |<span class="string">---------&gt;inc</span></span><br><span class="line"><span class="string">                </span>|</span><br><span class="line">                |<span class="string">---------&gt;src</span></span><br></pre></td></tr></table></figure>
<h2 id="1、特殊的预定义变量-VPATH（全大写）"><a href="#1、特殊的预定义变量-VPATH（全大写）" class="headerlink" title="1、特殊的预定义变量 VPATH（全大写）"></a>1、特殊的预定义变量 VPATH（全大写）</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;VPATH 变量的值用于<font color=dark>指示 make 如何查找文件</font>，<font color=blue>不同文件夹可作为 VPATH 的值同时出现</font>，<font color=brown>文件夹的名字需要使用分隔符进行区分</font></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">VPATH :</span>= inc src （空格）</span><br><span class="line"><span class="attr">VPATH :</span>= inc;src （分号）</span><br><span class="line"><span class="attr">VPATH :</span>= <span class="attr">inc:</span>src （冒号）</span><br></pre></td></tr></table></figure>
<h3 id="1）make-对于-VAPATH-值得处理方式"><a href="#1）make-对于-VAPATH-值得处理方式" class="headerlink" title="1）make 对于 VAPATH 值得处理方式"></a>1）make 对于 VAPATH 值得处理方式</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;当前文件夹找不到需要的文件时，VPATH会被使用，<font color=green>make 会在 VPATH 指定的文件夹中依次搜索文件</font>，当多个文件夹存在同名文件时，<font color=purple>选择第一次搜索到的文件</font></p>
<blockquote>
<p><strong>注意事项：</strong><br>   VPATH 只能决定 make 的搜索路径，无法决定命令的搜索路径<br>   <font color=red>对于特定的编译命令（gcc），需要独立指定编译搜索路径</font><br>   <strong>语法：gcc -I include-path</strong></p>
</blockquote>
<h3 id="2）VAPATH-使用实例"><a href="#2）VAPATH-使用实例" class="headerlink" title="2）VAPATH 使用实例"></a>2）VAPATH 使用实例</h3><p>.c 文件存放于 src 文件夹，.o 文件存放于 inc 文件夹，make 自动搜索相关路径生成可执行文件 app.out</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : all clean</span><br><span class="line"></span><br><span class="line">MKDIR := mkdir</span><br><span class="line">RM := rm -rf</span><br><span class="line">CC := gcc</span><br><span class="line"></span><br><span class="line">APP := app.out</span><br><span class="line"></span><br><span class="line">DIR_INC := inc</span><br><span class="line">DIR_SRC := src</span><br><span class="line"></span><br><span class="line">VPATH := inc src</span><br><span class="line"></span><br><span class="line">CFLAGS := -I<span class="variable">$(DIR_INC)</span></span><br><span class="line"></span><br><span class="line">all : <span class="variable">$(APP)</span> </span><br><span class="line">	@echo <span class="string">&quot;target ==&gt; <span class="variable">$(APP)</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(APP)</span> : a.o sub.o add.o</span><br><span class="line">	<span class="variable">$(CC)</span> -o <span class="variable">$@</span> <span class="variable">$^</span></span><br><span class="line">	</span><br><span class="line">%.o : %.c</span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> -c <span class="variable">$^</span> -o <span class="variable">$@</span></span><br><span class="line">	</span><br><span class="line">clean :</span><br><span class="line">	<span class="variable">$(RM)</span> *.o *.out</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;由于当多个文件夹存在同名文件时，选择第一次搜索到的文件这也会带来问题, 当 inc 文件意外出现源文件（c/cpp文件），那可能出现编译错误！可以使用 <font color=blue>vpath</font> 为不同类型的文件指定不同的搜索路径。</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">vpath</span> <span class="built_in">Pattern</span> <span class="built_in">Directory</span></span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;在 Directory 下搜索符合 Pattern 的规则文件，将上述 VPATH 修改为 vpath</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">vpath %</span>.h inc</span><br><span class="line"><span class="built_in">vpath %</span>.c src</span><br></pre></td></tr></table></figure>
<h2 id="2、取消搜索规则"><a href="#2、取消搜索规则" class="headerlink" title="2、取消搜索规则"></a>2、取消搜索规则</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;取消已经设置的某个搜索规则</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vpath <span class="built_in">Pattern</span></span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;示例</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vpath %.h <span class="keyword">inc</span>  <span class="meta"># 在 inc 中搜索 .h 文件</span></span><br><span class="line">Vpath %h       <span class="meta"># 不在 inc 中搜索 .h 文件</span></span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;取消所有已经设置的规则</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">vpath</span></span><br></pre></td></tr></table></figure>
<h2 id="3、问题分析"><a href="#3、问题分析" class="headerlink" title="3、问题分析"></a>3、问题分析</h2><ul>
<li><p><strong>当 VPATH 和 vpath 关键字同时出现，make 会如何处理？</strong><br>&nbsp;&nbsp;&nbsp;&nbsp;make 首先在当前文件夹下搜索需要的文件，如果失败: make首先在 vpath 提供的路径下寻搜索目标文件。当搜索失败时，转而搜索 VPATH 指定的文件夹</p>
</li>
<li><p><strong>当使用 vpath 对同一个 Pattern 指定多个文件夹时，make 会如何处理？</strong><br>make 首先在当前文件夹搜索需要的文件，如果失败：make 以自上而下的顺序搜索 vpath 指定的文件夹。当找到目标文件，搜索结束</p>
</li>
</ul>
<blockquote>
<p>小贴士：<br>在实际工程开发中优先选择 vpath 关键字预防 make 隐式规则的副作用</p>
</blockquote>
<ul>
<li><strong>通过 VPATH 变量指定搜索路径后，make 如何决定目标文件的最终位置？</strong><br>&nbsp;&nbsp;&nbsp;&nbsp;当 app.out 完全不存在，make 在<font color=purple>当前文件夹</font>下创建 app.out。<font color=dark>当 src 文件中存在 app.out</font>，<font color=blue>所有目标依赖的新旧关系不变，make 不会创建 app.out</font>。当依赖文件被更新，make 在<font color=purple>当前文件夹</font>下创建 app.out</li>
</ul>
<blockquote>
<p><strong>解决方案</strong><br>使用 GPATH 特殊变量指定目标文件夹 <font color=red>GPATH := src</font><br>当 app.out 完全不存在,make 默认在当前文件夹创建 app.out。当 app.out 存在于 src，且依赖文件被更新。make 在 src 中创建 app.out</p>
</blockquote>
<h2 id="4、工程建议"><a href="#4、工程建议" class="headerlink" title="4、工程建议"></a>4、工程建议</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;尽量使用 vpath 为不同文件指定搜索路径、不要在源代码文件夹中生成目标文件、为编译得到的结果创立独立的文件夹、避免 VTPAH 和 GPATH 特殊变量的使用、只要使用 VPATH 就要考虑是否使用 GPATH</p>
<h2 id="5、路径搜索的综合示例"><a href="#5、路径搜索的综合示例" class="headerlink" title="5、路径搜索的综合示例"></a>5、路径搜索的综合示例</h2><h3 id="1-需求分析"><a href="#1-需求分析" class="headerlink" title="1) 需求分析"></a>1) 需求分析</h3><ul>
<li>工程项目中<font color=red>不希望</font>源码文件夹在编译过程中被改动（只读文件夹）</li>
<li>在编译时<font color=blue>自动创建文件夹</font>（build）用于存放编译的结果</li>
<li>编译过程能够<font color=purple>自动搜索需要的文件</font></li>
<li>makefile 易于扩展，<font color=brown>能够复用于相同类型的项目</font></li>
<li>支持<font color=green>调试版本</font>的编译选项</li>
</ul>
<img width=800 src="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/6.png">

<h3 id="2-工具原料"><a href="#2-工具原料" class="headerlink" title="2) 工具原料"></a>2) 工具原料</h3><p>获取 $(DIR) 文件夹中满足 _pattern 的文件</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">wildcard</span> <span class="variable">$(DIR)</span>/_pattern)</span></span><br></pre></td></tr></table></figure>
<p>去除 _names 中每一个文件名的路径前缀</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor">$(<span class="params">notdir</span> <span class="params">_names</span>)</span></span><br></pre></td></tr></table></figure>
<p>将 _text 中符合 _pattern 的部分替换为 replacement</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="constructor">$(<span class="params">patsubst</span> <span class="params">_pattern</span>, <span class="params">replacement</span>, <span class="params">_text</span>)</span></span><br></pre></td></tr></table></figure>
<h3 id="3-关键技巧"><a href="#3-关键技巧" class="headerlink" title="3) 关键技巧"></a>3) 关键技巧</h3><p>自动获取源文件列表（函数调用）</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SRCS := <span class="variable">$(<span class="built_in">wildcard</span> src/*.c)</span></span><br></pre></td></tr></table></figure>
<p>根据源文件列表生成目标文件列表（变量值的替换）</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">OBJS :</span>= $(<span class="attr">SRCS:</span>.c=.o)</span><br></pre></td></tr></table></figure>
<p>替换每一个目标的路径前缀（函数调用）</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OBJS := <span class="variable">$(<span class="built_in">patsubst</span> src/%,build/%,<span class="variable">$(OBJS)</span>)</span></span><br></pre></td></tr></table></figure>
<h3 id="4-编程实现"><a href="#4-编程实现" class="headerlink" title="4) 编程实现"></a>4) 编程实现</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : all clean</span><br><span class="line"></span><br><span class="line">MKDIR := mkdir</span><br><span class="line">RM := rm -rf</span><br><span class="line">CC := gcc</span><br><span class="line"></span><br><span class="line">DIR_INC := inc</span><br><span class="line">DIR_SRC := src</span><br><span class="line">DIR_BUILDS := build</span><br><span class="line"></span><br><span class="line">TYPE_INT := .h</span><br><span class="line">TYPE_SRC := .c</span><br><span class="line">TYPE_OBJ := .o</span><br><span class="line"></span><br><span class="line">DEBUG := </span><br><span class="line"></span><br><span class="line">LFLAGS := </span><br><span class="line">CFLAGS := -I <span class="variable">$(DIR_INC)</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(DEBUG)</span>,true)</span><br><span class="line">CFLAGS += -g</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line">APP := <span class="variable">$(DIR_BUILDS)</span>/app.out</span><br><span class="line"></span><br><span class="line">SCRS := <span class="variable">$(<span class="built_in">wildcard</span> <span class="variable">$(DIR_SRC)</span>/*<span class="variable">$(TYPE_SRC)</span>)</span></span><br><span class="line">OBJS := $(SCRS:<span class="variable">$(TYPE_SRC)</span>=<span class="variable">$(TYPE_OBJ)</span>)</span><br><span class="line">OBJS := <span class="variable">$(<span class="built_in">patsubst</span> <span class="variable">$(DIR_SRC)</span>/%,<span class="variable">$(DIR_BUILDS)</span>/%,<span class="variable">$(OBJS)</span>)</span></span><br><span class="line">HDRS := <span class="variable">$(<span class="built_in">wildcard</span> <span class="variable">$(DIR_INC)</span>/*<span class="variable">$(TYPE_INC)</span>)</span></span><br><span class="line">HDRS := <span class="variable">$(<span class="built_in">notdir</span> <span class="variable">$(HDRS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">vpath</span> %<span class="variable">$(TYPE_INC)</span> <span class="variable">$(DIR_INC)</span></span><br><span class="line"><span class="keyword">vpath</span> %<span class="variable">$(TYPE_SRC)</span> <span class="variable">$(DIR_SRC)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">all : <span class="variable">$(DIR_BUILDS)</span> <span class="variable">$(APP)</span> </span><br><span class="line">	./<span class="variable">$(APP)</span></span><br><span class="line">	</span><br><span class="line"><span class="variable">$(DIR_BUILDS)</span> :</span><br><span class="line">	<span class="variable">$(MKDIR)</span> <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(APP)</span> : <span class="variable">$(OBJS)</span></span><br><span class="line">	@echo <span class="string">&quot;target ==&gt; <span class="variable">$(APP)</span>&quot;</span></span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(LFLAGS)</span> -o <span class="variable">$@</span> <span class="variable">$^</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(DIR_BUILDS)</span>/%<span class="variable">$(TYPE_OBJ)</span> : %<span class="variable">$(TYPE_SRC)</span> <span class="variable">$(HDRS)</span></span><br><span class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> -c <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line">clean :</span><br><span class="line">	<span class="variable">$(RM)</span> <span class="variable">$(DIR_BUILDS)</span></span><br></pre></td></tr></table></figure>
<h1 id="十四、打造专业的编译环境"><a href="#十四、打造专业的编译环境" class="headerlink" title="十四、打造专业的编译环境"></a><div align=center>十四、打造专业的编译环境</h1><h2 id="1、大型项目目录结构-无第三库"><a href="#1、大型项目目录结构-无第三库" class="headerlink" title="1、大型项目目录结构(无第三库)"></a>1、大型项目目录结构(无第三库)</h2><img width=800 src="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/7.jpg">

<h2 id="2、需要打造的编译环境"><a href="#2、需要打造的编译环境" class="headerlink" title="2、需要打造的编译环境"></a>2、需要打造的编译环境</h2><ul>
<li>源码文件夹在编译时<font color=red>不希望</font>被改动（只读文件夹）</li>
<li>在编译时<font color = blue>自动创建文件夹</font>（build）用于存放编译结果</li>
<li>编译过程中自动生成依赖关系，<font color=purple>自动搜索需要的文件</font></li>
<li>每个模块可以拥有自己<font color=brown>独立的编译方式</font></li>
<li>支持<font color=green>调试版本</font>的编译选项</li>
</ul>
<h2 id="3、项目架构设计分析"><a href="#3、项目架构设计分析" class="headerlink" title="3、项目架构设计分析"></a>3、项目架构设计分析</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;项目根据功能被划分为多个不同模块, 每个模块的代码用一个文件夹进行管理,文件夹由 inc, src, makfile 构成。每个模块的对外函数声明统一放置于 common/inc 中，如：common.h xxfunc.h</p>
<h3 id="1）实现阶段分析"><a href="#1）实现阶段分析" class="headerlink" title="1）实现阶段分析"></a>1）实现阶段分析</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;由项目的目录结构将整个 makefile 的实现分为两个阶段编译（Compile）和链接（Link）</p>
<ul>
<li><strong>Compile 阶段将每个文件中的代码编译成静态库文件</strong></li>
</ul>
<img width=600 src="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/8.jpg">

<p>&nbsp;&nbsp;&nbsp;&nbsp;因此 Compile 阶段，我们需要完成可用于各个模块可编译的 makefile 文件，每个模块的编译结果为静态库文件（.a文件）</p>
<ul>
<li><strong>link 阶段将每个模块的静态库文件链接生成最终可执行程序</strong></li>
</ul>
<img width=600 src="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/9.jpg">

<p>&nbsp;&nbsp;&nbsp;&nbsp;因此 link 阶段，我们需要完成整编译个工程的 makefile 文件，调用模块的 makefile 编译生成静态库文件链接所有的静态库文件，最终得到可执行程序</p>
<h4 id="a-Compile-阶段实现"><a href="#a-Compile-阶段实现" class="headerlink" title="a. Compile 阶段实现"></a>a. Compile 阶段实现</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;关键的实现要点有三个，自动生成依赖关系（gcc -MM），自动搜索需要的文件（vpath），将目标打包为静态库文件（ar crs） 。模块中的 makefile 构成如下。</p>
<img width=600 src="https://myblog-1259396478.cos.ap-chengdu.myqcloud.com/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/makefile/10.jpg">

<p>&nbsp;&nbsp;&nbsp;&nbsp;编程实现</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : all</span><br><span class="line"></span><br><span class="line">DIR_SRC := src</span><br><span class="line">DIR_INC := inc</span><br><span class="line">DIR_BUILD := /home/book/code/build</span><br><span class="line">DIR_COMMON_INC := /home/book/code/common/inc</span><br><span class="line"></span><br><span class="line">TYPE_INC := .h</span><br><span class="line">TYPE_SRC := .c</span><br><span class="line">TYPE_OBJ := .o</span><br><span class="line">TYPE_DEP := .dep</span><br><span class="line"></span><br><span class="line">AR := ar</span><br><span class="line">ARFLAGS := crs</span><br><span class="line"></span><br><span class="line">CC := gcc</span><br><span class="line">CFLAGS := -I<span class="variable">$(DIR_INC)</span> -I<span class="variable">$(DIR_COMMON_INC)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(DEBUG)</span>,true)</span><br><span class="line">CFLAGS += -g</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line">MODULE := <span class="variable">$(<span class="built_in">realpath</span> .)</span>       <span class="comment"># 获取当前路径下的绝对路径</span></span><br><span class="line">MODULE := <span class="variable">$(<span class="built_in">notdir</span> <span class="variable">$(MODULE)</span>)</span></span><br><span class="line"></span><br><span class="line">DIR_OUTPUT := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_BUILD)</span>/,<span class="variable">$(MODULE)</span>)</span></span><br><span class="line"></span><br><span class="line">OUTPUT := <span class="variable">$(MODULE)</span>.a</span><br><span class="line">OUTPUT := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_BUILD)</span>/,<span class="variable">$(OUTPUT)</span>)</span></span><br><span class="line"></span><br><span class="line">SRCS := <span class="variable">$(<span class="built_in">wildcard</span> <span class="variable">$(DIR_SRC)</span>/*<span class="variable">$(TYPE_SRC)</span>)</span></span><br><span class="line">OBJS := $(SRCS:<span class="variable">$(TYPE_SRC)</span>=<span class="variable">$(TYPE_OBJ)</span>)</span><br><span class="line">OBJS := <span class="variable">$(<span class="built_in">patsubst</span> <span class="variable">$(DIR_SRC)</span>/%,<span class="variable">$(DIR_OUTPUT)</span>/%,<span class="variable">$(OBJS)</span>)</span></span><br><span class="line"></span><br><span class="line">DEPS := $(SRCS:<span class="variable">$(TYPE_SRC)</span>=<span class="variable">$(TYPE_DEP)</span>)</span><br><span class="line">DEPS := <span class="variable">$(<span class="built_in">patsubst</span> <span class="variable">$(DIR_SRC)</span>/%, <span class="variable">$(DIR_OUTPUT)</span>/%,<span class="variable">$(DEPS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">vpath</span> %<span class="variable">$(TYPE_INC)</span> <span class="variable">$(DIR_INC)</span></span><br><span class="line"><span class="keyword">vpath</span> %<span class="variable">$(TYPE_INC)</span> <span class="variable">$(DIR_COMMON_INC)</span></span><br><span class="line"><span class="keyword">vpath</span> %<span class="variable">$(TYPE_SRC)</span> <span class="variable">$(DIR_SRC)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(DEPS)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">all :  <span class="variable">$(OUTPUT)</span></span><br><span class="line">    @echo <span class="string">&quot;Success! Target ==&gt; <span class="variable">$(OUTPUT)</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(OUTPUT)</span> : <span class="variable">$(OBJS)</span></span><br><span class="line">    <span class="variable">$(AR)</span> <span class="variable">$(ARFLAGS)</span> <span class="variable">$@</span> <span class="variable">$^</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(DIR_OUTPUT)</span>/%<span class="variable">$(TYPE_OBJ)</span> : %<span class="variable">$(TYPE_SRC)</span></span><br><span class="line">    <span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> -o <span class="variable">$@</span> -c <span class="variable">$(<span class="built_in">filter</span> %<span class="variable">$(TYPE_SRC)</span>,<span class="variable">$^</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(DIR_OUTPUT)</span>/%<span class="variable">$(TYPE_DEP)</span> : %<span class="variable">$(TYPE_SRC)</span></span><br><span class="line">    @echo <span class="string">&quot;Creating <span class="variable">$@</span> ...&quot;</span></span><br><span class="line">    @set -e; \</span><br><span class="line">    <span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> -MM -E <span class="variable">$(<span class="built_in">filter</span> %<span class="variable">$(TYPE_SRC)</span>,<span class="variable">$^</span>)</span> | sed &#x27;s,\(.*\)\.o[ :]*,<span class="variable">$(DIR_OUTPUT)</span>/\1.o <span class="variable">$@</span>: ,g&#x27; &gt; <span class="variable">$@</span></span><br></pre></td></tr></table></figure>
<h4 id="b-Link-阶段实现"><a href="#b-Link-阶段实现" class="headerlink" title="b. Link 阶段实现"></a>b. Link 阶段实现</h4><p>&nbsp;&nbsp;&nbsp;&nbsp;Link 阶段需要考虑的事情主要有四个，如何自动创建 build 文件夹以及子文件夹？如何进入每个模块进行编译？编译成功后如何链接所有的模块静态库？当前模块中有哪些模块？对于前三个问题比较简单分别是 使用 mkdir 创建 build 文件夹及子文件夹。使用 cd 命令进入模块编译。编译成功后使用 gcc 链接所有模块的静态库文件。需要解决的注意问题是第四个问题。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;在实际的工程里面，项目中各个模块在设计阶段就已经基本确定，因此在在之后的开发过程中不会频繁的随意增加或者减少。因此可以直接<font color = red>定义变量模块名列表（模块变量名）</font>，<font color=brown>利用 shell 的 for 循环遍历模块变量名</font>，<font color = purple>在 for 循环中进入模块文件夹进行编译</font>，<font color=blue>循环结束后链接所有的模块静态库文件</font></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;在 makefile 中插入 shell 的 for 循环的方式如下，需要注意的是 makefile 中嵌入 shell 代码时，<font color=dark>如果需要使用 shell 变量的值，必须在变量前面加上 $$ 。</font></p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">MODULES := common <span class="string">\</span></span><br><span class="line">           main <span class="string">\</span></span><br><span class="line">           <span class="built_in">module</span></span><br><span class="line"></span><br><span class="line">test :</span><br><span class="line">    @for dir <span class="keyword">in</span> $(MODULES);<span class="string">\</span></span><br><span class="line">    <span class="keyword">do</span><span class="string">\</span></span><br><span class="line">        echo $$dir;<span class="string">\</span></span><br><span class="line">    done</span><br><span class="line">    @echo <span class="string">&quot;Compile Success ...&quot;</span></span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;链接时需要注意，gcc 在进行静态库的链接时<font color = blue>必须遵循严格的依赖关系</font></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">gcc</span> <span class="selector-tag">-o</span> <span class="selector-tag">app</span><span class="selector-class">.out</span> <span class="selector-tag">x</span><span class="selector-class">.a</span> <span class="selector-tag">y</span><span class="selector-class">.a</span> <span class="selector-tag">z</span><span class="selector-class">.a</span></span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;其中的依赖关系必须为：x.a –&gt; y.a –&gt; z.a ，默认情况下遵循<font color=brown>自左向右的依赖关系</font>。如果不清楚库间的依赖关系，可以<font color=purple>使用 -Xlinker 自动确定依赖关系</font></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -o app<span class="selector-class">.out</span> -Xlinker <span class="string">&quot;-(&quot;</span> z<span class="selector-class">.a</span> y<span class="selector-class">.a</span> x<span class="selector-class">.a</span> -Xlinker <span class="string">&quot;-)&quot;</span></span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;编程实现 Link 阶段</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : all compile link</span><br><span class="line"></span><br><span class="line">MODULES := common \</span><br><span class="line">           main \</span><br><span class="line">           module</span><br><span class="line">        </span><br><span class="line">CC := gcc </span><br><span class="line">MKDIR := mkdir</span><br><span class="line">RM := rm -rf</span><br><span class="line"></span><br><span class="line">LFLAGS :=</span><br><span class="line"></span><br><span class="line">DIR_PROJECT := <span class="variable">$(<span class="built_in">realpath</span> .)</span></span><br><span class="line">DIR_BUILD := build</span><br><span class="line">DIR_BUILD_SUB := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_BUILD)</span>/,<span class="variable">$(MODULES)</span>)</span></span><br><span class="line">MODULE_LIB := <span class="variable">$(<span class="built_in">addsuffix</span> .a,<span class="variable">$(MODULES)</span>)</span>    <span class="comment"># 增加后缀 .a</span></span><br><span class="line">MODULE_LIB := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_BUILD)</span>/,<span class="variable">$(MODULE_LIB)</span>)</span></span><br><span class="line"></span><br><span class="line">APP := app.out</span><br><span class="line">APP := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_BUILD)</span>/,<span class="variable">$(APP)</span>)</span></span><br><span class="line"></span><br><span class="line">all : compile link</span><br><span class="line"></span><br><span class="line">link : <span class="variable">$(MODULE_LIB)</span></span><br><span class="line">	@echo <span class="string">&quot;Bengin to link ...&quot;</span></span><br><span class="line">	<span class="variable">$(CC)</span> -o <span class="variable">$(APP)</span> -Xlinker <span class="string">&quot;-(&quot;</span> <span class="variable">$^</span> -Xlinker <span class="string">&quot;-)&quot;</span> <span class="variable">$(LFLAGS)</span></span><br><span class="line">	@echo <span class="string">&quot;Success Target ==&gt; <span class="variable">$@</span> ...&quot;</span></span><br><span class="line"></span><br><span class="line">compile : <span class="variable">$(DIR_BUILD)</span> <span class="variable">$(DIR_BUILD_SUB)</span></span><br><span class="line">	@echo <span class="string">&quot;Compile Begin ...&quot;</span></span><br><span class="line">	@set -e;\</span><br><span class="line">	for dir in <span class="variable">$(MODULES)</span>;\</span><br><span class="line">	do\</span><br><span class="line">		cd $$dir &amp;&amp; make all DEBUG:=<span class="variable">$(DEBUG)</span> &amp;&amp; cd ..;\</span><br><span class="line">	done</span><br><span class="line">	@echo <span class="string">&quot;Compile Success ...&quot;</span></span><br><span class="line">	</span><br><span class="line"><span class="variable">$(DIR_BUILD)</span> <span class="variable">$(DIR_BUILD_SUB)</span> :</span><br><span class="line">	<span class="variable">$(MKDIR)</span> <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line">clean :</span><br><span class="line">	<span class="variable">$(RM)</span> <span class="variable">$(DIR_BUILD)</span> </span><br></pre></td></tr></table></figure>
<h3 id="2-编译优化"><a href="#2-编译优化" class="headerlink" title="2) 编译优化"></a>2) 编译优化</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;上述 makefile 存在两个潜在问题，首先是所有模块 makefile 中使用编译路径均为写死的绝对路径，一旦项目文件夹移动，编译必将失败</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;针对这个问题在工程 makefile 中获取项目的源码目录，根据项目源码路径：拼接得到编译文件夹路径 DIR_BUILD，拼接得到全局头文件路径 DIR_COMMON_INC。通过定义命令行变量将路径传递给模块 makefile。优化后的代码如下：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : all compile link rebuild</span><br><span class="line"></span><br><span class="line">MODULES := common \</span><br><span class="line">           main \</span><br><span class="line">           module</span><br><span class="line"></span><br><span class="line">CC := gcc</span><br><span class="line">MKDIR := mkdir</span><br><span class="line">RM := rm -rf</span><br><span class="line"></span><br><span class="line">DIR_PROJECT := <span class="variable">$(<span class="built_in">realpath</span> .)</span></span><br><span class="line">DIR_BUILD := build</span><br><span class="line">DIR_COMMON_INC := common/inc</span><br><span class="line">DIR_BUILD_SUB := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_BUILD)</span>/,<span class="variable">$(MODULES)</span>)</span></span><br><span class="line"></span><br><span class="line">MODULE_LIB := <span class="variable">$(<span class="built_in">addsuffix</span> .a, <span class="variable">$(MODULES)</span>)</span> <span class="comment"># 增加后缀 .a</span></span><br><span class="line">MODULE_LIB := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_BUILD)</span>/,<span class="variable">$(MODULE_LIB)</span>)</span></span><br><span class="line"></span><br><span class="line">APP := app.out</span><br><span class="line">APP := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_BUILD)</span>/,<span class="variable">$(APP)</span>)</span></span><br><span class="line"></span><br><span class="line">all : compile <span class="variable">$(APP)</span></span><br><span class="line">    @echo <span class="string">&quot;Target <span class="variable">$(APP)</span> success!&quot;</span></span><br><span class="line"></span><br><span class="line">compile : <span class="variable">$(DIR_BUILD)</span> <span class="variable">$(DIR_BUILD_SUB)</span></span><br><span class="line">    @echo <span class="string">&quot;compile begin ...&quot;</span></span><br><span class="line">    @set -e;\</span><br><span class="line">    for dir in <span class="variable">$(MODULES)</span>; \</span><br><span class="line">    do \</span><br><span class="line">        cd $$dir &amp;&amp; \</span><br><span class="line">        <span class="variable">$(MAKE)</span> all \ <span class="comment"># 传递路径给子 makefile</span></span><br><span class="line">            DEBUG:=<span class="variable">$(DEBUG)</span> \</span><br><span class="line">            DIR_BUILD:=<span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_PROJECT)</span>/,<span class="variable">$(DIR_BUILD)</span>)</span> \ </span><br><span class="line">            DIR_COMMON_INC:=<span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_PROJECT)</span>/,<span class="variable">$(DIR_COMMON_INC)</span>)</span> &amp;&amp; \</span><br><span class="line">        cd .. ;\</span><br><span class="line">    done</span><br><span class="line">    @echo <span class="string">&quot;compile success!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(DIR_BUILD)</span> <span class="variable">$(DIR_BUILD_SUB)</span> :</span><br><span class="line">    <span class="variable">$(MKDIR)</span> <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line">link <span class="variable">$(APP)</span> : <span class="variable">$(MODULE_LIB)</span></span><br><span class="line">    @echo <span class="string">&quot;begin to link !&quot;</span></span><br><span class="line">    <span class="variable">$(CC)</span> -o <span class="variable">$(APP)</span>  -Xlinker <span class="string">&quot;-(&quot;</span> <span class="variable">$(MODULE_LIB)</span> -Xlinker <span class="string">&quot;-)&quot;</span></span><br><span class="line">    @echo <span class="string">&quot;link success!&quot;</span></span><br><span class="line"></span><br><span class="line">clean :</span><br><span class="line">    <span class="variable">$(RM)</span> <span class="variable">$(DIR_BUILD)</span></span><br><span class="line"></span><br><span class="line">rebuild : clean all</span><br></pre></td></tr></table></figure>

<p>&nbsp;&nbsp;&nbsp;&nbsp;第二个问题就是，所有 makefile 模块完全相同，<font color=dark>当模块 makefile 需要改动时，将涉多处相同改动</font>。针对这个问题，可以将模块 makefile 差分为两个模板文件 <font color=blue>mod-cfg.mk</font> <font color = red>定义为可能改变的变量</font>，<font color=blue>mod-rule.mk</font> <font color=purple>定义相对稳定的变量和规则</font>。默认情况下，模块 makefile <font color=brown>复用模板文件实现功能 (include)</font>。这个解决方案需要，通过命令行变量进行模板文件位置的传递。优化后的 makefile 如下：</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;对于各个模块下的 makefile </p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">include $(MOD_CFG)</span><br><span class="line"></span><br><span class="line"><span class="meta"># Custmization Begin</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># DIR_SRC := src</span></span><br><span class="line"><span class="meta"># DIR_INC := inc</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># TYPE_INC := .h</span></span><br><span class="line"><span class="meta"># TYPE_SRC := .c</span></span><br><span class="line"><span class="meta"># TYPE_OBJ := .o</span></span><br><span class="line"><span class="meta"># TYPE_DEP := .dep</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta"># Custmization End</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">include $(CMD_CFG)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">include $(MOD_RULE)</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;工程目录下的 makefile</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">PHONY : all compile link rebuild</span><br><span class="line"></span><br><span class="line">MODULES := common \</span><br><span class="line">           main \</span><br><span class="line">           module</span><br><span class="line"></span><br><span class="line">CC := gcc</span><br><span class="line">MKDIR := mkdir</span><br><span class="line">RM := rm -rf</span><br><span class="line"></span><br><span class="line">DIR_PROJECT := <span class="variable">$(<span class="built_in">realpath</span> .)</span></span><br><span class="line">DIR_BUILD := build</span><br><span class="line">DIR_COMMON_INC := common/inc</span><br><span class="line">DIR_BUILD_SUB := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_BUILD)</span>/,<span class="variable">$(MODULES)</span>)</span></span><br><span class="line"></span><br><span class="line">MODULE_LIB := <span class="variable">$(<span class="built_in">addsuffix</span> .a, <span class="variable">$(MODULES)</span>)</span> <span class="comment"># 增加后缀 .a</span></span><br><span class="line">MODULE_LIB := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_BUILD)</span>/,<span class="variable">$(MODULE_LIB)</span>)</span></span><br><span class="line"></span><br><span class="line">MOD_CFG := mod-cfg.mk</span><br><span class="line">MOD_RULE := mod-rule.mk</span><br><span class="line">CMD_CFG := cmd-cfg.mk</span><br><span class="line"></span><br><span class="line">APP := app.out</span><br><span class="line">APP := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_BUILD)</span>/,<span class="variable">$(APP)</span>)</span></span><br><span class="line"></span><br><span class="line">all : compile <span class="variable">$(APP)</span></span><br><span class="line">    @echo <span class="string">&quot;Target <span class="variable">$(APP)</span> success!&quot;</span></span><br><span class="line"></span><br><span class="line">compile : <span class="variable">$(DIR_BUILD)</span> <span class="variable">$(DIR_BUILD_SUB)</span></span><br><span class="line">    @echo <span class="string">&quot;compile begin ...&quot;</span></span><br><span class="line">    @set -e;\</span><br><span class="line">    for dir in <span class="variable">$(MODULES)</span>; \</span><br><span class="line">    do \</span><br><span class="line">        cd $$dir &amp;&amp; \</span><br><span class="line">        <span class="variable">$(MAKE)</span> all \</span><br><span class="line">            DEBUG:=<span class="variable">$(DEBUG)</span> \</span><br><span class="line">            DIR_BUILD:=<span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_PROJECT)</span>/,<span class="variable">$(DIR_BUILD)</span>)</span> \</span><br><span class="line">            DIR_COMMON_INC:=<span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_PROJECT)</span>/,<span class="variable">$(DIR_COMMON_INC)</span>)</span> \</span><br><span class="line">            MOD_CFG:=<span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_PROJECT)</span>/,<span class="variable">$(MOD_CFG)</span>)</span> \</span><br><span class="line">            MOD_RULE:=<span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_PROJECT)</span>/,<span class="variable">$(MOD_RULE)</span>)</span>\</span><br><span class="line">            CMD_CFG:=<span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_PROJECT)</span>/,<span class="variable">$(CMD_CFG)</span>)</span>&amp;&amp; \</span><br><span class="line">        cd .. ;\</span><br><span class="line">    done</span><br><span class="line">    @echo <span class="string">&quot;compile success!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(DIR_BUILD)</span> <span class="variable">$(DIR_BUILD_SUB)</span> :</span><br><span class="line">    <span class="variable">$(MKDIR)</span> <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line">link <span class="variable">$(APP)</span> : <span class="variable">$(MODULE_LIB)</span></span><br><span class="line">    @echo <span class="string">&quot;begin to link !&quot;</span></span><br><span class="line">    <span class="variable">$(CC)</span> -o <span class="variable">$(APP)</span>  -Xlinker <span class="string">&quot;-(&quot;</span> <span class="variable">$(MODULE_LIB)</span> -Xlinker <span class="string">&quot;-)&quot;</span></span><br><span class="line">    @echo <span class="string">&quot;link success!&quot;</span></span><br><span class="line"></span><br><span class="line">clean :</span><br><span class="line">    <span class="variable">$(RM)</span> <span class="variable">$(DIR_BUILD)</span></span><br><span class="line"></span><br><span class="line">rebuild : clean all</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;可能改变的变量 mod-cfg.mk</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DIR_SRC := src</span><br><span class="line">DIR_INC := inc</span><br><span class="line"></span><br><span class="line">TYPE_INC := .h</span><br><span class="line">TYPE_SRC := .c</span><br><span class="line">TYPE_OBJ := .o</span><br><span class="line">TYPE_DEP := .dep</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;定义相对稳定的变量和规则 mod-rule.mk</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : all</span><br><span class="line"></span><br><span class="line">MODULE := <span class="variable">$(<span class="built_in">realpath</span> .)</span>       <span class="comment"># 获取当前路径下的绝对路径</span></span><br><span class="line">MODULE := <span class="variable">$(<span class="built_in">notdir</span> <span class="variable">$(MODULE)</span>)</span></span><br><span class="line"></span><br><span class="line">DIR_OUTPUT := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_BUILD)</span>/,<span class="variable">$(MODULE)</span>)</span></span><br><span class="line"></span><br><span class="line">OUTPUT := <span class="variable">$(MODULE)</span>.a</span><br><span class="line">OUTPUT := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_BUILD)</span>/,<span class="variable">$(OUTPUT)</span>)</span></span><br><span class="line"></span><br><span class="line">SRCS := <span class="variable">$(<span class="built_in">wildcard</span> <span class="variable">$(DIR_SRC)</span>/*<span class="variable">$(TYPE_SRC)</span>)</span></span><br><span class="line">OBJS := $(SRCS:<span class="variable">$(TYPE_SRC)</span>=<span class="variable">$(TYPE_OBJ)</span>)</span><br><span class="line">OBJS := <span class="variable">$(<span class="built_in">patsubst</span> <span class="variable">$(DIR_SRC)</span>/%,<span class="variable">$(DIR_OUTPUT)</span>/%,<span class="variable">$(OBJS)</span>)</span></span><br><span class="line"></span><br><span class="line">DEPS := $(SRCS:<span class="variable">$(TYPE_SRC)</span>=<span class="variable">$(TYPE_DEP)</span>)</span><br><span class="line">DEPS := <span class="variable">$(<span class="built_in">patsubst</span> <span class="variable">$(DIR_SRC)</span>/%, <span class="variable">$(DIR_OUTPUT)</span>/%,<span class="variable">$(DEPS)</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">vpath</span> %<span class="variable">$(TYPE_INC)</span> <span class="variable">$(DIR_INC)</span></span><br><span class="line"><span class="keyword">vpath</span> %<span class="variable">$(TYPE_INC)</span> <span class="variable">$(DIR_COMMON_INC)</span></span><br><span class="line"><span class="keyword">vpath</span> %<span class="variable">$(TYPE_SRC)</span> <span class="variable">$(DIR_SRC)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">-include</span> <span class="variable">$(DEPS)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">all :  <span class="variable">$(OUTPUT)</span></span><br><span class="line">    @echo <span class="string">&quot;Success! Target ==&gt; <span class="variable">$(OUTPUT)</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(OUTPUT)</span> : <span class="variable">$(OBJS)</span></span><br><span class="line">    <span class="variable">$(AR)</span> <span class="variable">$(ARFLAGS)</span> <span class="variable">$@</span> <span class="variable">$^</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(DIR_OUTPUT)</span>/%<span class="variable">$(TYPE_OBJ)</span> : %<span class="variable">$(TYPE_SRC)</span></span><br><span class="line">    <span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> -o <span class="variable">$@</span> -c <span class="variable">$(<span class="built_in">filter</span> %<span class="variable">$(TYPE_SRC)</span>,<span class="variable">$^</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(DIR_OUTPUT)</span>/%<span class="variable">$(TYPE_DEP)</span> : %<span class="variable">$(TYPE_SRC)</span></span><br><span class="line">    @echo <span class="string">&quot;Creating <span class="variable">$@</span> ...&quot;</span></span><br><span class="line">    @set -e; \</span><br><span class="line">    <span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> -MM -E <span class="variable">$(<span class="built_in">filter</span> %<span class="variable">$(TYPE_SRC)</span>,<span class="variable">$^</span>)</span> | sed &#x27;s,\(.*\)\.o[ :]*,<span class="variable">$(DIR_OUTPUT)</span>/\1.o <span class="variable">$@</span>: ,g&#x27; &gt; <span class="variable">$@</span></span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;定义相对稳定的命令 cmd-cfg.mk</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">AR := ar</span><br><span class="line">ARFLAGS := crs</span><br><span class="line"></span><br><span class="line">CC := gcc</span><br><span class="line">LFLAGS :=</span><br><span class="line">CFLAGS := -I<span class="variable">$(DIR_INC)</span> -I<span class="variable">$(DIR_COMMON_INC)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(DEBUG)</span>,true)</span><br><span class="line">CFLAGS += -g</span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;经过上述的拆分，已经解决了各个模块下的 makfile 复用的问题。但是对于工程 makefile 模块可以进一步进行优化。 可以拆分命令变量、项目变量、以及其他变量和规则到不同文件。</p>
<ul>
<li>cmd-cfg.mk ：定义命令相关变量</li>
<li>pro-cfg.mk ：定义项目变量以及编译路径变量等</li>
<li>pro-rule.mk ：定义其他变量和规则</li>
<li>最后的工程 makefile 通过包含拆分后的文件构成 (include)</li>
</ul>
<p>&nbsp;&nbsp;&nbsp;&nbsp;优化后的 makeflie 如下, 首先是定义命令相关变量 cmd-cfg.mk</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">AR := ar</span><br><span class="line">ARFLAGS := crs</span><br><span class="line"></span><br><span class="line">CC := gcc</span><br><span class="line">LFLAGS :=</span><br><span class="line">CFLAGS := -I<span class="variable">$(DIR_INC)</span> -I<span class="variable">$(DIR_COMMON_INC)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(DEBUG)</span>,true)</span><br><span class="line">CFLAGS += -g</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line">MKDIR := mkdir</span><br><span class="line">RM := rm -rf</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;定义项目变量以及编译路径变量等 pro-cfg.mk</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">MODULES</span> :<span class="string">= common \</span></span><br><span class="line">           <span class="attr">main</span> <span class="string">\</span></span><br><span class="line">           <span class="attr">module</span></span><br><span class="line"></span><br><span class="line"><span class="attr">MOD_CFG</span> :<span class="string">= mod-cfg.mk</span></span><br><span class="line"><span class="attr">MOD_RULE</span> :<span class="string">= mod-rule.mk</span></span><br><span class="line"><span class="attr">CMD_CFG</span> :<span class="string">= cmd-cfg.mk</span></span><br><span class="line"></span><br><span class="line"><span class="attr">DIR_BUILD</span> :<span class="string">= build</span></span><br><span class="line"><span class="attr">DIR_COMMON_INC</span> :<span class="string">= common/inc</span></span><br><span class="line"></span><br><span class="line"><span class="attr">APP</span> :<span class="string">= app.out</span></span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;定义其他变量和规则 pro-rule.mk</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">PHONY : all compile link rebuild</span><br><span class="line"></span><br><span class="line">DIR_PROJECT := <span class="variable">$(<span class="built_in">realpath</span> .)</span></span><br><span class="line">DIR_BUILD_SUB := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_BUILD)</span>/,<span class="variable">$(MODULES)</span>)</span></span><br><span class="line"></span><br><span class="line">MODULE_LIB := <span class="variable">$(<span class="built_in">addsuffix</span> .a, <span class="variable">$(MODULES)</span>)</span> <span class="comment"># 增加后缀 .a</span></span><br><span class="line">MODULE_LIB := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_BUILD)</span>/,<span class="variable">$(MODULE_LIB)</span>)</span></span><br><span class="line"></span><br><span class="line">APP := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_BUILD)</span>/,<span class="variable">$(APP)</span>)</span></span><br><span class="line"></span><br><span class="line">all : compile <span class="variable">$(APP)</span></span><br><span class="line">    @echo <span class="string">&quot;Target <span class="variable">$(APP)</span> success!&quot;</span></span><br><span class="line"></span><br><span class="line">compile : <span class="variable">$(DIR_BUILD)</span> <span class="variable">$(DIR_BUILD_SUB)</span></span><br><span class="line">    @echo <span class="string">&quot;compile begin ...&quot;</span></span><br><span class="line">    @set -e;\</span><br><span class="line">    for dir in <span class="variable">$(MODULES)</span>; \</span><br><span class="line">    do \</span><br><span class="line">        cd $$dir &amp;&amp; \</span><br><span class="line">        <span class="variable">$(MAKE)</span> all \</span><br><span class="line">            DEBUG:=<span class="variable">$(DEBUG)</span> \</span><br><span class="line">            DIR_BUILD:=<span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_PROJECT)</span>/,<span class="variable">$(DIR_BUILD)</span>)</span> \</span><br><span class="line">            DIR_COMMON_INC:=<span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_PROJECT)</span>/,<span class="variable">$(DIR_COMMON_INC)</span>)</span> \</span><br><span class="line">            MOD_CFG:=<span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_PROJECT)</span>/,<span class="variable">$(MOD_CFG)</span>)</span> \</span><br><span class="line">            MOD_RULE:=<span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_PROJECT)</span>/,<span class="variable">$(MOD_RULE)</span>)</span>\</span><br><span class="line">            CMD_CFG:=<span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(DIR_PROJECT)</span>/,<span class="variable">$(CMD_CFG)</span>)</span>&amp;&amp; \</span><br><span class="line">        cd .. ;\</span><br><span class="line">    done</span><br><span class="line">    @echo <span class="string">&quot;compile success!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(DIR_BUILD)</span> <span class="variable">$(DIR_BUILD_SUB)</span> :</span><br><span class="line">    <span class="variable">$(MKDIR)</span> <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line">link <span class="variable">$(APP)</span> : <span class="variable">$(MODULE_LIB)</span></span><br><span class="line">    @echo <span class="string">&quot;begin to link !&quot;</span></span><br><span class="line">    <span class="variable">$(CC)</span> -o <span class="variable">$(APP)</span>  -Xlinker <span class="string">&quot;-(&quot;</span> <span class="variable">$(MODULE_LIB)</span> -Xlinker <span class="string">&quot;-)&quot;</span></span><br><span class="line">    @echo <span class="string">&quot;link success!&quot;</span></span><br><span class="line"></span><br><span class="line">clean :</span><br><span class="line">    <span class="variable">$(RM)</span> <span class="variable">$(DIR_BUILD)</span></span><br><span class="line"></span><br><span class="line">rebuild : clean all</span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;最后工程 makefile 的内容就很简单了</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> pro-cfg.mk   <span class="comment"># 定义命令相关变量</span></span><br><span class="line"><span class="keyword">include</span> cmd-cfg.mk   <span class="comment"># 定义项目变量以及编译路径变量等</span></span><br><span class="line"><span class="keyword">include</span> pro-rule.mk  <span class="comment"># 定义其他变量和规则</span></span><br></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;到这里一个大型项目的编译环境就基本打造完成了。大型项目的编译环境是由不同的 makefile 构成的。编译环境的设计需要<font color=blue>依据项目的整体架构设计</font>。整个项目的编译可以<font color=dark>分解为不同阶段</font>。根据不同的阶段有针对性的对 makefile 进行设计。<font color=brown>makefile 也需要考虑复用性和维护性等基本程序特性。</font></p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>braon-z
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://example.com/2021/08/18/makfile%E4%B8%93%E9%A2%98/" title="makefile专题">https://example.com/2021/08/18/makfile专题/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" rel="tag"><i class="fa fa-tag"></i> 基础知识</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/07/03/mtk%E5%B9%B3%E5%8F%B0-lcd%E6%98%BE%E7%A4%BA%E6%8E%A5%E5%8F%A3/" rel="prev" title="番外篇-mtk平台logo显示接口">
                  <i class="fa fa-chevron-left"></i> 番外篇-mtk平台logo显示接口
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">braon-z</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">478k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">7:14</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/local-search.js"></script>






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"VsC1eQwQ4Xltm5eA9iYGp3VU-gzGzoHsz","appKey":"kyfyE4RWl6aIojedbxcuJa3V","serverURLs":null,"placeholder":"Just go go","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":false,"comment_count":true,"recordIP":false,"enableQQ":false,"requiredFields":[]}, {
      el: '#valine-comments',
      path: "/2021/08/18/makfile%E4%B8%93%E9%A2%98/",
      serverURLs: "https://vsc1eqwq.api.lncldglobal.com"
    }));
  }, window.Valine);
});
</script>




  <script src="/js/activate-power-mode.min.js"></script>
  <script>
    POWERMODE.colorful = true;
    POWERMODE.shake = false;
    document.body.addEventListener('input', POWERMODE);
  </script>
<div class="moon-menu">
  <div class="moon-menu-items">
    
    <div class="moon-menu-item" onclick="back2bottom()">
      <i class='fa fa-chevron-down'></i>    </div>
    
    <div class="moon-menu-item" onclick="back2top()">
      <i class='fa fa-chevron-up'></i>    </div>
    
  </div>
  <div class="moon-menu-button">
    <svg class="moon-menu-bg">
      <circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle>
      <circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle>
    </svg>
    <div class="moon-menu-content">
      <div class="moon-menu-icon"><i class='fas fa-ellipsis-v'></i></div>
      <div class="moon-menu-text"></div>
    </div>
  </div>
</div><script src="/js/injector.js"></script>
</body>
</html>
