<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":"ture","mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 用于记录 linux 驱动相关的基础知识，着重与用法于接口，类似于手册，方便快速查阅相关函数。">
<meta property="og:type" content="article">
<meta property="og:title" content="linux驱动-基础知识">
<meta property="og:url" content="https://example.com/2020/11/23/linux%E9%A9%B1%E5%8A%A8-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/index.html">
<meta property="og:site_name" content="braon-z&#39;s blog">
<meta property="og:description" content="&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 用于记录 linux 驱动相关的基础知识，着重与用法于接口，类似于手册，方便快速查阅相关函数。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-11-23T01:14:17.000Z">
<meta property="article:modified_time" content="2021-01-29T04:17:46.750Z">
<meta property="article:author" content="braon-z">
<meta property="article:tag" content="基础知识">
<meta property="article:tag" content="驱动">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://example.com/2020/11/23/linux%E9%A9%B1%E5%8A%A8-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>linux驱动-基础知识 | braon-z's blog</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">braon-z's blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%90%8C%E6%AD%A5%E4%B8%8E%E4%BA%92%E6%96%A5"><span class="nav-text">一、同步与互斥</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E5%8E%9F%E5%AD%90%E5%8F%98%E9%87%8F"><span class="nav-text">1、原子变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">1) 基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%95%B4%E5%9E%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C"><span class="nav-text">2) 整型原子操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E8%AE%BE%E7%BD%AE%E5%8E%9F%E5%AD%90%E5%8F%98%E9%87%8F"><span class="nav-text">1. 设置原子变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E8%8E%B7%E5%8F%96%E5%8E%9F%E5%AD%90%E5%8F%98%E9%87%8F%E7%9A%84%E5%80%BC"><span class="nav-text">2. 获取原子变量的值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E5%8E%9F%E5%AD%90%E5%8F%98%E9%87%8F%E5%8A%A0-%E5%87%8F"><span class="nav-text">3. 原子变量加&#x2F;减</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E5%8E%9F%E5%AD%90%E5%8F%98%E9%87%8F%E8%87%AA%E5%A2%9E-%E8%87%AA%E5%87%8F"><span class="nav-text">4. 原子变量自增&#x2F;自减</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-%E6%93%8D%E4%BD%9C%E5%B9%B6%E6%B5%8B%E8%AF%95"><span class="nav-text">5. 操作并测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-%E6%93%8D%E4%BD%9C%E5%B9%B6%E8%BF%94%E5%9B%9E"><span class="nav-text">6. 操作并返回</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E4%BD%8D%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C"><span class="nav-text">3) 位原子操作</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="nav-text">2、信号量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%93%8D%E4%BD%9C%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="nav-text">1) 操作信号量的接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BF%A1%E5%8F%B7%E9%87%8F"><span class="nav-text">1. 初始化信号量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E8%8E%B7%E5%8F%96%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%9A%84%E5%80%BC"><span class="nav-text">2. 获取信号量的值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E9%87%8A%E6%94%BE%E4%BF%A1%E5%8F%B7%E9%87%8F%E7%9A%84%E5%80%BC"><span class="nav-text">3. 释放信号量的值</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E8%87%AA%E6%97%8B%E9%94%81"><span class="nav-text">3、自旋锁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E8%87%AA%E6%97%8B%E9%94%81%E6%93%8D%E4%BD%9C%E6%8E%A5%E5%8F%A3"><span class="nav-text">1) 自旋锁操作接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%88%9D%E5%A7%8B%E5%8C%96%E8%87%AA%E6%97%8B%E9%94%81"><span class="nav-text">1. 初始化自旋锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E8%8E%B7%E5%8F%96%E8%87%AA%E6%97%8B%E9%94%81"><span class="nav-text">2. 获取自旋锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E9%87%8A%E6%94%BE%E8%87%AA%E6%97%8B%E9%94%81"><span class="nav-text">3. 释放自旋锁</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E4%BA%92%E6%96%A5%E9%94%81"><span class="nav-text">4、互斥锁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%BA%92%E6%96%A5%E9%94%81%E6%8E%A5%E5%8F%A3"><span class="nav-text">1) 互斥锁接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BA%92%E6%96%A5%E9%94%81"><span class="nav-text">1.初始化互斥锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E8%8E%B7%E5%8F%96%E4%BA%92%E6%96%A5%E9%94%81"><span class="nav-text">2. 获取互斥锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E9%87%8A%E6%94%BE%E4%BA%92%E6%96%A5%E9%94%81"><span class="nav-text">3. 释放互斥锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E8%8E%B7%E5%8F%96%E9%94%81%E7%8A%B6%E6%80%81"><span class="nav-text">4. 获取锁状态</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81linux-%E9%98%9F%E5%88%97"><span class="nav-text">二、linux 队列</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E7%AD%89%E5%BE%85%E9%98%9F%E5%88%97"><span class="nav-text">1、等待队列</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E7%AD%89%E5%BE%85%E9%98%9F%E5%88%97%E6%8E%A5%E5%8F%A3"><span class="nav-text">1) 等待队列接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%88%9B%E5%BB%BA%E4%B8%8E%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-text">1. 创建与初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%B7%BB%E5%8A%A0%E7%A7%BB%E9%99%A4%E7%AD%89%E5%BE%85%E9%98%9F%E5%88%97"><span class="nav-text">2. 添加移除等待队列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-%E8%BF%9B%E7%A8%8B%E4%BC%91%E7%9C%A0"><span class="nav-text">3. 进程休眠</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E5%94%A4%E9%86%92%E8%BF%9B%E7%A8%8B"><span class="nav-text">4. 唤醒进程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97"><span class="nav-text">2、工作队列</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E6%93%8D%E4%BD%9C%E5%87%BD%E6%95%B0"><span class="nav-text">3) 操作函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97"><span class="nav-text">1. 初始化工作队列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E8%B0%83%E5%BA%A6%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97"><span class="nav-text">2. 调度工作队列</span></a></li></ol></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="braon-z"
      src="/images/wallhaven.jfif">
  <p class="site-author-name" itemprop="name">braon-z</p>
  <div class="site-description" itemprop="description"> 爱一个人，攀一座山，追一次梦<br>不妨大胆一点，有很多事没有答案</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/yourname" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yourname" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yourname@gmail.com" title="E-Mail → mailto:yourname@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


<div style="">
  <canvas id="canvas" style="width:60%;">当前浏览器不支持canvas，请更换浏览器后再试</canvas>
</div>
<script>
(function(){

   var digit=
    [
        [
            [0,0,1,1,1,0,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,0,1,1,0],
            [0,0,1,1,1,0,0]
        ],//0
        [
            [0,0,0,1,1,0,0],
            [0,1,1,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [1,1,1,1,1,1,1]
        ],//1
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,1,1],
            [1,1,1,1,1,1,1]
        ],//2
        [
            [1,1,1,1,1,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//3
        [
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,0],
            [0,0,1,1,1,1,0],
            [0,1,1,0,1,1,0],
            [1,1,0,0,1,1,0],
            [1,1,1,1,1,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,1,1]
        ],//4
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,1,1,1,1,0],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//5
        [
            [0,0,0,0,1,1,0],
            [0,0,1,1,0,0,0],
            [0,1,1,0,0,0,0],
            [1,1,0,0,0,0,0],
            [1,1,0,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//6
        [
            [1,1,1,1,1,1,1],
            [1,1,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,0,0,1,1,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0],
            [0,0,1,1,0,0,0]
        ],//7
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,1,1,0]
        ],//8
        [
            [0,1,1,1,1,1,0],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [1,1,0,0,0,1,1],
            [0,1,1,1,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,0,1,1],
            [0,0,0,0,1,1,0],
            [0,0,0,1,1,0,0],
            [0,1,1,0,0,0,0]
        ],//9
        [
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0],
            [0,0,0,0,0,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0]
        ]//:
    ];

var canvas = document.getElementById('canvas');

if(canvas.getContext){
    var cxt = canvas.getContext('2d');
    //声明canvas的宽高
    var H = 100,W = 700;
    canvas.height = H;
    canvas.width = W;
    cxt.fillStyle = '#f00';
    cxt.fillRect(10,10,50,50);

    //存储时间数据
    var data = [];
    //存储运动的小球
    var balls = [];
    //设置粒子半径
    var R = canvas.height/20-1;
    (function(){
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        //存储时间数字，由十位小时、个位小时、冒号、十位分钟、个位分钟、冒号、十位秒钟、个位秒钟这7个数字组成
        data.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
    })();

    /*生成点阵数字*/
    function renderDigit(index,num){
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    cxt.beginPath();
                    cxt.arc(14*(R+2)*index + j*2*(R+1)+(R+1),i*2*(R+1)+(R+1),R,0,2*Math.PI);
                    cxt.closePath();
                    cxt.fill();
                }
            }
        }
    }

    /*更新时钟*/
    function updateDigitTime(){
        var changeNumArray = [];
        var temp = /(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date());
        var NewData = [];
        NewData.push(temp[1],temp[2],10,temp[3],temp[4],10,temp[5],temp[6]);
        for(var i = data.length-1; i >=0 ; i--){
            //时间发生变化
            if(NewData[i] !== data[i]){
                //将变化的数字值和在data数组中的索引存储在changeNumArray数组中
                changeNumArray.push(i+'_'+(Number(data[i])+1)%10);
            }
        }
        //增加小球
        for(var i = 0; i< changeNumArray.length; i++){
            addBalls.apply(this,changeNumArray[i].split('_'));
        }
        data = NewData.concat();
    }

    /*更新小球状态*/
    function updateBalls(){
        for(var i = 0; i < balls.length; i++){
            balls[i].stepY += balls[i].disY;
            balls[i].x += balls[i].stepX;
            balls[i].y += balls[i].stepY;
            if(balls[i].x > W + R || balls[i].y > H + R){
                balls.splice(i,1);
                i--;
            }
        }
    }

    /*增加要运动的小球*/
    function addBalls(index,num){
        var numArray = [1,2,3];
        var colorArray =  ["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"];
        for(var i = 0; i < digit[num].length; i++){
            for(var j = 0; j < digit[num][i].length; j++){
                if(digit[num][i][j] == 1){
                    var ball = {
                        x:14*(R+2)*index + j*2*(R+1)+(R+1),
                        y:i*2*(R+1)+(R+1),
                        stepX:Math.floor(Math.random() * 4 -2),
                        stepY:-2*numArray[Math.floor(Math.random()*numArray.length)],
                        color:colorArray[Math.floor(Math.random()*colorArray.length)],
                        disY:1
                    };
                    balls.push(ball);
                }
            }
        }
    }

    /*渲染*/
    function render(){
        //重置画布宽度，达到清空画布的效果
        canvas.height = 100;
        //渲染时钟
        for(var i = 0; i < data.length; i++){
            renderDigit(i,data[i]);
        }
        //渲染小球
        for(var i = 0; i < balls.length; i++){
            cxt.beginPath();
            cxt.arc(balls[i].x,balls[i].y,R,0,2*Math.PI);
            cxt.fillStyle = balls[i].color;
            cxt.closePath();
            cxt.fill();
        }
    }

    clearInterval(oTimer);
    var oTimer = setInterval(function(){
        //更新时钟
        updateDigitTime();
        //更新小球状态
        updateBalls();
        //渲染
        render();
    },50);
}

})();
</script>
        </div>
      </div>
        <div class="back-to-top animated" role="button">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://example.com/2020/11/23/linux%E9%A9%B1%E5%8A%A8-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/wallhaven.jfif">
      <meta itemprop="name" content="braon-z">
      <meta itemprop="description" content=" 爱一个人，攀一座山，追一次梦<br>不妨大胆一点，有很多事没有答案">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="braon-z's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          linux驱动-基础知识
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-11-23 09:14:17" itemprop="dateCreated datePublished" datetime="2020-11-23T09:14:17+08:00">2020-11-23</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-01-29 12:17:46" itemprop="dateModified" datetime="2021-01-29T12:17:46+08:00">2021-01-29</time>
      </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Valine：</span>
  
    <a title="valine" href="/2020/11/23/linux%E9%A9%B1%E5%8A%A8-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/11/23/linux%E9%A9%B1%E5%8A%A8-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>6.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>&nbsp;&nbsp;&nbsp;&nbsp; 用于记录 linux 驱动相关的基础知识，着重与用法于接口，类似于手册，方便快速查阅相关函数。</p>
<a id="more"></a>

<h1 id="一、同步与互斥"><a href="#一、同步与互斥" class="headerlink" title="一、同步与互斥"></a>一、同步与互斥</h1><ul>
<li><p><font color=red>互斥：</font>指某一资源同时只允许一个访问者对其进行访问，具有唯一性和排它性。但互斥无法限制访问者对资源的访问顺序，即访问是<strong>无序</strong>的。</p>
</li>
<li><p><font color=red>同步：</font>指在互斥的基础上（大多数情况），通过其它机制实现访问者对资源的<strong>有序</strong>访问。在大多数情况下，同步已经实现了互斥，特别是所有写入资源的情况必定是互斥的。少数情况是指可以允许多个访问者同时访问资源。</p>
</li>
</ul>
<p>参考<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzAxNTAyOTczMw==&mid=2649332930&idx=1&sn=cf6b11d2d344e1f192d07d5f5467bccb&chksm=83977848b4e0f15e0650ec8e39593a755d19f4e4f32b8a25e2a2de7ecb0a641bba98019f7e98&scene=126&sessionid=1594705404&key=fa39e04f3e1bcf44088e1716b6d43d3a03b055518147584373ba2c95ca0956ad080126390dacea464cf8ffc82257ffe2d3bf3ebcb9405b6446a978c602cb657a4da2cd6b3cbf401b3a61731f333a9093&ascene=1&uin=NjY2NDMyNjc3&devicetype=Windows+10+x64&version=62090070&lang=zh_CN&exportkey=Ac2AMR9MZ4QTTczcCBTu2/E=&pass_ticket=zyBtnDr5s7LlelcQOyYHgtbncGCTFppo47/yH8Kh7rf/WiwN/09CMEDyCfHkbEIF">【干货】同步与互斥的失败例子</a></p>
<h2 id="1、原子变量"><a href="#1、原子变量" class="headerlink" title="1、原子变量"></a>1、原子变量</h2><h3 id="1-基本概念"><a href="#1-基本概念" class="headerlink" title="1) 基本概念"></a>1) 基本概念</h3><p>&nbsp;&nbsp;&nbsp;&nbsp; 原子操作的基本单位，原子操作指的是由多步操作组成的一个操作。如果操作不能原子地执行，则要么执行完所有的步骤，要么一步也不执行，不可能执行所有步骤的一个子集。简单来说<font color=red>原子操作就是不能打断的操作，要么完整执行要么不执行</font>。</p>
<p>内核定义的原子变量结构如下:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kernel<span class="number">-4.4</span>/include/linux/types.h</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> counter;</span><br><span class="line">&#125; <span class="keyword">atomic_t</span>;</span><br></pre></td></tr></table></figure>
<h3 id="2-整型原子操作"><a href="#2-整型原子操作" class="headerlink" title="2) 整型原子操作"></a>2) 整型原子操作</h3><h4 id="1-设置原子变量"><a href="#1-设置原子变量" class="headerlink" title="1. 设置原子变量"></a>1. 设置原子变量</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>atomic_t v = ATOMIC_INIT(0)</td>
<td>定义原子变量并初始化v为0</td>
</tr>
<tr>
<td>void atomic_set(atomic_t* v,int i)</td>
<td>设置原子变量的值为i</td>
</tr>
</tbody></table>
<h4 id="2-获取原子变量的值"><a href="#2-获取原子变量的值" class="headerlink" title="2. 获取原子变量的值"></a>2. 获取原子变量的值</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>atomic_read(atomic_t* v)</td>
<td>返回原子变量的值</td>
</tr>
</tbody></table>
<h4 id="3-原子变量加-减"><a href="#3-原子变量加-减" class="headerlink" title="3. 原子变量加/减"></a>3. 原子变量加/减</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>void atomic_add(int i, atomic_t* v)</td>
<td>原子变量增加i</td>
</tr>
<tr>
<td>void atomic_sub(int i, atomic_t* v)</td>
<td>原子变量减少i</td>
</tr>
</tbody></table>
<h4 id="4-原子变量自增-自减"><a href="#4-原子变量自增-自减" class="headerlink" title="4. 原子变量自增/自减"></a>4. 原子变量自增/自减</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>void atomic_inc(atomic_t* v)</td>
<td>原子变量自增1</td>
</tr>
<tr>
<td>void atomic_dec(atomic_t* v)</td>
<td>源自变量自减1</td>
</tr>
</tbody></table>
<h4 id="5-操作并测试"><a href="#5-操作并测试" class="headerlink" title="5. 操作并测试"></a>5. 操作并测试</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>int atomic_inc_and_test(atomic_t* v)</td>
<td>原子变量自增1，并测试其值是否为0。为0返回true，否则返回false</td>
</tr>
<tr>
<td>int atomic_dec_and_test(atomic_t* v)</td>
<td>原子变量自减1，并测试其值是否为0。为0返回true，否则返回false</td>
</tr>
<tr>
<td>int atomic_sub_and_test(int i, atomic_t* v)</td>
<td>原子变量减少i， 并测试其值是否为0。为0返回true，否则返回false</td>
</tr>
</tbody></table>
<h4 id="6-操作并返回"><a href="#6-操作并返回" class="headerlink" title="6. 操作并返回"></a>6. 操作并返回</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>int atomic_add_return(int i, atomic_t* v)</td>
<td>原子变量的值增加i，并返回新的值</td>
</tr>
<tr>
<td>int atomic_sub_return(int i, atomic_t* v)</td>
<td>原子变量的值减少i，并返回新的值</td>
</tr>
<tr>
<td>int atomic_inc_return(atomic_t* v)</td>
<td>原子变量的值自增1，并返回新的值</td>
</tr>
<tr>
<td>int atomic_dec_return(atomic_t* v)</td>
<td>原子变量的值自减1，并返回新的值</td>
</tr>
</tbody></table>
<h3 id="3-位原子操作"><a href="#3-位原子操作" class="headerlink" title="3) 位原子操作"></a>3) 位原子操作</h3><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>void set_bit(nr,void* addr);</td>
<td>设置addr地址的第nr位，即将nr位置1</td>
</tr>
<tr>
<td>void clear_bit(nr, void* addr);</td>
<td>清除addr地址的nr位，即将nr位清0</td>
</tr>
<tr>
<td>void chang_bit(nr, void* addr);</td>
<td>将addr的nr为反置</td>
</tr>
<tr>
<td>test_bit(nr, void* addr);</td>
<td>返回addr的第nr位</td>
</tr>
<tr>
<td>int test_and_set_bit(nt, void* addr);</td>
<td>测试addr的nr位，再设置为1</td>
</tr>
<tr>
<td>int test_and_clear_bit(nr, void* addr);</td>
<td>测试addr的nr位，再清为0</td>
</tr>
<tr>
<td>int test_and_chang_bit(nr, void* addr);</td>
<td>测试addr的nr位，再反置nr位</td>
</tr>
</tbody></table>
<h2 id="2、信号量"><a href="#2、信号量" class="headerlink" title="2、信号量"></a>2、信号量</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;一个信号量本质上是一个整数值，它和一对函数联合使用，这对函数通常称为P和V。希望进入临界区的进程将在相关信号量上调用P;如果信号量的值大于0,则该值会减1，而进程可以继续。相反，如果信号量的值为0(或者更小)，进程进入休眠并等待直到其他人释放该信号量。对信号量的解锁通过调用V来完成；该函数增加信号量的值，并在必要时唤醒等待的进程。当我们需要将信号量用于互斥时，只需将信号量的值设为1。这样的信号量在任何给定时刻只能由单个线程拥有。内核定义的信号量如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">include/linux/semaphore.h</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span> &#123;</span></span><br><span class="line">    <span class="keyword">raw_spinlock_t</span>      lock;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>        count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">wait_list</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>只有得到信号量的进程才能执行临界区的代码，当得不到信号量时，进程会进入休眠等待状态。并将当前进程放入对应的链表中。当有信号量被释放时遍历这个链表，唤醒被休眠的进程继续执行</li>
</ul>
</blockquote>
<h3 id="1-操作信号量的接口"><a href="#1-操作信号量的接口" class="headerlink" title="1) 操作信号量的接口"></a>1) 操作信号量的接口</h3><h4 id="1-初始化信号量"><a href="#1-初始化信号量" class="headerlink" title="1. 初始化信号量"></a>1. 初始化信号量</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>DECLARE_MUTEX(name);</td>
<td>将信号量name初始化为1</td>
</tr>
<tr>
<td>DECLARE_MUTEX_LOCKED(name);</td>
<td>将信号量name初始化为0</td>
</tr>
<tr>
<td>void init_MUTEX(struct semaphore *sem)</td>
<td>将信号量sem初始化为1</td>
</tr>
<tr>
<td>void init_NUTEX_LOCKED(struct semaphore *sem);</td>
<td>将信号量sem初始化为0</td>
</tr>
<tr>
<td>void sema_init(struct semaphore* sem, int val);</td>
<td>初始化信号量的值为 val</td>
</tr>
</tbody></table>
<h4 id="2-获取信号量的值"><a href="#2-获取信号量的值" class="headerlink" title="2. 获取信号量的值"></a>2. 获取信号量的值</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>void&nbsp;down(struct&nbsp;semaphore&nbsp;*sem);</td>
<td>递减信号量的值，并在必要时一直等待</td>
</tr>
<tr>
<td>int&nbsp;down_interruptible(struct&nbsp;semaphore&nbsp;*sem);</td>
<td>递减信号量的值，并在必要时一直等待，但是操作是可以中断的，它允许一个在等待的信号量的用户空间进程被用户中断。如果在操作中被中断，函数会返回一个非零值，并且调用者不持有信号量，真确的使用它需要一直检查返回值并针对性地响应。</td>
</tr>
<tr>
<td>int&nbsp;down_trylock(struct&nbsp;seamphore*&nbsp;sem);</td>
<td>永远不会休眠，如果信号量在调用时不可获得，它会返回一个非零值</td>
</tr>
</tbody></table>
<ul>
<li>当一个线程成功调用上面的”down”函数之后，该线程就拥有了该信号量。该线程就被赋予了自由访问该信号量保护临界区的权限。当互斥操作完之后必须返回该信号量。</li>
</ul>
<h4 id="3-释放信号量的值"><a href="#3-释放信号量的值" class="headerlink" title="3. 释放信号量的值"></a>3. 释放信号量的值</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>void up(struct semaphore *sem);</td>
<td>增加信号量的值并且调用者不在拥有该信号量</td>
</tr>
</tbody></table>
<ul>
<li>任何拿到信号量的线程都必须通过一次对up的调用而释放该信号量。在出现错误的情况下，经常需要特别小心。如果在拥有一个信号量时发生错误，必须将错误状态返回给调用者之前释放该信号量。忘记释放信号量将导致进程在某些无关的位置被意外挂起，很难复现和跟踪</li>
</ul>
<h2 id="3、自旋锁"><a href="#3、自旋锁" class="headerlink" title="3、自旋锁"></a>3、自旋锁</h2><p>自旋锁是一种死等的锁机制，不会进入睡眠，进程会一直等待，直到获到锁为止,内核提供的数据结构如下.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">raw_spinlock</span> <span class="title">rlock</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_LOCK_ALLOC</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> LOCK_PADSIZE (offsetof(struct raw_spinlock, dep_map))</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            u8 __padding[LOCK_PADSIZE];</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">lockdep_map</span> <span class="title">dep_map</span>;</span></span><br><span class="line">        &#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125; <span class="keyword">spinlock_t</span>;</span><br></pre></td></tr></table></figure>
<h3 id="1-自旋锁操作接口"><a href="#1-自旋锁操作接口" class="headerlink" title="1) 自旋锁操作接口"></a>1) 自旋锁操作接口</h3><h4 id="1-初始化自旋锁"><a href="#1-初始化自旋锁" class="headerlink" title="1. 初始化自旋锁"></a>1. 初始化自旋锁</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>spin_lock_init(&amp;lock);</td>
<td>初始化自旋锁 lock</td>
</tr>
</tbody></table>
<h4 id="2-获取自旋锁"><a href="#2-获取自旋锁" class="headerlink" title="2. 获取自旋锁"></a>2. 获取自旋锁</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>spin_lock(&amp;lock);</td>
<td>如果能够获得自旋锁则立刻返回，否则将在那里自旋，直到该自旋锁的持有者释放。</td>
</tr>
<tr>
<td>spin_try_lock(&amp;lock);</td>
<td>尝试获得自旋锁，如果能立刻获得锁返回true，否则立刻返回false，实际不再原地打转。</td>
</tr>
</tbody></table>
<h4 id="3-释放自旋锁"><a href="#3-释放自旋锁" class="headerlink" title="3. 释放自旋锁"></a>3. 释放自旋锁</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>spin_unlock(&amp;lock);</td>
<td>释放自旋锁 lock</td>
</tr>
</tbody></table>
<h2 id="4、互斥锁"><a href="#4、互斥锁" class="headerlink" title="4、互斥锁"></a>4、互斥锁</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;互斥锁主要用于实现内核中的互斥访问功能。的数据结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> &#123;</span></span><br><span class="line">    <span class="keyword">atomic_long_t</span>       owner;</span><br><span class="line">    <span class="keyword">spinlock_t</span>      wait_lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MUTEX_SPIN_ON_OWNER</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">optimistic_spin_queue</span> <span class="title">osq</span>;</span> <span class="comment">/* Spinner MCS lock */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">wait_list</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_MUTEXES</span></span><br><span class="line">    <span class="keyword">void</span>            *magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_LOCK_ALLOC</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lockdep_map</span>  <span class="title">dep_map</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>同一时刻只有一个线程可以持有mutex</li>
<li>只有锁持有者可以解锁。不能再一个进程中持有mutex，在另外一个进程中释放</li>
<li>不允许递归地加锁和解锁</li>
<li>当进程持有mutex时，进程不可以退出</li>
<li>mutex必须使用官方API来初始化</li>
<li>mutex可以睡眠，所以不允许在中断处理程序或者中断下半部中使用，例如tasklet、定时器等</li>
</ul>
<p>参考 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/215308082">手把手教Linux驱动7-内核互斥锁</a></p>
<h3 id="1-互斥锁接口"><a href="#1-互斥锁接口" class="headerlink" title="1) 互斥锁接口"></a>1) 互斥锁接口</h3><h4 id="1-初始化互斥锁"><a href="#1-初始化互斥锁" class="headerlink" title="1.初始化互斥锁"></a>1.初始化互斥锁</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>DEFINE_MUTEX(name);</td>
<td>静态创建化互斥锁 name</td>
</tr>
<tr>
<td>mutex_init(&amp;mutex);</td>
<td>动态初始化互斥锁 mutex</td>
</tr>
</tbody></table>
<h4 id="2-获取互斥锁"><a href="#2-获取互斥锁" class="headerlink" title="2. 获取互斥锁"></a>2. 获取互斥锁</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>mutex_lock(lock)；</td>
<td>获取互斥锁，获取不到则进入睡眠</td>
</tr>
<tr>
<td>mutex_trylock(lock)；</td>
<td>尝试获取互斥锁，成功返回1，    失败返回0</td>
</tr>
</tbody></table>
<h4 id="3-释放互斥锁"><a href="#3-释放互斥锁" class="headerlink" title="3. 释放互斥锁"></a>3. 释放互斥锁</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>mutex_unlock(lock)；</td>
<td>释放互斥锁</td>
</tr>
</tbody></table>
<h4 id="4-获取锁状态"><a href="#4-获取锁状态" class="headerlink" title="4. 获取锁状态"></a>4. 获取锁状态</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>mutex_is_lock(lock)；</td>
<td>如果锁已被使用返回1，否则返回0</td>
</tr>
</tbody></table>
<h1 id="二、linux-队列"><a href="#二、linux-队列" class="headerlink" title="二、linux 队列"></a>二、linux 队列</h1><h2 id="1、等待队列"><a href="#1、等待队列" class="headerlink" title="1、等待队列"></a>1、等待队列</h2><p>等待队列从功能上可以简单理解为：让进程进入睡眠，在你想让他工作的时候唤醒。它有两部分组成首先是挂接我们等待队列项的等待头，等待队列头的数据结构描述如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">wait_queue_head</span> &#123;</span></span><br><span class="line">    <span class="keyword">spinlock_t</span>      lock; <span class="comment">// 在对task_list与操作的过程中，使用该锁实现对等待队列的互斥访问。</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">task_list</span>;</span> <span class="comment">// 链接等待队列项 wait_queue_t</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">wait_queue_head</span> <span class="title">wait_queue_head_t</span>;</span></span><br></pre></td></tr></table></figure>
<p>而挂接在其上面的等待队列项的数据局结构如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">wait_queue</span> <span class="title">wait_queue_t</span>;</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*<span class="keyword">wait_queue_func_t</span>)</span><span class="params">(<span class="keyword">wait_queue_t</span> *wait, <span class="keyword">unsigned</span> mode, <span class="keyword">int</span> flags, <span class="keyword">void</span> *key)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">default_wake_function</span><span class="params">(<span class="keyword">wait_queue_t</span> *wait, <span class="keyword">unsigned</span> mode, <span class="keyword">int</span> flags, <span class="keyword">void</span> *key)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* __wait_queue::flags */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WQ_FLAG_EXCLUSIVE   0x01</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WQ_FLAG_WOKEN       0x02</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">wait_queue</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>        flags;</span><br><span class="line">    <span class="keyword">void</span>            *<span class="keyword">private</span>;</span><br><span class="line">    <span class="keyword">wait_queue_func_t</span>   func;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">task_list</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="1-等待队列接口"><a href="#1-等待队列接口" class="headerlink" title="1) 等待队列接口"></a>1) 等待队列接口</h3><h4 id="1-创建与初始化"><a href="#1-创建与初始化" class="headerlink" title="1. 创建与初始化"></a>1. 创建与初始化</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>DECLARE_WAIT_QUEUE_HEAD(name)</td>
<td>声明等待队列头 name</td>
</tr>
<tr>
<td>init_waitqueue_head(name)</td>
<td>初始化等待队列头 name</td>
</tr>
<tr>
<td>DECLARE_WAITQUEUE(name, tsk)</td>
<td>定义等待队列成员 name</td>
</tr>
</tbody></table>
<h4 id="2-添加移除等待队列"><a href="#2-添加移除等待队列" class="headerlink" title="2. 添加移除等待队列"></a>2. 添加移除等待队列</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>void add_wait_queue(wait_queue_head_t *q, wait_queue_t *wait);</td>
<td>将等待队列成员 wait，添加进入等待队列头 q</td>
</tr>
<tr>
<td>void remove_wait_queue(wait_queue_head_t *q, wait_queue_t *wait);</td>
<td>从等待队列头移除等待队列成员 wait</td>
</tr>
</tbody></table>
<h4 id="3-进程休眠"><a href="#3-进程休眠" class="headerlink" title="3. 进程休眠"></a>3. 进程休眠</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>wait_event(wq,&nbsp;condition)</td>
<td>如果condition为0，则进程休眠，且休眠状态不能被中断打断</td>
</tr>
<tr>
<td>wait_event_timeout(wq,&nbsp;condition,&nbsp;timeout)</td>
<td>如果condition为0，则进入休眠，当 timeout 到了则唤醒进程不管此时condition为真为假都会返回</td>
</tr>
<tr>
<td>wait_event_interruptible(wq,&nbsp;condition)</td>
<td>如果condition为0，则进程休眠，休眠状态可以被中断打断，当休眠被中断打断时返回0，这时驱动应返回 -ERESTARTSYS</td>
</tr>
<tr>
<td>wait_event_interruptible_timeout(wq,&nbsp;condition,&nbsp;timeout)</td>
<td>如果condition为0，则进程休眠，休眠状态可以被中断打断，当休眠被中断打断时返回0，这时驱动应返回 -ERESTARTSY，当 timeout 到了则唤醒进程不管此时condition为真为假都会返回</td>
</tr>
</tbody></table>
<h4 id="4-唤醒进程"><a href="#4-唤醒进程" class="headerlink" title="4. 唤醒进程"></a>4. 唤醒进程</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>void&nbsp;wake_up(wait_queue_head_t&nbsp;*q);</td>
<td>唤醒等待队列 q 上的进程，如果 condition 为真则返回</td>
</tr>
<tr>
<td>void&nbsp;wake_up_interruptible(wait_queue_head_t&nbsp;*q);</td>
<td>唤醒等待队列 q 上的进程，如果 condition 为真则返回</td>
</tr>
</tbody></table>
<h2 id="2、工作队列"><a href="#2、工作队列" class="headerlink" title="2、工作队列"></a>2、工作队列</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;工作队列（work queue）是一种将工作推后执行的形式，它和tasklet有所不同。工作队列可以把工作推后，交由一个内核线程去执行，也就是说，这个下半部分可以在进程上下文中执行。这样，通过工作队列执行的代码能占尽进程上下文的所有优势。最重要的就是工作队列允许被重新调度甚至是睡眠。它的数据结构如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*<span class="keyword">work_func_t</span>)</span><span class="params">(struct work_struct *work)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">atomic_long_t</span> data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">entry</span>;</span></span><br><span class="line">    <span class="keyword">work_func_t</span> func;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_LOCKDEP</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lockdep_map</span> <span class="title">lockdep_map</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/bullbat/article/details/7410563">Linux内核实践之工作队列</a></p>
<h3 id="3-操作函数"><a href="#3-操作函数" class="headerlink" title="3) 操作函数"></a>3) 操作函数</h3><h4 id="1-初始化工作队列"><a href="#1-初始化工作队列" class="headerlink" title="1. 初始化工作队列"></a>1. 初始化工作队列</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>INIT_WORK(work,func)</td>
<td>初始化工作队列项 work，并设置回调函数func</td>
</tr>
<tr>
<td>DECLARE_WORK(name,func)</td>
<td>声明一个等待队列项 name，并设置回调函数func</td>
</tr>
</tbody></table>
<h4 id="2-调度工作队列"><a href="#2-调度工作队列" class="headerlink" title="2. 调度工作队列"></a>2. 调度工作队列</h4><table>
<thead>
<tr>
<th>函数接口</th>
<th>接口含义</th>
</tr>
</thead>
<tbody><tr>
<td>schedule_work(&amp;work)</td>
<td>调度工作队列</td>
</tr>
<tr>
<td>schedule_delayed_work(&amp;work,tick)</td>
<td>延时tick个滴答应答之后调度工作队列</td>
</tr>
</tbody></table>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>braon-z
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://example.com/2020/11/23/linux%E9%A9%B1%E5%8A%A8-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" title="linux驱动-基础知识">https://example.com/2020/11/23/linux驱动-基础知识/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" rel="tag"><i class="fa fa-tag"></i> 基础知识</a>
              <a href="/tags/%E9%A9%B1%E5%8A%A8/" rel="tag"><i class="fa fa-tag"></i> 驱动</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/02/05/c++%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" rel="prev" title="c++基础知识">
                  <i class="fa fa-chevron-left"></i> c++基础知识
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/11/23/linux%E9%A9%B1%E5%8A%A8-i2c%E6%A1%86%E6%9E%B6-%E9%87%8D%E6%9E%84/" rel="next" title="linux驱动-i2c">
                  linux驱动-i2c <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">braon-z</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">323k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">4:54</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/local-search.js"></script>






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





<script>
NexT.utils.loadComments('#valine-comments', () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', () => {
    new Valine(Object.assign({"enable":true,"appId":"VsC1eQwQ4Xltm5eA9iYGp3VU-gzGzoHsz","appKey":"kyfyE4RWl6aIojedbxcuJa3V","serverURLs":null,"placeholder":"Just go go","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":null,"visitor":false,"comment_count":true,"recordIP":false,"enableQQ":false,"requiredFields":[]}, {
      el: '#valine-comments',
      path: "/2020/11/23/linux%E9%A9%B1%E5%8A%A8-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/",
      serverURLs: "https://vsc1eqwq.api.lncldglobal.com"
    }));
  }, window.Valine);
});
</script>




  <script src="/js/activate-power-mode.min.js"></script>
  <script>
    POWERMODE.colorful = true;
    POWERMODE.shake = false;
    document.body.addEventListener('input', POWERMODE);
  </script>
<div class="moon-menu">
  <div class="moon-menu-items">
    
    <div class="moon-menu-item" onclick="back2bottom()">
      <i class='fa fa-chevron-down'></i>    </div>
    
    <div class="moon-menu-item" onclick="back2top()">
      <i class='fa fa-chevron-up'></i>    </div>
    
  </div>
  <div class="moon-menu-button">
    <svg class="moon-menu-bg">
      <circle class="moon-menu-cricle" cx="50%" cy="50%" r="44%"></circle>
      <circle class="moon-menu-border" cx="50%" cy="50%" r="48%"></circle>
    </svg>
    <div class="moon-menu-content">
      <div class="moon-menu-icon"><i class='fas fa-ellipsis-v'></i></div>
      <div class="moon-menu-text"></div>
    </div>
  </div>
</div><script src="/js/injector.js"></script>
</body>
</html>
